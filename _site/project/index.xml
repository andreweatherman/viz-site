<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Quantum Jitter</title>
<link>https://www.quantumjitter.com/project/index.html</link>
<atom:link href="https://www.quantumjitter.com/project/index.xml" rel="self" type="application/rss+xml"/>
<description>A data science and machine learning blog with the tidyverse at its {{&lt; fa regular heart &gt;}}</description>
<generator>quarto-1.3.56</generator>
<lastBuildDate>Tue, 01 Nov 2022 00:00:00 GMT</lastBuildDate>
<item>
  <title>A Footnote in History</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/footnote/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/footnote/feature.gif" class="img-fluid" alt="A caveman stands inside a cave viewing the wall. There are two paintings. A rabbit with a mark references a further picture below of bowl of steaming soup. The second painting is of a fearsome beast with a different mark referencing a picture of a stick man running for his life."></p>
<p>The nature of employment has seen significant shifts over time. Occupations are being consigned to ‘footnotes in history’ whilst others grow driven by trends such as concern for the environment.</p>
<p>Producing a journal-quality table requires fine-grained and reproducible control over presentation. Surgical targeting of footnotes, capable of adapting to changes in the underlying data, is one example.</p>
<p>This post briefly explores the shifts in the nature of employment whilst at the same time more fully exploring the grammar of tables <a href="https://gt.rstudio.com">gt</a><span class="citation" data-cites="gt">(Iannone et al. 2022)</span>: The natural companion to the grammar of graphics <a href="https://ggplot2.tidyverse.org">ggplot2</a><span class="citation" data-cites="ggplot2">(Wickham 2016)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://gt.rstudio.com/">gt</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>In <a href="https://www.quantumjitter.com/project/planning/">Digging Deep</a>, the <a href="https://rstudio.github.io/DT/">DT package</a> is used to produce a <em>reactable</em> table; one with sortable and searchable columns. DT is intended as an R interface to the DataTables library, but reactivity is not yet supported in gt.</p>
<p>Data frames are liberally printed across all projects including, for example, a table to summarise an auto-generated overview of R packages and functions used in each project. The YAML option <code>df-print: kable</code> renders a nice table (with striped rows) in these cases.</p>
<p>For this project something a little more sophisticated is needed.</p>
<p>As a guiding principle, <a href="https://posit.co">Posit</a> packages are my first port of call. This provides a confidence in cross-package consistency, interoperability, longevity and an investment in development and support. Hence gt is the go-to package for the footnoted table further down.</p>
<p>As the intent is to present a summary in the style of the Financial Times, we’ll need a suitable custom <a href="https://registry.origami.ft.com/components/o-colors@6.4.2">colour palette</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="st" style="color: #20794D;">"#FFF1E5"</span>, <span class="st" style="color: #20794D;">"#F2DFCE"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"#333333"</span>, <span class="st" style="color: #20794D;">"#800D33"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"#C00000"</span>, <span class="st" style="color: #20794D;">"#00994D"</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">6</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span>, <span class="va" style="color: #111111;">y</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    nudge_y <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.1</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"label"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3.5</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span>,</span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Financial Times"</span>,</span>
<span>    fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span>,</span>
<span>    alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.8</span>,</span>
<span>    size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/footnote/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The labour market data are sourced from the <a href="https://www.nomisweb.co.uk/datasets/aps168/reports/employment-by-occupation?compare=K02000001">Office for National Statistics</a><sup>1</sup>.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">read_data</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="va" style="color: #111111;">x</span>,</span>
<span>    skip <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">12</span>,</span>
<span>    col_names <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"occupation"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"persons"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    col_types <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"text"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"numeric"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"skip"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"skip"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"skip"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"skip"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"skip"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>year <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">x</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">".xlsx"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">pop_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"2004.xlsx"</span>, <span class="st" style="color: #20794D;">"2021.xlsx"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">read_data</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>There’s a hierarchy to the data, so I’ll extract the lowest level and then slice off the top and bottom occupations based on their percentage change over time.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">change_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">pop_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_starts.html">str_starts</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">occupation</span>, <span class="st" style="color: #20794D;">"\\d{4} "</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op" style="color: #5E5E5E;">(</span>names_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">year</span>, values_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">persons</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">occupation</span>, into <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"soc"</span>, <span class="st" style="color: #20794D;">"occupation"</span><span class="op" style="color: #5E5E5E;">)</span>, sep <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>change <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">`2021`</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="va" style="color: #111111;">`2004`</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">change</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>group <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">&lt;=</span> <span class="fl" style="color: #AD0000;">10</span>, <span class="st" style="color: #20794D;">"Risers"</span>, <span class="st" style="color: #20794D;">"Fallers"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">10</span>, <span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">:</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">group</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The handling of footnotes is a particularly nice feature in <a href="https://gt.rstudio.com">gt</a>: The package automatically assigns, and maintains the order of, the superscripted numbers (could also be symbols) to ensure they flow naturally. And targeting offers a high degree of control and reproducibility.</p>
<p>For example, two entries (highlighted light blue) in the table below use the abbreviation <em>n.e.c.</em>. The footnote may be targeted at rows which <em>contain that string</em> rather than having to manually identify the rows. And once added, any subsequent footnotes would be renumbered to maintain the flow. So, if I were to change the source datasets to different years or countries, all references to <em>n.e.c.</em> would be auto-magically found and appropriately footnoted.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">gt_tbl</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">change_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op" style="color: #5E5E5E;">(</span>rowname_col <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"occupation"</span><span class="op" style="color: #5E5E5E;">)</span>, groupname_col <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"group"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"UK Employment by Occupation"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op" style="color: #5E5E5E;">(</span>table.width <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/pct.html">pct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">100</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    columns <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"2"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    decimals <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    columns <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"c"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    decimals <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0</span>,</span>
<span>    force_sign <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/sub_missing.html">sub_missing</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Year"</span>,</span>
<span>    columns <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"2"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op" style="color: #5E5E5E;">(</span>transform <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"capitalize"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_column_labels.html">cells_column_labels</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"s"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op" style="color: #5E5E5E;">(</span>transform <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"uppercase"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_column_labels.html">cells_column_labels</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"soc"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_footnote.html">tab_footnote</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    footnote <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Not elsewhere classified"</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_stub.html">cells_stub</a></span><span class="op" style="color: #5E5E5E;">(</span>rows <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"n.e.c."</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_footnote.html">tab_footnote</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    footnote <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Count of all persons"</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_column_spanners.html">cells_column_spanners</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_footnote.html">tab_footnote</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    footnote <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Standard Occupational Classification 2020"</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_column_labels.html">cells_column_labels</a></span><span class="op" style="color: #5E5E5E;">(</span>columns <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"soc"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_footnote.html">tab_footnote</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    footnote <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Top &amp; bottom 10 occupations ordered by percent change"</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_row_groups.html">cells_row_groups</a></span><span class="op" style="color: #5E5E5E;">(</span>groups <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Risers"</span>, <span class="st" style="color: #20794D;">"Fallers"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_footnote.html">tab_footnote</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    footnote <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Figures suppressed as statistically unreliable"</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      columns <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">change</span>, <span class="va" style="color: #111111;">`2021`</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      rows <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">change</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_source_note.html">tab_source_note</a></span><span class="op" style="color: #5E5E5E;">(</span>source_note <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: Office for National Statistics (ONS)"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">gt_tbl</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style_body.html">tab_style_body</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_fill.html">cell_fill</a></span><span class="op" style="color: #5E5E5E;">(</span>color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"lightblue"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    pattern <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"n.e.c."</span>,</span>
<span>    extents <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"stub"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op" style="color: #5E5E5E;">(</span>style <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span>, color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"gray"</span>, add_row_striping <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/as_raw_html.html">as_raw_html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">

<div id="vjaoifkkcw" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
  
  <table class="gt_table" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: 100%; border-top-style: solid; border-top-width: 2px; border-top-color: #5F5F5F; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #5F5F5F; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3;" width="100%" bgcolor="#FFFFFF">
<thead class="gt_header"><tr>
<td colspan="5" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="background-color: #FFFFFF; text-align: center; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; color: #333333; font-size: 125%; padding-top: 4px; padding-bottom: 4px; padding-left: 5px; padding-right: 5px; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #5F5F5F; font-weight: normal;" bgcolor="#FFFFFF" align="center">UK Employment by Occupation</td>
    </tr></thead>
<thead class="gt_col_headings" style="border-top-style: solid; border-top-width: 2px; border-top-color: #5F5F5F; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #5F5F5F; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3;">
<tr>
<th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1" scope="col" id="" style="color: #FFFFFF; background-color: #5F5F5F; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; text-align: left;" bgcolor="#5F5F5F" valign="bottom" align="left"></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="2" colspan="1" style="color: #FFFFFF; background-color: #5F5F5F; font-size: 100%; font-weight: normal; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; text-transform: uppercase;" scope="col" id="soc<sup class=&quot;gt_footnote_marks&quot;>2</sup>" bgcolor="#5F5F5F" valign="bottom" align="right">soc<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">2</sup>
</th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="2" scope="colgroup" id="Year<sup class=&quot;gt_footnote_marks&quot;>1</sup>" style="color: #FFFFFF; background-color: #5F5F5F; font-size: 100%; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; text-align: center;" bgcolor="#5F5F5F" align="center">
        <span class="gt_column_spanner" style="border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #5F5F5F; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%;">Year<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">1</sup></span>
      </th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="2" colspan="1" style="color: #FFFFFF; background-color: #5F5F5F; font-size: 100%; font-weight: normal; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; text-transform: capitalize;" scope="col" id="change" bgcolor="#5F5F5F" valign="bottom" align="right">change</th>
    </tr>
<tr>
<th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" style="color: #FFFFFF; background-color: #5F5F5F; font-size: 100%; font-weight: normal; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; text-transform: capitalize;" scope="col" id="2004" bgcolor="#5F5F5F" valign="bottom" align="right">2004</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" style="color: #FFFFFF; background-color: #5F5F5F; font-size: 100%; font-weight: normal; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; text-transform: capitalize;" scope="col" id="2021" bgcolor="#5F5F5F" valign="bottom" align="right">2021</th>
    </tr>
</thead>
<tbody class="gt_table_body" style="border-top-style: solid; border-top-width: 2px; border-top-color: #5F5F5F; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #5F5F5F;">
<tr class="gt_group_heading_row">
<th colspan="5" class="gt_group_heading" scope="colgroup" id="Risers<sup class=&quot;gt_footnote_marks&quot;>3</sup>" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #5F5F5F; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #5F5F5F; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; text-align: left;" bgcolor="#FFFFFF" valign="middle" align="left">Risers<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">3</sup>
</th>
    </tr>
<tr class="gt_row_group_first">
<th id="stub_1_1" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Industrial cleaning process occupations</th>
<td headers="Risers stub_1_1 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-top-width: 2px;" valign="middle" align="right">9132 </td>
<td headers="Risers stub_1_1 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-top-width: 2px;" valign="middle" align="right">26,300</td>
<td headers="Risers stub_1_1 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-top-width: 2px;" valign="middle" align="right">241,100</td>
<td headers="Risers stub_1_1 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-top-width: 2px;" valign="middle" align="right">+817%</td>
</tr>
<tr>
<th id="stub_1_2" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left; background-color: #ADD8E6;" bgcolor="#ADD8E6" valign="middle" align="left">Health professionals n.e.c.<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">4</sup>
</th>
<td headers="Risers stub_1_2 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">2219 </td>
<td headers="Risers stub_1_2 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">9,000</td>
<td headers="Risers stub_1_2 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">70,100</td>
<td headers="Risers stub_1_2 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">+679%</td>
</tr>
<tr>
<th id="stub_1_3" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Police community support officers</th>
<td headers="Risers stub_1_3 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">3315 </td>
<td headers="Risers stub_1_3 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">2,100</td>
<td headers="Risers stub_1_3 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">13,900</td>
<td headers="Risers stub_1_3 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">+562%</td>
</tr>
<tr>
<th id="stub_1_4" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Business and financial project management professionals</th>
<td headers="Risers stub_1_4 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">2424 </td>
<td headers="Risers stub_1_4 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">58,300</td>
<td headers="Risers stub_1_4 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">350,000</td>
<td headers="Risers stub_1_4 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">+500%</td>
</tr>
<tr>
<th id="stub_1_5" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Advertising and public relations directors</th>
<td headers="Risers stub_1_5 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">1134 </td>
<td headers="Risers stub_1_5 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">19,400</td>
<td headers="Risers stub_1_5 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">69,000</td>
<td headers="Risers stub_1_5 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">+256%</td>
</tr>
<tr>
<th id="stub_1_6" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">IT business analysts, architects and systems designers</th>
<td headers="Risers stub_1_6 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">2135 </td>
<td headers="Risers stub_1_6 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">82,800</td>
<td headers="Risers stub_1_6 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">270,500</td>
<td headers="Risers stub_1_6 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">+227%</td>
</tr>
<tr>
<th id="stub_1_7" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Aircraft maintenance and related trades</th>
<td headers="Risers stub_1_7 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">5235 </td>
<td headers="Risers stub_1_7 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">27,200</td>
<td headers="Risers stub_1_7 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">88,300</td>
<td headers="Risers stub_1_7 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">+225%</td>
</tr>
<tr>
<th id="stub_1_8" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Quality assurance and regulatory professionals</th>
<td headers="Risers stub_1_8 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">2462 </td>
<td headers="Risers stub_1_8 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">43,700</td>
<td headers="Risers stub_1_8 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">138,000</td>
<td headers="Risers stub_1_8 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">+216%</td>
</tr>
<tr>
<th id="stub_1_9" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Officers of non-governmental organisations</th>
<td headers="Risers stub_1_9 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">4114 </td>
<td headers="Risers stub_1_9 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">41,800</td>
<td headers="Risers stub_1_9 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">127,200</td>
<td headers="Risers stub_1_9 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">+204%</td>
</tr>
<tr>
<th id="stub_1_10" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Environment professionals</th>
<td headers="Risers stub_1_10 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">2142 </td>
<td headers="Risers stub_1_10 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">17,500</td>
<td headers="Risers stub_1_10 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">52,100</td>
<td headers="Risers stub_1_10 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">+198%</td>
</tr>
<tr class="gt_group_heading_row">
<th colspan="5" class="gt_group_heading" scope="colgroup" id="Fallers<sup class=&quot;gt_footnote_marks&quot;>3</sup>" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 2px; border-top-color: #5F5F5F; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #5F5F5F; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; text-align: left;" bgcolor="#FFFFFF" valign="middle" align="left">Fallers<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">3</sup>
</th>
    </tr>
<tr class="gt_row_group_first">
<th id="stub_1_11" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Sheet metal workers</th>
<td headers="Fallers stub_1_11 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-top-width: 2px;" valign="middle" align="right">5213 </td>
<td headers="Fallers stub_1_11 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-top-width: 2px;" valign="middle" align="right">29,100</td>
<td headers="Fallers stub_1_11 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-top-width: 2px;" valign="middle" align="right">10,900</td>
<td headers="Fallers stub_1_11 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-top-width: 2px;" valign="middle" align="right">−63%</td>
</tr>
<tr>
<th id="stub_1_12" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left; background-color: #ADD8E6;" bgcolor="#ADD8E6" valign="middle" align="left">Process operatives n.e.c.<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">4</sup>
</th>
<td headers="Fallers stub_1_12 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">8119 </td>
<td headers="Fallers stub_1_12 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">22,200</td>
<td headers="Fallers stub_1_12 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">8,200</td>
<td headers="Fallers stub_1_12 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">−63%</td>
</tr>
<tr>
<th id="stub_1_13" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Footwear and leather working trades</th>
<td headers="Fallers stub_1_13 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">5413 </td>
<td headers="Fallers stub_1_13 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">13,000</td>
<td headers="Fallers stub_1_13 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">4,800</td>
<td headers="Fallers stub_1_13 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">−63%</td>
</tr>
<tr>
<th id="stub_1_14" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Printing machine assistants</th>
<td headers="Fallers stub_1_14 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">8127 </td>
<td headers="Fallers stub_1_14 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">22,600</td>
<td headers="Fallers stub_1_14 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">8,100</td>
<td headers="Fallers stub_1_14 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">−64%</td>
</tr>
<tr>
<th id="stub_1_15" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Assemblers (electrical and electronic products)</th>
<td headers="Fallers stub_1_15 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">8131 </td>
<td headers="Fallers stub_1_15 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">63,200</td>
<td headers="Fallers stub_1_15 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">20,700</td>
<td headers="Fallers stub_1_15 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">−67%</td>
</tr>
<tr>
<th id="stub_1_16" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Printers</th>
<td headers="Fallers stub_1_16 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">5422 </td>
<td headers="Fallers stub_1_16 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">63,600</td>
<td headers="Fallers stub_1_16 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">8,900</td>
<td headers="Fallers stub_1_16 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">−86%</td>
</tr>
<tr>
<th id="stub_1_17" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Chartered architectural technologists</th>
<td headers="Fallers stub_1_17 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">2435 </td>
<td headers="Fallers stub_1_17 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">2,400</td>
<td headers="Fallers stub_1_17 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
<td headers="Fallers stub_1_17 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
</tr>
<tr>
<th id="stub_1_18" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Moulders, core makers and die casters</th>
<td headers="Fallers stub_1_18 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">5212 </td>
<td headers="Fallers stub_1_18 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">3,900</td>
<td headers="Fallers stub_1_18 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
<td headers="Fallers stub_1_18 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
</tr>
<tr>
<th id="stub_1_19" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Air-conditioning and refrigeration engineers</th>
<td headers="Fallers stub_1_19 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">5225 </td>
<td headers="Fallers stub_1_19 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">19,400</td>
<td headers="Fallers stub_1_19 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
<td headers="Fallers stub_1_19 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
</tr>
<tr>
<th id="stub_1_20" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Pre-press technicians</th>
<td headers="Fallers stub_1_20 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">5421 </td>
<td headers="Fallers stub_1_20 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">8,600</td>
<td headers="Fallers stub_1_20 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
<td headers="Fallers stub_1_20 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; background-color: #F4F4F4; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" bgcolor="#F4F4F4" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
</tr>
<tr>
<th id="stub_1_21" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; color: #333333; background-color: #D5D5D5; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D5D5D5; padding-left: 5px; padding-right: 5px; text-align: left;" valign="middle" bgcolor="#D5D5D5" align="left">Coal mine operatives</th>
<td headers="Fallers stub_1_21 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">8122 </td>
<td headers="Fallers stub_1_21 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">2,600</td>
<td headers="Fallers stub_1_21 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
<td headers="Fallers stub_1_21 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D5D5D5; border-left-style: none; border-left-width: 1px; border-left-color: #D5D5D5; border-right-style: none; border-right-width: 1px; border-right-color: #D5D5D5; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
</tr>
</tbody>
<tfoot class="gt_sourcenotes" style="color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3;" bgcolor="#FFFFFF"><tr>
<td class="gt_sourcenote" colspan="5" style="font-size: 90%; padding-top: 4px; padding-bottom: 4px; padding-left: 5px; padding-right: 5px;">Source: Office for National Statistics (ONS)</td>
    </tr></tfoot>
<tfoot class="gt_footnotes" style="color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3;" bgcolor="#FFFFFF">
<tr>
<td class="gt_footnote" colspan="5" style="margin: 0px; font-size: 90%; padding-left: 4px; padding-right: 4px; padding-left: 5px; padding-right: 5px;">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">1</sup> Count of all persons</td>
    </tr>
<tr>
<td class="gt_footnote" colspan="5" style="margin: 0px; font-size: 90%; padding-left: 4px; padding-right: 4px; padding-left: 5px; padding-right: 5px;">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">2</sup> Standard Occupational Classification 2020</td>
    </tr>
<tr>
<td class="gt_footnote" colspan="5" style="margin: 0px; font-size: 90%; padding-left: 4px; padding-right: 4px; padding-left: 5px; padding-right: 5px;">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">3</sup> Top &amp; bottom 10 occupations ordered by percent change</td>
    </tr>
<tr>
<td class="gt_footnote" colspan="5" style="margin: 0px; font-size: 90%; padding-left: 4px; padding-right: 4px; padding-left: 5px; padding-right: 5px;">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">4</sup> Not elsewhere classified</td>
    </tr>
<tr>
<td class="gt_footnote" colspan="5" style="margin: 0px; font-size: 90%; padding-left: 4px; padding-right: 4px; padding-left: 5px; padding-right: 5px;">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup> Figures suppressed as statistically unreliable</td>
    </tr>
</tfoot>
</table>
</div>
</div>
</div>
<p>The above table uses one of the in-built style theme options. It looks clean and polished. But sometimes the table to be published needs a high degree of customisation to match, for example, a specific branding. <a href="https://gt.rstudio.com">gt</a> offers this as we’ll demonstrate by attempting to replicate the style employed by the <a href="https://markets.ft.com/data/">market data in the Financial Times</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">gt_ft</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">gt_tbl</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    table.border.top.color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#FFF1E5"</span>,</span>
<span>    table.border.bottom.color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#FFF1E5"</span>,</span>
<span>    table.background.color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#FFF1E5"</span>,</span>
<span>    table.font.size <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/px.html">px</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    table.font.color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#262A33"</span>,</span>
<span>    heading.align <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"left"</span>,</span>
<span>    heading.title.font.size <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/px.html">px</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">20</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    heading.title.font.weight <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bold"</span>,</span>
<span>    heading.background.color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#FFF1E5"</span>,</span>
<span>    row.striping.include_table_body <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>    row.striping.include_stub <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>    row.striping.background_color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#F2DFCE"</span>,</span>
<span>    row_group.background.color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#FFF1E5"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/html.html">html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"UK Employment by Occupation  "</span>, </span>
<span>                          <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/local_image.html">local_image</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"logo.png"</span>, height <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">20</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op" style="color: #5E5E5E;">(</span>font <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Financier Display"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_borders.html">cell_borders</a></span><span class="op" style="color: #5E5E5E;">(</span>sides <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bottom"</span>, weight <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/px.html">px</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span>, color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#262A33"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_title.html">cells_title</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op" style="color: #5E5E5E;">(</span>size <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/px.html">px</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">14</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_row_groups.html">cells_row_groups</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op" style="color: #5E5E5E;">(</span>color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#800D33"</span>, weight <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bold"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_stub.html">cells_stub</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op" style="color: #5E5E5E;">(</span>weight <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bold"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_column_labels.html">cells_column_labels</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>                     <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_column_spanners.html">cells_column_spanners</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>                     <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_row_groups.html">cells_row_groups</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_borders.html">cell_borders</a></span><span class="op" style="color: #5E5E5E;">(</span>style <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"hidden"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>                     <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_row_groups.html">cells_row_groups</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>                     <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_stub.html">cells_stub</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op" style="color: #5E5E5E;">(</span>color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#00994D"</span>, weight <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bold"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      columns <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">change</span>,</span>
<span>      rows <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">change</span> <span class="op" style="color: #5E5E5E;">&gt;=</span> <span class="fl" style="color: #AD0000;">0</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op" style="color: #5E5E5E;">(</span>color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#C00000"</span>, weight <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bold"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      columns <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">change</span>,</span>
<span>      rows <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">change</span> <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="fl" style="color: #AD0000;">0</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op" style="color: #5E5E5E;">(</span>color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"grey40"</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/px.html">px</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">9</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    locations <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_footnotes.html">cells_footnotes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/cells_source_notes.html">cells_source_notes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">gt_ft</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://gt.rstudio.com/reference/as_raw_html.html">as_raw_html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">

<div id="zxkctbifww" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
  
  <table class="gt_table" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif; display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #262A33; font-size: 10px; font-weight: normal; font-style: normal; background-color: #FFF1E5; width: 100%; border-top-style: solid; border-top-width: 2px; border-top-color: #FFF1E5; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #FFF1E5; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3;" width="100%" bgcolor="#FFF1E5">
<thead class="gt_header"><tr>
<td colspan="5" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="background-color: #FFF1E5; text-align: left; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; color: #262A33; font-size: 20px; padding-top: 4px; padding-bottom: 4px; padding-left: 5px; padding-right: 5px; font-weight: normal; font-family: 'Financier Display'; border-bottom-width: 3px; border-bottom-style: solid; border-bottom-color: #262A33;" bgcolor="#FFF1E5" align="left">UK Employment by Occupation   <img src="https://www.quantumjitter.com/project/footnote/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAmUAAAJlCAYAAACbj4UnAAAACXBIWXMAAAsSAAALEgHS3X78AAAgAElEQVR4nO3deZSl11nf+291Vc+j1HLLmqfWLMuSPMmYaXkAbIwTAiSASezYBBwTB4jjAE5YKzErI3DBDHcFXxLb10wGEi+GCxhiG9t4kKzJkjVLrW5rHnqeh6q6f+xzXOecPjWf/ex3+H7Weteprm7t531b1XV+9bz73RskSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSbUzVvoEJA21Cvgu4HuA64FLgJXAceAR4A7gE8DngMlC5yhJktRYa4D3Ai8A0ws4HgZ+CH/AkiRJGpmrgPtYWBgbPP4c2Bp/ypIkSc3yTcABlhbIertm50afuCRJUlNcwcJvV8533Adsij19SZKk+psgTdofRSDrHh+JvABJkqQmeDejDWTd41siL0KSJKnOJoBd5AllfxF4HZIkSbX2I+QJZNPAFLAt7lIkSZLqaQXwAPlC2TTww2FXI0lathWlT0Bqqb8HXJm5xvWZx5ckjZChTCrj3QE1zg+oIUkaEUOZFO9K4HUBddYE1JAkjYihTIr3s8TsVXksoIYkaUQMZVKsC4G3BtV6PKiOJGkEDGVSrPcCK4Nq3RZUR5IkqVa2AIfIuwxG9zgKbIy5LEnSKNgpk+K8HVgfVOuvgYNBtSRJkmrlPmK6ZNPAu4KuSZIkqVZuJi6QTQEXxFyWJGlUvH0pxXhHYK0v4pOXkiRJp1kH7CeuU/YvYy5LkiSpXv4xcYFsGrgs5rIkSZLq5dPEBbJ7g65JkjRizimT8roE+PbAen8aWEuSNEKGMimvtxOzz2XXJwJrSZIk1cIKYBdxty4fi7ksSVIOdsqkfF5L2oA8yh8G1pIkSaqN3yX2qcurYi5LkiSpPjYDR4gLZJ+PuSxJUi7evpTy+EfA2sB6HwqsJUmSVBtfJK5LtpfYAChJklQL24mdS/YbMZclScrJ25fS6P1IcL3/GVxPkiSpFh4mrkt2V9A1SZIys1MmjdbNpNuXUeySSZIkDfGbxHXJjgNbYy5LkiSpPlYCzxMXyv4o5rIkSZLq5XuIferyjTGXJUmSVC8fJy6QPQ6Mx1yWJElSfWwidlul/xBzWZIkSfXyTuIC2SRwYcxlSZIk1cvniQtlfxl0TZIkSbVyGXGBbBr4vpjLkiRJqpcPEBfIniEtvSFJkqQeK4CdxIWy/xpyVZIkSTXzemJvXV4ec1mSJEn18nvEBbLPBF2TJElSrWwBjhIXyn445rIkSZLq5d3EBbLdwOqYy5IkSaqX24gLZb8adE2SJEm1cj1xgWwauDbmsiRJkurlV4kLZF8KuiZJkqRaWQU8T1wo+7GYy5IkSaqX7ycukB0BNsdcliRJUr38BXGh7PeCrkmSJKlWzgNOERfKviPmsiRJkurl54gLZI+T9taUJEnSgIeJC2X/KeiaJEmSauVbiQtk08AVMZclSZJULx8hLpB9MeaSJEmS6mUjcJi4UPbjMZclSZJUL/+MuEB2FNgSc1mSJEn18iXiQtkfBF2TJElSrVxDXCCbBr4r5rIkSZLq5ZeIC2RPAeMxlyVJklQfK4FniQtl/zXmsiRJkurle4m9dXllzGVJkiTVy58RF8g+H3RNkiRJtXIOsZuPvz3kqiRJkmrmZ4gLZAeA9TGXJUmSVC8PEhfKPhR0TZIkSbXyLcQFsmnglTGXJUmSVC8fJi6Q3RN0TZIkSbWyEThEXCj7qZjLkiRJqpfIzcePA2fFXJYkSVK9RG4+/sdB1yRJklQr0ZuPvzHmsiRJkuolcvPxJ3DzcUmSpNOsBJ4jLpT9x5jLkiRJqpfvJy6QTQGXxVyWJElSvfwVcaHsc0HXJEmSVCsXAZPEhbJ3xFyWJElSvfwH4gLZYdICtZIkSeqxAnicuFD2/8ZcliRJUr28ibhANg28LuayJEmS6uUTxAWyXcBYzGVJkiTVx7nASeJC2S/EXJYkSVK9/Dyxty63x1yWJElSfawg3U6MCmRfiLksSVIdrSh9AlJBbwQuDKz30cBakiRJtfGnxHXJjgKbYy5LkiSpPi4mdgX/Pwi5KklSbXn7Um31HmK/r11KUmSNGADsI+4LtnTwHjIlUmSastOmdro7cTO7/pd0q1SSZIkdYwBDxHXJZsGbgy5MkmSpBr5+8QGsntjLkuSJKk+LgCeIzaUvT/kyiRJkmrkb4gNZFOkpTckSZrXROkTkIK8BXh9cM0vADuDaw4aB1YDa0lPnW4E1nd+vRpY0/ncxp7f7/14EjhE6jB+HTgArCR97zgBHCM9MLSt89+c6tTcB+zt/Le7SfP49me+VkmqNUOZ2uLnC9T83UX82W5oWs/sAan348HPdf/b9aSgtbpzVGUpjmngNuBjwG+TdjiQJPUYK30CUoBriJ9wP0kKICtIgav3WEcKT71hqk3L0zxFWrz3f5c+EUmqEkOZqmKM1OFZN+To3m5bA6widYCGvU6Qbq0NHjcCL4m7FC3QfwN+pvRJSFJVGMo0n27oWT3w8Rr6Oz+9naDubbTeTlDvx8OC11r8emwjg5kkdfgmuDxjwBmkeTsHSZOeo6yiv5PUG3C6Aao3RPWGpsG5SL1Hb4BahV8jyu/78FamJPmGu0hrgO8G3gjcDFxOCi5dTwNfJj2l1l0SYbrzeyuZCUjdY/B220TnGB84Jpi5tdcNVlWZwC0t11Okf0tHSp+IJJVkKFuYTcD7gJ8gdcYkjdZPAR8sfRKSVJKhbH5vAv4H8OLSJyI12F24R6ikljOUze3ngP+If09ShK3AntInIUmltGltpMX6d8B/wkAmRbmu9AlIUkmGsuH+AfALpU9CapnNpU9AkkoylJ3uRaRtYCTFmip9ApJUkqHsdB/AJyylEi4vfQKSVJKhrN+LgX9a+iSklvq20icgSSUZyvq9lbSoq6R4r8UHayS1mKGs3/eUPgGpxTYBF5U+CUkqxVA2Y5y0dZKkcs4ufQKSVIqhbMaFeOtSKs3vSZJay2+AM7aWPgFJPFf6BCSpFEPZDP8upLIOADtKn4QklWIQmbG39AlILfcAMF36JCSpFEPZjJ3AydInIbXYk6VPQJJKMpTNOAk8VPokpBY7v/QJSFJJE6VPoGK+Dlxb+iSkQMeBw8Ax0g8mx3s+d6hzXAzcEHAu2wJqSFJlGcr6PVv6BKQe06Sw1D2ODvn4CGmC/MHOMezjQ50/f7znvz3S+fypBZzH34zqguaxIaiOJFWSoayfbwpaimPA/iFHNxwdGji6n+t2qLrH8SG/roKo7rHTKSS1mqGs36bSJ6AQJ5kJRwfpD0qDn5vt40OkTtR+qhOectgInBNU61hQHUmqJENZv3WlT0DzOkEKQ4PH3iHHns5r7228gzQ7RI3alYG1DgXWkqTKMZT1c1X/5TtBmq90dJbXI6TbdocHPp7v1waqMiJD2TOBtSSpcgxl/dq0GfIUKSjNdhymvxO1f+DXg7fyuh+71luzXBVY67HAWpJUOYayGSuBM0qfxCxOkAJPt2N0eMjR7SodpH+yeTdEDf455+9oISI7Za4TKKnVDGUztgFjAXXuZWbO0z6Gz4Ua/PyRgPOShokMZV8LrCVJqrCbSOtC5TwMV6qTMdLXbO5/F91je8xlSVI1uS7QjBcF1NgfUEMalYuAtUG1jgI7gmpJUiUZymZEbPFiKFOdRE7yf5D08IkktZahbIahTOp3dWCthwNrSVIlGcpmRNy+3BdQQxqVyE6ZT15Kaj1D2YyzAmoYylQndsokKZChbEbEav6GMtVJZCizUyap9QxlMyI6ZXsDakijcBYx/ya67JRJaj1D2Qw7ZdKMyC7ZXuCFwHqSVEmGshnOKZNmeOtSkoK5zVIyTkynzCUxVBdO8peqZStwDamBMAk8RdqazH2MG8RQlmwlpmtop0x1YadMKm8V8KPAO4EbOX1/5uPAp4APAn8de2pSPtcRs7ffq6MuSFqmXcTtefmDQdck1cl3AI+x8H9Hf0PaGk2qvdcR8+YT2X2Qlmo9acujqFB2U8xlSbXxftItysX+W3oOeE2B85VG6oeIefM5J+qCpGV4GXGBbBrYGHNZUi38DMv793QAuDb8rDUSPn2ZnB1Ux4n+qoPIju4zwMHAelKVvQH4z8scYyPwp8C65Z+OohnKkojNyE8CRwLqSMvlJH8p3lrg1zl9Mv9SXAr89AjGUTBDWRLRKfPJS9WFoUyK99vAlSMc79+Qgp5qxFCWGMqkGYYyKdbbgR8e8ZibSLdDVSOGssRQJiUrge2B9Vw4Vm23CfjFTGO/LtO4ysRQlkTMKTOUqQ62E7uotJ0ytd2Pkm+bv4szjatMDGVJRCjzyUvVwVWBtaaARwPrSVX0YxnHdrmZmjGUpS/aNQF17JSpDiLnk32dtE2M1FavYrST+wfZDKgZQ1lMlwwMZaqHyE6Zty7Vdj+XefxHMo+vETOUGcqkXpGdMif5q81uBv5e5hpfyDy+RsxQZiiTeuW8lTLITpna7P0BNR4IqKERMpTle+plkPf2VXXnEzsx2FCmtroKeHPmGtOkeZuqEUMZbA2qY6dMVRc5nwy8fan2+ueMZjuluezArf1qx1AW1ykzlKnqIueTnQB2BtaTqmIN8I8D6vxtQA2NmKHMUCZ1RXbKHgMmA+tJVfEW4IyAOh8PqKERM5R5+1Lqcs9LKb+3BtS4D/g/AXU0YoYyJ/pLXT55KeV1PvDGgDr/ljTRXzVjKIsJZaeAgwF1pKXaAJwbWM9H9dVG/xZYmbnG48CfZK6hTAxlMbcv9wbUkJbjiuB6hjK1zcXAOwPq/C/sktVW20PZCmImXO4OqCEtR3Qouz+4nlTaz5O/Swbw4YAayqTtoexMYv4O9gTUkJYjMpS9gD+oqF0uImYZjC8BdwfUUSZtD2VRk/x9A1LVRYYyb12qbd5HTJfsNwNqKKO2h7Izg+rYKVPVRT556a1LtcmLiZlL9izwRwF1lJGhLIadMlWdnTIpj/eQVvHP7ddIO2WoxtoeyiIm+YOdMlXb2cCmwHp2ytQW64AfD6jzAvAbAXWUWdtDmZ0yyeUwpFz+CTHLLv1n4EBAHWVmKIthp0xVFjmf7CiwK7CeVMoY8FMBdSaB3wmoowCGshh2ylRlkZ2yh4CpwHpSKW8i5geevwWeC6ijAG0PZc4pk5zkL+Xwr4LqfDyojgK0PZTZKZMMZdKovRR4bUCdE6RtldQQhrIYdspUVePAZYH1fPJSbfAvgur8Gb6/qEEeJG3cmvM4FnY10uJtJ/+/gd7jpTGXJRWzBThMzL+ntwRdk4LYKcvPW5eqssgnL6dJE/2lJns7aX2y3J4B/jKgjgK1OZSNETPR31CmKosMZbtIS2JITTUGvDuo1m8DJ4NqKUibQ9kW0nya3AxlqrLIUPZgYC2phDcAlwfUmQR+K6COgrU5lJ0VVOeFoDrSUhjKpNH5iaA6fwY8EVRLgdocyiK2vgA7Zaq2qwJrGcrUZBcBbw6q9etBdRSszaEsqlNmKFNVbSZtRh7FNcrUZD9OzHvqvcCnA+qogDaHMjtlarvIW5dgp0zNtQp4Z1Atu2QN1uZQZqdMbRcZyg4BTwbWkyJ9P7AtoM4e4GMBdVRIm0NZVKfMif6qKif5S6MRtQzGbwFHgmqpgDaHMjtlajtDmbR81wOvCahzEvjNgDoqqM2hzDllajtDmbR8UV2yP8QpAGqwzxKzN1nUpufSYqwgra4fteflP4y5LCnUJuAgMf+GXhZ0TSrITlleU8DegDrSYl0ErAmsZ6dMTfQjwIaAOp8Hbg+oIxXzDPl/snGSv6rqu4jrkk0Ba2MuSwp1DzH/hr436oJUlp2yvPYE1JCWInI+2ddxI3I1zzcD1wXUeRT4k4A6qoC2hrLNwERAHW9dqqoit1d6KLCWFOVdQXV+ldRtVgu0NZRFPXlpKFNVGcqkpTuLtGBsbnuADwfUUUW0NZRFrVFmKFNVXR1Yy0n+app3AKsD6vwWcDigjiqiraHMTpnabAuxG5HbKVOTrCBtPp7bCdznsnXaGsqiOmX7gupIixF56xIMZWqW7wIuDajz+8DTAXVUIYayvOyUqYoiQ9lxYFdgPSm3qBX8fzmojiqkraHM25dqs8hQ9ig+OabmuAR4Y0CdvyatgaaWaWsos1OmNosMZU7yV5O8h5j3TbtkLWUoy8tQpipyOQxp8TYB7wyocw+pU6YWMpTlZShT1awELgusZyhTU7yTFMxys0um1onar+zioOuRFuoq4va8nCZtRSPV3TjwGPn/vTwFrAq6JlWQnbK87JSpalwOQ1q87yfmh+xfJ61PJrXKCfL/xDMJjEVdkLRAP0tcl8wfStQUt5H/38sh4IyoC1I1tbFTtpk0rya3faR/aFKVOMlfWpxvB14WUOcj+INM67UxlEWtUbYnqI60GIYyaXHeF1BjCvhgQB1VXBtDmfPJ1GZXBtZ6ILCWlMO1xCwW++fAwwF1VHGGsnzslKlqtpE2I49iKFPdvZeYucG/FlBDNWAoy8dQpqq5Irje/cH1pFE6F3hrQJ0HgU8F1FENtDGUOadMbRUZyiaBRwLrSaP2k8SsGfZ/B9RQTbQxlDmnTG0VGcp24HpLqq9NwLsC6hwGPhpQRzVhKMvHTpmqJjKUOZ9MdfbjxGyp9AfA/oA6qglDWT6GMlVNZChzPpnqahXwU0G1/ntQHdVEG0OZc8rURiuA7YH17JSprn6ENMk/tztIOwVI3zBR+gQKcE6Z2ugiYHVgPUPZ4qwhrSF3Dum22WXA2aQlTDaSHpx4gfTwxK3ALcDJImfabOPELBYLdsk0hKEsHztlqpLo5TAMZfPbDLyNtNn1zSxu+7d9wF3AUeB45zi2iNcjPcfhIb+eXNaV1dePErPrxUHg9wPqqGbaGMrODKpjKFOVRIayZ7FTPJcNwE8D/4qlL+a7hbQnYy4nSeGtN8j1Hic6f+bUEl9P9ozR+/Fsr4OfGzynUYTITcAHRjDOQvwOaQNyqU/bQtl6YjYjB0OZqsUnL6vhJuDjxM7vW4qVnWNj6RNZoFPMHSKHhcpuuOt+/K2kXS8i/FZQHdVM20JZVJfsCK7RpGpxz8vyfpC0JlXEgqRtM0HqQG4ofSILdBepuzfVOSYHXmf7eHLg87Mdp+jvTp4a8rmTQz7u/rr3dvdR0i3tg6Tu3hHS1lNrSXPwDpHWJXx+pH9DLWUoy2N3UB1poeyUlfVm4GO073uuZjfeOZpiB/CXwFeBaVJo20/aaP1OUsjTPNr2DeKMoDovBNWRFmINcGFgPdco63ct8Ie07/ut2uVS4Cdm+b2jwP9H2lLqM2FnVENtW6fMTpna6HLS7YYodspmjAEfJnUNpLZaS3rK+NPA54Ebyp5OdbUtlNkpUxtFzic7Anw9sF7VfR/witInIVXIN5PW2ftnpU+kitoWyuyUqY0iQ9mDpPkkSt5T+gSkCloFfAh4d+kTqZq2hTI7ZWojJ/mXsY3UFZA03G8AnwV+gLjlqiqtbaHMTpnayOUwyngN7fseKy3GGGl9uD8kbSH2trKnU17bvmFEhTI7ZaqSyFDmk5czXlL6BKQauRD4CPA3xC3iWzltC2VRty/tlKkqtrH0rXyWwk7ZjAtKn4BUQ68HvkJ6arx12hbK7JSpbSLnk02RFopUsq70CUg1dSHwt8D5hc8jXNtCmZ0ytU3krcuduGp3L/8upKU7F/gELXsAoG2hzE6Z2sb5ZOW4F6C0PC8Hfqb0SURqUyibADYH1DlO2rxVqgKfvCzn6dInIDXAzwJnlz6JKG0KZa5RpjZyjbJyXERXWr71zL6nZuO0KZRtDarjfDJVxQRwWWA9Q1m/m/D7gTQKbyN2/95i2hTKnE+mtrmE2EmyzinrdzWwpvRJSA1wIfDS0icRoU2hzE6Z2iZyPtkL+LXfa4wUytaXPhGpIV5d+gQiGMpGzzcmVYWT/Mu5HNhY+iSkBtle+gQitCmUue+l2ubqwFoPBtaqg5eXPgGpYaIe1iuqTaHMTpna5qrAWg8F1qoDQ5k0WidLn0CENoWyqE7ZnqA60nwiO2WGsn6vKH0CUsPsKn0CEdoUyuyUqU1eRNwPIuDty17jpOUwJI3OnaVPIMJE6RMIFPUG9a+BHyP93Q4e46QFJXsPhnxu2O9PzXPM92dG8fuLOd/BY2qZr7ONPQWc6hyTPR93j5M9xyT9xkg/mAy+dn9YmevaBn9/vl9PD9SZ7ejWnyAtZ7GWtLF192vnOOlJxz2dP7+yc12Hgec6fx8Q2yWbAh4NrFd119KMzcinSF9b3X+DvV+7vR9LuZ0Cvlj6JCK0KZRFdcq+LaiONOg46SnIzxA7/2IncCKwXtVFrac0TXrC9iinh/puWOr+UDU58Drf57rhfiEGa4/3vI4P+XXvDx6Df36ukLeQHRIGr2nwda4fJnvP5TrgB4HXARfMUutp4MvAX5E6xd0fvJfy2v0hrPcY9rnZju5Y8/3dD/v1sGZB7w+Sqzp/BtL3lWOdemfN8veSwxeA/YH1imlTKIu8lSOVsJoUCKIXWXQ+Wb+ov/8ngIeDas2lt2vdFE8Cn+x8fA5piZMzSde4G9hBu/c2/Wbg84H1PhpYq6g2hbKoTpnUNoayfi8JqvNIUJ22e5p2B7Bhrg+s9Tjwe4H1imrLRP/VuLK2lIuhrN8lQXUMZSrlhsBav0qamtEKbQlldsmkfAxlM8aAi4JqVeHWpdopMpR9JrBWcYYySctlKJtxLmlidIR7gupIvcaJu0V/ELg7qFYltCWURT4lIrXJMdKcDyVRXTJo2ZuVKuMqYE1QrS9z+lJGjWYok7Qcj9Csp+6W67ygOs8CTwXVknpFPt3dirXJehnKJC2Hty77RYWyLwfVkQZFhrIvBdaqhLaEMueUSXkYyvoZytR0kYsj3xpUqzLaEsrslEl5GMr6Rc0p+7ugOtKgqCcvHwT2BtWqDEOZpOUwlPW7PKDGMeArAXWkQWd3jgit7AYbyiQth2tl9dseUONWWrSYpirF+WSZtSWUOadMGr0DwHOlT6JCXgxsCKjzuYAa0jCGsszaEsrslEmj563LflcF1TGUqZSo+WQHgHuDalWKoUzSUnnrst81ATWmaelcG1VCVKfsVlq6/mEbQtlqYm4pSG1jKOt3dUCNh0lbz0jRVgNXBtVq5a1LaEcocz6ZlIe3L/tFdMpuD6ghDXMtMBFUq3Ur+Xe1IZR561LKw05ZP0OZmixqPtk0cEtQrcoxlElaKkPZjDNIT1/mZihTKVHzyR6ghYvGdhnKJC3Fblr8jXOIqEn+dwbUkYaJ6pS1dj4ZtCOUnVn6BKQGcj5Zv4hQ9giwP6CONMz1QXUMZQ1nKJNGz1uX/SJC2R0BNaRhLga2BNUylDWcoUwaPUNZv2sDahjKVErUfLL9wH1BtSrJUCZpKbx92S+iU3ZPQA1pmKj5ZLeQ5k62VtSaIyUZyhZvCpjsvE4v83W235sETvUcJwd+PdlzDlNDPp4c+Lj3OAmcGHjtftx7TnMdDLx2j97zGDyv6SFjD/v8sPoAY51jvHNMAGuB9cDKzp/bQ5pkv6fz30x0ru1NwK8Tx07ZjM3AeQF1DGUqJapT1upbl2AoG6X/i3R7oftmOk7qRPam/sE3++7H3Tf7YcdgQDk1x58d9t/2Boe5Qk73tdU/pdTY+cH1DGUzIrpke4EnAupIw0R1ylq/hZihbHT+BDcKVjlRm2EDPAkcCqxXdRHzyb4WUEMaZhNpon9u7uuKc8pGyTWbVFJkKHswsFYdRISyuwNqSMPcQJpWkdsDwL6AOpVmKBudPfP/ESmLCeCywHpO8u/nJH812Y1BdVo/nwyaH8rWkXa2j2AoUymXETsVwU5Zv4hOmaFMpRjKAjU9lEV1yY4BR4NqSYMib12CoaxXxJOX0xjKVI6hLJChbDScT6aSDGXlbA+osQM4GFBHGrSamNvzrV80tstQNhreulRJVwbWOg7sCqxXdRGh7K6AGtIw1xEzNaL1i8Z2GcpGw1CmkiI7ZY+S1rNTYihTk90UVKf1S2F0GcpGw1CmklwOoxxDmZrM+WTBmh7KtgbVcU6ZStkGnBFYz1DWL2IpEkOZSokIZdOk25ei+aHMTpmaLnI+GbhG2aDcnbLduL2SyhgHrg+o8xA2Nr6h6aEsqlNmKFMpPnlZznrgnMw1vpp5fGk2V5LW+szNLlkPQ9lovBBURxpkKCvn0oAatwfUkIZ5WVAdQ1mPpocyb1+q6SJD2e7OoSQilPmGpVKinry8NahOLTQ9lEV1ynyjUimRocz5ZP0iJvkbylRKRKfsGN6i79P0UBbVKTOUqYTVwMWB9R4IrFUHuTtlT+Ikf5WxgpgnL+8CTgbUqY2mhzI7ZWqy7cT+G3Y+Wb/cocwumUq5AtgQUOe2gBq10uRQth5YFVTLUKYSopfDsFPWL/ftS0OZSnE+WSFNDmVRXbKjnUOKFv3kpaFsxgry3zo2lKmUqCcvvxJUpzYMZctnl0ylRHbKTgE7AutV3SXk7cRP4q0dlRMRyg7glIjTNDmUOclfTRcZyh7FCbm9rsk8/n3A4cw1pGHGiJnkfxtpiyX1aHIoczV/NV1kKPMn2n65Q9mdmceXZrMd2BRQx1uXQxjKls9OmUrYBmwJrOd8sn5XZx7/jszjS7NxPllBhrLlM5SpBLdXKstQpqaKCmU+eTlEk0OZc8rUZC6HUVbOUDZNWlRTKiEilD0LPB5Qp3aaHMrslKnJDGXlvBjYmHH8HcDBjONLsxkjZo0yu2SzMJQtn6FMJUSGshfwgZZeF2Qe3y6ZSrkU2BxQx/lkszCULZ+hTCVEhjK7ZP3Oyzy+oUylOMm/sCaHMueUqalWkX/fxV5O8u93fubxneSvUgxlhTU5lLlOmZrqMmA8sJ6dsn7nZB7fNyyVEjGfbAc2M2bV1FC2AqxGP3AAACAASURBVDgjqJZfXIoWPcnfTlm/nF34XcDzGceX5hIRyvyhYw5NDWVbiLm2aeyUKZ5PXpaVM5R9IePY0lwuJGbaj09ezqGpoSxqPtk+YCqoltQVGcpOAo8F1quDnN9fPpdxbGkuEftdAtwSVKeWmhrKfPJSTRa9EfmpwHp1cG7GsT+bcWxpLjcE1DiFD7LMyVC2PIYylRC5xZLzyfqNkzZszmEX3ipWORGdsruBowF1astQtjyGMkU7i7jb82AoG3QpaUmSHP4i07jSQkR0yrx1OY+mhjLXKFNT+eRlWTm7lIYylXImcFFAHUPZPJoaylyjTE1lKCsr10bkJ4FPZxpbmk9Elwx88nJehrLlsVOmaIaysnJ1yh4AjmQaW5pPRCjbj3Mm52UoWx5DmaJFTvLfQ9qMXDMuyzTuPZnGlRYiYpL/V0hre2oOTQ1lzilTU0V2yuySne6STOPenWlcaSGc5F8RTQ1ldsrURBPk69QMYyjrtxI4L9PYd2YaV5rPGvLNlexlKFsAQ9nyGMoU6VJSMItiKOt3KXm+Z07jBGiVcx1p/b3c/BpfAEPZ8hjKFMlJ/mXlnOS/L9PY0nwi5pPtAp4NqFN7TQxlq4ANQbWeD6ojgaGstFx/1/KNK60EBGhzFuXC9TEUBY1yf8obhehWJFPXk4CjwTWq4OXZxrXNyyVZCirkCaGsqhbly4VoGiRoWwncCKwXh18W6ZxXQ5DpawArg+oYyhbIEPZ0hnKFM3lMMq5DNiWaez7M40rzedKYF3mGqeAOzLXaIwmhjLXKFMTnUnajDyKoazfqzKN+wxO8lc5Ebcu78apPgvWxFBmp0xN5CT/sm7ONK7z9lSS88kqxlC2dHbKFClyPhkYyga9ItO4uzKNKy2EK/lXjKFs6eyUKZKdsnLGSAts5vD1TONKC2GnrGIMZUtnKFOkyFB2AHg6sF7VXUy+tQ93ZhpXms+F5H+/3I8/4C1KE0PZGUF1vH2pSJGh7KHAWnXwkoxjO6dMpUTcuvwKaRsxLVATQ1nU05d2yhRlHDciL+najGP7d61SvHVZQU0MZVGdMkOZolxC2j4sikGhX66HLPYBBzONLc3HUFZBE6VPIAPXKVPTOMm/rFyhbAtpzs1J4BApoA17HXbsA/YCe3pe9wNTmc5VzWMoq6AmhjI7ZWoaQ1lZuZcjWUn6vrXc711TpGD2wizHblLQOzDL68ll1ld9nEma6J/TTuC5zDUap2mhbIJ8T0n1OgocCagjQewaZdM40b/XucCm0iexQCuYCXeXL+G/P8bcoa23gzfbx72vdu2qyy5ZRTUtlG0JqmOXTJEiO2WP45Yova4pfQKB1nSOF41ovCP0h7blHEdIX5fHRnRubWcoq6imhTJvXaqJ3Ii8nDaFslFb1znOHuGYU8zcqVjocXiRr20IfhGh7NaAGo3TtFBmp0xNs5nRvqnNx1DW7+rSJ6A+K4D1nSOXKRYf5rofd3/d7fAN3tI9nPG8FyN3KDsJ3J65RiM1LZTZKVPTRE/yfyC4XtXZKWufFaS5yTnmJ0+Rgtls8/CW8npqkeewDrhimdcxn6/Sjo7jyDUtlNkpU9P45GVZdso0SiuAjZ1jVI4zE9K68+6OdT4+0XMcJwXCDaQFqXP6cubxG8tQtjSGMkWxU1bOVkY36V3KZXXnOKv0ifQwlC1R01b09/almiYylB0GngysV3V2yaSlMZQtUdNCmZ0yNU3kGmUP4ebBvQxl0uI9Dzxa+iTqylC2NIYyRVgBbA+s563LfoYyafHski1D00KZty/VJBeRFvOM4iT/foYyafEMZcvQtFAWtRm5oUwRnORflqFMWjxD2TIYypbGUKYILodRzlryb9gsNc0U8JXSJ1FnhrLFO0ha80XKLTKUuRF5vyuAsdInIdXMvaT3SC2RoWzx7JIpSvRG5EcC61VddJdSagJvXS5Tk0LZOLApoI6hTFEig4HzyfoZyqTFM5QtU5NC2RnE3G7YHVBD2gCcF1jP+WT9DGXS4n2p9AnUXZNCWdQkf0OZIjjJvyxDmbQ4+7DjvmyGssUzlCmCy2GUZSiTFucLuCPIsjUplEVtxmooUwRDWTnnAxtLn4RUM58vfQJNYChbPEOZIlweWOsAbkTey0VjpcUzlI1Ak0LZ1qA6hjJFuCKwll2yfoYyaXGOAbeVPokmaFIos1OmJonslN0fWKsODGXS4tyCi6qPxETpExghQ5ma4mxi1tzrMpT1uybDmKeAXyRtQwNpQvQqYHXPsZ60FEr3dcPA51ZmOC9pFLx1OSKGssXbE1RH7RXZJQNvXw7K0Sn7KvD+ZY4xDqwh7cu5hhTkVpK+j68c8vGwY6Lz360F1vW8zvbxsM+tXuZ1qHkMZSPSpFDmnDI1ReR8MrBT1msr8KIM4351BGNMAoc7R0njpHC2npnAtn6W18HP9Xb+Zvu4Se9LbTCJi8aOTJO++CM6ZSdws1XlF9kpOwE8Gliv6q7LNO5dmcYtYZL0fTDX98JVDA9sG0hLlXSPTUM+HvY5O3t53YXviyNjKFscb10qQmSn7GHSm6ySl2QadxSdsrY40Tn2jmi8VQwPckv53DpitvOrk8+VPoEmaUooGyNmRX9vXSqCT16WkyuU3Z1pXM3vBOl79yi+f49xevdu2DHs93vn5q2d5eM6vic7n2yE6vgFMMwW0jyH3OyUKbcxYHtgPSf597s+w5i7SPsCqv6mgUOd49kM409w+kMWsz2MMXhbt/d1M+l9cQvpLlLO90dD2Qg1JZT55KWa4nzSN94odspmjJMnlDVpPpnyOsXo5+t9EviOEY7X60HghUxjt1JTFo81lKkpfPKynKtJHYhRuzfDmNJCrABelXF8n7ocMUPZ4hjKlFvkfLJp0k+6Sm7KNK7BV6VcQ7qVmcsXM47dSk0JZVFrlBnKlFtkp2wXcCSwXtW9LNO4hjKV8k2Zx7dTNmJNCWU5FnscZlSPaEuziQxlhoV+uTplPkyhUl6dcewjwH0Zx2+lpoQyb1+qKSJDmWFhxgrghgzjPkP5FfjVXjk7Zfcws5erRsRQtjiGMuW0ErgksJ6hbMYVpKUERs3dElTKVvL+kOdTxRkYyhbHUKacLiV2mRpD2Yxc2ysZylRKzluXAHdmHr+VmhLKnOivJrgyuJ6hbMa1mcb16VaVknuSv52yDJoSyqI6ZU70V06R88n2As8F1qu6azKN60RolfKajGNPkeaUacQMZQs3CewPqKP2iuyU2SXrZyhTk6wEXpFx/B24nE4WTQhlK4AzAursIy22KeXik5dl5Npv9BjOKVMZN5J3uza7ZJk0IZSdScx1OJ9MuV0VWMu5TjPOA9ZkGPdrpA67FC33fDJDWSZNCGVO8lcTnAlsC6z3cGCtqsu1tdUdmcaV5pNzPhkYyrJpQihzOQw1Qa45TbN5KLheleXqULpkgErJ3Sm7O/P4rWUoWzifvFROVwfWmsa5Tr1yLYdhp0wlXAycm3H8o8AjGcdvNUPZwtkpU06RnbInSN9YleT4uz+F3QSVkfvW5X24vVI2hrKFM5Qpp8hOmfPJZoyRZ8/L+0hPX0rRXpl5fH/YyKgJocyJ/mqCyE6Z88lmbCfPkjreulQpL888vpP8M2pCKHtRUB1DmXLZCFwQWM9O2YxcXQXXgVMJ46Q1ynKyU5ZRE0JZVKfMif7KJfrJS0PZjFyhzHXgVMK15F00FtzzMqsmhLIzg+rYKVMuuZ7+m41PTs14SaZxDWUqIfety8eB3ZlrtFoTQplzylR31wXWmiLtW6ckx36jk7jkiMrI8dBKL9fey8xQtnCGMuUS2Sl7HDgeWK/KNpBnPaedwIkM40rzeWnm8b11mVkTQlnEZuRgKFM+kZ0yb13OyLUBvLcuVUruUHZ75vFbr+6hbDMwEVDnAGkxSGnUziDv6tuDnOQ/I9eel/dnGleay8Wk98Scvpx5/Nareyhzkr/qzkn+5WzPNO6tmcaV5pK7S/YY8FzmGq1X91DmfDLVnaGsnFxLkdySaVxpLtdnHv9LmccX9Q9lUZ0yHwFWLq5RVk6OzsIzwK4M40rzyR3KvHUZoO6hzE6Z6i4ylLkcxoy15FkOw+2VVIqdsgYwlC2MoUy5RIayJ3CT7K7ryfOQkPsCqoR15JsjCXAU+GrG8dVR91DmRH/V2WZin7x0PtmMmzKNayhTCdeR9/38duBkxvHVUfdQFtUpc06ZcoieT2Yom/GyTOMaylRC7pX8vXUZpO6hzE6Z6uzq4HpO8p9xY4YxTwEPZBhXmo+hrCHqHsqcU6Y6s1NWxgR5liLZgdsrqYwcP2T0MpQFqXsos1OmOrNTVsZVwOoM47q9kkpYAbwk4/g7SUu9KEDdQ9mWoDrOKVMOkaFsCjtlXblu9XjrUiVcA6zPOL7rkwWqeyjLvc9Xl50yjdpa4KLAejuB44H1qizXek52ylTCzZnH99ZloLqHsqhOmaFMo3YFsf/+HgqsVXW5trayU6YSDGUNUudQthpYE1DnIOmpKmmUrgquZxdnRq5Qdm+mcaW5vDrj2MeAuzKOrwF1DmVRty6dT6Ycoif52ylLNgAXZhj3cWBfhnGluWwm7/cSF40NVudQdkZQHW9dKgc7ZWVcAYxlGNdFY1XCq8jz9dx1W8axNUSdQ5lrlKnOct1Cm42dsuTSTOMaylRC7vlkd2QeXwPqHMrOCqpjKNOorQKuDKx3lLQZufKFsrszjSvNJed8MoA7M4+vAXUOZduC6jinTKN2JbAysN4OYDqwXpVdkmlcb/Mo2hjp9mUux4D7M46vIeocys4PqmOnTKOWc/XtYVw0dsZlGcbcj7slKN6V5J1bfQ+uPBDOUDa/UF11B7RoezR4HpVtj3DmLdhJ1Lxcs8n89ZlAROlT2CJxoDXBNU6FFSnTdaQtgVZR/oaHO85VpD+/67oOcZ6fn+i5xjveZ0i/VQ37Jjs/P446bZh979bQXrc+3jPcbLnoFN78FgxUL/36P5+94moI8DhntfD2CkrZTV5lsP4SoYxpfnkDmWuT1ZAXUPZG4lbUqDKoWycNGl8LSnorCG98aztvK4HNvYcG0ihZDBETJGCSzdIdEPHqs6Y6zpj9h6rO2Ot7Py57rhweoDpPdZ1zrvNorsqhrLkavJ87RnKVELuUObDKwXUNZS9NbDWu4BXACc6R7eb0qsbTFaRwkrv0fu5bpemtyvU+zrXxyt7jonOa871aZRP9P83b18mL800rrd5FG0N+ZfVcZmXAuoYysaA7wys902dQ6qjSWBX6ZOoiFdmGHM/8FiGcaW53EDe9++dwIGM42sWdZzofxFxC8dKdfcMKZgpz+0elwxQCS/LPL63LgupayiTtDAuGpusBa7PMO4DGcaU5vPyzON/NfP4mkUdQ9mW0icg1YihLLmRPLd7nK+nEgxlDVXHUObkdmnhnix9AhVxQ6ZxDWWKto70JHFOLodRSB1D2bOlT0CqETtlSa5QtiPTuNJsbiDvskIH8Ou6mDqGsodKn4BUI4ayJNdyGL55KVqur+Wuu3CHimLqGMp242KY0kIZylJXIccuCruB5zOMK80lV9e369bM42sOdQxlAH9a+gSkmnANrTT/Zm2Gce/NMKY0n9ydslsyj6851DWU/c/SJyDVwGHgqdInUQG53sRcy0nRVpB/71xDWUF1DWX3YrdMms8dpH1N2y7H+mTgsgGKdznp6ctcngIezzi+5lHXUAbwPpyMKM3lb0ufQEVck2lcb18qWu75ZF/MPL7mUedQtgPXLJPm8uelT6AicoUyV/NXNENZw9U5lJ3qHJJOdx8+RQXpVs/FGcZ9AtibYVxpLrn3vPxS5vE1jzqHMkibLUs63a+UPoGKuJ483+dc8Vwl3JRx7OOkeagqqO6h7GulT0CqoAeBj5Q+iYrI1VnwyUtFuwjYmnH824ETGcfXAtQ9lH2m9AlIFTMFvANv7XflWg7jnkzjSrPJ2SUD55NVQt1D2R+XPgGpYv41fnPtdV2mcd1VRNFuzDz+VzKPrwWoeyjbAfxl6ZOQKuIDOJdsUK4nL3dmGleaTe6V/G/PPL5a4ibSrZppD4+WHgeBt6NB28jz97078iKkjp3k+x7ik8QVUfdOGaSnRX659ElIBUwDnyA9YfiRsqdSSZdnGve+TONKs9lCmuifi12yipgofQIj8u+BbwdeWfY0pFkdAJ7tHM91jueBF0idl93APuBVwBuB1wIrZxlrJ/C/gA/jqvJzuSTTuHdmGleaTa6twrqcT1YRTQllR4E3AZ8j3xwSNcsJ0ro8B4D9nWNv59hH2sz76JDjBHCSdMu8+9o9JnuOo8ChznGw82cX4svAB4E1wMuBS0mPwR8mrct3J+5Nt1C5QpmL8iqa88laoimhDFKn4XXAx4FvLXwuOt0RUgAa6zkmScGoG5COA8cGjuOdPzdNWu5huvPr3jB0jP4AdJAUsvZ1jv2kUNP731TdMeDvOoeWJlco+3KmcaXZ5A5lt2QeXwvUpFAGqZPwWuAXSBuW576+KYZ3SqZ6ju7nTjITQIYdJ4ccvePO9jr4uame8xvcG3S68zo5pP6xzusq0p6Ja5b8tzLcClIL/vkRjyvN5rIMYz6Py2EoXs5Q9jR23yujaaEMUuB4P/Ax4N8BP8Dsc3N6PQt8lDRf53DnODTLx0dY+O2ouvlRRh/I6Iz5TuC/ZBhbGubKDGO6BpyijZNvvT2wS6ZgZ5FWOP8ocBtpI+HngUeBTwG/BLyBhQW3Nvhz8j127bwFRdlEnq/hfxN5ERJwLXmX1Hlv3KVIWowx0vyrXP/4J4GNYVejNruZPF/DzldVtH9B3lD2qrhL0XyasE6ZRud8UochlxXAVRnHl7q+PcOYU6R1EaVIr8849hH8mq4UQ5l6nR9Q45yAGlKON7KHSHNLpSjj5PkBo+vLNHd+dC0ZytQr4tbi1oAaarfVwGsyjHt/hjGluVwFbM44/ucyjq0lMJSp1+ASGjk4p0y5vZI8TxA/mGFMaS4vyzy+a+5VjKFMvSLa2KsDaqjdck3GfzbTuNJsXpJ5/Icyj69FMpSpV8RK9zk6GFKvGzONuzvTuNJsLsw49gng6xnH1xIYytQrIpR5+1K55eouuBuFouUMZY+SlilShRjK1CsilOVcckOaIM/2SuBWNIr3ooxj35dxbC2RoUy9jgfUWBtQQ+11LmkZgRwMZYp2Rsaxb804tpbIUKZehwNqRHTj1F4XZBr3KeBAprGlYcbIuxzGZzKOrSVq4obkWrojATVcqFA5XZxpXFc910JNAGf2HJuADcB6YBWpkzvsmCDdSVhDCmNnka/r+zRpL2hVjKFMvSImfbokhnLKNZ/s9kzjqppWkoLRpp7XwaMbnLaR5n51j83ErPm4HH9M2vdSFWMoU7Sc7Xjp8kzjfjHTuMpngpnwtIX+7lX32Drkc2fQ/KV7frf0CWg4Q5l6rQqoYShTTjdkGPMUhrJo48wEqm6o2jzHMez314efdT08ANxS+iQ0nKFMvQxlqrO1wNUZxr0DNyJfiHFO7z51P94IrCMFpfU9H6/rOdZ2Ptedg6U8/p/SJ6DZGcrUK2K+l6FMuVxPnonRd2UYs6rW0j+Paq7XM+mfT3Um1Z9L1XaHgP9R+iQ0O0OZekV0yvwJWLnk2rz5/kzjjsoK0r+r7gT0jQv4uPfX3dt9m0gT3NVcnwX2lz4Jzc5Qpl4RT+NEBD+1002Zxn1gROOMk4JQ79ENR90lE3pv8Q3e6pvtc2uxQ6WFeab0CWhuhjL1ilgSw1CmXHJ1yqZJt0bHOscqUogaPDaSntwbPLZ0XtdlOj9podp0K76W/OlKvS4lbVKb0wlcq0yjNwYcxa8taS7X4p6XleY2S+oVsc2Sc1aUw3kYyKS53I2BrPIMZeoVsc3SGN421+jlWslfaooPlj4Bzc9Qpl4RoQz8utPoGcqk2T0I/E7pk9D8fHNUr0nSnK/c/LrTqF1Y+gSkijoOvIOY7+1aJt8cNehoQA0fMNGonVP6BKQKmgR+GLcJqw1DmQZFhDLnlGnUDGXS6d4N/O/SJ6GFM5RpkKFMdXRe6ROQKuZTwIdKn4QWx1CmQRHzDlxAVqN2bukTkCrkKPDPS5+EFs9QpkERq/qvCaihdtlY+gSkipgE/gnwcOkT0eIZyjRoKqCGoUyjdqr0CUgVcBT4IeCPS5+IlsZQpkERnbL1ATXULvtLn4BU2O3Aq4A/Kn0iWjpDmQZFdMq81aRRe6H0CUgFnAI+DfwA8ArgnrKno+XyKTgNilhDzFCmUbsfuKn0SUgjsAd4ovN6ADjYee0eu0k/hDxB2svyYJnTVA6GMg2KCGUbAmqoXR4ofQLSHE6RwtMe4KnO8XTPx08AT3aOiGWJVFGGMg2KuKVtKNOo3Vf6BNRIh0nzFff1HN1fHwAOdf7M4Gu3q7W/8xq1r7BqzlCmQXbKVEd/B0zjFl5KpkmdqX3AXvoDVTcoDb4Ofu4gMQ8+Sd9gKNMgQ5nq6DngC8A3lz4RjURvqBrsUPX+eu/A57ohbD8xDy1JI2UoUwlO9FcOH8JQVlXdW3p7gecHjhdIoXrwc649p9YxlGmQnTLV1e8DPw9cXvpE9A2XAF/HrpW0IIYyleDiscrhFPAe4K9Kn0jFHGXmtt6wo/t73SUYPgRcMYK6p4DHMZBJC2Yo06DpgBqrA2qonT4J/Arw06VPJINjzNza6772fryH0+dX7QNOLKLGuxhNIIP0vWQr6dakpAUwlGnQyYAaft0pp/cBFwPfW/g85nKEFKK63ao9nB64BoPX4cznNAa8d4TjrQTeBvziCMeUGs03Rw2KCGUrA2qovSaBf0i6DfdPM9bZDzwDPMvME3/d5RQGP95PfwhbTPcqyquA7SMe8y0YyqQFM5RpkJ0yNcEp4B2kZTJ+Gdi8hDFOAp8DdgA7O8djpFXXnwWOj+A8q+Q7M4z5SmAtrlIvSUvyGdJckJzHJ8OuRoKzgQ+Sbv8t5OuzO9n94gLnWtIXyfPv/ebIi5DqzI6FBkX89O/XnSI9C/wkabmM7wW+A7gBeDHpa/EZ0lOCd5CCySdpX2fnTFJXK4dzMo0rNY5vjhoUEcqcU6YSDgAf7Rzq993AeKax/fcuLVDE5tOqF0OZ1D5vzji2+5FKC2Qo06BjATVWBdSQtDBjwBsyjr8u49hSoxjKNMhOmdQu24EzMo6/lCdfpVYylGlQRKfMUCZVR64J/l2bMo8vNYahTIMiOmXevpSqI3coy/UAgdQ4hjINilhp3E6ZVB3XZB7fif7SAhnKNMhtlqR2uSzz+FXcUkqqJEOZBkWEMm9fStWwErgwc43dmceXGsNQpkERoWx1QA1J87uQ/HO+DGXSAhnKNMhOmdQeFwTUeCGghtQIhjINippT5teeVN75ATWeC6ghNYJvjBp0KqiO3TKpvIhQtiughtQIhjINinpSynllUnm5Q9lu4GDmGlJjGMo0KGLxWDCUSVWQO5Q9lnl8qVEMZRoUsc0SGMqkKsgdynZmHl9qFEOZBkWFsomgOpJmZ6dMqhBDmQZFhTL3w5PKWg1sy1zDUCYtgqFMgwxlUjucT/59KXdmHl9qFEOZBkWFMr/2pLIuCqixM6CG1Bi+MWqQnTKpHXLveQnweEANqTEMZRpkKJPaIXco2w8cylxDahRDmQYZyqR2yH370i6ZtEiGMg0ylEntkLtT9kTm8aXGMZRpUNSK/iuD6kgaLncos1MmLZKhTIOiOmVuSC6VlXvhWEOZtEiGMg06CUwF1LFTJpVzJrAucw1vX0qLZCjTMBG3MO2USeVcEFDDTpm0SIYyDRMRyuyUSeVEhDI7ZdIiGco0zHRADTtlUjm555OBnTJp0QxlGib3fnhgp0wqKXenbC9wOHMNqXEMZSol9yRjSbPL3Sn7eubxpUYylGmYiE7ZpoAakobLvUaZoUxaAkOZStlY+gSkFjOUSRVkKNMwEZ0yQ5lUxhjevpQqyVCmUgxlUhlnk/pZ0OZtASGMg0T8XXhnDKpjIg1ygxl0hIYyjRMxNeFnTKpjNzzycBQJi2JoUzDjAfUsFMmlZE7lJ0CnspcQ2okQ5mGsVMmNVfuUPYkMJW5htRIhjINYyiTmuuSzON761JaIkOZhvH2pdRcl2Ye31AmLZGhTIMi1igDO2VSKXbKpIoylGnQdFCd1eRfK0lSv7OADZlrGMqkJTKUaZioSbp2y6RYuW9dgqFMWjJDmYaZDKqT+yd2Sf1y37oEQ5m0ZIYyDXMqqM66oDqSkohO2ZMBNaRGMpRpmKhOmaFMinVZ5vGPAnsz15Aay1CmYaJC2dqgOpKS7ZnHdyV/aRkMZRomaqK/nTIplqFMqjBDmYaJWhbDUCbFWQucm7mGoUxaBkOZhjGUSc1zGfkXhzaUSctgKNMwhjKpeXLfugRDmbQshjINEzWnbGtQHUkxoeyZgBpSYxnKNOhc0lYsEf5+UB1JcGVAjecCakiNZSjToO8h7uviVcQFQKntrgqo8WxADamxDGUa9OrAWmPB9aQ2uzqghp0yaRkMZRoUMe+kV8QtFantXkT+OZzTwPOZa0iNZijToC3B9bYF15PaKOLW5V7i9s2VGslQpkFRWyx1rQ6uJ7WRty6lGjCUadALwfUOBdeT2iiiU+atS2mZDGUa9HBwvceC60ltdG1AjQMBNaRGM5Rp0C3B9W4Nrie10fUBNfYH1JAazVCmQX9N3Ir+TwL3BNWS2mob8OKAOnbKpGUylGnQk8Cng2p9hLh9NqW2emlQHUOZtEyGMg3zSwE1jgC/FlBHaruIW5dgKJOWzVCmYT5Juo2Z0wfwEXopgp0ySaq5i0iLQU5nOD4LjMdditRqXyXPv+PB421RFyRJbfQG4ASj/cb9EK7iL0VZw+j/Dc92fF/QNUlSa72FNP9rFN+0vwacF3v6Uqu9nphANg18Z9A1SVKrvYy0qOxyvmH/HrAp+sSllvsvxIWymdM/FgAAAb1JREFU1wRdkyS13lrg35MWiFzMN+p7gO+OP11JwO3EhbKbg65JktSxGXgX8H+Y/bbmM8DHSLczxsqcptR6F5AWgo4KZa+MuSypuSZKn4BqZz/w3zvHBHApcA5pQvFBYCfwVKmTk/QNbyb2h6LpwFpSIxnKtBynSE9TPlT6RCSdJrpztSa4ntQ4Lh4rSc10bXC9M4PrSY1jKJOkZtoaXO+M4HpS4xjKJKmZoh+ycZcOaZkMZZLUTNF7UR4Kric1jqFMkpppV3C9J4PrSY1jKJOkZro9sNYUaRs1SZIkDbiZuIVjbwm6JkmSpNoZAx4lJpT9y6BrkiRJqqX3kD+Q7QY2Rl2QJElSHa0CHiFvKHtP2NVIkiTV2LcAk+QJZJ/CB8YkSZIW7CcZfSC7Bzgr8iIkSZKa4OcYXSD7GrAt9vQlSZKa4x+RVvpfTiD7KE7slyRJWrYLgD8gLfi6mDD2CPAPCpyvJElSo10N/ArwGLMHsUPAJ0hhzA3HpczGSp+AJKm480khbSuwGtgP7ADuA04VPC9JkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJ5f3/1apdPd/iLYAAAAASUVORK5CYII=" style="height:20px;">
</td>
    </tr></thead>
<thead class="gt_col_headings" style="border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3;">
<tr>
<th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1" scope="col" id="" style="color: #262A33; background-color: #FFF1E5; font-size: 100%; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; text-align: left;" bgcolor="#FFF1E5" valign="bottom" align="left"></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="2" colspan="1" style="color: #262A33; background-color: #FFF1E5; font-size: 100%; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; text-transform: uppercase; font-weight: bold;" scope="col" id="soc<sup class=&quot;gt_footnote_marks&quot;>2</sup>" bgcolor="#FFF1E5" valign="bottom" align="right">soc<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">2</sup>
</th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="2" style="color: #262A33; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; text-align: center; font-weight: bold;" scope="colgroup" id="Year<sup class=&quot;gt_footnote_marks&quot;>1</sup>" bgcolor="#FFF1E5" align="center">
        <span class="gt_column_spanner" style="border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 5px; overflow-x: hidden; display: inline-block; width: 100%;">Year<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">1</sup></span>
      </th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="2" colspan="1" style="color: #262A33; background-color: #FFF1E5; font-size: 100%; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; text-transform: capitalize; font-weight: bold;" scope="col" id="change" bgcolor="#FFF1E5" valign="bottom" align="right">change</th>
    </tr>
<tr>
<th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" style="color: #262A33; background-color: #FFF1E5; font-size: 100%; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; text-transform: capitalize; font-weight: bold;" scope="col" id="2004" bgcolor="#FFF1E5" valign="bottom" align="right">2004</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" style="color: #262A33; background-color: #FFF1E5; font-size: 100%; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: bottom; padding-top: 5px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; text-transform: capitalize; font-weight: bold;" scope="col" id="2021" bgcolor="#FFF1E5" valign="bottom" align="right">2021</th>
    </tr>
</thead>
<tbody class="gt_table_body" style="border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3;">
<tr class="gt_group_heading_row">
<th colspan="5" class="gt_group_heading" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; color: #262A33; background-color: #FFF1E5; text-transform: inherit; vertical-align: middle; text-align: left; font-size: 14px; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" scope="colgroup" id="Risers<sup class=&quot;gt_footnote_marks&quot;>3</sup>" bgcolor="#FFF1E5" valign="middle" align="left">Risers<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">3</sup>
</th>
    </tr>
<tr class="gt_row_group_first">
<th id="stub_1_1" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Industrial cleaning process occupations</th>
<td headers="Risers stub_1_1 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">9132 </td>
<td headers="Risers stub_1_1 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">26,300</td>
<td headers="Risers stub_1_1 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">241,100</td>
<td headers="Risers stub_1_1 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #00994D; font-weight: bold;" valign="middle" align="right">+817%</td>
</tr>
<tr>
<th id="stub_1_2" scope="row" class="gt_row gt_left gt_stub gt_striped" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; background-color: #F2DFCE; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="left">Health professionals n.e.c.<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">4</sup>
</th>
<td headers="Risers stub_1_2 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">2219 </td>
<td headers="Risers stub_1_2 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">9,000</td>
<td headers="Risers stub_1_2 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">70,100</td>
<td headers="Risers stub_1_2 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #00994D; font-weight: bold;" valign="middle" bgcolor="#F2DFCE" align="right">+679%</td>
</tr>
<tr>
<th id="stub_1_3" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Police community support officers</th>
<td headers="Risers stub_1_3 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">3315 </td>
<td headers="Risers stub_1_3 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">2,100</td>
<td headers="Risers stub_1_3 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">13,900</td>
<td headers="Risers stub_1_3 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #00994D; font-weight: bold;" valign="middle" align="right">+562%</td>
</tr>
<tr>
<th id="stub_1_4" scope="row" class="gt_row gt_left gt_stub gt_striped" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; background-color: #F2DFCE; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="left">Business and financial project management professionals</th>
<td headers="Risers stub_1_4 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">2424 </td>
<td headers="Risers stub_1_4 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">58,300</td>
<td headers="Risers stub_1_4 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">350,000</td>
<td headers="Risers stub_1_4 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #00994D; font-weight: bold;" valign="middle" bgcolor="#F2DFCE" align="right">+500%</td>
</tr>
<tr>
<th id="stub_1_5" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Advertising and public relations directors</th>
<td headers="Risers stub_1_5 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">1134 </td>
<td headers="Risers stub_1_5 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">19,400</td>
<td headers="Risers stub_1_5 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">69,000</td>
<td headers="Risers stub_1_5 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #00994D; font-weight: bold;" valign="middle" align="right">+256%</td>
</tr>
<tr>
<th id="stub_1_6" scope="row" class="gt_row gt_left gt_stub gt_striped" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; background-color: #F2DFCE; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="left">IT business analysts, architects and systems designers</th>
<td headers="Risers stub_1_6 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">2135 </td>
<td headers="Risers stub_1_6 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">82,800</td>
<td headers="Risers stub_1_6 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">270,500</td>
<td headers="Risers stub_1_6 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #00994D; font-weight: bold;" valign="middle" bgcolor="#F2DFCE" align="right">+227%</td>
</tr>
<tr>
<th id="stub_1_7" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Aircraft maintenance and related trades</th>
<td headers="Risers stub_1_7 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">5235 </td>
<td headers="Risers stub_1_7 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">27,200</td>
<td headers="Risers stub_1_7 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">88,300</td>
<td headers="Risers stub_1_7 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #00994D; font-weight: bold;" valign="middle" align="right">+225%</td>
</tr>
<tr>
<th id="stub_1_8" scope="row" class="gt_row gt_left gt_stub gt_striped" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; background-color: #F2DFCE; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="left">Quality assurance and regulatory professionals</th>
<td headers="Risers stub_1_8 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">2462 </td>
<td headers="Risers stub_1_8 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">43,700</td>
<td headers="Risers stub_1_8 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">138,000</td>
<td headers="Risers stub_1_8 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #00994D; font-weight: bold;" valign="middle" bgcolor="#F2DFCE" align="right">+216%</td>
</tr>
<tr>
<th id="stub_1_9" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Officers of non-governmental organisations</th>
<td headers="Risers stub_1_9 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">4114 </td>
<td headers="Risers stub_1_9 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">41,800</td>
<td headers="Risers stub_1_9 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">127,200</td>
<td headers="Risers stub_1_9 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #00994D; font-weight: bold;" valign="middle" align="right">+204%</td>
</tr>
<tr>
<th id="stub_1_10" scope="row" class="gt_row gt_left gt_stub gt_striped" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; background-color: #F2DFCE; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="left">Environment professionals</th>
<td headers="Risers stub_1_10 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">2142 </td>
<td headers="Risers stub_1_10 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">17,500</td>
<td headers="Risers stub_1_10 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">52,100</td>
<td headers="Risers stub_1_10 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #00994D; font-weight: bold;" valign="middle" bgcolor="#F2DFCE" align="right">+198%</td>
</tr>
<tr class="gt_group_heading_row">
<th colspan="5" class="gt_group_heading" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; color: #262A33; background-color: #FFF1E5; text-transform: inherit; vertical-align: middle; text-align: left; font-size: 14px; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" scope="colgroup" id="Fallers<sup class=&quot;gt_footnote_marks&quot;>3</sup>" bgcolor="#FFF1E5" valign="middle" align="left">Fallers<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">3</sup>
</th>
    </tr>
<tr class="gt_row_group_first">
<th id="stub_1_11" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Sheet metal workers</th>
<td headers="Fallers stub_1_11 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">5213 </td>
<td headers="Fallers stub_1_11 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">29,100</td>
<td headers="Fallers stub_1_11 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">10,900</td>
<td headers="Fallers stub_1_11 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #C00000; font-weight: bold;" valign="middle" align="right">−63%</td>
</tr>
<tr>
<th id="stub_1_12" scope="row" class="gt_row gt_left gt_stub gt_striped" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; background-color: #F2DFCE; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="left">Process operatives n.e.c.<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">4</sup>
</th>
<td headers="Fallers stub_1_12 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">8119 </td>
<td headers="Fallers stub_1_12 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">22,200</td>
<td headers="Fallers stub_1_12 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">8,200</td>
<td headers="Fallers stub_1_12 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #C00000; font-weight: bold;" valign="middle" bgcolor="#F2DFCE" align="right">−63%</td>
</tr>
<tr>
<th id="stub_1_13" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Footwear and leather working trades</th>
<td headers="Fallers stub_1_13 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">5413 </td>
<td headers="Fallers stub_1_13 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">13,000</td>
<td headers="Fallers stub_1_13 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">4,800</td>
<td headers="Fallers stub_1_13 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #C00000; font-weight: bold;" valign="middle" align="right">−63%</td>
</tr>
<tr>
<th id="stub_1_14" scope="row" class="gt_row gt_left gt_stub gt_striped" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; background-color: #F2DFCE; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="left">Printing machine assistants</th>
<td headers="Fallers stub_1_14 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">8127 </td>
<td headers="Fallers stub_1_14 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">22,600</td>
<td headers="Fallers stub_1_14 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">8,100</td>
<td headers="Fallers stub_1_14 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #C00000; font-weight: bold;" valign="middle" bgcolor="#F2DFCE" align="right">−64%</td>
</tr>
<tr>
<th id="stub_1_15" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Assemblers (electrical and electronic products)</th>
<td headers="Fallers stub_1_15 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">8131 </td>
<td headers="Fallers stub_1_15 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">63,200</td>
<td headers="Fallers stub_1_15 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">20,700</td>
<td headers="Fallers stub_1_15 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #C00000; font-weight: bold;" valign="middle" align="right">−67%</td>
</tr>
<tr>
<th id="stub_1_16" scope="row" class="gt_row gt_left gt_stub gt_striped" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; background-color: #F2DFCE; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="left">Printers</th>
<td headers="Fallers stub_1_16 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">5422 </td>
<td headers="Fallers stub_1_16 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">63,600</td>
<td headers="Fallers stub_1_16 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">8,900</td>
<td headers="Fallers stub_1_16 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000; color: #C00000; font-weight: bold;" valign="middle" bgcolor="#F2DFCE" align="right">−86%</td>
</tr>
<tr>
<th id="stub_1_17" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Chartered architectural technologists</th>
<td headers="Fallers stub_1_17 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">2435 </td>
<td headers="Fallers stub_1_17 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">2,400</td>
<td headers="Fallers stub_1_17 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
<td headers="Fallers stub_1_17 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
</tr>
<tr>
<th id="stub_1_18" scope="row" class="gt_row gt_left gt_stub gt_striped" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; background-color: #F2DFCE; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="left">Moulders, core makers and die casters</th>
<td headers="Fallers stub_1_18 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">5212 </td>
<td headers="Fallers stub_1_18 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">3,900</td>
<td headers="Fallers stub_1_18 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
<td headers="Fallers stub_1_18 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
</tr>
<tr>
<th id="stub_1_19" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Air-conditioning and refrigeration engineers</th>
<td headers="Fallers stub_1_19 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">5225 </td>
<td headers="Fallers stub_1_19 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">19,400</td>
<td headers="Fallers stub_1_19 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
<td headers="Fallers stub_1_19 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
</tr>
<tr>
<th id="stub_1_20" scope="row" class="gt_row gt_left gt_stub gt_striped" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; background-color: #F2DFCE; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="left">Pre-press technicians</th>
<td headers="Fallers stub_1_20 soc" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">5421 </td>
<td headers="Fallers stub_1_20 2004" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">8,600</td>
<td headers="Fallers stub_1_20 2021" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
<td headers="Fallers stub_1_20 change" class="gt_row gt_right gt_striped" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #F2DFCE; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#F2DFCE" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
</tr>
<tr>
<th id="stub_1_21" scope="row" class="gt_row gt_left gt_stub" style="padding-top: 8px; padding-bottom: 8px; margin: 10px; vertical-align: middle; overflow-x: hidden; background-color: #FFF1E5; font-size: 100%; text-transform: inherit; padding-left: 5px; padding-right: 5px; text-align: left; color: #800D33; font-weight: bold; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" bgcolor="#FFF1E5" align="left">Coal mine operatives</th>
<td headers="Fallers stub_1_21 soc" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">8122 </td>
<td headers="Fallers stub_1_21 2004" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">2,600</td>
<td headers="Fallers stub_1_21 2021" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
<td headers="Fallers stub_1_21 change" class="gt_row gt_right" style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; vertical-align: middle; overflow-x: hidden; text-align: right; font-variant-numeric: tabular-nums; border-left-width: 1px; border-left-style: hidden; border-left-color: #000000; border-right-width: 1px; border-right-style: hidden; border-right-color: #000000; border-top-width: 1px; border-top-style: hidden; border-top-color: #000000; border-bottom-width: 1px; border-bottom-style: hidden; border-bottom-color: #000000;" valign="middle" align="right">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup>&nbsp;—</td>
</tr>
</tbody>
<tfoot class="gt_sourcenotes" style="color: #262A33; background-color: #FFF1E5; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3;" bgcolor="#FFF1E5"><tr>
<td class="gt_sourcenote" style="padding-top: 4px; padding-bottom: 4px; padding-left: 5px; padding-right: 5px; color: #666666; font-size: 9px;" colspan="5">Source: Office for National Statistics (ONS)</td>
    </tr></tfoot>
<tfoot class="gt_footnotes" style="color: #262A33; background-color: #FFF1E5; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3;" bgcolor="#FFF1E5">
<tr>
<td class="gt_footnote" style="margin: 0px; padding-left: 4px; padding-right: 4px; padding-left: 5px; padding-right: 5px; color: #666666; font-size: 9px;" colspan="5">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">1</sup> Count of all persons</td>
    </tr>
<tr>
<td class="gt_footnote" style="margin: 0px; padding-left: 4px; padding-right: 4px; padding-left: 5px; padding-right: 5px; color: #666666; font-size: 9px;" colspan="5">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">2</sup> Standard Occupational Classification 2020</td>
    </tr>
<tr>
<td class="gt_footnote" style="margin: 0px; padding-left: 4px; padding-right: 4px; padding-left: 5px; padding-right: 5px; color: #666666; font-size: 9px;" colspan="5">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">3</sup> Top &amp; bottom 10 occupations ordered by percent change</td>
    </tr>
<tr>
<td class="gt_footnote" style="margin: 0px; padding-left: 4px; padding-right: 4px; padding-left: 5px; padding-right: 5px; color: #666666; font-size: 9px;" colspan="5">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">4</sup> Not elsewhere classified</td>
    </tr>
<tr>
<td class="gt_footnote" style="margin: 0px; padding-left: 4px; padding-right: 4px; padding-left: 5px; padding-right: 5px; color: #666666; font-size: 9px;" colspan="5">
<sup class="gt_footnote_marks" style="font-style: italic; font-weight: normal; font-size: 75%; vertical-align: 0.4em;">5</sup> Figures suppressed as statistically unreliable</td>
    </tr>
</tfoot>
</table>
</div>
</div>
</div>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box/">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 1%">
<col style="width: 98%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.character[1]; as.integer[1]; c[8]; is.na[1]; library[3]; list[5]</td>
</tr>
<tr class="even">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[1]; arrange[1]; desc[1]; if_else[1]; mutate[3]; n[2]; relocate[1]; row_number[1]; slice[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">forcats</td>
<td style="text-align: left;">fct_inorder[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[2]; annotate[1]; geom_col[1]; geom_label[1]; ggplot[1]; scale_fill_manual[1]; theme[1]; theme_bw[1]; theme_set[1]; theme_void[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gt</td>
<td style="text-align: left;">as_raw_html[2]; cell_borders[2]; cell_fill[1]; cell_text[9]; cells_body[4]; cells_column_labels[4]; cells_column_spanners[2]; cells_footnotes[1]; cells_row_groups[4]; cells_source_notes[1]; cells_stub[3]; cells_title[1]; fmt_number[1]; fmt_percent[1]; gt[2]; html[1]; local_image[1]; opt_stylize[1]; pct[1]; px[5]; sub_missing[1]; tab_footnote[5]; tab_header[2]; tab_options[2]; tab_source_note[1]; tab_spanner[1]; tab_style[10]; tab_style_body[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">list_rbind[1]; map[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">readxl</td>
<td style="text-align: left;">read_xlsx[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_remove[1]; str_starts[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">tibble[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">pivot_wider[1]; separate[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-gt" class="csl-entry">
Iannone, Richard, Joe Cheng, Barret Schloerke, Ellis Hughes, and JooYoung Seo. 2022. <span>“Gt: Easily Create Presentation-Ready Display Tables.”</span>
</div>
<div id="ref-ggplot2" class="csl-entry">
Wickham, Hadley. 2016. <span>“Ggplot2: Elegant Graphics for Data Analysis.”</span> <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>
<ol>
<li id="fn1"><p>Contains public sector information licensed under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">Open Government Licence v3.0</a>.↩︎</p></li>
</ol></section></div> ]]></description>
  <category>R</category>
  <category>tables</category>
  <guid>https://www.quantumjitter.com/project/footnote/index.html</guid>
  <pubDate>Tue, 01 Nov 2022 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/footnote/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Finding Happiness in The Smoke</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/happiness/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/happiness/feature.gif" class="img-fluid" alt="A silhouette of the Houses of Parliament in bright yellow below a blue sky. Smoke wafts into the sky from several points and the peace symbol takes the place of Big Ben's clock."></p>
<p><a href="https://www.theguardian.com/environment/2002/nov/30/uknews.pollution">The Smoke</a>, to use London’s nickname, has 32 boroughs plus the central business district known as the <a href="https://en.wikipedia.org/wiki/City_of_London">City of London</a>. What does Cluster Analysis tell us about the characteristics that bind them?</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/juliasilge/tidytext">tidytext</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidymodels/tidyclust">tidyclust</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/slowkow/ggrepel">ggrepel</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The graphics will use a custom palette created in <a href="https://color.adobe.com">Adobe Colour</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"#0AC449"</span>, <span class="st" style="color: #20794D;">"#CF4E0A"</span>, <span class="st" style="color: #20794D;">"#0057B7"</span>, <span class="st" style="color: #20794D;">"#FFD700"</span>, <span class="st" style="color: #20794D;">"#870AC4"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">5</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span>, <span class="va" style="color: #111111;">y</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span>, vjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"label"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span>,</span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Custom Pallette"</span>,</span>
<span>    fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span>,</span>
<span>    alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.8</span>,</span>
<span>    size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p><a href="https://data.london.gov.uk">The London Datastore</a> provides data profiling each area.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"london-borough-profiles.xlsx"</span>, sheet <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_starts.html">str_starts</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">code</span>, <span class="st" style="color: #20794D;">"E"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">where</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">is.character</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/na_if.html">na_if</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.</span>, <span class="st" style="color: #20794D;">"."</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    inner_outer_london <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">inner_outer_london</span>, <span class="st" style="color: #20794D;">" London"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<section id="dimensionality-reduction" class="level2"><h2 class="anchored" data-anchor-id="dimensionality-reduction">Dimensionality Reduction</h2>
<p>These data include 81 numeric variables quantifying such things as population density, happiness and age. Way too many variables to visualise two-dimensionally. <a href="https://en.wikipedia.org/wiki/Principal_component_analysis">Principal Components Analysis</a> can reduce the bulk of the information down to two variables. It is then possible to more easily visualise the relationships.</p>
<p>The City of London, aka “The Square Mile”, is quite distinct from the other 32 areas and has many NA values.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>na_count <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/deprec-context.html">cur_data</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">area_name</span>, <span class="va" style="color: #111111;">na_count</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">na_count</span> <span class="op" style="color: #5E5E5E;">!=</span> <span class="fl" style="color: #AD0000;">0</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">na_count</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">area_name</th>
<th style="text-align: right;">na_count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">City of London</td>
<td style="text-align: right;">27</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kensington and Chelsea</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Barnet</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Camden</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Hackney</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Haringey</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Harrow</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Islington</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Lewisham</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Merton</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Richmond upon Thames</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Waltham Forest</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Wandsworth</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Not surprisingly, the two-dimensional visualisation sets the City of London apart. And the other 32 are broadly, albeit with some mixing, divided into inner and outer London boroughs.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">pca_fit</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">where</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">is.numeric</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op" style="color: #5E5E5E;">(</span>scale <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">pca_augmented</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">pca_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">raw_df</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">pca_augmented</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.fittedPC1</span>, <span class="va" style="color: #111111;">.fittedPC2</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">inner_outer_london</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">area_name</span><span class="op" style="color: #5E5E5E;">)</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"inward"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"33 London Areas"</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"London"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Principal Component 1"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Principal Component 2"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.london.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/pca-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>After squeezing the many dimensions into two, how much of the original information was it possible to retain?</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">pca_tidied</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">pca_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op" style="color: #5E5E5E;">(</span>matrix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"eigenvalues"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">pct_explained</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">pca_tidied</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"cumulative"</span>, <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">pca_tidied</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">PC</span>, <span class="va" style="color: #111111;">percent</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">PC</span> <span class="op" style="color: #5E5E5E;">&lt;=</span> <span class="fl" style="color: #AD0000;">2</span>, <span class="cn" style="color: #8f5902;">TRUE</span>, <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.8</span>, show.legend <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"{percent(pct_explained, 0.1)} of the "</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Variance Explained by Principal Components 1 &amp; 2"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Principal Component"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/pc1 &amp; 2-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Whilst we do lose ease of interpretation by distilling the information in this way, it is still possible to understand which of the original variables influenced their two-dimensional positioning.</p>
<p>The axes depicted by the arrows below tell us that <strong>anxiety scores</strong> play a significant role in the placement of the City of London towards the upper-left. <strong>Average age</strong> pushes areas more towards the top. And <strong>happiness</strong> influences the bottom-right.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">pattern</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"_\\d{4}|_st.+|_score|_rates|^percent(_of)?_|"</span>,</span>
<span>        <span class="st" style="color: #20794D;">"^proportion_of_|^population(_of)?_|^number(_of)?_|"</span>, </span>
<span>        <span class="st" style="color: #20794D;">"_\\d{2}_out_of_\\d{2}|_estimate|_percent"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">pca_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op" style="color: #5E5E5E;">(</span>matrix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"rotation"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op" style="color: #5E5E5E;">(</span>names_from <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"PC"</span>, names_prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"PC"</span>, </span>
<span>              values_from <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"value"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>column <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">column</span>, <span class="va" style="color: #111111;">pattern</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">PC1</span>, <span class="va" style="color: #111111;">PC2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    xend <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0</span>, yend <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"grey70"</span>,</span>
<span>    arrow <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op" style="color: #5E5E5E;">(</span>ends <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"first"</span>, length <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">8</span>, <span class="st" style="color: #20794D;">"pt"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html">geom_text_repel</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">column</span><span class="op" style="color: #5E5E5E;">)</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"PC 1"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"PC 2"</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Characteristics Influencing Area Positioning"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.london.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>axis.text <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/interpretation-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>This may be validated by ranking all 33 areas by these three original variables.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">pca_long</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">pca_augmented</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">area_name</span>, <span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"happ|anx|average_age"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.</span>, <span class="st" style="color: #20794D;">"_.*"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"avg_age"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"average"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">area</span>, values_to <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"score"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>area <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tidytext/man/reorder_within.html">reorder_within</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">area</span>, <span class="va" style="color: #111111;">score</span>, <span class="va" style="color: #111111;">name</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> </span>
<span></span>
<span><span class="va" style="color: #111111;">pca_long</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">area</span>, <span class="va" style="color: #111111;">score</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">name</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op" style="color: #5E5E5E;">(</span>show.legend <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">name</span>, scales <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"free"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tidytext/man/reorder_within.html">scale_x_reordered</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.london.gov.uk"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/ranking-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</section><section id="cluster-modelling" class="level2"><h2 class="anchored" data-anchor-id="cluster-modelling">Cluster Modelling</h2>
<p>To collect these areas into their natural groupings, a decision is needed on the desired number of clusters. We can visualise dividing the areas into 1, 2, 3 and so forth clusters. And, per below, 3 appears to nicely capture the natural grouping of the coloured points.</p>
<div class="cell">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2022</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kclusts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span>k <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    kclust <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">k</span>, \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">k</span><span class="op" style="color: #5E5E5E;">)</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">pca_augmented</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.fittedPC1</span>, <span class="va" style="color: #111111;">.fittedPC2</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">k</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    tidied <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">kclust</span>, <span class="va" style="color: #111111;">tidy</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    glanced <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">kclust</span>, <span class="va" style="color: #111111;">glance</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    augmented <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">kclust</span>, <span class="va" style="color: #111111;">augment</span>, <span class="va" style="color: #111111;">pca_augmented</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">assignments</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">kclusts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op" style="color: #5E5E5E;">(</span>cols <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">augmented</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">clusters</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">kclusts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op" style="color: #5E5E5E;">(</span>cols <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">tidied</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">assignments</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.fittedPC1</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.fittedPC2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>color <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.cluster</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">k</span>, nrow <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">clusters</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span>, shape <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">13</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"How Many Clusters Best Captures the Groupings?"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"X Marks the Cluster Centre"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.london.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/kmeans-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The <a href="https://en.wikipedia.org/wiki/Elbow_method_(clustering)">elbow method</a> provides a more mathematical approach to the choice. The compactness of the clustering (as measured by the total within-cluster sum of squares) is significantly optimised when choosing 3 clusters, with diminishing returns thereafter.</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">kclusts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op" style="color: #5E5E5E;">(</span>cols <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">glanced</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">k</span>, <span class="va" style="color: #111111;">tot.withinss</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">k</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">3</span>, <span class="st" style="color: #20794D;">"Elbow"</span>, <span class="cn" style="color: #8f5902;">NA_character_</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    nudge_y <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">25</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Elbow Method"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Clusters"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Within-Cluster Variance"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/elbow-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>And settling on this choice of 3 clusters, we get this split.</p>
<div class="cell">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">assignments</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">k</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.fittedPC1</span>, <span class="va" style="color: #111111;">.fittedPC2</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.cluster</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">area_name</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>             size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"inward"</span>, overlap <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Closely-Related London Areas"</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cluster"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Principal Component 1"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Principal Component 2"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.london.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/final clusters-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</section><section id="using-tidymodels" class="level2"><h2 class="anchored" data-anchor-id="using-tidymodels">Using Tidymodels</h2>
<p>An alternative approach is to use the new <a href="https://github.com/EmilHvitfeldt/tidyclust">tidyclust</a><span class="citation" data-cites="tidyclust">(Hvitfeldt and Bodwin 2022)</span> package which augments the tidymodels framework with a tidy unified interface to clustering models.</p>
<p>First we tune the model with 1 to 6 clusters and review how well they capture the natural groupings.</p>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">kmeans_spec</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tidyclust/man/k_means.html">k_means</a></span><span class="op" style="color: #5E5E5E;">(</span>num_clusters <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"stats"</span>, algorithm <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Hartigan-Wong"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_rec</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">where</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">is.numeric</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">recipe</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">.</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">step_zv</span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">all_predictors</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">step_normalize</span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">all_predictors</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">step_pca</span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">all_predictors</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, threshold <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.9</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_wflow</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">workflow</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_model</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">kmeans_spec</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_recipe</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">kmeans_rec</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_cv</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">vfold_cv</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pca_augmented</span>, v <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_res</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tidyclust/man/tune_cluster.html">tune_cluster</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="va" style="color: #111111;">kmeans_wflow</span>,</span>
<span>  resamples <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">kmeans_cv</span>,</span>
<span>  grid <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/expand.html">crossing</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    num_clusters <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">6</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  control <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">control_grid</span><span class="op" style="color: #5E5E5E;">(</span>save_pred <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  metrics <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tidyclust/man/cluster_metric_set.html">cluster_metric_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sse_total</span>, <span class="va" style="color: #111111;">sse_ratio</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_metrics</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">kmeans_res</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;">collect_metrics</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_metrics</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.metric</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"sse_ratio"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">num_clusters</span>, <span class="va" style="color: #111111;">mean</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">num_clusters</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">3</span>, <span class="st" style="color: #20794D;">"Elbow"</span>, <span class="cn" style="color: #8f5902;">NA_character_</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>             nudge_y <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.1</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Elbow Method"</span>, x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Clusters"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"WSS"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/tidyclust tune-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Again we can visualise the 3 clusters suggested by the elbow method.</p>
<div class="cell">
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">kmeans_spec</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tidyclust/man/k_means.html">k_means</a></span><span class="op" style="color: #5E5E5E;">(</span>num_clusters <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"stats"</span>, algorithm <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Hartigan-Wong"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_wflow</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">kmeans_wflow</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">update_model</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">kmeans_spec</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_fit</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">kmeans_wflow</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pca_augmented</span><span class="op" style="color: #5E5E5E;">)</span> </span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_clust</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">kmeans_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tidyclust/man/extract_centroids.html">extract_centroids</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">".fitted"</span>, <span class="va" style="color: #111111;">.</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"PC"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_aug</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">kmeans_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pca_augmented</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">kmeans_aug</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>.pred_cluster <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.pred_cluster</span>, <span class="st" style="color: #20794D;">"Cluster_"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.fittedPC1</span>, <span class="va" style="color: #111111;">.fittedPC2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">area_name</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.pred_cluster</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>             size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"inward"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">kmeans_clust</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span>, shape <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">13</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Closely-Related London Areas"</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cluster"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"X Marks the Cluster Centre"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Principal Component 1"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Principal Component 2"</span>,</span>
<span>    colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cluster"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.london.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/tidyclust fit-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>How does this look with <a href="https://data.london.gov.uk/dataset/statistical-gis-boundary-files-london">geospatial data</a>? And how do the clusters relate to inner and outer London?</p>
<div class="cell">
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">shape_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"statistical-gis-boundaries-london/ESRI"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"London_Borough_Excluding_MHW"</span>,</span>
<span>    as_tibble <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, quiet <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">assignments</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>              <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">k</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span>, by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"GSS_CODE"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"code"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.cluster</span>, <span class="va" style="color: #111111;">inner_outer_london</span>, <span class="va" style="color: #111111;">NAME</span>, <span class="va" style="color: #111111;">geometry</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.cluster</span>, <span class="va" style="color: #111111;">inner_outer_london</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>value <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">value</span>, <span class="st" style="color: #20794D;">"1"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cluster 1"</span>, </span>
<span>                        <span class="st" style="color: #20794D;">"2"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cluster 2"</span>, <span class="st" style="color: #20794D;">"3"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cluster 3"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">shape_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>name <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">name</span>,</span>
<span>    <span class="st" style="color: #20794D;">".cluster"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"By Cluster"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"inner_outer_london"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"By Inner/Outer"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">value</span><span class="op" style="color: #5E5E5E;">)</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">NAME</span><span class="op" style="color: #5E5E5E;">)</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.7</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">4</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">name</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/happiness/index_files/figure-html/geospatial-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Not too dissimilar, but with some notable differences.</p>
<p>The City of London is a cluster apart in the heart of London. Kensington and Chelsea is an inner-London borough, but exhibits outer-London characteristics. And the reverse is true of the likes of Brent and Greenwich.</p>
<p>Dimensionality reduction is further explored in <a href="../../project/un">East-West Drift</a> coupled with animation.</p>
</section><section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 2%">
<col style="width: 97%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.character[8]; c[10]; is.character[1]; is.na[1]; is.numeric[2]; library[10]; mean[1]; seq[1]; set.seed[1]; sum[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[5]; across[1]; arrange[1]; cur_data[1]; desc[1]; if_else[3]; left_join[1]; mutate[8]; na_if[1]; recode[2]; rename[1]; rename_with[2]; rowwise[1]; select[6]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">forcats</td>
<td style="text-align: left;">fct_inorder[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[21]; annotate[1]; arrow[1]; coord_flip[2]; element_blank[1]; facet_wrap[3]; geom_col[2]; geom_label[6]; geom_line[2]; geom_point[6]; geom_segment[1]; geom_sf[1]; geom_sf_label[1]; ggplot[11]; labs[10]; scale_colour_manual[3]; scale_fill_manual[5]; scale_x_continuous[1]; scale_y_continuous[1]; theme[3]; theme_bw[1]; theme_minimal[1]; theme_set[1]; theme_void[2]; unit[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggrepel</td>
<td style="text-align: left;">geom_text_repel[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">janitor</td>
<td style="text-align: left;">clean_names[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">map[4]; pluck[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">readxl</td>
<td style="text-align: left;">read_xlsx[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">recipes</td>
<td style="text-align: left;">all_predictors[3]; recipe[1]; step_normalize[1]; step_pca[1]; step_zv[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rsample</td>
<td style="text-align: left;">vfold_cv[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">label_percent[1]; number[1]; percent[3]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sf</td>
<td style="text-align: left;">st_read[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">kmeans[1]; prcomp[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[2]; str_remove[3]; str_remove_all[1]; str_starts[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">tibble[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tidyclust</td>
<td style="text-align: left;">cluster_metric_set[1]; extract_centroids[1]; k_means[2]; sse_ratio[1]; tune_cluster[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">crossing[1]; pivot_longer[2]; pivot_wider[1]; population[1]; unnest[3]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tidytext</td>
<td style="text-align: left;">reorder_within[1]; scale_x_reordered[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tune</td>
<td style="text-align: left;">control_grid[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">workflows</td>
<td style="text-align: left;">add_model[1]; add_recipe[1]; update_model[1]; workflow[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-tidyclust" class="csl-entry">
Hvitfeldt, Emil, and Kelly Bodwin. 2022. <span>“Tidyclust: A Common API to Clustering.”</span> <a href="https://github.com/EmilHvitfeldt/tidyclust">https://github.com/EmilHvitfeldt/tidyclust</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>dimension reduction</category>
  <category>clustering</category>
  <category>geospatial</category>
  <category>machine learning</category>
  <guid>https://www.quantumjitter.com/project/happiness/index.html</guid>
  <pubDate>Sat, 19 Mar 2022 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/happiness/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Bootstraps &amp; Bandings</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/bands/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/bands/feature.jpg" class="img-fluid" alt="A boot with a strap leans against a pile of ribbon-rolls"></p>
<p>Are the residential property bands of <a href="https://www.gov.uk/guidance/understand-how-council-tax-bands-are-assessed#council-tax-bands-in-england-based-on-1-april-1991-values">3 decades ago</a> becoming less so? Would a sample of those recently-sold reveal band convergence? And what may be inferred about those not sampled?</p>
<p>Over the years, urban properties have been added to and divided up. And two streets of equal attractiveness, and with equivalently-banded properties, may have diverged as neighbourhoods evolved.</p>
<p>Whilst properties can and do move to higher or lower bands following alteration, would a sample of those recently-sold reveal band convergence after so long? And what may be inferred about the wider housing stock?</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span>, exclude <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"date_format"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">SPARQL</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">RColorBrewer</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://vctrs.r-lib.org/">vctrs</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidymodels/infer">infer</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tsibble.tidyverts.org">tsibble</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://ggfx.data-imaginist.com">ggfx</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Setting the theme and colour palette for all graphics (with a little help from the <a href="https://ggfx.data-imaginist.com">ggfx</a> package).</p>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">col</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"RdYlBu"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">scale_fill_continuous</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">...</span><span class="op" style="color: #5E5E5E;">)</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op" style="color: #5E5E5E;">(</span>palette <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">col</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">7</span>, <span class="va" style="color: #111111;">col</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">7</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span>, <span class="va" style="color: #111111;">y</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">fill</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggfx.data-imaginist.com/reference/as_reference.html">as_reference</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span>show.legend <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span>, id <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"cols"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggfx.data-imaginist.com/reference/with_blend.html">with_blend</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>,</span>
<span>      y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3.5</span>,</span>
<span>      label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">col</span>,</span>
<span>      size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">40</span>,</span>
<span>      fontface <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bold"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    bg_layer <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"cols"</span>,</span>
<span>    blend_type <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"atop"</span>,</span>
<span>    flip_order <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>    id <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"text"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggfx.data-imaginist.com/reference/with_outer_glow.html">with_outer_glow</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"text"</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html">scale_fill_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/bands/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p><a href="https://www.gov.uk/council-tax-bands">Property band</a> and <a href="https://landregistry.data.gov.uk/app/qonsole">price-paid</a> data are separately sourced. The free-form street address is the only way to bring the two together. The structure, content and even spelling of the address sometimes differ, for example: “FLAT C, 22 SOME STREET, SOME AREA, SW10 1AA” in one may be “22C 2ND FLR, HOUSE NAME, SOME STREET SW10 1AA” in the other.</p>
<p>So, a little string manipulation is needed to create a common key. And reusable patterns will enable a consistent application to both.</p>
<p><a href="https://en.wikipedia.org/wiki/Regular_expression">Regex</a> is used here to isolate pieces of text:</p>
<ul>
<li>
<code>, London, SW10 .+$</code> finds for example <code>,&nbsp;London,&nbsp;SW10&nbsp;0ST</code> and all other <code>SW10</code> postcodes. See the difference by comparing the data frame <code>band_df</code> ( before) with <code>band_df2</code> (after).</li>
<li>
<code>(1ST|2ND|3RD|4TH|5TH|6TH) FLR</code> does the same for floor numbers irrespective of whether it’s the 1ST or 2ND etc.</li>
<li>
<code>(?&lt;=COURT|WALK).*</code> uses a <a href="https://www.rexegg.com/regex-lookarounds.html">positive lookbehind</a> to find anything following the word <code>COURT</code> or <code>WALK</code> (since the postcode is stored in a separate variable and already isolates the road, the road name is redundant).</li>
<li>
<code>^([0-9]{1,3})([A-Z])(?= .*)</code> and <code>\\2 \\1</code> makes use of <a href="https://www.rexegg.com/regex-capture.html">capture groups</a> to temporarily memorise a number (capture group 1) followed by a letter (capture group 2), then swap them around. This is because a flat number may be <code>C22</code> in one dataset and <code>22C</code> in the other.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">remove_pattern</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">", London, SW10 .+$"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"FLAT "</span>,</span>
<span>    <span class="st" style="color: #20794D;">"APARTMENT "</span>,</span>
<span>    <span class="st" style="color: #20794D;">"CHELSEA HARBOUR"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"(?&lt;=COURT|SANDHILLS| HOUSE|WALK|ESTATE|ROW).*"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"[,'\\.]"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"(?&lt;= )AT "</span>,</span>
<span>    <span class="st" style="color: #20794D;">"(?&lt;=VINT)N"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"(?&lt;=FARRIER)S"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"(1ST|2ND|3RD|4TH|5TH|6TH) FLR "</span>,</span>
<span>    <span class="st" style="color: #20794D;">"FLR (1ST|2ND|3RD|4TH|5TH|6TH) "</span>,</span>
<span>    <span class="st" style="color: #20794D;">" ?- ?[0-9]{1,3}"</span>,</span>
<span>    sep <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"|"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">swizzle_from</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"^([0-9]{1,3})([A-Z])(?= .*)"</span> </span>
<span><span class="va" style="color: #111111;">swizzle_to</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"\\2 \\1"</span></span></code></pre></div>
</div>
<p>Council Tax band data are available for non-commercial use<sup>1</sup>.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">url1</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"https://www.tax.service.gov.uk/"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"check-council-tax-band/"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"search-council-tax-advanced?"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"postcode=Fkvms5WVQum-uX3L00_pcA&amp;"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"filters.councilTaxBands="</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">url2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"&amp;filters.propertyUse=N&amp;postcode=Fkvms5WVQum-uX3L00_pcA&amp;page="</span></span>
<span></span>
<span><span class="va" style="color: #111111;">url3</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"&amp;filters.bandStatus=Current"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">index</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/expand.html">crossing</a></span><span class="op" style="color: #5E5E5E;">(</span>band <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">LETTERS</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">8</span><span class="op" style="color: #5E5E5E;">]</span>, page <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">120</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">band_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">index</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">band</span>, <span class="va" style="color: #111111;">index</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">page</span>, <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/possibly.html">possibly</a></span><span class="op" style="color: #5E5E5E;">(</span>\<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">i</span>, <span class="va" style="color: #111111;">j</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url1</span>, <span class="va" style="color: #111111;">i</span>, <span class="va" style="color: #111111;">url2</span>, <span class="va" style="color: #111111;">j</span>, <span class="va" style="color: #111111;">url3</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_element.html">html_element</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"#search-results-table"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_table.html">html_table</a></span><span class="op" style="color: #5E5E5E;">(</span>convert <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span>, otherwise <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA_character_</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">band_df2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">band_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>postcode <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">address</span>, <span class="st" style="color: #20794D;">"SW10 .+$"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>         raw_band_address <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">address</span>, <span class="st" style="color: #20794D;">", London, SW10 .+$"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>         address <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">address</span>, <span class="va" style="color: #111111;">remove_pattern</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>         address <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">address</span>, <span class="va" style="color: #111111;">swizzle_from</span>, <span class="va" style="color: #111111;">swizzle_to</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>         address <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">address</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p><a href="https://www.gov.uk/guidance/about-the-price-paid-data#explanations-of-column-headers-in-the-ppd">House price-paid</a> data are similarly available for non-commercial use<sup>2</sup>.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">endpoint</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"https://landregistry.data.gov.uk/landregistry/query"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">query</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">'</span></span>
<span><span class="st" style="color: #20794D;">PREFIX  xsd:  &lt;http://www.w3.org/2001/XMLSchema#&gt;</span></span>
<span><span class="st" style="color: #20794D;">PREFIX  text: &lt;http://jena.apache.org/text#&gt;</span></span>
<span><span class="st" style="color: #20794D;">PREFIX  ppd:  &lt;http://landregistry.data.gov.uk/def/ppi/&gt;</span></span>
<span><span class="st" style="color: #20794D;">PREFIX  lrcommon: &lt;http://landregistry.data.gov.uk/def/common/&gt;</span></span>
<span><span class="st" style="color: #20794D;"></span></span>
<span><span class="st" style="color: #20794D;">SELECT  ?ppd_propertyAddress ?ppd_transactionCategory ?ppd_transactionDate ?ppd_pricePaid ?ppd_estateType ?ppd_propertyAddressCounty ?ppd_propertyAddressDistrict ?ppd_propertyAddressLocality ?ppd_propertyAddressPaon ?ppd_propertyAddressPostcode ?ppd_propertyAddressSaon ?ppd_propertyAddressStreet ?ppd_propertyAddressTown ?ppd_propertyType ?ppd_recordStatus</span></span>
<span><span class="st" style="color: #20794D;"></span></span>
<span><span class="st" style="color: #20794D;">WHERE</span></span>
<span><span class="st" style="color: #20794D;">  { { ?ppd_propertyAddress</span></span>
<span><span class="st" style="color: #20794D;">                text:query               ( lrcommon:postcode "( SW10 )" 3000000 ) .</span></span>
<span><span class="st" style="color: #20794D;">      ?item     ppd:propertyAddress      ?ppd_propertyAddress ;</span></span>
<span><span class="st" style="color: #20794D;">                ppd:transactionCategory  ppd:standardPricePaidTransaction ;</span></span>
<span><span class="st" style="color: #20794D;">                ppd:transactionDate      ?ppd_transactionDate ;</span></span>
<span><span class="st" style="color: #20794D;">                ppd:pricePaid            ?ppd_pricePaid ;</span></span>
<span><span class="st" style="color: #20794D;">      FILTER ( ?ppd_transactionDate &gt;= "2020-01-01"^^xsd:date )</span></span>
<span><span class="st" style="color: #20794D;">    }</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?item  ppd:estateType  ?ppd_estateType }</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?ppd_propertyAddress lrcommon:county  ?ppd_propertyAddressCounty}</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?ppd_propertyAddress lrcommon:district  ?ppd_propertyAddressDistrict}</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?ppd_propertyAddress lrcommon:locality  ?ppd_propertyAddressLocality}</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?ppd_propertyAddress lrcommon:paon  ?ppd_propertyAddressPaon}</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?ppd_propertyAddress lrcommon:postcode  ?ppd_propertyAddressPostcode}</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?ppd_propertyAddress lrcommon:saon  ?ppd_propertyAddressSaon}</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?ppd_propertyAddress lrcommon:street  ?ppd_propertyAddressStreet}</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?ppd_propertyAddress lrcommon:town  ?ppd_propertyAddressTown}</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?item  ppd:propertyType  ?ppd_propertyType }</span></span>
<span><span class="st" style="color: #20794D;">    OPTIONAL{ ?item  ppd:recordStatus  ?ppd_recordStatus }</span></span>
<span><span class="st" style="color: #20794D;">    BIND(ppd:standardPricePaidTransaction AS ?ppd_transactionCategory)</span></span>
<span><span class="st" style="color: #20794D;">  }'</span></span>
<span></span>
<span><span class="va" style="color: #111111;">prices_list</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/SPARQL/man/SPARQL.html">SPARQL</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">endpoint</span>, <span class="va" style="color: #111111;">query</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">prices_df2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">prices_list</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">results</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.</span>, <span class="st" style="color: #20794D;">"ppd_|property_address_"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    transaction_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://vctrs.r-lib.org/reference/new_date.html">new_datetime</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">transaction_date</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/as_date.html">as_date</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    price_paid <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">price_paid</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">1000000</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">transaction_date</span> <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="st" style="color: #20794D;">"2022-01-01"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    raw_price_address <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace_na.html">str_replace_na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">saon</span>, <span class="st" style="color: #20794D;">""</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>                              <span class="va" style="color: #111111;">paon</span>, <span class="va" style="color: #111111;">street</span>, sep <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">" "</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    address <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">raw_price_address</span>, <span class="va" style="color: #111111;">remove_pattern</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    address <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">address</span>, <span class="va" style="color: #111111;">swizzle_from</span>, <span class="va" style="color: #111111;">swizzle_to</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="va" style="color: #111111;">address</span>,</span>
<span>    <span class="va" style="color: #111111;">raw_price_address</span>,</span>
<span>    <span class="va" style="color: #111111;">postcode</span>,</span>
<span>    <span class="va" style="color: #111111;">price_paid</span>,</span>
<span>    <span class="va" style="color: #111111;">transaction_date</span>,</span>
<span>    <span class="va" style="color: #111111;">estate_type</span>,</span>
<span>    <span class="va" style="color: #111111;">property_type</span>,</span>
<span>    <span class="va" style="color: #111111;">transaction_category</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Now there’s a common key to join the data.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">joined_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">prices_df2</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">band_df2</span>, by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"address"</span>, <span class="st" style="color: #20794D;">"postcode"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">raw_band_address</span>, .after <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">raw_price_address</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">postcode</span>, <span class="va" style="color: #111111;">address</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>council_tax_band <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">council_tax_band</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>As with previous posts <a href="https://www.quantumjitter.com/project/planning/">Digging Deep</a> and <a href="https://www.quantumjitter.com/project/sw10/">House Sales</a>, I’m focusing on postcodes in the SW10 part of London.</p>
<p>It’s not possible to assess all SW10 properties by band since only a tiny fraction will have been sold recently. Recent sales could though be used as a sample and <a href="https://en.wikipedia.org/wiki/Bootstrapping_(statistics)">Bootstrap Confidence Intervals</a> then employed to draw a wider inference.</p>
<p><a href="https://www.huffingtonpost.co.uk/entry/pull-yourself-up-by-your-bootstraps-nonsense_n_5b1ed024e4b0bbb7a0e037d4">“Pulling yourself up by your bootstraps”</a> originally meant doing something absurd. Later it came to mean succeeding with only what you have at your disposal. Hence only the sample will be used as a surrogate for the true population by making repeated random draws from it (with replacement).</p>
<p>A key assumption is that the sample is representative of the true population.</p>
<p>Even though only recent sales transactions have been selected, a small movement in market prices will have occurred. So ensuring the bands are reasonably well distributed over the period is worthwhile.</p>
<div class="cell">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">joined_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">transaction_date</span>, <span class="va" style="color: #111111;">price_paid</span>, <span class="va" style="color: #111111;">council_tax_band</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>yearquarter <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://tsibble.tidyverts.org/reference/year-quarter.html">yearquarter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">transaction_date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">yearquarter</span>, <span class="va" style="color: #111111;">council_tax_band</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">yearquarter</span>, <span class="va" style="color: #111111;">n</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">council_tax_band</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span>position <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/position_stack.html">position_fill</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tsibble.tidyverts.org/reference/tsibble-scales.html">scale_x_yearquarter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">7</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Distribution of Sales Transactions by Band &amp; Quarter"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Quarter"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Proportion"</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Band"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/bands/index_files/figure-html/distribution-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>A violin plot of the property values by band shows some bimodal distribution and oddly shows bands E &amp; F with lower mean prices than band D. This is worth closer inspection to ensure the sample is representative.</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">labels</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">joined_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, mean_price <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">price_paid</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">council_tax_band</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">transactions</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">joined_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">from</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">joined_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">transaction_date</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://tsibble.tidyverts.org/reference/year-quarter.html">yearquarter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">to</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">joined_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">transaction_date</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://tsibble.tidyverts.org/reference/year-quarter.html">yearquarter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">joined_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">council_tax_band</span>, <span class="va" style="color: #111111;">price_paid</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"n = {n} \nAvg Price "</span>,</span>
<span>    <span class="st" style="color: #20794D;">"{dollar(mean_price, prefix = '£', suffix = 'm', accuracy = 0.01)}"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">16</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">labels</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2.3</span>, alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.7</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>,</span>
<span>    suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span>, accuracy <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.1</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Droopy Bandings"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"Sample of {transactions} Property "</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Transactions in SW10 ({from} to {to})"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Council Tax Band"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Sale Price (log10 scale)"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Sources: tax.service.gov.uk &amp; landregistry.data.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/bands/index_files/figure-html/visualise-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">joined_df2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">joined_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>`SW10 0JR` <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">postcode</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"SW10 0JR"</span>, <span class="st" style="color: #20794D;">"Yes"</span>, <span class="st" style="color: #20794D;">"No"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>It turns out that the unusual transactions below £0.3m are almost entirely from one postcode as shown below when isolating “SW10 0JR”. This appears to be a single large new development with all sub-units sold in 2020.</p>
<p>These specific transactions feel somewhat unusual at these banding levels. And irrespective of their accuracy, a sample of 169 postcodes heavily dominated by the transactions of just one would not be representative of the true population.</p>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">joined_df2</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">council_tax_band</span>, <span class="va" style="color: #111111;">price_paid</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">`SW10 0JR`</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"n = {n} \nAvg Price\n"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"{dollar(mean_price, prefix = '£', suffix = 'm', accuracy = 0.01)}"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">16</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">labels</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2.3</span>, alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.7</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op" style="color: #5E5E5E;">(</span>yintercept <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.3</span>, linetype <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"dashed"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>,</span>
<span>    suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span>, accuracy <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.1</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Unusual Bandings"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"Sample of {transactions} Property "</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Transactions in SW10 ({from} to {to})"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Council Tax Band"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Sale Price (log10 scale)"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Sources: tax.service.gov.uk &amp; landregistry.data.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/bands/index_files/figure-html/anomaly-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">joined_df2</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">postcode</span>, sort <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">postcode</th>
<th style="text-align: right;">n</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">SW10 0JR</td>
<td style="text-align: right;">79</td>
</tr>
<tr class="even">
<td style="text-align: left;">SW10 0HQ</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SW10 0AA</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: left;">SW10 0HG</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SW10 9AD</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: left;">SW10 9JP</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SW10 0DD</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">SW10 0UY</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SW10 9BT</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">SW10 9JR</td>
<td style="text-align: right;">5</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>So, I’ll remove this postcode.</p>
<div class="cell">
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">joined_df3</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">joined_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">postcode</span> <span class="op" style="color: #5E5E5E;">!=</span> <span class="st" style="color: #20794D;">"SW10 0JR"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>This now feels like a representative sample of 312 property transactions. And broadly-speaking the plot shows a progression in average property values as we step through the bands. There is though substantial convergence between some, with the “drippy” band E still looking almost indistinguishable from band D.</p>
<div class="cell">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">labels</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">joined_df3</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, mean_price <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">price_paid</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">council_tax_band</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">transactions</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">joined_df3</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">joined_df3</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">council_tax_band</span>, <span class="va" style="color: #111111;">price_paid</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"n = {n} \nAvg Price "</span>,</span>
<span>    <span class="st" style="color: #20794D;">"{dollar(mean_price, prefix = '£', suffix = 'm', accuracy = 0.01)}"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">16</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">labels</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2.3</span>, alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.7</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span>prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>, </span>
<span>                                       suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span>, accuracy <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Drippy Bandings"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"Sample of {transactions} Property "</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Transactions in SW10 ({from} to {to})"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Council Tax Band"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Sale Price (log10 scale)"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Sources: tax.service.gov.uk &amp; landregistry.data.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/bands/index_files/figure-html/drippy-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Can we infer that the true population of band Es no longer exhibits any difference in mean values with respect to band D?</p>
<div class="cell">
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">bands_ef</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">joined_df3</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">council_tax_band</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"E"</span>, <span class="st" style="color: #20794D;">"D"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">obs_stat</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">bands_ef</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://infer.tidymodels.org/reference/specify.html">specify</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">price_paid</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">council_tax_band</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://infer.tidymodels.org/reference/calculate.html">calculate</a></span><span class="op" style="color: #5E5E5E;">(</span>stat <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"diff in means"</span>, order <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"E"</span>, <span class="st" style="color: #20794D;">"D"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">boot_dist</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">bands_ef</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://infer.tidymodels.org/reference/specify.html">specify</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">price_paid</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">council_tax_band</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://infer.tidymodels.org/reference/generate.html">generate</a></span><span class="op" style="color: #5E5E5E;">(</span>reps <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2000</span>, type <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bootstrap"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://infer.tidymodels.org/reference/calculate.html">calculate</a></span><span class="op" style="color: #5E5E5E;">(</span>stat <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"diff in means"</span>, order <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"E"</span>, <span class="st" style="color: #20794D;">"D"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">perc_ci</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://infer.tidymodels.org/reference/get_confidence_interval.html">get_ci</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">boot_dist</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">lower</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">perc_ci</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">lower_ci</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/dollar_format.html">dollar</a></span><span class="op" style="color: #5E5E5E;">(</span>prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>, suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span>, accuracy <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.01</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">upper</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">perc_ci</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">upper_ci</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/dollar_format.html">dollar</a></span><span class="op" style="color: #5E5E5E;">(</span>prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>, suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span>, accuracy <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.01</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">boot_dist</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://infer.tidymodels.org/reference/visualize.html">visualise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://infer.tidymodels.org/reference/shade_confidence_interval.html">shade_confidence_interval</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    endpoints <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">perc_ci</span>,</span>
<span>    color <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">]</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">]</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op" style="color: #5E5E5E;">(</span>xintercept <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">obs_stat</span>, linetype <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"dashed"</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"label"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.12</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">350</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>,</span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"Observed Difference\nBetween Bands D &amp; E is "</span>,</span>
<span>      <span class="st" style="color: #20794D;">"{dollar(obs_stat, prefix = '£', suffix = 'm', accuracy = 0.01)}"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>,</span>
<span>    suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span>, accuracy <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.1</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"95% Confident the Difference "</span>,</span>
<span>      <span class="st" style="color: #20794D;">"in Mean Prices Between Bands D &amp; E is {lower} to {upper}"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Difference in Means"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Count"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Sources: tax.service.gov.uk &amp; landregistry.data.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/bands/index_files/figure-html/infer-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Bootstrapping with a 95% confidence interval suggests the true difference in mean prices between all band D and E properties in SW10 is somewhere in the range -£0.10m to £0.10m. Considerable convergence compared to <a href="https://www.gov.uk/guidance/understand-how-council-tax-bands-are-assessed#council-tax-bands-in-england-based-on-1-april-1991-values">3 decades ago</a> when the band E minimum exceeded the band D maximum.</p>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 3%">
<col style="width: 96%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">RColorBrewer</td>
<td style="text-align: left;">brewer.pal[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">SPARQL</td>
<td style="text-align: left;">SPARQL[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">c[6]; factor[1]; library[12]; max[1]; mean[2]; min[1]; readRDS[1]; saveRDS[1]; scale[3]; seq[1]; set.seed[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">as_date[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[4]; across[1]; arrange[1]; count[4]; if_else[1]; inner_join[1]; mutate[7]; n[2]; pull[7]; relocate[1]; rename_with[1]; select[4]; slice_head[1]; slice_sample[1]; summarise[4]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggfx</td>
<td style="text-align: left;">as_reference[1]; with_blend[1]; with_outer_glow[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[8]; annotate[1]; coord_flip[1]; geom_col[2]; geom_hline[1]; geom_label[3]; geom_text[1]; geom_violin[3]; geom_vline[1]; ggplot[5]; labs[5]; position_fill[1]; scale_fill_distiller[1]; scale_fill_manual[2]; scale_x_continuous[1]; scale_y_continuous[1]; scale_y_log10[3]; theme_bw[1]; theme_set[1]; theme_void[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[9]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">infer</td>
<td style="text-align: left;">calculate[2]; generate[1]; get_ci[1]; shade_confidence_interval[1]; specify[2]; visualise[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">janitor</td>
<td style="text-align: left;">clean_names[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">list_rbind[1]; map2[1]; possibly[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">rvest</td>
<td style="text-align: left;">html_element[1]; html_table[1]; read_html[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">dollar[6]; label_dollar[4]; label_percent[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[4]; str_extract[1]; str_remove[1]; str_remove_all[4]; str_replace[2]; str_replace_na[1]; str_squish[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">as_tibble[1]; tibble[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">crossing[1]; fill[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tsibble</td>
<td style="text-align: left;">scale_x_yearquarter[1]; tsibble[1]; yearquarter[3]</td>
</tr>
<tr class="even">
<td style="text-align: left;">vctrs</td>
<td style="text-align: left;">new_datetime[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


</section><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>
<ol>
<li id="fn1"><p>This data is licensed under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">Open Government Licence v3.0</a>.↩︎</p></li>
<li id="fn2"><p>Contains HM Land Registry data © Crown copyright and database right 2021. This data is licensed under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">Open Government Licence v3.0</a>.↩︎</p></li>
</ol></section></div> ]]></description>
  <category>R</category>
  <category>statistical inference</category>
  <category>regex</category>
  <category>special effects</category>
  <category>web scraping</category>
  <guid>https://www.quantumjitter.com/project/bands/index.html</guid>
  <pubDate>Tue, 08 Mar 2022 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/bands/feature.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Sea Monsters that Lost their Way</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/cetacea/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/cetacea/feature.gif" class="img-fluid" alt="A buoy sways in the sea water in front of the coastal cliff. On it, a sign points left for dolphins and right for orca. And a dolphin and orca are seen in the foreground reading the sign."></p>
<p>The Natural History Museum began recording cetacean (whales, dolphins and porpoises) strandings in 1913 <span class="citation" data-cites="naturalhistorymuseum2019">(Natural History Museum 2019)</span>. Let’s explore this 1913-1989 dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidymodels/probably/">probably</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidymodels/finetune">finetune</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidymodels/textrecipes">textrecipes</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/quanteda/stopwords">stopwords</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/koalaverse/vip/">vip</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/jabiru/tictoc">tictoc</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/RevolutionAnalytics/doparallel">doParallel</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op" style="color: #5E5E5E;">(</span>cores <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span>name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Darjeeling2"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/cetacea/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">strandings_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"strandings.csv"</span>, show_col_types <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    date_rep <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%d/%m/%Y"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    length <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/parse_number.html">parse_number</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">length_et</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    species_lumped <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_lump.html">fct_lump_n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, <span class="fl" style="color: #AD0000;">20</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"_val"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">as.integer</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    rep_comment <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">comment</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># glimpse(strandings_df)</span></span></code></pre></div>
</div>
<section id="exploratory" class="level2"><h2 class="anchored" data-anchor-id="exploratory">Exploratory</h2>
<p>Some of the <code>species</code> labels contain a question mark or forward slash. This indicates uncertainty, so it might be fun to see if a machine learning model (multi-class classification) could learn from the known species and suggest an appropriate <code>species</code> where it’s uncertain.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">strandings_df2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">strandings_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>species_uncertainty <span class="op" style="color: #5E5E5E;">=</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, <span class="st" style="color: #20794D;">"[?/]"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"Uncertain"</span>, <span class="st" style="color: #20794D;">"Known"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">strandings_df2</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species_uncertainty</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Uncertain"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, sort <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Count"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">species</th>
<th style="text-align: right;">Count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">delphis/coeruleoalba</td>
<td style="text-align: right;">48</td>
</tr>
<tr class="even">
<td style="text-align: left;">phocoena?</td>
<td style="text-align: right;">42</td>
</tr>
<tr class="odd">
<td style="text-align: left;">melaena?</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="even">
<td style="text-align: left;">delphis?</td>
<td style="text-align: right;">18</td>
</tr>
<tr class="odd">
<td style="text-align: left;">truncatus?</td>
<td style="text-align: right;">18</td>
</tr>
<tr class="even">
<td style="text-align: left;">acutorostrata?</td>
<td style="text-align: right;">12</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The <code>date</code> variable has many NA’s. Fortunately, the components to construct many of these are in the <code>year_val</code>, <code>month_val</code> and <code>day_val</code> variables. With a little wrangling and imputation, we can coalesce these variables into a new date. This will be useful since plots of sample <code>species</code> by <code>year</code>, <code>month</code> and <code>week</code> of stranding suggest a de-constructed <code>date</code> could be a useful predictor.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">strandings_df2</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date_rep</span>, <span class="va" style="color: #111111;">year_val</span>, <span class="va" style="color: #111111;">month_val</span>, <span class="va" style="color: #111111;">day_val</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    date_rep             year_val      month_val         day_val     
 Min.   :1913-02-13   Min.   :   0   Min.   : 0.000   Min.   : 0.00  
 1st Qu.:1933-09-09   1st Qu.:1933   1st Qu.: 4.000   1st Qu.: 9.00  
 Median :1954-04-13   Median :1955   Median : 7.000   Median :16.00  
 Mean   :1955-01-08   Mean   :1954   Mean   : 6.766   Mean   :15.66  
 3rd Qu.:1979-03-21   3rd Qu.:1979   3rd Qu.:10.000   3rd Qu.:22.00  
 Max.   :1989-12-25   Max.   :1989   Max.   :12.000   Max.   :31.00  
 NA's   :121                                                         </code></pre>
</div>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">strandings_df3</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">strandings_df2</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    month_val <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">month_val</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">0</span>, <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">month_val</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>                          <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">month_val</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    day_val <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">day_val</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">0</span>, <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">day_val</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">day_val</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    day_val <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">day_val</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">1L</span>, <span class="va" style="color: #111111;">day_val</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    date2 <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_build.html">date_build</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year_val</span>, <span class="va" style="color: #111111;">month_val</span>, <span class="va" style="color: #111111;">day_val</span>, invalid <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"NA"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">species</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>date3 <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/coalesce.html">coalesce</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date_rep</span>, <span class="va" style="color: #111111;">date2</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>         date_rep <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date_rep</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date3</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">date3</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>         <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">date2</span>, <span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">date3</span>, <span class="op" style="color: #5E5E5E;">-</span><span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"_val"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">example_species</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"musculus"</span>, <span class="st" style="color: #20794D;">"melas"</span>, <span class="st" style="color: #20794D;">"crassidens"</span>, <span class="st" style="color: #20794D;">"borealis"</span>, <span class="st" style="color: #20794D;">"coeruleoalba"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">known_species</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">strandings_df3</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species_uncertainty</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Known"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">plot_date_feature</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">var</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="va" style="color: #111111;">known_species</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      year <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_year</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date_rep</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      month <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_month</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date_rep</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      week <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/as_iso_year_week_day.html">as_iso_year_week_day</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date_rep</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_week</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;">example_species</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, <span class="op" style="color: #5E5E5E;">{</span><span class="op" style="color: #5E5E5E;">{</span> <span class="va" style="color: #111111;">var</span> <span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, <span class="op" style="color: #5E5E5E;">{</span><span class="op" style="color: #5E5E5E;">{</span> <span class="va" style="color: #111111;">var</span> <span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.7</span>,</span>
<span>      fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>      show.legend <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Variation in {str_to_title(as.character(var))}"</span>,</span>
<span>                   <span class="st" style="color: #20794D;">" of Stranding for Known Species"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"{str_to_title(as.character(var))}"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"year"</span>, <span class="st" style="color: #20794D;">"month"</span>, <span class="st" style="color: #20794D;">"week"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sym</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">plot_date_feature</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op" style="color: #5E5E5E;">(</span>ncol <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/cetacea/index_files/figure-html/impute-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Do <code>latitude</code> and <code>longitude</code> carry useful predictive information?</p>
<p>A geospatial visualisation of strandings shows some <code>species</code> do gravitate towards particular stretches of coastline, e.g.&nbsp;“acutus” and “albirostris” to the east, and “coeruleoalba” to the south-west.</p>
<p>Some <code>species</code> may also be more prone to mass stranding, so something that indicates whether a <code>species</code> has such a history (in these data) may be worth including in the mix.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">uki</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/map_data.html">map_data</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"world"</span>, region <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"uk"</span>, <span class="st" style="color: #20794D;">"ireland"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">labels</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Mass"</span>, <span class="st" style="color: #20794D;">"Single"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">uki</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_map.html">geom_map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">long</span>, <span class="va" style="color: #111111;">lat</span>, map_id <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">region</span><span class="op" style="color: #5E5E5E;">)</span>, map <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">uki</span>, </span>
<span>           colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"black"</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"grey90"</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">longitude</span>, <span class="va" style="color: #111111;">latitude</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">mass_single</span>, </span>
<span>                  size <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">mass_single</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>              alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span>, data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">known_species</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">species_lumped</span>, nrow <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_map.html">coord_map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"mollweide"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_size_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">0.5</span><span class="op" style="color: #5E5E5E;">)</span>, labels <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">labels</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span>, labels <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">labels</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"top"</span>, </span>
<span>        strip.text <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"grey50"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Strandings by Species"</span>, </span>
<span>       colour <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/cetacea/index_files/figure-html/mass-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;"># Add history of mass stranding</span></span>
<span><span class="va" style="color: #111111;">strandings_df4</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">strandings_df3</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>mass_possible <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">mass_single</span>, na.rm <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>         .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">species</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Some records are missing the <code>length</code> measurement of the mammal. Nonetheless, where present, this is likely to be predictive, and may help, for example, separate species labelled as “delphis/coeruleoalba” where the <code>length</code> is at the extreme ends of the “delphis” range as we see below. And the range of <code>length</code> may differ by mammal <code>sex</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">known_species</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>sex <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="va" style="color: #111111;">sex</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"M"</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Male"</span>,</span>
<span>    <span class="va" style="color: #111111;">sex</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"F"</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Female"</span>,</span>
<span>    <span class="cn" style="color: #8f5902;">TRUE</span>       <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Unknown"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species_lumped</span> <span class="op" style="color: #5E5E5E;">!=</span> <span class="st" style="color: #20794D;">"Other"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species_lumped</span>, <span class="va" style="color: #111111;">length</span>, <span class="va" style="color: #111111;">sex</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>species_lumped <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species_lumped</span>, </span>
<span>                                      <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">length</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">min</span>, na.rm <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species_lumped</span>, <span class="va" style="color: #111111;">length</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species_lumped</span>, <span class="st" style="color: #20794D;">"^de|^co"</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>                                 <span class="cn" style="color: #8f5902;">TRUE</span>, <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>, show.legend <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">sex</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Variation in Species Length by Sex"</span>, </span>
<span>       x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Length (metres)"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/cetacea/index_files/figure-html/length-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>With map coordinates not always available, <code>county</code> could be, with a little string cleaning, a useful additional predictor.</p>
<div class="cell">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">strandings_df4</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">county</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">county</span>, <span class="st" style="color: #20794D;">"Shet|Northumberland"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span>County <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">county</span>, Count <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">County</th>
<th style="text-align: right;">Count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Fair Isle, Shetland Isles</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Northumberland</td>
<td style="text-align: right;">89</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Northumberland.</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Shetland Islands, Scotland</td>
<td style="text-align: right;">232</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Shetland Isles, Scotland</td>
<td style="text-align: right;">35</td>
</tr>
<tr class="even">
<td style="text-align: left;">Shetland, Scotland</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Shetlands, Scotland</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">regex_pattern</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"[,/].*$"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"(?&lt;!Che|Hamp|Lanca|North York)-?shire"</span>,</span>
<span>    <span class="st" style="color: #20794D;">" Isl.*$"</span>,</span>
<span>    <span class="st" style="color: #20794D;">" &amp;.*$"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"[-.]$"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">strandings_df5</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">strandings_df4</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    county <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">county</span>, <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">regex_pattern</span>, collapse <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"|"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    county <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">county</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Carnarvon"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Caernarvon"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"E.Lothian"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"East Lothian"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Shetlands"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Shetland"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"W.Glamorgan"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"West Glamorgan"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"S.Glamorgan"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"South Glamorgan"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> </span>
<span></span>
<span><span class="va" style="color: #111111;">strandings_df4</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>counties_before <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">county</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: right;">counties_before</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">146</td>
</tr></tbody>
</table>
</div>
</div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">strandings_df5</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>counties_after <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">county</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: right;">counties_after</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">109</td>
</tr></tbody>
</table>
</div>
</div>
</div>
<p>Whilst <code>count</code> also appears to hold, based on the plot pattern below, species-related information, I’m not going to use it as a predictor as we do not know enough about how it was derived, as reflected in these <a href="https://data.nhm.ac.uk/dataset/historical-uk-cetacean-strandings-dataset/resource/9a306dcd-1667-48b5-b682-ce6f071d85ce">variable descriptions</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">strandings_df5</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, <span class="va" style="color: #111111;">count</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">species_uncertainty</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op" style="color: #5E5E5E;">(</span>alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"How 'Count' Relates to Species"</span>, </span>
<span>       x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Count (log10)"</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Species"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"top"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/cetacea/index_files/figure-html/count-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</section><section id="modelling" class="level2"><h2 class="anchored" data-anchor-id="modelling">Modelling</h2>
<p>So, I’ll set aside the rows where the species is uncertain (to be used later for new predictions), and I’ll train a model on 75% of known species, and test it on the remaining 25%. I’ll use the following predictors:</p>
<ul>
<li>
<code>latitude</code> and <code>longitude</code>
</li>
<li>Mammal <code>length</code> and <code>sex</code>
</li>
<li>
<code>mass_possible</code> indicating a <code>species</code> history of mass strandings</li>
<li>
<code>date</code> reported converted into decimal, week, month and year</li>
<li>
<code>county</code> may be useful, especially where the longitude and latitude are missing</li>
<li>
<code>fam_genus</code> which narrows the range of likely species</li>
</ul>
<p>I’d like to also make use of the textrecipes<span class="citation" data-cites="textrecipes">(Hvitfeldt 2022)</span> package. I can tokenise the textual information in <code>rep_comment</code> and <code>location</code> to see if these add to the predictive power of the model.</p>
<p>I’ll tune the model using <code>tune_race_anova</code><span class="citation" data-cites="finetune">(Kuhn 2022)</span> which quickly discards hyperparameter combinations showing little early promise.</p>
<div class="cell" data-hash="index_cache/html/model_14d201fd648095cd6b5f9716448d613b">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">known_species</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">strandings_df5</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species_uncertainty</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Known"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"species"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"mass_single"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"mass_possible"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"county"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"location"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"sex"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"fam_genus"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="va" style="color: #111111;">factor</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">123</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">data_split</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">known_species</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>species <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_drop.html">fct_drop</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">initial_split</span><span class="op" style="color: #5E5E5E;">(</span>strata <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">species</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">train</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_split</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;">training</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">test</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_split</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;">testing</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">predictors</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"latitude"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"longitude"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"length"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"mass_single"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"mass_possible"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"county"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"location"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"rep_comment"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"sex"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"fam_genus"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">recipe</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">train</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/roles.html">update_role</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, new_role <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"outcome"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/roles.html">update_role</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">predictors</span><span class="op" style="color: #5E5E5E;">)</span>, new_role <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"predictor"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/roles.html">update_role</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/has_role.html">has_role</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"outcome"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">&amp;</span> <span class="op" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/has_role.html">has_role</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"predictor"</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>              new_role <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"id"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/step_date.html">step_date</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date_rep</span>, features <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"decimal"</span>, <span class="st" style="color: #20794D;">"week"</span>, <span class="st" style="color: #20794D;">"month"</span>, <span class="st" style="color: #20794D;">"year"</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>            label <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">location</span>, <span class="va" style="color: #111111;">rep_comment</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://textrecipes.tidymodels.org/reference/step_stopwords.html">step_stopwords</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">location</span>, <span class="va" style="color: #111111;">rep_comment</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://textrecipes.tidymodels.org/reference/step_tokenfilter.html">step_tokenfilter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">location</span>, <span class="va" style="color: #111111;">rep_comment</span>, max_tokens <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="co" style="color: #5E5E5E;">#100</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://textrecipes.tidymodels.org/reference/step_tf.html">step_tf</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">location</span>, <span class="va" style="color: #111111;">rep_comment</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/step_zv.html">step_zv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_nominal_predictors</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">xgb_model</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;">boost_tree</span><span class="op" style="color: #5E5E5E;">(</span>trees <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="co" style="color: #5E5E5E;"># 440</span></span>
<span>             mtry <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="co" style="color: #5E5E5E;"># 0.6</span></span>
<span>             learn_rate <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.02</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">set_mode</span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"classification"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">set_engine</span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"xgboost"</span>, </span>
<span>             count <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span>,</span>
<span>             verbosity <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0</span>,</span>
<span>             tree_method <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"hist"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">xgb_wflow</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">workflow</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_recipe</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">recipe</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_model</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">xgb_model</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">9</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">folds</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">vfold_cv</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">train</span>, strata <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">species</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">tune_result</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">xgb_wflow</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://finetune.tidymodels.org/reference/tune_race_anova.html">tune_race_anova</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    resamples <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">folds</span>,</span>
<span>    grid <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/expand.html">crossing</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      trees <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">200</span>, <span class="fl" style="color: #AD0000;">520</span>, <span class="fl" style="color: #AD0000;">40</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      mtry <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">0.5</span>, <span class="fl" style="color: #AD0000;">0.7</span>, <span class="fl" style="color: #AD0000;">0.1</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      max_tokens <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">80</span>, <span class="fl" style="color: #AD0000;">120</span>, <span class="fl" style="color: #AD0000;">20</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    control <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://finetune.tidymodels.org/reference/control_race.html">control_race</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    metrics <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">metric_set</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">accuracy</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>396.407 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">tune_result</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://finetune.tidymodels.org/reference/plot_race.html">plot_race</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Early Elimination of Parameter Combinations"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/cetacea/index_files/figure-html/model-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">123</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">xgb_fit</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">xgb_wflow</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tune.tidymodels.org/reference/finalize_model.html">finalize_workflow</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">tune_result</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>                      <span class="fu" style="color: #4758AB;"><a href="https://tune.tidymodels.org/reference/show_best.html">select_best</a></span><span class="op" style="color: #5E5E5E;">(</span>metric <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"accuracy"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">fit</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">train</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Having fitted the model with the 3080 records in the training data, I’ll test its accuracy on the 1028 records of <em>known</em> species the model has not yet seen.</p>
<p>Without spending time on alternative models, we’re getting a reasonable result for the “porpoise” of this post, as reflected in both the accuracy metric and confusion matrix.</p>
<div class="cell">
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">xgb_results</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">xgb_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op" style="color: #5E5E5E;">(</span>new_data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">test</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">xgb_results</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">accuracy</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, <span class="va" style="color: #111111;">.pred_class</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">.metric</th>
<th style="text-align: left;">.estimator</th>
<th style="text-align: right;">.estimate</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">multiclass</td>
<td style="text-align: right;">0.9931907</td>
</tr></tbody>
</table>
</div>
</div>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">xgb_results</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">conf_mat</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, <span class="va" style="color: #111111;">.pred_class</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op" style="color: #5E5E5E;">(</span>type <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"heatmap"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    mid <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span>,</span>
<span>    high <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>    midpoint <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Confusion Matrix"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/cetacea/index_files/figure-html/results-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The top variable importance scores include <code>fam_genus</code>, many of the <code>rep_comment</code> tokens, plus <code>length</code>, <code>mass-possible</code>, <code>date_decimal</code>, <code>date_year</code>, and <code>latitude</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/vip/man/vi.html">vi</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">xgb_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html">extract_fit_parsnip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">Importance</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>ranking <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">40</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: right;">Importance</th>
<th style="text-align: right;">ranking</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fam_genus_Phocoena</td>
<td style="text-align: right;">0.1215845</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">fam_genus_Globicephala</td>
<td style="text-align: right;">0.0816541</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tf_rep_comment_unidentified</td>
<td style="text-align: right;">0.0736307</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">fam_genus_Delphinus</td>
<td style="text-align: right;">0.0710860</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fam_genus_Tursiops</td>
<td style="text-align: right;">0.0500141</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_false</td>
<td style="text-align: right;">0.0498405</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fam_genus_Lagenorhynchus</td>
<td style="text-align: right;">0.0448997</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_finned</td>
<td style="text-align: right;">0.0341306</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tf_rep_comment_sided</td>
<td style="text-align: right;">0.0302409</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_long</td>
<td style="text-align: right;">0.0244866</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fam_genus_Hyperoodon</td>
<td style="text-align: right;">0.0240353</td>
<td style="text-align: right;">11</td>
</tr>
<tr class="even">
<td style="text-align: left;">length</td>
<td style="text-align: right;">0.0230962</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fam_genus_Grampus</td>
<td style="text-align: right;">0.0227513</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_beaked</td>
<td style="text-align: right;">0.0219021</td>
<td style="text-align: right;">14</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tf_rep_comment_lesser</td>
<td style="text-align: right;">0.0215853</td>
<td style="text-align: right;">15</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_rorqual</td>
<td style="text-align: right;">0.0199182</td>
<td style="text-align: right;">16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tf_rep_comment_dolphin</td>
<td style="text-align: right;">0.0198597</td>
<td style="text-align: right;">17</td>
</tr>
<tr class="even">
<td style="text-align: left;">fam_genus_Orcinus</td>
<td style="text-align: right;">0.0194480</td>
<td style="text-align: right;">18</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tf_rep_comment_porpoise</td>
<td style="text-align: right;">0.0192418</td>
<td style="text-align: right;">19</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_bottle</td>
<td style="text-align: right;">0.0165892</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fam_genus_Pseudorca</td>
<td style="text-align: right;">0.0159957</td>
<td style="text-align: right;">21</td>
</tr>
<tr class="even">
<td style="text-align: left;">fam_genus_Physeter</td>
<td style="text-align: right;">0.0159090</td>
<td style="text-align: right;">22</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tf_rep_comment_risso’s</td>
<td style="text-align: right;">0.0131135</td>
<td style="text-align: right;">23</td>
</tr>
<tr class="even">
<td style="text-align: left;">mass_possible_S</td>
<td style="text-align: right;">0.0127573</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fam_genus_Mesoplodon</td>
<td style="text-align: right;">0.0123743</td>
<td style="text-align: right;">25</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_fin</td>
<td style="text-align: right;">0.0122737</td>
<td style="text-align: right;">26</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fam_genus_Ziphius</td>
<td style="text-align: right;">0.0122521</td>
<td style="text-align: right;">27</td>
</tr>
<tr class="even">
<td style="text-align: left;">fam_genus_odontocete</td>
<td style="text-align: right;">0.0109274</td>
<td style="text-align: right;">28</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fam_genus_cetacean</td>
<td style="text-align: right;">0.0104412</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_killer</td>
<td style="text-align: right;">0.0099741</td>
<td style="text-align: right;">30</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fam_genus_Stenella</td>
<td style="text-align: right;">0.0087018</td>
<td style="text-align: right;">31</td>
</tr>
<tr class="even">
<td style="text-align: left;">date_rep_decimal</td>
<td style="text-align: right;">0.0081614</td>
<td style="text-align: right;">32</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tf_rep_comment_nosed</td>
<td style="text-align: right;">0.0075943</td>
<td style="text-align: right;">33</td>
</tr>
<tr class="even">
<td style="text-align: left;">date_rep_year</td>
<td style="text-align: right;">0.0072361</td>
<td style="text-align: right;">34</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tf_rep_comment_whale</td>
<td style="text-align: right;">0.0071684</td>
<td style="text-align: right;">35</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_white</td>
<td style="text-align: right;">0.0067214</td>
<td style="text-align: right;">36</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mass_single_S</td>
<td style="text-align: right;">0.0041988</td>
<td style="text-align: right;">37</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_common</td>
<td style="text-align: right;">0.0041767</td>
<td style="text-align: right;">38</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tf_rep_comment_cuvier’s</td>
<td style="text-align: right;">0.0036603</td>
<td style="text-align: right;">39</td>
</tr>
<tr class="even">
<td style="text-align: left;">tf_rep_comment_sowerby’s</td>
<td style="text-align: right;">0.0036372</td>
<td style="text-align: right;">40</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Do the predictions look reasonable?</p>
<p>The class probability is spread across 27 species. I’m going to set a high threshold of 0.9, meaning the predicted species needs to be a pretty confident prediction.</p>
<div class="cell">
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">xgb_preds</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">xgb_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op" style="color: #5E5E5E;">(</span>new_data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">strandings_df5</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>            <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species_uncertainty</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Uncertain"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">species_levels</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">xgb_preds</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">".pred_"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">.pred_class</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/coercion-factor.html">as.factor</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">subset_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">xgb_preds</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    .class_pred <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://probably.tidymodels.org/reference/make_class_pred.html">make_class_pred</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">.pred_acutorostrata</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_acutus</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_albirostris</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_ampullatus</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_bidens</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_borealis</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_breviceps</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_cavirostris</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_coeruleoalba</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_crassidens</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_delphis</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_electra</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_europaeus</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_griseus</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_leucas</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_macrocephalus</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_melaena</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_melas</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_mirus</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_monoceros</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_musculus</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_novaeangliae</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_orca</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_phocoena</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_physalus</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_sp.indet.</span>,</span>
<span>      <span class="va" style="color: #111111;">.pred_truncatus</span>,</span>
<span>      levels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species_levels</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      min_prob <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">.9</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">subset_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, <span class="va" style="color: #111111;">.class_pred</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">species</span>, <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Actual"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">species</span>, <span class="st" style="color: #20794D;">"Predicted"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.class_pred</span>, <span class="st" style="color: #20794D;">"Count"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">Actual</th>
<th style="text-align: right;">Predicted</th>
<th style="text-align: right;">Count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">acutorostrata/borealis</td>
<td style="text-align: right;">.pred_acutorostrata</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">acutorostrata?</td>
<td style="text-align: right;">.pred_acutorostrata</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">acutus?</td>
<td style="text-align: right;">.pred_acutus</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">albirostris?</td>
<td style="text-align: right;">.pred_albirostris</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ampullatus?</td>
<td style="text-align: right;">.pred_ampullatus</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">bidens?</td>
<td style="text-align: right;">.pred_bidens</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bidens?</td>
<td style="text-align: right;">[EQ]</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">cavirostris?</td>
<td style="text-align: right;">.pred_cavirostris</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">coeruleoalba?</td>
<td style="text-align: right;">.pred_coeruleoalba</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">delphis/coeruleoalba</td>
<td style="text-align: right;">[EQ]</td>
<td style="text-align: right;">48</td>
</tr>
<tr class="odd">
<td style="text-align: left;">delphis?</td>
<td style="text-align: right;">.pred_delphis</td>
<td style="text-align: right;">18</td>
</tr>
<tr class="even">
<td style="text-align: left;">griseus?</td>
<td style="text-align: right;">.pred_griseus</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">macrocephalus?</td>
<td style="text-align: right;">.pred_macrocephalus</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">melaena?</td>
<td style="text-align: right;">.pred_melaena</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">orca?</td>
<td style="text-align: right;">.pred_orca</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">phocoena?</td>
<td style="text-align: right;">.pred_phocoena</td>
<td style="text-align: right;">42</td>
</tr>
<tr class="odd">
<td style="text-align: left;">physalus/acutorostrata</td>
<td style="text-align: right;">[EQ]</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">physalus?</td>
<td style="text-align: right;">.pred_physalus</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">truncatus/albirostris</td>
<td style="text-align: right;">[EQ]</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">truncatus?</td>
<td style="text-align: right;">.pred_truncatus</td>
<td style="text-align: right;">18</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The majority of the 203 uncertain records are predicted to be as suspected in the original labelling. The remainder are classed as equivocal as they have not met the high bar of a 0.9-or-above probability for a single species.</p>
</section><section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 3%">
<col style="width: 96%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.character[2]; as.integer[3]; c[13]; is.na[1]; length[2]; levels[1]; library[14]; log10[1]; mean[2]; min[1]; names[1]; seq[3]; set.seed[4]; summary[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">as_iso_year_week_day[1]; date_build[1]; date_parse[1]; get_month[1]; get_week[1]; get_year[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">doParallel</td>
<td style="text-align: left;">registerDoParallel[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[7]; across[2]; arrange[2]; case_when[1]; coalesce[1]; count[4]; desc[3]; if_else[6]; mutate[13]; n[4]; n_distinct[2]; recode[1]; rename[2]; row_number[1]; select[3]; slice_head[2]; summarise[3]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">finetune</td>
<td style="text-align: left;">control_race[1]; plot_race[1]; tune_race_anova[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">forcats</td>
<td style="text-align: left;">fct_drop[1]; fct_lump_n[1]; fct_reorder[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[6]; coord_flip[3]; coord_map[1]; element_text[2]; facet_wrap[2]; geom_jitter[2]; geom_map[1]; geom_violin[2]; ggplot[4]; labs[6]; map_data[1]; scale_colour_manual[2]; scale_fill_gradient2[1]; scale_fill_manual[1]; scale_size_manual[1]; scale_y_log10[1]; theme[3]; theme_bw[1]; theme_set[1]; theme_void[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[3]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">janitor</td>
<td style="text-align: left;">clean_names[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">parsnip</td>
<td style="text-align: left;">boost_tree[1]; set_engine[1]; set_mode[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patchwork</td>
<td style="text-align: left;">wrap_plots[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">probably</td>
<td style="text-align: left;">make_class_pred[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">map[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">readr</td>
<td style="text-align: left;">parse_number[1]; read_csv[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">recipes</td>
<td style="text-align: left;">all_nominal_predictors[1]; all_predictors[1]; has_role[2]; step_date[1]; step_dummy[1]; step_zv[1]; update_role[3]</td>
</tr>
<tr class="even">
<td style="text-align: left;">rsample</td>
<td style="text-align: left;">initial_split[1]; testing[1]; training[1]; vfold_cv[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">var[3]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stopwords</td>
<td style="text-align: left;">stopwords[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[1]; str_detect[3]; str_remove_all[1]; str_to_title[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">textrecipes</td>
<td style="text-align: left;">step_stopwords[1]; step_tf[1]; step_tokenfilter[1]; step_tokenize[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tictoc</td>
<td style="text-align: left;">tic[1]; toc[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">crossing[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tune</td>
<td style="text-align: left;">finalize_workflow[1]; select_best[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">vip</td>
<td style="text-align: left;">vip[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">workflows</td>
<td style="text-align: left;">add_model[1]; add_recipe[1]; workflow[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">yardstick</td>
<td style="text-align: left;">accuracy[2]; conf_mat[1]; metric_set[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-textrecipes" class="csl-entry">
Hvitfeldt, Emil. 2022. <span>“Textrecipes: Extra ’Recipes’ for Text Processing.”</span> <a href="https://CRAN.R-project.org/package=textrecipes">https://CRAN.R-project.org/package=textrecipes</a>.
</div>
<div id="ref-finetune" class="csl-entry">
Kuhn, Max. 2022. <span>“Finetune: Additional Functions for Model Tuning.”</span> <a href="https://CRAN.R-project.org/package=finetune">https://CRAN.R-project.org/package=finetune</a>.
</div>
<div id="ref-naturalhistorymuseum2019" class="csl-entry">
Natural History Museum. 2019. <span>“Query on the Natural History Museum Data Portal (Data.nhm.ac.uk) (4311 Records).”</span> Natural History Museum. <a href="https://doi.org/10.5519/QD.IWG63595">https://doi.org/10.5519/QD.IWG63595</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>geospatial</category>
  <category>machine learning</category>
  <category>textual analysis</category>
  <guid>https://www.quantumjitter.com/project/cetacea/index.html</guid>
  <pubDate>Sat, 04 Dec 2021 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/cetacea/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>A Frosty Deal?</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/deal/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/deal/feature.gif" class="img-fluid" alt="Two frosty fists bump"></p>
<p>Before the post-Brexit trade negotiations concluded, what did quantitative textual analysis and word embeddings tell us about the shifting trade-talk sentiment?</p>
<p>Reading news articles on the will-they-won’t-they post-Brexit trade negotiations with the EU sees days of optimism jarred by days of gloom. Do negative news articles, when one wants a positive outcome, leave a deeper impression?</p>
<p>Is it possible to get a more objective view from <a href="https://quanteda.io">quantitative analysis of textual data</a>? To do this, I’m going to look at hundreds of articles published in the Guardian newspaper over the course of the year to see how trade-talk sentiment changed week-to-week.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://docs.evanodell.com/guardianapi">guardianapi</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://quanteda.io">quanteda</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/jabiru/tictoc">tictoc</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="http://text2vec.org">text2vec</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">topicmodels</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/r-lib/slider">slider</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span>name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Chevalier1"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/deal/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The Withdrawal Agreement between the UK and the European Union was <a href="https://en.wikipedia.org/wiki/Brexit_withdrawal_agreement">signed on the 24th of January 2020</a>. Brexit-related newspaper articles will be imported from that date.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Since publishing this article in September 2020, <a href="https://www.bbc.com/news/uk-politics-55476625">an agreement was reached on December 24th 2020</a>.</p>
</div>
</div>
<p>The Guardian newspaper asks for requests to span no more than 1 month at a time. Creating a set of monthly date ranges will enable the requests to be chunked.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">dates_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span>start_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_build.html">date_build</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2020</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">11</span>, <span class="fl" style="color: #AD0000;">25</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>end_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-arithmetic.html">add_months</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">start_date</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-arithmetic.html">add_days</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">dates_df</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">start_date</th>
<th style="text-align: left;">end_date</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-01-25</td>
<td style="text-align: left;">2020-02-24</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-02-25</td>
<td style="text-align: left;">2020-03-24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-03-25</td>
<td style="text-align: left;">2020-04-24</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-04-25</td>
<td style="text-align: left;">2020-05-24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-05-25</td>
<td style="text-align: left;">2020-06-24</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-06-25</td>
<td style="text-align: left;">2020-07-24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-07-25</td>
<td style="text-align: left;">2020-08-24</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-08-25</td>
<td style="text-align: left;">2020-09-24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-09-25</td>
<td style="text-align: left;">2020-10-24</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-10-25</td>
<td style="text-align: left;">2020-11-24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-11-25</td>
<td style="text-align: left;">2020-12-24</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Access to the Guardian’s API via <a href="https://github.com/cran/guardianapi">guardianapi</a><span class="citation" data-cites="guardianapi">(Odell 2019)</span> requires a key which may be requested <a href="https://open-platform.theguardian.com/access/">here</a> and stored in the .Renviron file.</p>
</div>
</div>
<div class="cell" data-hash="index_cache/html/read_b9a221b348136d61f0c7450830da90ee">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">read_slowly</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/slowly.html">slowly</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">gu_content</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">article_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/pmap.html">pmap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dates_df</span>, \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">start_date</span>, <span class="va" style="color: #111111;">end_date</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>    <span class="fu" style="color: #4758AB;">read_slowly</span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"brexit"</span>,</span>
<span>      from_date <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">start_date</span>,</span>
<span>      to_date <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">end_date</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The data need a little cleaning, for example, to remove multi-topic articles, html tags and non-breaking spaces.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">trade_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">article_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">id</span>, <span class="st" style="color: #20794D;">"/live/"</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>         <span class="va" style="color: #111111;">section_id</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"world"</span>, <span class="st" style="color: #20794D;">"politics"</span>, <span class="st" style="color: #20794D;">"business"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    body <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">body</span>, <span class="st" style="color: #20794D;">"&lt;.*?&gt;"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    body <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">body</span>, <span class="st" style="color: #20794D;">"[^a-z0-9 .-]"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    body <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">body</span>, <span class="st" style="color: #20794D;">"nbsp"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>A corpus then gives me a collection of texts whereby each document is a newspaper article.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">trade_corp</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">trade_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/corpus.html">corpus</a></span><span class="op" style="color: #5E5E5E;">(</span>docid_field <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"short_url"</span>, </span>
<span>         text_field <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"body"</span>, unique_docnames <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Although only articles mentioning Brexit have been imported, some of these will not be related to trade negotiations with the EU. For example, there are on-going negotiations with many countries around the world. So, word embeddings<span class="citation" data-cites="text2vec">(Selivanov, Bickel, and Wang 2022)</span> will help to narrow the focus to the specific context of the UK-EU trade deal.</p>
<p>The chief negotiator for the EU is Michel Barnier, so I’ll quantitatively identify words in close proximity to “Barnier” in the context of these Brexit news articles.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">window</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fl" style="color: #AD0000;">5</span></span>
<span></span>
<span><span class="va" style="color: #111111;">trade_fcm</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">trade_corp</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/fcm.html">fcm</a></span><span class="op" style="color: #5E5E5E;">(</span>context <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"window"</span>, window <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">window</span>, </span>
<span>      count <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"weighted"</span>, weights <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">window</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">glove</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;"><a href="https://rdrr.io/pkg/text2vec/man/GloVe.html">GlobalVectors</a></span><span class="op" style="color: #5E5E5E;">$</span><span class="fu" style="color: #4758AB;">new</span><span class="op" style="color: #5E5E5E;">(</span>rank <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">60</span>, x_max <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">42</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">wv_main</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">glove</span><span class="op" style="color: #5E5E5E;">$</span><span class="fu" style="color: #4758AB;">fit_transform</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">trade_fcm</span>, n_iter <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO  [16:12:38.514] epoch 1, loss 0.3788
INFO  [16:12:40.959] epoch 2, loss 0.2570
INFO  [16:12:43.337] epoch 3, loss 0.2292
INFO  [16:12:45.761] epoch 4, loss 0.2090
INFO  [16:12:48.188] epoch 5, loss 0.1921
INFO  [16:12:50.624] epoch 6, loss 0.1791
INFO  [16:12:53.043] epoch 7, loss 0.1694
INFO  [16:12:55.450] epoch 8, loss 0.1619
INFO  [16:12:57.849] epoch 9, loss 0.1557
INFO  [16:13:00.231] epoch 10, loss 0.1506</code></pre>
</div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">wv_context</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">glove</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">components</span></span>
<span><span class="va" style="color: #111111;">word_vectors</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">wv_main</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">wv_context</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">search_coord</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">word_vectors</span><span class="op" style="color: #5E5E5E;">[</span><span class="st" style="color: #20794D;">"barnier"</span>, , drop <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">]</span></span>
<span></span>
<span><span class="va" style="color: #111111;">word_vectors</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/text2vec/man/similarities.html">sim2</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">search_coord</span>, method <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"cosine"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op" style="color: #5E5E5E;">(</span>rownames <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"term"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span>similarity <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">similarity</span>, n <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">similarity</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">barnier</td>
<td style="text-align: right;">1.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">negotiator</td>
<td style="text-align: right;">0.8060194</td>
</tr>
<tr class="odd">
<td style="text-align: left;">michel</td>
<td style="text-align: right;">0.8060093</td>
</tr>
<tr class="even">
<td style="text-align: left;">frost</td>
<td style="text-align: right;">0.8040999</td>
</tr>
<tr class="odd">
<td style="text-align: left;">brussels</td>
<td style="text-align: right;">0.7012591</td>
</tr>
<tr class="even">
<td style="text-align: left;">negotiators</td>
<td style="text-align: right;">0.6404119</td>
</tr>
<tr class="odd">
<td style="text-align: left;">chief</td>
<td style="text-align: right;">0.6399011</td>
</tr>
<tr class="even">
<td style="text-align: left;">friday</td>
<td style="text-align: right;">0.6363004</td>
</tr>
<tr class="odd">
<td style="text-align: left;">team</td>
<td style="text-align: right;">0.6253523</td>
</tr>
<tr class="even">
<td style="text-align: left;">negotiations</td>
<td style="text-align: right;">0.6246642</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Word embedding is a learned modelling technique placing words into a multi-dimensional vector space such that contextually-similar words may be found close by. Not surprisingly, one of the closest words contextually is “Michel”. And as he is the chief negotiator for the EU, we find “negotiator” and “brussels” also in the top most contextually-similar words.</p>
<p>The word embeddings algorithm, through word co-occurrence, has identified the name of Michel Barnier’s UK counterpart David Frost. So filtering articles for “Barnier”, “Frost” and “UK-EU” should help narrow the focus.</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">context_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">trade_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">body</span>, <span class="st" style="color: #20794D;">"barnier|frost|uk-eu"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> </span>
<span></span>
<span><span class="va" style="color: #111111;">context_corp</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">context_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/corpus.html">corpus</a></span><span class="op" style="color: #5E5E5E;">(</span>docid_field <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"short_url"</span>, text_field <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"body"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Quanteda’s<span class="citation" data-cites="quanteda">(Benoit et al. 2018)</span> <code>kwic</code> function shows key phrases in context to ensure we’re homing in on the required texts. Short URLs are included below so one can click on any to read the actual article as presented by The Guardian.</p>
<div class="cell">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">123</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">context_corp</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/tokens.html">tokens</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    remove_punct <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>    remove_symbols <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>    remove_numbers <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/kwic.html">kwic</a></span><span class="op" style="color: #5E5E5E;">(</span>pattern <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/phrase.html">phrase</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"trade negotiation"</span>, <span class="st" style="color: #20794D;">"trade deal"</span>, <span class="st" style="color: #20794D;">"trade talks"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>       valuetype <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"regex"</span>, window <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">7</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">article_df</span>, by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"docname"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"short_url"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">docname</span>, <span class="va" style="color: #111111;">pre</span>, <span class="va" style="color: #111111;">keyword</span>, <span class="va" style="color: #111111;">post</span>, <span class="va" style="color: #111111;">headline</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 15%">
<col style="width: 19%">
<col style="width: 8%">
<col style="width: 22%">
<col style="width: 33%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">docname</th>
<th style="text-align: left;">pre</th>
<th style="text-align: left;">keyword</th>
<th style="text-align: left;">post</th>
<th style="text-align: left;">headline</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">https://www.theguardian.com/p/ep2yb</td>
<td style="text-align: left;">put pressure on brussels to agree a</td>
<td style="text-align: left;">trade deal</td>
<td style="text-align: left;">and iron out problems with the withdrawal</td>
<td style="text-align: left;">Boris Johnson bows to Tory rebels with Brexit bill compromise</td>
</tr>
<tr class="even">
<td style="text-align: left;">https://www.theguardian.com/p/dag4n</td>
<td style="text-align: left;">expected from parties about to embark on</td>
<td style="text-align: left;">trade talks</td>
<td style="text-align: left;">eu member states are due to confirm</td>
<td style="text-align: left;">Brexit deal ‘a different ball game’ to Canada agreement, warns EU</td>
</tr>
<tr class="odd">
<td style="text-align: left;">https://www.theguardian.com/p/ekz7e</td>
<td style="text-align: left;">has gone down badly in brussels in</td>
<td style="text-align: left;">trade negotiations</td>
<td style="text-align: left;">usually both sides work out a consolidated</td>
<td style="text-align: left;">Barnier ‘flabbergasted’ at UK attempt to reopen Brexit specialty food debate</td>
</tr>
<tr class="even">
<td style="text-align: left;">https://www.theguardian.com/p/fptbj</td>
<td style="text-align: left;">the eu followed the usual pattern of</td>
<td style="text-align: left;">trade talks</td>
<td style="text-align: left;">down the ages the negotiations seemed to</td>
<td style="text-align: left;">Brexit talks followed common pattern but barrier-raising outcome is unique</td>
</tr>
<tr class="odd">
<td style="text-align: left;">https://www.theguardian.com/p/dq896</td>
<td style="text-align: left;">text contains a cut-and-paste from the eus</td>
<td style="text-align: left;">trade deal</td>
<td style="text-align: left;">with canada stating merely that it would</td>
<td style="text-align: left;">Brexit talks: Britain accuses EU of treating UK as ‘unworthy’ partner</td>
</tr>
<tr class="even">
<td style="text-align: left;">https://www.theguardian.com/p/fmmga</td>
<td style="text-align: left;">the conservative party for years john harris</td>
<td style="text-align: left;">trade deals</td>
<td style="text-align: left;">are not meant to assert sovereignty she</td>
<td style="text-align: left;">EU leaders stress unity as they welcome Brexit trade talks extension</td>
</tr>
<tr class="odd">
<td style="text-align: left;">https://www.theguardian.com/p/fv2xh</td>
<td style="text-align: left;">demanded a last-minute compromise to reach a</td>
<td style="text-align: left;">trade deal</td>
<td style="text-align: left;">and avert chaos at the border as</td>
<td style="text-align: left;">Firms plead for Brexit deal as coronavirus leaves industry reeling</td>
</tr>
<tr class="even">
<td style="text-align: left;">https://www.theguardian.com/p/f6444</td>
<td style="text-align: left;">canada-style trade deal the eu has a</td>
<td style="text-align: left;">trade deal</td>
<td style="text-align: left;">with canada called the comprehensive economic and</td>
<td style="text-align: left;">What did Boris Johnson mean by an Australia-style system of trade?</td>
</tr>
<tr class="odd">
<td style="text-align: left;">https://www.theguardian.com/p/fk5kt</td>
<td style="text-align: left;">companies await news of a potential uk-eu</td>
<td style="text-align: left;">trade deal</td>
<td style="text-align: left;">abf said our businesses have completed all</td>
<td style="text-align: left;">Primark reports ‘phenomenal’ trading since lockdowns ended</td>
</tr>
<tr class="even">
<td style="text-align: left;">https://www.theguardian.com/p/evgxe</td>
<td style="text-align: left;">in talks trying to thrash out a</td>
<td style="text-align: left;">trade deal</td>
<td style="text-align: left;">before january but after the chief negotiators</td>
<td style="text-align: left;">Wednesday briefing: Tory revolt over Cummings piles pressure on PM</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Quanteda provides a sentiment dictionary which, in addition to identifying positive and negative words, also finds negative-negatives and negative-positives such as, for example, “not effective”. For each week’s worth of articles, we can calculate the proportion of positive sentiments.</p>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">sent_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">context_corp</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/tokens.html">tokens</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/dfm.html">dfm</a></span><span class="op" style="color: #5E5E5E;">(</span>dictionary <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">data_dictionary_LSD2015</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">context_df</span>, by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"doc_id"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"short_url"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    pos <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">positive</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="va" style="color: #111111;">neg_negative</span>,</span>
<span>    neg <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">negative</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="va" style="color: #111111;">neg_positive</span>,</span>
<span>    web_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date-and-date-time-rounding.html">date_ceiling</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">web_publication_date</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"week"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    pct_pos <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">pos</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pos</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="va" style="color: #111111;">neg</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">sent_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span>Article <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">doc_id</span>, <span class="st" style="color: #20794D;">"Pos Score"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">pos</span>, <span class="st" style="color: #20794D;">"Neg Score"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">neg</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">Article</th>
<th style="text-align: right;">Pos Score</th>
<th style="text-align: right;">Neg Score</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">https://www.theguardian.com/p/d6qhb</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">22</td>
</tr>
<tr class="even">
<td style="text-align: left;">https://www.theguardian.com/p/d9e9j</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">15</td>
</tr>
<tr class="odd">
<td style="text-align: left;">https://www.theguardian.com/p/d6kzd</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">27</td>
</tr>
<tr class="even">
<td style="text-align: left;">https://www.theguardian.com/p/d79cn</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">51</td>
</tr>
<tr class="odd">
<td style="text-align: left;">https://www.theguardian.com/p/d6t3c</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">26</td>
</tr>
<tr class="even">
<td style="text-align: left;">https://www.theguardian.com/p/d9vjq</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">23</td>
</tr>
<tr class="odd">
<td style="text-align: left;">https://www.theguardian.com/p/d7n8b</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">35</td>
</tr>
<tr class="even">
<td style="text-align: left;">https://www.theguardian.com/p/dag4n</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">38</td>
</tr>
<tr class="odd">
<td style="text-align: left;">https://www.theguardian.com/p/d9xtf</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">14</td>
</tr>
<tr class="even">
<td style="text-align: left;">https://www.theguardian.com/p/d7d9t</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">11</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">summary_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">sent_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>pct_pos <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pct_pos</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>            n <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">web_date</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.945 sec elapsed</code></pre>
</div>
</div>
<p>Plotting the changing proportion of positive sentiment over time did surprise me a little. The outcome was more balanced than I expected which perhaps confirms the deeper impression left on me by negative articles.</p>
<p>The upper plot shows a rolling 7-day mean with a narrowing ribbon representing a narrowing variation in sentiment.</p>
<p>The lower plot shows the volume of articles. As we drew closer to the crunch-point the volume picked up.</p>
<div class="cell">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">width</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fl" style="color: #AD0000;">7</span></span>
<span></span>
<span><span class="va" style="color: #111111;">sent_df2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">sent_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>web_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">web_publication_date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">web_date</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>pct_pos <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pos</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">neg</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="va" style="color: #111111;">pos</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    roll_mean <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://slider.r-lib.org/reference/slide.html">slide_dbl</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pct_pos</span>, <span class="va" style="color: #111111;">mean</span>, .before <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    roll_lq <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://slider.r-lib.org/reference/slide.html">slide_dbl</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pct_pos</span>, <span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.x</span>, probs <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.25</span><span class="op" style="color: #5E5E5E;">)</span>, .before <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    roll_uq <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://slider.r-lib.org/reference/slide.html">slide_dbl</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pct_pos</span>, <span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.x</span>, probs <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.75</span><span class="op" style="color: #5E5E5E;">)</span>, .before <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p1</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">sent_df2</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">web_date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>y <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">roll_mean</span><span class="op" style="color: #5E5E5E;">)</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>ymin <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">roll_lq</span>, ymax <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">roll_uq</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>              alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.33</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op" style="color: #5E5E5E;">(</span>yintercept <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span>, linetype <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"dashed"</span>, </span>
<span>             colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">]</span>, linewidth <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op" style="color: #5E5E5E;">(</span>accuracy <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Changing Sentiment Towards a UK-EU Trade Deal"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Rolling {width} days Since the Withdrawal Agreement"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Positive Sentiment"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">summary_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">web_date</span>, <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Weeks"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Article Count"</span>,</span>
<span>       caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: Guardian Newspaper"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="va" style="color: #111111;">p2</span> <span class="op" style="color: #5E5E5E;">+</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op" style="color: #5E5E5E;">(</span>heights <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/deal/index_files/figure-html/plot-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 7%">
<col style="width: 92%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.Date[2]; c[5]; library[12]; mean[1]; set.seed[2]; sum[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">add_days[1]; add_months[1]; date_build[1]; date_ceiling[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[2]; group_by[1]; left_join[2]; mutate[5]; n[2]; rename[1]; select[2]; slice[1]; slice_max[1]; slice_sample[1]; summarise[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[4]; geom_hline[1]; geom_line[2]; geom_ribbon[1]; ggplot[2]; labs[2]; scale_y_continuous[1]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">guardianapi</td>
<td style="text-align: left;">gu_content[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patchwork</td>
<td style="text-align: left;">plot_layout[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">list_rbind[1]; pmap[1]; slowly[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">quanteda</td>
<td style="text-align: left;">t[1]; corpus[2]; data_dictionary_LSD2015[1]; dfm[1]; fcm[1]; kwic[1]; phrase[1]; tokens[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">label_percent[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">slider</td>
<td style="text-align: left;">slide_dbl[3]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">quantile[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_detect[2]; str_remove_all[3]; str_to_lower[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">text2vec</td>
<td style="text-align: left;">sim2[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">as_tibble[3]; tibble[1]; rownames_to_column[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tictoc</td>
<td style="text-align: left;">tic[2]; toc[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-quanteda" class="csl-entry">
Benoit, Kenneth, Kohei Watanabe, Haiyan Wang, Paul Nulty, Adam Obeng, Stefan Müller, and Akitaka Matsuo. 2018. <span>“Quanteda: An r Package for the Quantitative Analysis of Textual Data”</span> 3: 774. <a href="https://doi.org/10.21105/joss.00774">https://doi.org/10.21105/joss.00774</a>.
</div>
<div id="ref-guardianapi" class="csl-entry">
Odell, Evan. 2019. <span>“<span></span>Guardianapi<span></span>: Access the ’Guardian’ Newspaper Open Data API.”</span> <a href="https://doi.org/10.5281/zenodo.2551001">https://doi.org/10.5281/zenodo.2551001</a>.
</div>
<div id="ref-text2vec" class="csl-entry">
Selivanov, Dmitriy, Manuel Bickel, and Qing Wang. 2022. <span>“Text2vec: Modern Text Mining Framework for r.”</span> <a href="https://CRAN.R-project.org/package=text2vec">https://CRAN.R-project.org/package=text2vec</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>textual analysis</category>
  <category>word embeddings</category>
  <category>natural language processing</category>
  <guid>https://www.quantumjitter.com/project/deal/index.html</guid>
  <pubDate>Thu, 17 Sep 2020 23:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/deal/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>The Goldilocks Principle</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/goldilocks/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/goldilocks/feature.gif" class="img-fluid" alt="Three bowls of porridge rest on a long table. The small bowl has no heat rising from it, whilst the largest bowl is steaming hot. The middle bowl, with a spoon wedged in it, looks just right."></p>
<p><a href="https://en.wikipedia.org/wiki/Goldilocks_principle">The Goldilocks principle</a> has its origins in a children’s story about a girl who tastes the bowls of porridge left by three bears. She prefers the one that is neither too hot nor too cold, but is just right.</p>
<p>When it comes to investing in stocks, how many is “just right”?</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/olafmersmann/truncnorm">truncnorm</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>I’ll use this palette.</p>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span>name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Darjeeling2"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/goldilocks/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Suppose the <a href="https://www.investopedia.com/ask/answers/042415/what-average-annual-return-sp-500.asp">average stock market return</a> is around 10%. And you do extensive research, burning the midnight oil, poring over stock fundamentals. Or perhaps you develop a cool machine learning model. And you arrive at a list of 50 promising stocks you feel confident would, on average, deliver well-above-market returns.</p>
<p>I’ll create some randomly made up stocks with an average return close to 40%. Some will tank due to events one could not foresee; I’ll allow some to lose up to 20%. Similarly, some could generate exceptional returns.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">123</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">stock_data</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  stock <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/chartr.html">chartr</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"0123456789"</span>, <span class="st" style="color: #20794D;">"abcdefghij"</span>, <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">50</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  return <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/truncnorm/man/dtruncnorm.html">rtruncnorm</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">50</span>, a <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.2</span>, mean <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.4</span>, sd <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">stock_data</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">return</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4200244</code></pre>
</div>
</div>
<p>Here’s the resultant distribution I’ll use to assess the impact of portfolio size. Stock markets are fairly close to a normal distribution, albeit with fatter tails due to a few extreme outcomes.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">stock_data</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">return</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"50 Randomly-generated Stock Returns"</span>, </span>
<span>       x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Annual Return"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Count"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/goldilocks/index_files/figure-html/distribution-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Now suppose you share 2 stocks, selected at random, with 1,000 of your social network friends (selecting a different pair of stocks for each friend). Will they all still be friends a year later? And if you repeated the same scenario with portfolio sizes of 5, 10, 20 and 50 stocks per person, would that change the outcome? Let’s see.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">portfolio</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="va" style="color: #111111;">stock_data</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">x</span>, replace <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      portfolio_return <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">return</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      portfolio_size <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">x</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">456</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">portfolios</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">1000</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">5</span>, <span class="fl" style="color: #AD0000;">1000</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">10</span>, <span class="fl" style="color: #AD0000;">1000</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">20</span>, <span class="fl" style="color: #AD0000;">1000</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">50</span>, <span class="fl" style="color: #AD0000;">1000</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">portfolio</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>portfolio_size <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">portfolio_size</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">mean_returns</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">portfolios</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    mean_return <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">portfolio_return</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    min_return <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">portfolio_return</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">portfolio_size</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">portfolios</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">portfolio_size</span>, <span class="va" style="color: #111111;">portfolio_return</span>, group <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">portfolio_size</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">portfolio_size</span><span class="op" style="color: #5E5E5E;">)</span>, show.legend <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">portfolio_size</span>, <span class="fl" style="color: #AD0000;">1.5</span>,</span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/percent_format.html">percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">mean_return</span>, accuracy <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">mean_returns</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">portfolio_size</span>, <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.2</span>,</span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/percent_format.html">percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">min_return</span>, accuracy <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">mean_returns</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/breaks_extended.html">breaks_extended</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">9</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Portfolio Size"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Return"</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"How Portfolio Size Changes Downside &amp; Upside Risk"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"BLUE Labels = Mean Return; BROWN Labels = Worst Return"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/goldilocks/index_files/figure-html/simulate-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>So, for all portfolio sizes, the average return across your 1,000 friends is around 42%.</p>
<p>But, when the portfolio size is 2, you may be erased from a few Christmas card lists (or worse). If one of those two stocks has an extreme negative outcome, there’s little else in the portfolio to dissipate the effect. As the portfolio size increases, the risk (downside and upside) dramatically reduces.</p>
<p>But is more always better? Well, irrespective of whether your list of promising stocks resulted from desk research or a model, there will be a varying degree of confidence in the 50. A machine learning model, for example, would assign class probabilities to each stock.</p>
<p>So by picking a smaller number, one can select those in which one feels most confident, or which have the highest class probability. And by picking a larger number (ideally across different sectors to further reduce risk) one can weaken the effects of a bad egg or two caused by events no research or model could foresee.</p>
<p>So perhaps the answer is to pick a worst-case scenario one would be prepared to accept. In the plot above, accepting a small chance of only a 12% return (still better than the historical average market return), might provide the “just right” portfolio. A portfolio of a manageable size, focused on your highest-confidence stocks, and with pretty good odds of the desired return.</p>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 6%">
<col style="width: 93%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">c[2]; chartr[1]; factor[1]; library[4]; mean[3]; min[1]; rep[5]; return[2]; sample[1]; set.seed[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">bind_rows[1]; mutate[1]; slice_sample[1]; summarise[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[5]; geom_histogram[1]; geom_label[2]; geom_violin[1]; ggplot[2]; labs[2]; scale_fill_manual[1]; scale_x_continuous[1]; scale_y_continuous[1]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">list_rbind[1]; map[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">breaks_extended[1]; label_percent[2]; percent[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">tibble[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">truncnorm</td>
<td style="text-align: left;">rtruncnorm[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


</section> ]]></description>
  <category>R</category>
  <category>sample distribution</category>
  <category>simulation</category>
  <guid>https://www.quantumjitter.com/project/goldilocks/index.html</guid>
  <pubDate>Sat, 08 Aug 2020 23:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/goldilocks/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Weathering the Storm</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/storm/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/storm/feature.gif" class="img-fluid" alt="Two meerkats cuddle under an umbrella shielded from the pouring rain"></p>
<p>In 2020, Covid-19 began battering financial markets now further impacted by the war in Ukraine. Which sectors are faring best?</p>
<p>I’ll compare each sector in the S&amp;P 500 with the overall market. Baselining each at zero as of February 19th, we’ll see which were the first to recover lost ground.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span>, exclude <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"date_format"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/business-science/tidyquant">tidyquant</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Moonrise2"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/storm/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">symbols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"SPY"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLV"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLK"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLE"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLF"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLC"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLI"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLY"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLP"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLRE"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLU"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"XLB"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">from</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"2020-02-19"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">from_formatted</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">from</span>, format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%Y-%m-%d"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/date_format.html">date_format</a></span><span class="op" style="color: #5E5E5E;">(</span>format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%b %d, %Y"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">eod_sectors</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tidyquant/man/tq_get.html">tq_get</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">symbols</span>, from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">from</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    norm_close <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">adjusted</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">adjusted</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="fl" style="color: #AD0000;">1</span>,</span>
<span>    type <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"SPY"</span>, <span class="st" style="color: #20794D;">"Market"</span>, <span class="st" style="color: #20794D;">"Sector"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    sector <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"SPY"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"S&amp;P 500"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLB"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Materials"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLE"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Energy"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLU"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Utilities"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLI"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Industrical"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLRE"</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Real Estate"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLV"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Health"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLK"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Technology"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLF"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Financial"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLC"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Communication"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLY"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Consumer Discretionary"</span>,</span>
<span>      <span class="va" style="color: #111111;">symbol</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"XLP"</span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Consumer Staples"</span>,</span>
<span>      <span class="cn" style="color: #8f5902;">TRUE</span>             <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Other"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">symbol</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Perhaps not too surprising to see that Tech led the way back from Covid. But with the further impact of the situation in Ukraine, the Energy sector is now the strongest performer relative to February 2020. Comms, with all that home-working, benefited initially during the lockdown, but has faded since.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">eod_sectors</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    sector <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_wrap.html">str_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sector</span>, <span class="fl" style="color: #AD0000;">12</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    sector <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sector</span>, <span class="va" style="color: #111111;">norm_close</span>, <span class="va" style="color: #111111;">last</span>, .desc <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, <span class="va" style="color: #111111;">norm_close</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sign.html">sign</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">norm_close</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op" style="color: #5E5E5E;">(</span>yintercept <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0</span>, linetype <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"dashed"</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"grey80"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">sector</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_colour_gradient</a></span><span class="op" style="color: #5E5E5E;">(</span>low <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span>, high <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"S&amp;P 500 Sector Impact of Covid-19 &amp; Ukraine"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Relative to {from_formatted}"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>        legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/storm/index_files/figure-html/visualisation-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 6%">
<col style="width: 93%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">c[1]; library[6]; sign[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">date_format[1]; date_parse[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">case_when[1]; if_else[1]; mutate[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">forcats</td>
<td style="text-align: left;">fct_reorder[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[1]; element_text[1]; facet_wrap[1]; geom_hline[1]; geom_line[1]; ggplot[1]; labs[1]; scale_colour_gradient[1]; scale_y_continuous[1]; theme[1]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">label_percent[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_wrap[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tidyquant</td>
<td style="text-align: left;">tq_get[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">drop_na[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


</section> ]]></description>
  <category>R</category>
  <category>quant</category>
  <guid>https://www.quantumjitter.com/project/storm/index.html</guid>
  <pubDate>Sat, 01 Aug 2020 23:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/storm/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Favourite Things</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/box/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/box/feature-1.png" class="img-fluid" alt="Wordcloud emphasising this site's most used R packages and functions"></p>
<p>Each <a href="../../project/">project</a> closes with a table summarising the R tools used. By aggregating the package and function usage across all projects, there’s an opportunity to:</p>
<ul>
<li><p>Spot the use of superseded functions like <code>map_dfr</code></p></li>
<li><p>Identify variable names that conflict with function names, for example, reminding me not to use <code>date</code> as a variable name (it’s also a base function), but rather use something more explicit and informative like <code>date_start</code> or <code>date_observed</code></p></li>
<li><p>Check for usage consistency, e.g.&nbsp;<code><a href="https://clock.r-lib.org/reference/date-today.html">clock::date_today</a></code> versus <code>Sys.Date</code></p></li>
<li><p>See where it would be most useful to keep an eye on package version updates</p></li>
</ul>
<p>Since starting this in 2017, functions like tidyr’s <code>spread</code> and <code>gather</code> have been superseded by <code>pivot_wider</code> and <code>pivot_longer</code>. Newer packages have emerged like <a href="https://github.com/EmilHvitfeldt/tidyclust">tidyclust</a>, which brings cluster modelling to tidymodels (now used in <a href="https://www.quantumjitter.com/project/happiness/">Finding Happiness in ‘The Smoke’</a>). <a href="https://rstudio.github.io/bslib/">bslib</a> has brought improvements to the latest shiny app version embedded in <a href="https://www.quantumjitter.com/project/thicken/">Plots Thicken</a>. The paletteer package has put it’s arms around the myriad palette packages out there. And scales’ <code>cut_short_scale</code> assisted with plot labelling.</p>
<p>Most recently, the latest versions of dplyr and purrr have presented a host of enhancements. For example, the <code>.by</code> argument in <code>mutate</code> and friends offers a neat alternative to <code>group_by</code> and <code>ungroup</code> in many situations. And changes in the <code>map_</code> family introduce <code>list_rbind</code> and associates with <code>map_dfr</code>, for example, now superseded.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/juliasilge/tidytext">tidytext</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/EmilHvitfeldt/paletteer">paletteer</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/lepennec/ggwordcloud">ggwordcloud</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/robjhyndman/fpp3-package">fpp3</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">n</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fl" style="color: #AD0000;">4</span></span>
<span><span class="va" style="color: #111111;">palette</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"harrypotter::ronweasley2"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/paletteer/man/paletteer_c.html">paletteer_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">palette</span>, n <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="va" style="color: #111111;">n</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span>, <span class="va" style="color: #111111;">y</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"FF$"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>             size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span>, vjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"label"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">n</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">2</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span>,</span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">palette</span>,</span>
<span>    fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span>,</span>
<span>    alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.8</span>,</span>
<span>    size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/box/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>We need to web-scrape <a href="https://www.quantumjitter.com/project/">all the projects on this web-site</a>, starting by grabbing the url for each one.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">urls</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"https://www.quantumjitter.com/project/"</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_element.html">html_elements</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">".quarto-grid-link"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_attr.html">html_attr</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"href"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/transmute.html">transmute</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"https://www.quantumjitter.com/"</span>, <span class="va" style="color: #111111;">value</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Then we can extract their package and function usage tables.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">table_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">urls</span>, \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="va" style="color: #111111;">x</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_element.html">html_elements</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"#r-toolbox , kable-table"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_table.html">html_table</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_flatten.html">list_flatten</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op" style="color: #5E5E5E;">(</span>replace <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"io"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">""</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">package</span>, <span class="va" style="color: #111111;">functn</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Separation of tidyverse and non-tidyverse packages may be achieved by using the likes of <code>tidyverse_packages</code> which lists all packages in the tidyverse.</p>
<ul>
<li><a href="https://www.tidyverse.org/packages/">tidyverse</a></li>
<li><a href="https://www.tidymodels.org/packages/">tidymodels</a></li>
<li><a href="https://tidyverts.org">tidyverts</a></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">tidy</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://tidyverse.tidyverse.org/reference/tidyverse_packages.html">tidyverse_packages</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/fpp3/man/fpp3_packages.html">fpp3_packages</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://tidymodels.tidymodels.org/reference/tidymodels_packages.html">tidymodels_packages</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">table_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">functn</span>, sep <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">";"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">functn</span>, <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"functn"</span>, <span class="st" style="color: #20794D;">"count"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"\\Q[\\E"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    count <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">count</span>, <span class="st" style="color: #20794D;">"]"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    functn <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">functn</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">package</span>, <span class="va" style="color: #111111;">functn</span>, wt <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">count</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>multiverse <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="va" style="color: #111111;">package</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;">tidy</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"tidy"</span>,</span>
<span>    <span class="va" style="color: #111111;">package</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"base"</span>, <span class="st" style="color: #20794D;">"graphics"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"base"</span>,</span>
<span>    <span class="cn" style="color: #8f5902;">TRUE</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"special"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Then we can summarise usage.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">pack_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">package</span>, <span class="va" style="color: #111111;">multiverse</span>, wt <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"package"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">fun_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">functn</span>, <span class="va" style="color: #111111;">multiverse</span>, wt <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"function"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">n_url</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">urls</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">packfun_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">pack_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">fun_df</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    packfun <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/coalesce.html">coalesce</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">package</span>, <span class="va" style="color: #111111;">functn</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    name <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">name</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">name</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Use of Quarto’s <code>{{&lt; include _foobar.qmd &gt;}}</code> has enabled the lifting, standardisation and simplification of the toolbox code. Previously this code (essentially replicated across the 20 projects) inflated the usage numbers.</p>
<p>With the latest versions of dplyr and purrr, usage of <code>group_by</code>, <code>ungroup</code> and <code>map_dfr</code> has fallen away whilst <code>list_rbind</code> has newly appeared.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">p1</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">packfun_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">name</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"package"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">packfun</span>, <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">n</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">multiverse</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span>show.legend <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"inward"</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, </span>
<span>       subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Package Usage"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">min_n</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fl" style="color: #AD0000;">5</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">packfun_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">name</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"function"</span>, <span class="va" style="color: #111111;">n</span> <span class="op" style="color: #5E5E5E;">&gt;=</span> <span class="va" style="color: #111111;">min_n</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">packfun</span>, <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">n</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">multiverse</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"inward"</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, </span>
<span>       subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Function Usage &gt;= {min_n}"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p1</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="va" style="color: #111111;">p2</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"Favourite Things from {n_url} Projects as at "</span>,</span>
<span>      <span class="st" style="color: #20794D;">"{date_format(date_today('Europe/London'), format = '%B %d, %Y')}"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/box/index_files/figure-html/plot-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>This last code chunk generates the word cloud for use as the feature image for this project.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">set.seed</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">123</span></span>
<span></span>
<span><span class="va" style="color: #111111;">packfun_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span> <span class="op" style="color: #5E5E5E;">*</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">2</span>, <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>                             replace <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, </span>
<span>                             prob <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">4</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">packfun</span>,</span>
<span>    size <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span>,</span>
<span>    colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">multiverse</span>,</span>
<span>    angle <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">angle</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://lepennec.github.io/ggwordcloud/reference/geom_text_wordcloud.html">geom_text_wordcloud</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    eccentricity <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>,</span>
<span>    seed <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">789</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html">scale_size_area</a></span><span class="op" style="color: #5E5E5E;">(</span>max_size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">20</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>plot.background <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/box/feature-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>This project’s code too should be included in my “favourite things”.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 4%">
<col style="width: 95%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.character[1]; as.integer[1]; c[8]; library[11]; sample[1]; unique[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">date_today[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[2]; arrange[1]; bind_rows[1]; case_when[1]; coalesce[1]; count[4]; desc[1]; mutate[6]; n_distinct[1]; pull[1]; select[1]; transmute[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">forcats</td>
<td style="text-align: left;">fct_reorder[2]; fct_rev[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fpp3</td>
<td style="text-align: left;">fpp3_packages[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[7]; annotate[1]; coord_flip[2]; element_rect[1]; geom_col[3]; geom_label[3]; ggplot[4]; labs[2]; scale_colour_manual[1]; scale_fill_manual[3]; scale_size_area[1]; theme[2]; theme_bw[1]; theme_set[1]; theme_void[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggwordcloud</td>
<td style="text-align: left;">geom_text_wordcloud[1]; ggwordcloud[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[4]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">janitor</td>
<td style="text-align: left;">clean_names[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">paletteer</td>
<td style="text-align: left;">paletteer_c[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patchwork</td>
<td style="text-align: left;">plot_annotation[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">list_flatten[1]; list_rbind[1]; map[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rvest</td>
<td style="text-align: left;">html_attr[1]; html_elements[2]; html_table[1]; read_html[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[1]; str_remove[2]; str_squish[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">as_tibble[1]; tibble[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tidymodels</td>
<td style="text-align: left;">tidymodels_packages[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">drop_na[1]; separate[1]; separate_rows[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tidyverse</td>
<td style="text-align: left;">tidyverse_packages[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


</section> ]]></description>
  <category>R</category>
  <category>web scraping</category>
  <guid>https://www.quantumjitter.com/project/box/index.html</guid>
  <pubDate>Sat, 25 Jul 2020 23:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/box/feature-1.png" medium="image" type="image/png" height="77" width="144"/>
</item>
<item>
  <title>East-West Drift</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/un/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/un/feature.gif" class="img-fluid" alt="The enlarged face of a compass with West and East breaking off and repeatedly drifting away and drifting back"></p>
<p>In <a href="../../project/happiness">Finding Happiness in ‘The Smoke’</a>, dimension reduction and cluster analysis are used to see how different characteristics group London boroughs.</p>
<p>Dimension reduction is used here to visualise the grouping of UN members, for example <a href="https://research.un.org/en/unmembers/founders">five of the founding members</a>, based on their <a href="http://www.un.org/en/ga/">General Assembly</a> voting patterns. And by using animation, it’s possible to more easily see changes over time. Are they drifting closer or farther apart?</p>
<p>General Assembly votes are obtained from unvotes<span class="citation" data-cites="unvotes">(Robinson 2021)</span> and the visualisation animated using gganimate<span class="citation" data-cites="gganimate">(Pedersen and Robinson 2022)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tsibble.tidyverts.org">tsibble</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://gganimate.com">gganimate</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/dgrtwo/unvotes">unvotes</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"GrandBudapest2"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/un/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">un_votes</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">un_roll_calls</span>, by <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"rcid"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span>vote_date <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">date</span>, <span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">country_code</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"GB"</span>, <span class="st" style="color: #20794D;">"CN"</span>, <span class="st" style="color: #20794D;">"US"</span>, <span class="st" style="color: #20794D;">"FR"</span>, <span class="st" style="color: #20794D;">"RU"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    country <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">country_code</span>,</span>
<span>      GB <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"UK"</span>,</span>
<span>      CN <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"China"</span>,</span>
<span>      FR <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"France"</span>,</span>
<span>      RU <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Russia"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    vote_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_date</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>                           format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%Y-%m-%d"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">from</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_year</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">to</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_year</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Applying a sliding window to the roll-calls from 1946 to 2019 will make it possible to show the temporal changes.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_date</span>, <span class="va" style="color: #111111;">rcid</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_date</span>, <span class="va" style="color: #111111;">rcid</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>vote_id <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, year <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_year</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">data</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/complete.html">complete</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">country</span>, <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/expand.html">nesting</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_id</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>vote <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"na"</span><span class="op" style="color: #5E5E5E;">)</span>, value <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_id</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/fill.html">fill</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, .direction <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"updown"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>variation <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">variation</span> <span class="op" style="color: #5E5E5E;">!=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">country</span>, <span class="va" style="color: #111111;">vote_id</span>, <span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">vote</span>, <span class="va" style="color: #111111;">value</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">wdow_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tsibble.tidyverts.org/reference/as-tsibble.html">as_tsibble</a></span><span class="op" style="color: #5E5E5E;">(</span>key <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">country</span>, index <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">vote_id</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">vote_id</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tsibble.tidyverts.org/reference/slide_tsibble.html">slide_tsibble</a></span><span class="op" style="color: #5E5E5E;">(</span>.size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1000</span>, .step <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">250</span>, .id <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"slide_id"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">data</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">slide_id</span>, <span class="va" style="color: #111111;">vote_id</span>, <span class="va" style="color: #111111;">country</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Dimensionality reduction may be performed on each window. And the voting patterns are then visualised as a two-dimensional animation.</p>
<div class="cell" data-hash="index_cache/html/pca_e97d2bcf856e68b8865330448d3c8ba2">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">wdows</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">wdow_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">slide_id</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">slide_pca</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="va" style="color: #111111;">wide_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">wdow_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">slide_id</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      id_cols <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">country</span>, <span class="va" style="color: #111111;">slide_id</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      names_from <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_id</span>, <span class="va" style="color: #111111;">vote</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      values_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">value</span>,</span>
<span>      values_fill <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span>  <span class="va" style="color: #111111;">pca_fit</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">wide_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">country</span>, <span class="va" style="color: #111111;">slide_id</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op" style="color: #5E5E5E;">(</span>scale <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;">augment</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">wide_df</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">slide_id</span>, <span class="va" style="color: #111111;">country</span>, <span class="va" style="color: #111111;">.fittedPC1</span>, <span class="va" style="color: #111111;">.fittedPC2</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span></span>
<span></span>
<span><span class="va" style="color: #111111;">pca_windows</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="va" style="color: #111111;">wdows</span>, <span class="va" style="color: #111111;">slide_pca</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">pca_windows</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>east_west <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">country</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"China"</span>, <span class="st" style="color: #20794D;">"Russia"</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>                             <span class="st" style="color: #20794D;">"East"</span>, <span class="st" style="color: #20794D;">"West"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.fittedPC1</span>, <span class="va" style="color: #111111;">.fittedPC2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">country</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">east_west</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gganimate.com/reference/transition_time.html">transition_time</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">slide_id</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"P5 Distance for the Period {from} to {to}"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Frame {frame} of {nframes}"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Principal Component 1"</span>,</span>
<span>    y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Principal Component 2"</span>,</span>
<span>    fill <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: unvotes"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://gganimate.com/reference/shadow_wake.html">shadow_wake</a></span><span class="op" style="color: #5E5E5E;">(</span>wake_length <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.1</span>, wrap <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  </span>
<span><span class="fu" style="color: #4758AB;"><a href="https://gganimate.com/reference/animate.html">animate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">p</span>, fps <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">5</span>, end_pause <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/un/index_files/figure-html/pca-1.gif" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>France and the UK, for example, have remained particularly close given their historical ties and geographical proximity.</p>
<p>The UN’s <a href="http://research.un.org/en/docs/sc/quick/veto">Security Council Veto List</a> provides further insights on the changing profile of P5 voting over the decades.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">url</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"https://www.un.org/depts/dhl/resguide/scact_veto_table_en.htm"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">meeting_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">url</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_element.html">html_element</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">".tablefont"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_table.html">html_table</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span>vote_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>, draft <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, meeting <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>, agenda <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span>, vetoed_by <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">meeting_df2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">meeting_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    vote_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_date</span>, <span class="st" style="color: #20794D;">"-(?:\\d{2}|\\d)"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    vote_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_date</span>, format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%d %B %Y"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    vote_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_year</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_date</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"86"</span>, </span>
<span>                        <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_build.html">date_build</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1986</span>, <span class="fl" style="color: #AD0000;">01</span>, <span class="fl" style="color: #AD0000;">01</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">vote_date</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    vetoed_by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vetoed_by</span>, <span class="st" style="color: #20794D;">"USSR"</span>, <span class="st" style="color: #20794D;">"Russia"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    Russia <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vetoed_by</span>, <span class="st" style="color: #20794D;">"Russia"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">0</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    China <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vetoed_by</span>, <span class="st" style="color: #20794D;">"China"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">0</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    France <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vetoed_by</span>, <span class="st" style="color: #20794D;">"France"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">0</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    US <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vetoed_by</span>, <span class="st" style="color: #20794D;">"US"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">0</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    UK <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vetoed_by</span>, <span class="st" style="color: #20794D;">"UK"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">0</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">Russia</span><span class="op" style="color: #5E5E5E;">:</span><span class="va" style="color: #111111;">UK</span><span class="op" style="color: #5E5E5E;">)</span>, names_to <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"country"</span>, values_to <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"veto"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">veto</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">country_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">meeting_df2</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">country</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>country <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">country</span>, <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">cols2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">5</span>, name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"GrandBudapest2"</span>, type <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"continuous"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">little_plot</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">country_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">country</span>, <span class="va" style="color: #111111;">n</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">country</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols2</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"inward"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Most Vetoes"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: research.un.org"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">year_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">meeting_df2</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>year <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_year</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote_date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">country</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">to_date</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">meeting_df2</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">vote_date</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"%b %d, %y"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">big_plot</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">year_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">n</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">country</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span>show.legend <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols2</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1945</span>, <span class="fl" style="color: #AD0000;">2020</span>, <span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Veto Count"</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Security Council Vetoes to {to_date}"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">layout</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"AAB"</span></span>
<span><span class="va" style="color: #111111;">big_plot</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="va" style="color: #111111;">little_plot</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op" style="color: #5E5E5E;">(</span>design <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">layout</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/un/index_files/figure-html/plot-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 5%">
<col style="width: 94%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.character[2]; c[11]; format[1]; library[10]; max[3]; min[1]; seq[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">date_build[1]; date_parse[2]; get_year[5]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[4]; arrange[2]; count[2]; group_by[1]; if_else[7]; inner_join[1]; mutate[8]; n[2]; n_distinct[1]; pull[3]; recode[1]; row_number[1]; select[5]; slice[1]; summarise[3]; ungroup[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">forcats</td>
<td style="text-align: left;">fct_reorder[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gganimate</td>
<td style="text-align: left;">animate[1]; gganimate[1]; shadow_wake[1]; transition_time[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[5]; coord_flip[1]; element_text[1]; geom_col[2]; geom_label[2]; ggplot[3]; labs[3]; scale_fill_manual[3]; scale_x_continuous[1]; theme[1]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[3]</td>
</tr>
<tr class="even">
<td style="text-align: left;">patchwork</td>
<td style="text-align: left;">plot_layout[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">list_rbind[1]; map[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">rvest</td>
<td style="text-align: left;">html_element[1]; html_table[1]; read_html[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">prcomp[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_detect[5]; str_remove[1]; str_replace[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">as_tibble[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">complete[1]; fill[1]; nest[2]; nesting[1]; pivot_longer[1]; pivot_wider[1]; replace_na[1]; unnest[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tsibble</td>
<td style="text-align: left;">as_tsibble[1]; slide_tsibble[1]; tsibble[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">utils</td>
<td style="text-align: left;">data[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[2]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-gganimate" class="csl-entry">
Pedersen, Thomas Lin, and David Robinson. 2022. <span>“Gganimate: A Grammar of Animated Graphics.”</span> <a href="https://CRAN.R-project.org/package=gganimate">https://CRAN.R-project.org/package=gganimate</a>.
</div>
<div id="ref-unvotes" class="csl-entry">
Robinson, David. 2021. <span>“Unvotes: United Nations General Assembly Voting Data.”</span> <a href="https://CRAN.R-project.org/package=unvotes">https://CRAN.R-project.org/package=unvotes</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>dimension reduction</category>
  <category>animation</category>
  <guid>https://www.quantumjitter.com/project/un/index.html</guid>
  <pubDate>Wed, 09 Jan 2019 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/un/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Seeing the Wood for the Trees</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/wood/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/wood/feature.gif" class="img-fluid" alt="A small clump of trees with a &quot;Little Wood&quot; sign nailed to one of them. It's a dark starry night and a rabbit peers out at a thief tip-toeing away."></p>
<p>In <a href="../../project/forest">Criminal Goings-on</a> faceting offered a way to get a sense of the data. This is a great visualisation tool building on the principle of small multiples. There may come a point though where the sheer volume of small multiples make it harder to “see the wood for the trees”. What’s an alternative strategy?</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/hafen/trelliscopejs">trelliscopejs</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://hafen.github.io/rbokeh/">rbokeh</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/cherylisabella/vangogh">vangogh</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>This time I’ll use Van Gogh’s “The Starry Night” palette for the feature image and plots. And there are 9 types of criminal offence, so <code>colorRampPalette</code> will enable the interpolation of an extended set.</p>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/vangogh/man/vangogh_palette.html">vangogh_palette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"StarryNight"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/wood/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">cols9</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">9</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The data need a little tidy-up.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">url</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="st" style="color: #20794D;">"https://data.london.gov.uk/"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"download/recorded_crime_rates/"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"c051c7ec-c3ad-4534-bbfe-6bdfee2ef6bb/"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"crime%20rates.csv"</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">crime_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span>, col_types <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"cfcfdn"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    year <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="st" style="color: #20794D;">"(?:1999|200[0-9]|201[0-7])"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    year <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>number_of_offences <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">borough</span>, <span class="va" style="color: #111111;">offences</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="va" style="color: #111111;">offences</span> <span class="op" style="color: #5E5E5E;">!=</span> <span class="st" style="color: #20794D;">"All recorded offences"</span>,</span>
<span>    <span class="op" style="color: #5E5E5E;">!</span><span class="va" style="color: #111111;">borough</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"England and Wales"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Met Police Area"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Inner London"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Outer London"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>This was the original visualisation in <a href="../../project/forest">Criminal Goings-on</a> using ggplot’s <code>facet_wrap</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">crime_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>borough <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_wrap.html">str_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">borough</span>, <span class="fl" style="color: #AD0000;">11</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">number_of_offences</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">offences</span>, group <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">offences</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">borough</span>, scales <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"free_y"</span>, ncol <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"London Crime by Borough"</span>,</span>
<span>    colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Offence"</span>, caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols9</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op" style="color: #5E5E5E;">(</span>nrow <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    strip.background <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bottom"</span>,</span>
<span>    axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/wood/index_files/figure-html/facet-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>There are some nice alternatives which allow one to go deeper into the data whilst making the whole experience more consumable and engaging.</p>
<p>Switching <code>facet_wrap</code> for <code>facet_trelliscope</code> is a simple option. Or <code>trelliscope</code><span class="citation" data-cites="trelliscopejs">(Hafen and Schloerke 2021)</span> may be used in combination with the rbokeh <span class="citation" data-cites="rbokeh">(Hafen 2021)</span> (or plotly) packages. Irrespective of the option chosen, one can more flexibly display the several hundred “small multiple” panels required to go deeper into the crime data.</p>
<p>Pairing <code>trelliscope</code> with rbokeh permits the addition of some custom cognostics and additional interactivity. The slope cognostic, for example, enables filtering on the boroughs and types of offence exhibiting the steepest upward or downward trends.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">slope</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span>, <span class="va" style="color: #111111;">y</span><span class="op" style="color: #5E5E5E;">)</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">y</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span></span>
<span></span>
<span><span class="va" style="color: #111111;">plot_data</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">crime_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">borough</span>, <span class="va" style="color: #111111;">offences</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    additional_cogs <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/trelliscopejs/man/map_cog.html">map_cog</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">data</span>,</span>
<span>      <span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>        slope <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/trelliscopejs/man/cog.html">cog</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">slope</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.x</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">.x</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>          desc <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Steepness of the trend"</span></span>
<span>        <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>          <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>        mean_count <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/trelliscopejs/man/cog.html">cog</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.x</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>          desc <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Average count"</span></span>
<span>        <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>        iqr_count <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/trelliscopejs/man/cog.html">cog</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.x</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>          desc <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Interquartile range"</span></span>
<span>        <span class="op" style="color: #5E5E5E;">)</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    panel <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/trelliscopejs/man/map_plot.html">map_plot</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">data</span>,</span>
<span>      <span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;"><a href="https://hafen.github.io/rbokeh/reference/figure.html">figure</a></span><span class="op" style="color: #5E5E5E;">(</span>xlab <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Date"</span>, ylab <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Count"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>        <span class="fu" style="color: #4758AB;"><a href="https://hafen.github.io/rbokeh/reference/ly_lines.html">ly_lines</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">number_of_offences</span>, color <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">]</span>, </span>
<span>                 width <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>        <span class="fu" style="color: #4758AB;"><a href="https://hafen.github.io/rbokeh/reference/ly_points.html">ly_points</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">number_of_offences</span>,</span>
<span>          size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span>,</span>
<span>          fill_color <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">9</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>          hover <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">number_of_offences</span>, data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.x</span></span>
<span>        <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>        <span class="fu" style="color: #4758AB;"><a href="https://hafen.github.io/rbokeh/reference/theme_plot.html">theme_plot</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>          background_fill_color <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>          background_fill_alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span>        <span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A <a href="https://github.com/hafen/trelliscopejs/issues/122">Github issue</a> has been raised as the <code>trelliscope</code> will <em>not</em> render (knit) when publishing the page. Running the code chunks <em>will</em> however generate the expected <code>trelliscope</code>.</p>
<p>So, to get the <code>trelliscope below</code>: 1) run all the code chunks to generate the <code>appfiles</code> folder. 2) Set the following chunk to <code>#| eval: false</code>. 3) Use an <code>iframe</code> to display the <code>index.html</code> in the <code>appfiles</code> folder. 4) Set <code>resources: project/wood/appfiles/</code> under <code>project:</code> in the <code>_quarto.yml</code> file to ensure the <code>appfiles</code> folder is included in <code>_static</code>.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">plot_data</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/trelliscopejs/man/trelliscope.html">trelliscope</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"London Crime"</span>,</span>
<span>    desc <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.gov.uk"</span>,</span>
<span>    nrow <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>,</span>
<span>    ncol <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>,</span>
<span>    state <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      sort <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/trelliscopejs/man/sort_spec.html">sort_spec</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"slope"</span>, dir <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"desc"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"borough"</span>, <span class="st" style="color: #20794D;">"offences"</span>, <span class="st" style="color: #20794D;">"slope"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    path <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"appfiles"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<iframe src="../../project/wood/appfiles/index.html" width="100%" height="600" frameborder="0" allowfullscreen=""></iframe>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 6%">
<col style="width: 93%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.numeric[1]; c[4]; library[5]; list[2]; mean[1]; round[1]; sum[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[1]; mutate[3]; summarise[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[1]; element_rect[1]; element_text[1]; facet_wrap[1]; geom_line[1]; ggplot[1]; guide_legend[1]; guides[1]; labs[1]; scale_colour_manual[1]; theme[1]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">grDevices</td>
<td style="text-align: left;">colorRampPalette[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">janitor</td>
<td style="text-align: left;">clean_names[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">rbokeh</td>
<td style="text-align: left;">figure[1]; ly_lines[1]; ly_points[1]; theme_plot[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">readr</td>
<td style="text-align: left;">read_csv[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">IQR[1]; coef[1]; lm[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[1]; str_extract[1]; str_wrap[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">tibble[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">nest[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">trelliscopejs</td>
<td style="text-align: left;">cog[3]; map_cog[1]; map_plot[1]; sort_spec[1]; trelliscope[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">vangogh</td>
<td style="text-align: left;">vangogh_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-rbokeh" class="csl-entry">
Hafen, Ryan, and Continuum Analytics, Inc. 2021. <span>“Rbokeh: R Interface for Bokeh.”</span> <a href="https://CRAN.R-project.org/package=rbokeh">https://CRAN.R-project.org/package=rbokeh</a>.
</div>
<div id="ref-trelliscopejs" class="csl-entry">
Hafen, Ryan, and Barret Schloerke. 2021. <span>“Trelliscopejs: Create Interactive Trelliscope Displays.”</span> <a href="https://CRAN.R-project.org/package=trelliscopejs">https://CRAN.R-project.org/package=trelliscopejs</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>apps</category>
  <guid>https://www.quantumjitter.com/project/wood/index.html</guid>
  <pubDate>Tue, 01 Jan 2019 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/wood/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Can Ravens Forecast?</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/forecast/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/forecast/feature.gif" class="img-fluid" alt="A silhouette of the Houses of Parliament with rain pouring down on a man holding an umbrella and a raven swooping across the sky"></p>
<p>Humans have the magical ability to plan for future events, for future gain. It’s <a href="https://www.newscientist.com/article/2140668-ravens-can-plan-for-future-as-well-as-4-year-old-children-can/">not quite a uniquely human trait</a>. Because apparently ravens can match a four-year-old.</p>
<p>An abundance of data, and some very nice R packages, make our ability to plan all the more powerful.</p>
<p>In the Spring of 2018 I looked at sales from an historical perspective in <a href="../../project/six">Six Months Later.</a>. Here I’ll use the data to model a time-series forecast for the year ahead. The techniques apply to any time series with characteristics of trend, seasonality or longer-term cycles.</p>
<p>Why forecast sales? Business plans require a budget, e.g.&nbsp;for resources, marketing and office space. A good projection of revenue provides the foundation for the budget. And, for an established business, with historical data, time-series forecasting is one way to deliver a robust projection.</p>
<p>Without exogenous data, the forecast assumes one continues to do what one’s doing. So, it provides a good starting-point. Then one might, for example, add assumptions about new products or services. And, if there is forward-looking data available, for example, market size projections (with past projections to train the model), then one could feed this into the forecast modelling too.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/robjhyndman/fpp3-package">fpp3</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span>name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"IsleofDogs2"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forecast/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>First I’ll check the encoding of the data.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">url</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="st" style="color: #20794D;">"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">gcloud_csv</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span>, <span class="st" style="color: #20794D;">"703943/G-Cloud_spend_data_to_end_March_2018.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">dos_csv</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span>, <span class="st" style="color: #20794D;">"703952/DOS_spend_data_to_end_March_2018.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">names</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">gcloud_csv</span>, <span class="va" style="color: #111111;">dos_csv</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Use walk to suppress the printing of list element numbers</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">names</span>, \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="va" style="color: #111111;">p</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/encoding.html">guess_encoding</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">p</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  encoding   confidence
  &lt;chr&gt;           &lt;dbl&gt;
1 ISO-8859-1       0.4 
2 ISO-8859-2       0.22
# A tibble: 2 × 2
  encoding   confidence
  &lt;chr&gt;           &lt;dbl&gt;
1 ISO-8859-1       0.36
2 ISO-8859-2       0.24</code></pre>
</div>
</div>
<p>Next I’ll set up a vector of column names to apply consistently to both files, and import the data with the suggested encoding.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">colnam</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"sector"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"lot"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"date"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"spend"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"status"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"supplier"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"customer"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"framework"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">read_dm</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="va" style="color: #111111;">x</span>,</span>
<span>    col_names <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">colnam</span>,</span>
<span>    skip <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>,</span>
<span>    locale <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/locale.html">locale</a></span><span class="op" style="color: #5E5E5E;">(</span>encoding <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"ISO-8859-1"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    show_col_types <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span></span>
<span></span>
<span><span class="va" style="color: #111111;">raw</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">names</span>, <span class="va" style="color: #111111;">read_dm</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"gcloud"</span>, <span class="st" style="color: #20794D;">"dos"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>framework <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">framework</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"DOS"</span>, <span class="va" style="color: #111111;">framework</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>I’d like to create some new features: Month-end dates, something to distinguish between the two frameworks (<em>G-Cloud</em> or <em>DOS</em>). The spend has a messy format and needs a bit of cleaning too.</p>
<p>The lot structure for <em>G-Cloud</em> has evolved over time, but fortunately, there is a simple mapping, i.e.&nbsp;<em>PaaS</em> and <em>IaaS</em> became <em>Cloud Hosting</em>, <em>SaaS</em> became <em>Cloud Software</em>, and <em>Specialist Cloud Services</em> became <em>Cloud Support</em>, so I’ll standardise on the latter.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">both</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">raw</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    month_end <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, <span class="st" style="color: #20794D;">"01"</span>, sep <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"-"</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>                           format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%b-%y-%d"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-arithmetic.html">add_months</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-arithmetic.html">add_days</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">yearmonth</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">month_end</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    framework <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">framework</span>, <span class="st" style="color: #20794D;">".{3,7}"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/modifiers.html">coll</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"£"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, <span class="st" style="color: #20794D;">"^\\("</span>, <span class="st" style="color: #20794D;">"-"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/parse_number.html">parse_number</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">1000000</span>,</span>
<span>    lot <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">lot</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Software as a Service (SaaS)"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cloud Software"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Infrastructure as a Service (IaaS)"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cloud Hosting"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Platform as a Service (PaaS)"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cloud Hosting"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Specialist Cloud Services"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cloud Support"</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The tidied data now needs to be converted to a <a href="https://github.com/tidyverts/tsibble">tsibble</a><span class="citation" data-cites="tsibble">(Wang, Cook, and Hyndman 2020)</span>, the temporal equivalent of a <a href="https://tibble.tidyverse.org">tibble</a><span class="citation" data-cites="tibble">(Müller and Wickham 2022)</span>.</p>
<p>R has evolved since I first wrote this post. At that time, it was necessary to either split the data into the two frameworks (G-Cloud and DOS) and forecast them separately. Or, as I did with the three G-Cloud lots, use the purrr package to iterate through a forecast.</p>
<p>The tsibble package combined with the newer fable<span class="citation" data-cites="fable">(O’Hara-Wild, Hyndman, and Wang 2022a)</span> and feasts<span class="citation" data-cites="feasts">(O’Hara-Wild, Hyndman, and Wang 2022b)</span> packages, make this easier. One of the defining feature of the tsibble is the <code>key</code>. I want a model for each framework, so I’m setting this as the tsibble <code>key</code> (and the temporal variable as the tsibble <code>index</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">both_ts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">both</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, <span class="va" style="color: #111111;">framework</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">as_tsibble</span><span class="op" style="color: #5E5E5E;">(</span>key <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">framework</span>, index <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">date</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">both_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, <span class="va" style="color: #111111;">spend</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">framework</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span>key_glyph <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"timeseries"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span>prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>, suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Monthly Digital Marketplace Sales"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forecast/index_files/figure-html/plot sales-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>By decomposing the historical data we can tease out the underlying trend and seasonality:</p>
<ul>
<li><p><strong>Trend</strong>: The sales for both frameworks have grown over time as more Suppliers have added their services to the Government frameworks, and more Public Sector organizations have found the benefits of purchasing Cloud services through this faster, simpler, more transparent and more competitive contracting vehicle.</p></li>
<li><p><strong>Seasonality</strong>: Suppliers often manage their sales and financials based on a quarterly cycle, with a particular emphasis on a strong close to the financial year. And Government Buyers may want to make optimal use of their budgets at the close of their financial year (March 31st). Consequently, we see quarterly seasonality with an extra spike at financial year-end.</p></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">both_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">model</span><span class="op" style="color: #5E5E5E;">(</span>stl <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">STL</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;">trend</span><span class="op" style="color: #5E5E5E;">(</span>window <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">7</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">season</span><span class="op" style="color: #5E5E5E;">(</span>window <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"periodic"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">components</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Time Series Decomposition"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forecast/index_files/figure-html/decomposition-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>I’ll use <code>auto.arima</code>: <a href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average">AutoRegressive Integrated Moving Average</a> modelling which aims to describe the autocorrelations in the data.</p>
<p>By setting <code>stepwise</code> and <code>approximation</code> to <code>FALSE</code>, <code>auto.arima</code> will explore a wider range of potential models.</p>
<p>I’ll forecast with the default 80% and 95% prediction intervals. This means the darker-shaded 80% range should include the future sales value with an 80% probability. Likewise with a 95% probability when adding the wider and lighter-shaded area.</p>
<p>Use of <code>autoplot</code> would simplify the code, but personally I like to expose all the data, for example unpacking the prediction intervals, and have finer control over the visualisation.</p>
<div class="cell">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">mod_ts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">both_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">model</span><span class="op" style="color: #5E5E5E;">(</span>ARIMA <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">ARIMA</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, stepwise <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, approximation <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">mod_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">glance</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">ar_roots</span>, <span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">ma_roots</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">framework</th>
<th style="text-align: left;">.model</th>
<th style="text-align: right;">sigma2</th>
<th style="text-align: right;">log_lik</th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">AICc</th>
<th style="text-align: right;">BIC</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">DOS</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: right;">23.60154</td>
<td style="text-align: right;">-59.93305</td>
<td style="text-align: right;">123.8661</td>
<td style="text-align: right;">124.5720</td>
<td style="text-align: right;">125.8576</td>
</tr>
<tr class="even">
<td style="text-align: left;">G-Cloud</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: right;">34.75275</td>
<td style="text-align: right;">-191.61547</td>
<td style="text-align: right;">393.2309</td>
<td style="text-align: right;">394.3421</td>
<td style="text-align: right;">403.7027</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">mod_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">tidy</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 14%">
<col style="width: 10%">
<col style="width: 13%">
<col style="width: 16%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">framework</th>
<th style="text-align: left;">.model</th>
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">DOS</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">ma1</td>
<td style="text-align: right;">-0.7725018</td>
<td style="text-align: right;">0.1718541</td>
<td style="text-align: right;">-4.495102</td>
<td style="text-align: right;">0.0002213</td>
</tr>
<tr class="even">
<td style="text-align: left;">G-Cloud</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">ar1</td>
<td style="text-align: right;">0.9390150</td>
<td style="text-align: right;">0.0595354</td>
<td style="text-align: right;">15.772391</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">G-Cloud</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">ma1</td>
<td style="text-align: right;">-0.5777210</td>
<td style="text-align: right;">0.1094066</td>
<td style="text-align: right;">-5.280494</td>
<td style="text-align: right;">0.0000019</td>
</tr>
<tr class="even">
<td style="text-align: left;">G-Cloud</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">sar1</td>
<td style="text-align: right;">-0.5124417</td>
<td style="text-align: right;">0.1142670</td>
<td style="text-align: right;">-4.484597</td>
<td style="text-align: right;">0.0000336</td>
</tr>
<tr class="odd">
<td style="text-align: left;">G-Cloud</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">constant</td>
<td style="text-align: right;">1.4084703</td>
<td style="text-align: right;">0.3168155</td>
<td style="text-align: right;">4.445712</td>
<td style="text-align: right;">0.0000385</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">fcast_ts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">mod_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">forecast</span><span class="op" style="color: #5E5E5E;">(</span>h <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"2 years"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>`95%` <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">hilo</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, <span class="fl" style="color: #AD0000;">95</span><span class="op" style="color: #5E5E5E;">)</span>, `80%` <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">hilo</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, <span class="fl" style="color: #AD0000;">80</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">unpack_hilo</span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"95%"</span>, <span class="st" style="color: #20794D;">"80%"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span>fc_spend <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">spend</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">both_ts</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">fcast_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">framework</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>y <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">spend</span><span class="op" style="color: #5E5E5E;">)</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>ymin <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">`95%_lower`</span>, ymax <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">`95%_upper`</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>ymin <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">`80%_lower`</span>, ymax <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">`80%_upper`</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>y <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.mean</span><span class="op" style="color: #5E5E5E;">)</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span>prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>, suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">framework</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Digital Marketplace Sales Forecast by Framework"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Spend"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"80 &amp; 95% Prediction Intervals"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span>,</span>
<span>    axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forecast/index_files/figure-html/auto arima-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The G-Cloud framework compromises three lots: Cloud Hosting, Cloud Software and Cloud Support.</p>
<p>I previously combined <code>auto.arima</code> (from the forecast package) with functions from the sweep package, to create multiple forecasts in one shot. tsibble coupled fabletools handle this with the <code>key</code> set to the <code>lot</code> variable.</p>
<p>An alternative option is hierarchical time-series forecasting which models bottom-up, top-down or middle-out, and ensures the sum of the forecasts at the lower level sum to the top-level forecast. This approach has pros and cons and is not considered here.</p>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">gcloud_ts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">both</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">framework</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"G-Cloud"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, <span class="va" style="color: #111111;">lot</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">as_tsibble</span><span class="op" style="color: #5E5E5E;">(</span>key <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">lot</span>, index <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">date</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">gc_ts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">gcloud_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">model</span><span class="op" style="color: #5E5E5E;">(</span>ARIMA <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">ARIMA</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, stepwise <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, approximation <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">gc_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">glance</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">ar_roots</span>, <span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">ma_roots</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 21%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">lot</th>
<th style="text-align: left;">.model</th>
<th style="text-align: right;">sigma2</th>
<th style="text-align: right;">log_lik</th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">AICc</th>
<th style="text-align: right;">BIC</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Cloud Hosting</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: right;">1.347179</td>
<td style="text-align: right;">-109.3173</td>
<td style="text-align: right;">224.6346</td>
<td style="text-align: right;">224.9982</td>
<td style="text-align: right;">231.3801</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cloud Software</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: right;">2.275664</td>
<td style="text-align: right;">-107.5551</td>
<td style="text-align: right;">221.1102</td>
<td style="text-align: right;">221.5465</td>
<td style="text-align: right;">227.3428</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Cloud Support</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: right;">18.606529</td>
<td style="text-align: right;">-212.6556</td>
<td style="text-align: right;">435.3112</td>
<td style="text-align: right;">436.2342</td>
<td style="text-align: right;">446.6246</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">gc_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;">tidy</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 20%">
<col style="width: 9%">
<col style="width: 12%">
<col style="width: 15%">
<col style="width: 13%">
<col style="width: 15%">
<col style="width: 13%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">lot</th>
<th style="text-align: left;">.model</th>
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Cloud Hosting</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">ma1</td>
<td style="text-align: right;">-0.8269314</td>
<td style="text-align: right;">0.0765747</td>
<td style="text-align: right;">-10.799011</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cloud Hosting</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">constant</td>
<td style="text-align: right;">0.1713346</td>
<td style="text-align: right;">0.0258894</td>
<td style="text-align: right;">6.617935</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Cloud Software</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">ma1</td>
<td style="text-align: right;">-0.9981867</td>
<td style="text-align: right;">0.1304426</td>
<td style="text-align: right;">-7.652304</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cloud Software</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">ma2</td>
<td style="text-align: right;">0.2242994</td>
<td style="text-align: right;">0.1224834</td>
<td style="text-align: right;">1.831264</td>
<td style="text-align: right;">0.0721116</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Cloud Support</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">ma1</td>
<td style="text-align: right;">-0.7044948</td>
<td style="text-align: right;">0.0743797</td>
<td style="text-align: right;">-9.471597</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cloud Support</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">sma1</td>
<td style="text-align: right;">0.3878660</td>
<td style="text-align: right;">0.1458579</td>
<td style="text-align: right;">2.659205</td>
<td style="text-align: right;">0.0096735</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Cloud Support</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">sma2</td>
<td style="text-align: right;">0.7866476</td>
<td style="text-align: right;">0.4284425</td>
<td style="text-align: right;">1.836064</td>
<td style="text-align: right;">0.0705352</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cloud Support</td>
<td style="text-align: left;">ARIMA</td>
<td style="text-align: left;">constant</td>
<td style="text-align: right;">0.7601155</td>
<td style="text-align: right;">0.2889763</td>
<td style="text-align: right;">2.630373</td>
<td style="text-align: right;">0.0104520</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">fcgc_ts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">gc_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">forecast</span><span class="op" style="color: #5E5E5E;">(</span>h <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"2 years"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>`95%` <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">hilo</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, <span class="fl" style="color: #AD0000;">95</span><span class="op" style="color: #5E5E5E;">)</span>, `80%` <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">hilo</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, <span class="fl" style="color: #AD0000;">80</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">unpack_hilo</span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"95%"</span>, <span class="st" style="color: #20794D;">"80%"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span>fc_spend <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">spend</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">gcloud_ts</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">fcgc_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">lot</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>y <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">spend</span><span class="op" style="color: #5E5E5E;">)</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>ymin <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">`95%_lower`</span>, ymax <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">`95%_upper`</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>ymin <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">`80%_lower`</span>, ymax <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">`80%_upper`</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>y <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.mean</span><span class="op" style="color: #5E5E5E;">)</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span>prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>, suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">lot</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"G-Cloud Sales Forecast by Lot"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Spend"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"80 &amp; 95% Prediction Intervals"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span>,</span>
<span>    axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forecast/index_files/figure-html/by lot-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>So ravens are not yet ready for forecasting with R. But then neither are 4-year-olds, are they?</p>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 6%">
<col style="width: 93%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">c[9]; is.na[1]; library[5]; print[1]; sum[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">add_days[1]; add_months[1]; date_parse[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[1]; bind_rows[3]; if_else[1]; mutate[4]; recode[1]; rename[2]; select[2]; summarise[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">fable</td>
<td style="text-align: left;">ARIMA[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fabletools</td>
<td style="text-align: left;">components[1]; forecast[2]; glance[2]; hilo[4]; model[3]; tidy[2]; unpack_hilo[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">feasts</td>
<td style="text-align: left;">STL[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[11]; element_text[2]; facet_wrap[2]; geom_line[5]; geom_ribbon[4]; ggplot[3]; labs[4]; scale_colour_manual[2]; scale_y_continuous[3]; theme[2]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">map[1]; set_names[1]; walk[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">readr</td>
<td style="text-align: left;">guess_encoding[1]; locale[1]; parse_number[1]; read_csv[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">label_dollar[3]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">coll[1]; str_c[3]; str_extract[1]; str_remove[1]; str_replace[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tsibble</td>
<td style="text-align: left;">yearmonth[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-tibble" class="csl-entry">
Müller, Kirill, and Hadley Wickham. 2022. <span>“Tibble: Simple Data Frames.”</span> <a href="https://CRAN.R-project.org/package=tibble">https://CRAN.R-project.org/package=tibble</a>.
</div>
<div id="ref-fable" class="csl-entry">
O’Hara-Wild, Mitchell, Rob Hyndman, and Earo Wang. 2022a. <span>“Fable: Forecasting Models for Tidy Time Series.”</span> <a href="https://CRAN.R-project.org/package=fable">https://CRAN.R-project.org/package=fable</a>.
</div>
<div id="ref-feasts" class="csl-entry">
———. 2022b. <span>“Feasts: Feature Extraction and Statistics for Time Series.”</span> <a href="https://CRAN.R-project.org/package=feasts">https://CRAN.R-project.org/package=feasts</a>.
</div>
<div id="ref-tsibble" class="csl-entry">
Wang, Earo, Dianne Cook, and Rob J Hyndman. 2020. <span>“A New Tidy Data Structure to Support Exploration and Modeling of Temporal Data”</span> 29: 466–78. <a href="https://doi.org/10.1080/10618600.2019.1695624">https://doi.org/10.1080/10618600.2019.1695624</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>time series</category>
  <category>forecast</category>
  <guid>https://www.quantumjitter.com/project/forecast/index.html</guid>
  <pubDate>Sat, 28 Jul 2018 23:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/forecast/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Six Months Later</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/six/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/six/feature.gif" class="img-fluid" alt="A silhouette of the Houses of Parliament and three clouds in Spring colours, e.g. yellow and green. Flowers shoot up from the word &quot;Spring&quot;."></p>
<p>In September 2017 I wrote a post entitled <a href="../../project/jitter">Let’s Jitter</a>. It looked at how the SME share of sales evolved over time. I revisited this topic here six months later, along the way adding a splash of colour and some faceted plots.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>I’m using one of the beautiful range of <a href="https://github.com/karthik/wesanderson">Wes Anderson Palettes</a>. I often use the palettes provided by <a href="https://colorbrewer2.org/#type=sequential&amp;scheme=BuGn&amp;n=3">ColorBrewer</a> too.</p>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">9</span>, name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Chevalier1"</span>, type <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"continuous"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/six/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>In <a href="../../project/jitter">Let’s Jitter</a> I assumed the G-Cloud data file adopted the <a href="https://www.gov.uk/guidance/gds-api-technical-and-data-standards#use-unicode-for-encoding">UK Government standard</a> of UTF-8. I used the stringr package to fix any issues.</p>
<p>This time around, I’m importing the files for two frameworks (G-Cloud and DOS) after first checking the encoding to see if I can get a cleaner import. <code>guess_encoding</code> suggests these files use the ISO-8859-1 standard.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">url</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="st" style="color: #20794D;">"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">gcloud_csv</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span>, <span class="st" style="color: #20794D;">"678283/G-Cloud-spend-Dec2017.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">dos_csv</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span>, <span class="st" style="color: #20794D;">"678286/DOS-spend-Dec2017.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">names</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">gcloud_csv</span>, <span class="va" style="color: #111111;">dos_csv</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">names</span>, <span class="va" style="color: #111111;">guess_encoding</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
# A tibble: 2 × 2
  encoding   confidence
  &lt;chr&gt;           &lt;dbl&gt;
1 ISO-8859-1       0.39
2 ISO-8859-2       0.24

[[2]]
# A tibble: 2 × 2
  encoding   confidence
  &lt;chr&gt;           &lt;dbl&gt;
1 ISO-8859-1       0.44
2 ISO-8859-2       0.23</code></pre>
</div>
</div>
<p>Next I’ll set up a vector of column names to apply consistently to both files, import the data with the suggested encoding, and bind them into one tibble.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">colnam</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"sector"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"lot"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"month"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"spend"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"status"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"supplier"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"customer"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"framework"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">read_dm</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="va" style="color: #111111;">x</span>,</span>
<span>    col_names <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">colnam</span>,</span>
<span>    skip <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>,</span>
<span>    locale <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/locale.html">locale</a></span><span class="op" style="color: #5E5E5E;">(</span>encoding <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"ISO-8859-1"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    col_types <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    show_col_types <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span></span>
<span></span>
<span><span class="va" style="color: #111111;">combined_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">names</span>, <span class="va" style="color: #111111;">read_dm</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"gcloud"</span>, <span class="st" style="color: #20794D;">"dos"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>framework <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">framework</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"DOS"</span>, <span class="va" style="color: #111111;">framework</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>I’d like to create some new features: Month-end dates, something to distinguish between the two frameworks (<em>G-Cloud</em> or <em>DOS</em>) and the framework version (i.e.&nbsp;G-Cloud 1 to 9). The spend has a messy format and needs a bit of cleaning too.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">clean_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">combined_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    month_end <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">month</span>, <span class="st" style="color: #20794D;">"01"</span>, sep <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"-"</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>                           format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%b-%y-%d"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-arithmetic.html">add_months</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-arithmetic.html">add_days</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    version <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">framework</span>, <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/modifiers.html">fixed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"-Cloud "</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    version <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">version</span>, <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/modifiers.html">fixed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"G-Cloud"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"G1"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    version <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">version</span>, <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/modifiers.html">fixed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"GIII"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"G3"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    version <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">version</span>, <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/modifiers.html">fixed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"GServices II"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"G2"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    framework <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">framework</span>, <span class="st" style="color: #20794D;">".{3,7}"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/modifiers.html">fixed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"£"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, <span class="st" style="color: #20794D;">"^\\("</span>, <span class="st" style="color: #20794D;">"-"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/parse_number.html">parse_number</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    SME_spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">status</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"SME"</span>, <span class="va" style="color: #111111;">spend</span>, <span class="fl" style="color: #AD0000;">0</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Finding the interval between G-Cloud versions will enable me to calculate and print the average in the next paragraph using inline r code.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">version_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">clean_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">version</span> <span class="op" style="color: #5E5E5E;">!=</span> <span class="st" style="color: #20794D;">"DOS"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>start <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">month_end</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">version</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>next_start <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lead</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">start</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>         interval <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">lubridate</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">start</span>, <span class="va" style="color: #111111;">next_start</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Every 7.8 months, on average, suppliers are asked to resubmit their G-Cloud offerings with their latest pricing and service descriptions. It’s a chance for new suppliers, often smaller ones, to join the existing list of suppliers and increase overall competitiveness for Cloud services.</p>
<p>Let’s visualise how each of these framework versions grows, matures and fades away as the next one takes over.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">vers_summary</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">clean_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">version</span> <span class="op" style="color: #5E5E5E;">!=</span> <span class="st" style="color: #20794D;">"DOS"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>sales <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">1000000</span>,</span>
<span>            .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">version</span>, <span class="va" style="color: #111111;">month_end</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">vers_summary</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">month_end</span>, <span class="va" style="color: #111111;">sales</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">version</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op" style="color: #5E5E5E;">(</span>linewidth <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op" style="color: #5E5E5E;">(</span>date_breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"years"</span>, date_labels <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%Y"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span>prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>, suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"The Lifecycle of G-Cloud Versions"</span>, </span>
<span>       subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Monthly Sales by Version"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"\nSource: GOV.UK's Digital Marketplace"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/six/index_files/figure-html/lifecycle-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p><a href="../../project/jitter">Let’s Jitter</a> showed signs of a weakening in the SME share of G-Cloud sales by value. This plot shows this trend to have persisted, and also reflects the Digital Outcomes &amp; Specialists (DOS) framework exhibiting a downward trend.</p>
<div class="cell">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">fw_summary</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">clean_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>pct <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">SME_spend</span>, na.rm <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, na.rm <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">framework</span>, <span class="va" style="color: #111111;">month_end</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">fw_summary</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">month_end</span>, <span class="va" style="color: #111111;">pct</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">framework</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op" style="color: #5E5E5E;">(</span>linewidth <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">0.25</span>, <span class="fl" style="color: #AD0000;">0.5</span>, <span class="fl" style="color: #AD0000;">0.75</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>, labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op" style="color: #5E5E5E;">(</span>date_breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"years"</span>, date_labels <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%Y"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">9</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, </span>
<span>       title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"The Waning SME Share of Sales"</span>, </span>
<span>       subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"% Monthly Sales Value via SME (vs Large Enterprise) Suppliers"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"\nSource: GOV.UK's Digital Marketplace"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/six/index_files/figure-html/trend-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Overall spending via the combined frameworks however continues to grow across all parts of Public Sector. I’ll use a <a href="https://en.wikipedia.org/wiki/Small_multiple">small multiples</a> visualisation technique to show this using ggplot2’s<span class="citation" data-cites="ggplot2">(Wickham 2016)</span> <code>facet_wrap</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">sect_summary</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">clean_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">!</span><span class="va" style="color: #111111;">sector</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"Unregistered or Unknown"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"Utility (Historic)"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"Wider Public Sector"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    sales <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">1000000</span>,</span>
<span>    pct <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">SME_spend</span>, na.rm <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend</span>, na.rm <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sector</span>, <span class="va" style="color: #111111;">month_end</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">sect_summary</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">month_end</span>, <span class="va" style="color: #111111;">sales</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">sector</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op" style="color: #5E5E5E;">(</span>size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">sector</span>, scales <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"free_y"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op" style="color: #5E5E5E;">(</span>date_breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"years"</span>, date_labels <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%Y"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span>prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>, suffix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"m"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, </span>
<span>       title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"All Sectors Increase Digital Marketplace Spend"</span>, </span>
<span>       subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"G-Cloud &amp; DOS Spend by Sector"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"\nSource: GOV.UK's Digital Marketplace"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/six/index_files/figure-html/multiples-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The decline in the proportion of spend via SMEs is also fairly broad-based.</p>
<div class="cell">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">sect_summary</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">month_end</span>, <span class="va" style="color: #111111;">pct</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">sector</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op" style="color: #5E5E5E;">(</span>size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">sector</span>, scales <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"free_y"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op" style="color: #5E5E5E;">(</span>date_breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"years"</span>, date_labels <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%Y"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, </span>
<span>       title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Most Sectors Spend Proportionately Less on SMEs"</span>, </span>
<span>       subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Pct SME G-Cloud &amp; DOS Spend by Sector"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"\nSource: GOV.UK's Digital Marketplace"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/six/index_files/figure-html/proportion-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 6%">
<col style="width: 93%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">c[9]; is.na[1]; library[4]; min[1]; months[1]; sum[6]; version[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">add_days[1]; add_months[1]; date_parse[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[3]; bind_rows[1]; if_else[2]; lead[1]; mutate[3]; summarise[4]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[4]; facet_wrap[2]; geom_line[4]; geom_smooth[4]; ggplot[4]; labs[8]; scale_colour_manual[4]; scale_x_date[4]; scale_y_continuous[4]; theme[2]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">map[2]; set_names[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">readr</td>
<td style="text-align: left;">guess_encoding[1]; locale[1]; parse_number[1]; read_csv[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">label_dollar[2]; label_percent[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">start[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">fixed[5]; str_c[3]; str_extract[1]; str_remove[2]; str_replace[4]</td>
</tr>
<tr class="even">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-ggplot2" class="csl-entry">
Wickham, Hadley. 2016. <span>“Ggplot2: Elegant Graphics for Data Analysis.”</span> <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <guid>https://www.quantumjitter.com/project/six/index.html</guid>
  <pubDate>Sun, 01 Apr 2018 23:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/six/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Criminal Goings-on in a Random Forest</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/forest/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/forest/feature.gif" class="img-fluid" alt="A micro-forest in the middle of nowhere has the sign &quot;Random Forest&quot; nailed to a tree. A white rabbit peers out at a thief tip-toeing away with a bag labelled &quot;swag&quot;.."></p>
<p>When first posted in 2018 this project used the caret package to model <a href="https://data.gov.uk/dataset">crime in London</a>. Since then, the newer <a href="https://www.tidymodels.org">tidymodels</a><span class="citation" data-cites="tidymodels">(Kuhn and Wickham 2020)</span> framework, consistent with tidy data principles, has rapidly evolved.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/koalaverse/vip/">vip</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidymodels/poissonreg">poissonreg</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>This custom palette was created in <a href="https://color.adobe.com/create/color-wheel">Adobe Colour</a> as the basis for the feature image above and with the hex codes loaded for use in ggplot. <code>colorRampPalette</code> enables interpolation of an extended set of colours to support the number of offence types.</p>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"#798E87"</span>, <span class="st" style="color: #20794D;">"#C27D38"</span>, <span class="st" style="color: #20794D;">"#CCC591"</span>, <span class="st" style="color: #20794D;">"#29211F"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">4</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span>, <span class="va" style="color: #111111;">y</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span>, vjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"label"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2.5</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span>,</span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Custom Pallette"</span>,</span>
<span>    fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span>,</span>
<span>    alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.8</span>,</span>
<span>    size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">cols10</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">url</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="st" style="color: #20794D;">"https://data.london.gov.uk/"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"download/recorded_crime_rates/"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"c051c7ec-c3ad-4534-bbfe-6bdfee2ef6bb/"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"crime%20rates.csv"</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span>, col_types <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"cfcfdn"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    year <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="st" style="color: #20794D;">"(?:1999|200[0-9]|201[0-7])"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="co" style="color: #5E5E5E;"># 1999-2007</span></span>
<span>    year <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>number_of_offences <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">borough</span>, <span class="va" style="color: #111111;">offences</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>A faceted plot is one way to get a sense of the data.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>borough <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_wrap.html">str_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">borough</span>, <span class="fl" style="color: #AD0000;">11</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">number_of_offences</span>, </span>
<span>             colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">offences</span>, group <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">offences</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">borough</span>, scales <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"free_y"</span>, ncol <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"London Crime by Borough"</span>,</span>
<span>    colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Offence"</span>, caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols10</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op" style="color: #5E5E5E;">(</span>nrow <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bottom"</span>,</span>
<span>    axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/facet-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Visualising data in small multiples using <code>facet_wrap</code> or <code>facet_grid</code> can be a useful way to explore data. When there are a larger number of these however, as we’re starting to see in the example above, there are alternative techniques one can employ. This is explored in <a href="../../project/wood">Seeing the Wood for the Trees</a>.</p>
<p>Nonetheless, one can anyway see there are data aggregated at multiple levels. So to net these data down to purely borough-level, I’ll filter out the summarised rows, for example, “England and Wales” and “Inner London”.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">crime_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">raw_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="va" style="color: #111111;">offences</span> <span class="op" style="color: #5E5E5E;">!=</span> <span class="st" style="color: #20794D;">"All recorded offences"</span>,</span>
<span>    <span class="op" style="color: #5E5E5E;">!</span><span class="va" style="color: #111111;">borough</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"England and Wales"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Met Police Area"</span>, </span>
<span>      <span class="st" style="color: #20794D;">"Inner London"</span>, </span>
<span>      <span class="st" style="color: #20794D;">"Outer London"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>There are 9 types of offence in 33 boroughs. The dataset covers the period 1999 to 2016.</p>
<p>The faceted plot hints at a potential interaction between borough and type of offence. In more affluent boroughs, and/or those attracting greater visitor numbers, e.g.&nbsp;Westminster and Kensington &amp; Chelsea, “theft and handling” is the more dominant category. In Lewisham, for example, “violence against the person” exhibits higher counts. However, for the purpose of this basic model comparison, I’m going to set aside the potential interaction term.</p>
<p>Before modelling, I’ll visualise the dependent variable against each independent variable.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">crime_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>number_of_offences <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">offences</span>, <span class="va" style="color: #111111;">borough</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    median_offences <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    offences <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_wrap.html">str_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">offences</span>, <span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">offences</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">offences</span>, <span class="va" style="color: #111111;">median_offences</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_number.html">label_number</a></span><span class="op" style="color: #5E5E5E;">(</span>scale_cut <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/number.html">cut_short_scale</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Number of Offences by Type"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/by type-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">crime_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>number_of_offences <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">offences</span>, <span class="va" style="color: #111111;">borough</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    median_offences <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    offences <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_wrap.html">str_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">offences</span>, <span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">borough</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">borough</span>, <span class="va" style="color: #111111;">median_offences</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_number.html">label_number</a></span><span class="op" style="color: #5E5E5E;">(</span>scale_cut <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/number.html">cut_short_scale</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Number of Offences by Borough"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/by borough-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The offences and borough variables show significant variation in crime counts. And there is also evidence of a change over time.</p>
<div class="cell">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">crime_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>number_of_offences <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">year</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">year</span>, <span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">]</span>, linetype <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"dashed"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">]</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_number.html">label_number</a></span><span class="op" style="color: #5E5E5E;">(</span>scale_cut <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/number.html">cut_short_scale</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Number of Offences by Year"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: data.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/by year-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>I’ll separate out some test data so I can compare the performance of the models on data they have not see during model training.</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">123</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">data_split</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">crime_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">initial_split</span><span class="op" style="color: #5E5E5E;">(</span>strata <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">offences</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">crime_train</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_split</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">training</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">crime_test</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_split</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">testing</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>I’m using the recipes package to establish the role of the variables. Alternatively I could have used a formula-based approach, i.e.&nbsp;<code>number_of_offences ~ borough + offences + year</code>.</p>
<p>Whilst <code>borough</code> and <code>offences</code> are nominal, I’m not creating any dummy variables since I intend to use tree-based models which will anyway branch left and right based on groups of values.</p>
<div class="cell">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">crime_recipe</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">crime_train</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">recipe</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">update_role</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span>, new_role <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"outcome"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">update_role</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="fu" style="color: #4758AB;">has_role</span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"outcome"</span><span class="op" style="color: #5E5E5E;">)</span>, new_role <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"predictor"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_recipe</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 27%">
<col style="width: 44%">
<col style="width: 14%">
<col style="width: 13%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: left;">type</th>
<th style="text-align: left;">role</th>
<th style="text-align: left;">source</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">year</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">borough</td>
<td style="text-align: left;">factor , unordered, nominal</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="odd">
<td style="text-align: left;">offences</td>
<td style="text-align: left;">factor , unordered, nominal</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">number_of_offences</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">outcome</td>
<td style="text-align: left;">original</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>I’ll start with a Recursive Partitioning And Regression Trees (rpart) model. The feature importance plot tells me which variables are having the biggest influence on the model. The type of offence is the most important predictor in the rpart model, followed by the location of the offences. This makes intuitive sense.</p>
<p>Clearly there is a temporal component too otherwise there would be no trend.</p>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">rp_model</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/decision_tree.html">decision_tree</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"rpart"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_args.html">set_mode</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"regression"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">rp_wflow</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">workflow</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_recipe</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_recipe</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_model</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">rp_model</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">rp_fit</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">rp_wflow</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_train</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">rp_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">extract_fit_parsnip</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/vip/man/vip.html">vip</a></span><span class="op" style="color: #5E5E5E;">(</span>aesthetics <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Feature Importance -- rpart"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/rpart-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">rp_results</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">rp_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_test</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>model <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"rpart"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Ranger is an implementation of random forests or recursive partitioning that, according to the documentation, is particularly suited to high dimensional data. My data is not high-dimensional, but let’s throw it into the mix.</p>
<div class="cell">
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">ranger_model</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html">rand_forest</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"ranger"</span>, importance <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"impurity"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_args.html">set_mode</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"regression"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">ranger_wflow</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">workflow</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_recipe</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_recipe</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_model</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">ranger_model</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">ranger_fit</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">ranger_wflow</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_train</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">ranger_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">extract_fit_parsnip</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/vip/man/vip.html">vip</a></span><span class="op" style="color: #5E5E5E;">(</span>aesthetics <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Feature Importance -- Ranger"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/ranger-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">ranger_results</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">ranger_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_test</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>model <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"ranger"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>And of course my project title would make little sense without a Random Forest.</p>
<div class="cell">
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">rf_model</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html">rand_forest</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"randomForest"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_args.html">set_mode</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"regression"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">rf_wflow</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">workflow</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_recipe</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_recipe</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_model</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">rf_model</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">rf_fit</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">rf_wflow</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_train</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">rf_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">extract_fit_parsnip</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/vip/man/vip.html">vip</a></span><span class="op" style="color: #5E5E5E;">(</span>aesthetics <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"grey60"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Feature Importance -- Random Forest"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/forest-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">rf_results</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">rf_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_test</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>model <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"random forest"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>For good measure, I’ll also include a generalized linear model (glm)</p>
<div class="cell">
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">poisson_model</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html">poisson_reg</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"glm"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_args.html">set_mode</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"regression"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">poisson_wflow</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">workflow</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_recipe</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_recipe</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_model</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">poisson_model</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">poisson_fit</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">poisson_wflow</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_train</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">poisson_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">extract_fit_parsnip</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/vip/man/vip.html">vip</a></span><span class="op" style="color: #5E5E5E;">(</span>aesthetics <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Feature Importance -- glm"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/poisson-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">poisson_results</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">poisson_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crime_test</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>model <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"glm"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The Random Forest and the glm models performed the best here, with the former edging the Mean Absolute Error and R Squared metrics, and the latter with its nose in front on the Root Mean Squared Error.</p>
<div class="cell">
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">model_results</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">rp_results</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">ranger_results</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">rf_results</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">poisson_results</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">model</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">metrics</span><span class="op" style="color: #5E5E5E;">(</span>truth <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">number_of_offences</span>, estimate <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.pred</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">model_results</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">model</span>, <span class="va" style="color: #111111;">.estimate</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">model</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.estimate</span>, <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">.metric</span>, scales <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"free_y"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">4</span>, <span class="fl" style="color: #AD0000;">5</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Comparison of Model Metrics"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>        legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/results-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Another way of approaching all this would be to use time-series forecasting. This would major on auto-regression, i.e.&nbsp;looking at how the lagged number-of-offences influence future values. And one could further include exogenous data such as, say, the numbers of police. It would be reasonable to expect that increasing police numbers would, in time, lead to decreased crime levels.</p>
<p>I explored time-series in other posts such as <a href="../../project/planning">Digging Deep</a>, so I won’t go down that path here.</p>
<p>What I could do though is to strengthen my tree-based models above by engineering some additional temporal features. Let’s try that just with the Random Forest to see if it improves the outcome.</p>
<div class="cell">
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">temp_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">crime_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>num_lag1 <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>         num_lag2 <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span>, <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>         num_lag3 <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span>, <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>So, when predicting the number of offences, the model will now additionally consider, for each borough, type of offence and year, the number of offences in each of the three prior years.</p>
<div class="cell">
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">123</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">data_split</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">temp_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">initial_split</span><span class="op" style="color: #5E5E5E;">(</span>strata <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">offences</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">temp_train</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_split</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">training</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">temp_test</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_split</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">testing</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">temp_recipe</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">temp_train</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">recipe</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">update_role</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">number_of_offences</span>, new_role <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"outcome"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">update_role</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="fu" style="color: #4758AB;">has_role</span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"outcome"</span><span class="op" style="color: #5E5E5E;">)</span>, new_role <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"predictor"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">temp_recipe</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 27%">
<col style="width: 44%">
<col style="width: 14%">
<col style="width: 13%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: left;">type</th>
<th style="text-align: left;">role</th>
<th style="text-align: left;">source</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">year</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">borough</td>
<td style="text-align: left;">factor , unordered, nominal</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="odd">
<td style="text-align: left;">offences</td>
<td style="text-align: left;">factor , unordered, nominal</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">number_of_offences</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">outcome</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="odd">
<td style="text-align: left;">num_lag1</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">num_lag2</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="odd">
<td style="text-align: left;">num_lag3</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">temp_model</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html">rand_forest</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"randomForest"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://parsnip.tidymodels.org/reference/set_args.html">set_mode</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"regression"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">temp_wflow</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">workflow</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_recipe</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">temp_recipe</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">add_model</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">temp_model</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">temp_fit</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">temp_wflow</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">temp_train</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">temp_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">extract_fit_parsnip</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/vip/man/vip.html">vip</a></span><span class="op" style="color: #5E5E5E;">(</span>aesthetics <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Feature Importance -- Random Forest with Lags"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/forest2-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">temp_results</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">temp_fit</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">temp_test</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">metrics</span><span class="op" style="color: #5E5E5E;">(</span>truth <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">number_of_offences</span>, estimate <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">.pred</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>model <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"rf with lags"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The recipe summary includes the three new predictors. And the feature importance plot shows the lags playing a larger role in the model than the <code>year</code> variable, so looks like we should anticipate a model improvement.</p>
<div class="cell">
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">updated_results</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">model_results</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">temp_results</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">updated_results</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">model</span>, <span class="va" style="color: #111111;">.estimate</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">model</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.estimate</span>, <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">.metric</span>, scales <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"free_y"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">4</span>, <span class="fl" style="color: #AD0000;">5</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Comparison of Model Metrics"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>        legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/forest/index_files/figure-html/results2-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The model metrics bear this out. The <code>mae</code> and <code>rmse</code> are markedly smaller, and the <code>rsq</code> significantly improved. We could have tried further lags. We could have tried tweaking some parameters. We could have tried time-series forecasting with, for example a statistical model like ARIMA, or a Neural Network model such as NNETAR.</p>
<p>The best approach would depend upon a more precise definition of the objective. And some trial and error, comparing approaches after more extensive feature-engineering, validation, testing and tuning. For the purposes of this post though I wanted to merely explore some techniques. So I’ll leave it there.</p>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 2%">
<col style="width: 97%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.character[3]; as.numeric[1]; c[7]; library[6]; list[5]; round[2]; set.seed[2]; sum[4]; summary[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[1]; bind_rows[4]; group_by[1]; mutate[10]; summarise[4]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">forcats</td>
<td style="text-align: left;">fct_inorder[1]; fct_reorder[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[10]; annotate[1]; coord_flip[1]; element_text[3]; facet_wrap[3]; geom_boxplot[2]; geom_col[3]; geom_label[3]; geom_line[2]; geom_smooth[1]; ggplot[7]; guide_legend[1]; guides[1]; labs[11]; scale_colour_manual[1]; scale_fill_manual[3]; scale_y_continuous[1]; scale_y_log10[2]; theme[4]; theme_bw[1]; theme_set[1]; theme_void[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">grDevices</td>
<td style="text-align: left;">colorRampPalette[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">janitor</td>
<td style="text-align: left;">clean_names[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">parsnip</td>
<td style="text-align: left;">decision_tree[1]; poisson_reg[1]; rand_forest[3]; set_engine[5]; set_mode[5]</td>
</tr>
<tr class="even">
<td style="text-align: left;">readr</td>
<td style="text-align: left;">read_csv[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">recipes</td>
<td style="text-align: left;">has_role[2]; recipe[2]; update_role[4]</td>
</tr>
<tr class="even">
<td style="text-align: left;">rsample</td>
<td style="text-align: left;">initial_split[2]; testing[2]; training[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">cut_short_scale[3]; label_number[3]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">median[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[1]; str_extract[1]; str_wrap[3]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">tibble[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">drop_na[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">vip</td>
<td style="text-align: left;">vip[6]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">workflows</td>
<td style="text-align: left;">add_model[5]; add_recipe[5]; workflow[5]</td>
</tr>
<tr class="even">
<td style="text-align: left;">yardstick</td>
<td style="text-align: left;">metrics[2]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-tidymodels" class="csl-entry">
Kuhn, Max, and Hadley Wickham. 2020. <span>“Tidymodels: A Collection of Packages for Modeling and Machine Learning Using Tidyverse Principles.”</span> <a href="https://www.tidymodels.org">https://www.tidymodels.org</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>machine learning</category>
  <guid>https://www.quantumjitter.com/project/forest/index.html</guid>
  <pubDate>Thu, 01 Mar 2018 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/forest/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Plots Thicken</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/thicken/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/thicken/feature.gif" class="img-fluid" alt="The keys of a typewriter with &quot;R&quot; highlighted and the word &quot;plot&quot; being typed"></p>
<p>One could think of data science as “art grounded in facts”. It tells a story through visualisation. Both story and visualisation rely on a good plot. And an abundance of those has evolved over time. Many have their own dedicated Wikipedia page <iconify-icon inline="" icon="iconoir:emoji-surprise-alt"></iconify-icon>.</p>
<p>Which generate the most interest? How is the interest trending over time? Let’s build an interactive app to find out.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">gridlayout</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/ironholds/pageviews">pageviews</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://rstudio.github.io/bslib/">bslib</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">8</span>, name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"IsleofDogs1"</span>, type <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"continuous"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/thicken/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>I’m going to start by harvesting some data from Wikipedia’s <a href="https://en.wikipedia.org/wiki/Category:Statistical_charts_and_diagrams">Statistical charts and diagrams category</a>. I can use this to build a list of all chart types which have a dedicated Wikipedia article page. Using rvest <span class="citation" data-cites="rvest">(Wickham 2022)</span> inside the app ensures it will respond to any newly-created articles.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">charts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    chart <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"https://en.wikipedia.org/wiki/"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"Category:Statistical_charts_and_diagrams"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_element.html">html_elements</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">".mw-category-group a"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The pageviews <span class="citation" data-cites="pageviews">(Keyes and Lewis 2020)</span> package provides an API into Wikipedia. I’ll create a function wrapped around <code>article_pageviews</code> so I can later iterate through a subset of the list established in the prior code chunk.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">pv</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">article</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/pageviews/man/article_pageviews.html">article_pageviews</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    project <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"en.wikipedia"</span>,</span>
<span>    <span class="va" style="color: #111111;">article</span>,</span>
<span>    user_type <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"user"</span>,</span>
<span>    start <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"2015070100"</span>,</span>
<span>    end <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://lubridate.tidyverse.org/reference/now.html">today</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span></span></code></pre></div>
</div>
<p>I want an input selector so that a user can choose plot types for comparison. I also want to provide user control of the y-axis scale. A combination of <em>fixed</em> and <em>log10</em> is better for comparing plots. <em>Free</em> scaling reveals more detail in the individual trends.</p>
<p>Although <a href="https://rstudio.github.io/shinyuieditor/">shinyuieditor</a> <span class="citation" data-cites="shinyuieditor">(Strayer 2022)</span>&nbsp;is currently in Alpha at the time of this update, using <code>launch_editor("/content/project/thicken/")</code> helped me modify the basic grid layout of the UI for this pre-existing <code>app.R</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">ui</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/gridlayout/man/grid_page.html">grid_page</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  theme <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rstudio.github.io/bslib/reference/bs_theme.html">bs_theme</a></span><span class="op" style="color: #5E5E5E;">(</span>version <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">5</span>, bootswatch <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"simplex"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  layout <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"header  header"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"sidebar line "</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  row_sizes <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"100px"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"1fr"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  col_sizes <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"250px"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"1fr"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  gap_size <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"1rem"</span>,</span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/gridlayout/man/grid_card.html">grid_card</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    area <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"sidebar"</span>,</span>
<span>    item_alignment <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"top"</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Options"</span>,</span>
<span>    item_gap <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"13px"</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://shiny.rstudio.com/reference/shiny/latest/dateRangeInput.html">dateRangeInput</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"dates"</span>,</span>
<span>      label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Date range"</span>,</span>
<span>      start <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"2015-07-01"</span>,</span>
<span>      end <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://shiny.rstudio.com/reference/shiny/latest/selectInput.html">selectizeInput</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      inputId <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"article"</span>,</span>
<span>      label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Chart type"</span>,</span>
<span>      choices <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">charts</span>,</span>
<span>      selected <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>        <span class="st" style="color: #20794D;">"Violin plot"</span>,</span>
<span>        <span class="st" style="color: #20794D;">"Dendrogram"</span>,</span>
<span>        <span class="st" style="color: #20794D;">"Histogram"</span>,</span>
<span>        <span class="st" style="color: #20794D;">"Pie chart"</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      options <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span>maxItems <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">8</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      multiple <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://shiny.rstudio.com/reference/shiny/latest/selectInput.html">selectInput</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      inputId <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"scales"</span>,</span>
<span>      label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Fixed or free y-axis"</span>,</span>
<span>      choices <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Fixed"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"fixed"</span>, <span class="st" style="color: #20794D;">"Free"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"free"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      selected <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"fixed"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://shiny.rstudio.com/reference/shiny/latest/selectInput.html">selectInput</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      inputId <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"log10"</span>,</span>
<span>      label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Log 10 or normal y-axis"</span>,</span>
<span>      choices <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Log 10"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"log10"</span>, <span class="st" style="color: #20794D;">"Normal"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"norm"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      selected <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"log10"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/gridlayout/man/grid_card_text.html">grid_card_text</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    area <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"header"</span>,</span>
<span>    content <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"   Plot Plotter   "</span>,</span>
<span>    alignment <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"center"</span>,</span>
<span>    is_title <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span>,</span>
<span>    icon <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"logo1.png"</span>,</span>
<span>    img_height <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">30</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/gridlayout/man/grid_card_plot.html">grid_card_plot</a></span><span class="op" style="color: #5E5E5E;">(</span>area <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"line"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The server component outputs a faceted ggplot.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">server</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">input</span>, <span class="va" style="color: #111111;">output</span>, <span class="va" style="color: #111111;">session</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="va" style="color: #111111;">subsetr</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://shiny.rstudio.com/reference/shiny/latest/reactive.html">reactive</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">{</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://shiny.rstudio.com/reference/shiny/latest/req.html">req</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">input</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">article</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="va" style="color: #111111;">pageviews</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">input</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">article</span>, <span class="va" style="color: #111111;">pv</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>        date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>        article <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">article</span>, <span class="st" style="color: #20794D;">"_"</span>, <span class="st" style="color: #20794D;">" "</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span> <span class="op" style="color: #5E5E5E;">&gt;=</span> <span class="va" style="color: #111111;">input</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">dates</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>, <span class="va" style="color: #111111;">date</span> <span class="op" style="color: #5E5E5E;">&lt;=</span> <span class="va" style="color: #111111;">input</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">dates</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span>  <span class="va" style="color: #111111;">output</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">line</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://shiny.rstudio.com/reference/shiny/latest/renderPlot.html">renderPlot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">{</span></span>
<span>    <span class="va" style="color: #111111;">p</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="fu" style="color: #4758AB;">subsetr</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>,</span>
<span>        <span class="va" style="color: #111111;">views</span>,</span>
<span>        colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">article</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">7</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">article</span>, nrow <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>, scales <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">input</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">scales</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>        legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span>,</span>
<span>        axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>        plot.margin <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="st" style="color: #20794D;">"cm"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>        x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>        caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"\nSource: Daily Wikipedia Article Page Views"</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span>    <span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">input</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">log10</span>,</span>
<span>      norm <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">p</span>,</span>
<span>      log10 <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">p</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>        labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_number.html">label_number</a></span><span class="op" style="color: #5E5E5E;">(</span>scale_cut <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/number.html">cut_short_scale</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://shiny.rstudio.com/reference/shiny/latest/shinyApp.html">shinyApp</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">ui</span>, <span class="va" style="color: #111111;">server</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>And here’s the live shiny <span class="citation" data-cites="shiny">(Chang et al. 2022)</span> app deployed via <a href="https://www.shinyapps.io">shinyapps.io</a>.</p>
<iframe src="https://quantumjitter.shinyapps.io/thicken/" width="100%" height="700" scrolling="no" frameborder="0"></iframe>
<p>Note the utility of selecting the right scaling. The combination of “fixed” and “normal” reveals what must have been “world histogram day” on July 27th 2015, but little else.</p>
<p>Turning non-interactive code into an app sharpens the mind’s focus on performance. And profvis <span class="citation" data-cites="profvis">(Chang, Luraschi, and Mastny 2020)</span>, integrated into RStudio via the profile menu option, is a wonderful “tool for helping you understand how R spends its time”.</p>
<p>My first version of the app was finger-tappingly slow.</p>
<p>Profvis revealed the main culprit to be the pre-loading of a dataframe with the page-view data for all chart types (there are more than 100). Profiling prompted the more efficient “reactive” approach of loading the data only for the user’s selection (maximum of 8).</p>
<p>Profiling also showed that rounding the corners of the plot.background with additional grid-package code was expensive. App efficiency felt more important than minor cosmetic detailing (to the main panel to match the theme’s side panel). And most users would probably barely notice (had I not drawn attention to it here).</p>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 5%">
<col style="width: 94%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">c[6]; library[9]; list[1]; switch[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">bslib</td>
<td style="text-align: left;">bs_theme[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[1]; mutate[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[1]; element_text[1]; facet_wrap[1]; geom_line[1]; geom_smooth[1]; ggplot[1]; labs[1]; margin[1]; scale_colour_manual[1]; scale_y_log10[1]; theme[1]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gridlayout</td>
<td style="text-align: left;">grid_card[1]; grid_card_plot[1]; grid_card_text[1]; grid_page[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">lubridate</td>
<td style="text-align: left;">today[1]; ymd[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pageviews</td>
<td style="text-align: left;">article_pageviews[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">list_rbind[1]; map[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rvest</td>
<td style="text-align: left;">html_elements[1]; html_text[1]; read_html[1]; session[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">cut_short_scale[1]; label_number[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">shiny</td>
<td style="text-align: left;">dateRangeInput[1]; reactive[1]; renderPlot[1]; req[1]; selectInput[2]; selectizeInput[1]; shinyApp[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[1]; str_replace_all[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">tibble[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-shiny" class="csl-entry">
Chang, Winston, Joe Cheng, JJ Allaire, Carson Sievert, Barret Schloerke, Yihui Xie, Jeff Allen, Jonathan McPherson, Alan Dipert, and Barbara Borges. 2022. <span>“Shiny: Web Application Framework for r.”</span> <a href="https://CRAN.R-project.org/package=shiny">https://CRAN.R-project.org/package=shiny</a>.
</div>
<div id="ref-profvis" class="csl-entry">
Chang, Winston, Javier Luraschi, and Timothy Mastny. 2020. <span>“Profvis: Interactive Visualizations for Profiling r Code.”</span> <a href="https://CRAN.R-project.org/package=profvis">https://CRAN.R-project.org/package=profvis</a>.
</div>
<div id="ref-pageviews" class="csl-entry">
Keyes, Os, and Jeremiah Lewis. 2020. <span>“Pageviews: An API Client for Wikimedia Traffic Data.”</span> <a href="https://CRAN.R-project.org/package=pageviews">https://CRAN.R-project.org/package=pageviews</a>.
</div>
<div id="ref-shinyuieditor" class="csl-entry">
Strayer, Nick. 2022. <span>“Shinyuieditor: Build and Modify Your Shiny UI, Visually.”</span> <a href="https://rstudio.github.io/shinyuieditor/">https://rstudio.github.io/shinyuieditor/</a>.
</div>
<div id="ref-rvest" class="csl-entry">
Wickham, Hadley. 2022. <span>“Rvest: Easily Harvest (Scrape) Web Pages.”</span> <a href="https://CRAN.R-project.org/package=rvest">https://CRAN.R-project.org/package=rvest</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>apps</category>
  <category>web scraping</category>
  <guid>https://www.quantumjitter.com/project/thicken/index.html</guid>
  <pubDate>Wed, 07 Feb 2018 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/thicken/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Cluster of Six</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/hansard/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/hansard/feature.gif" class="img-fluid"></p>
<p>Before each vote, the Speaker of the House yells “Division! Clear the Lobby”. I’d like to find which cluster of MPs (Members of Parliament) may be exiting the lobby and going their own way.</p>
<p><a href="https://hansard.parliament.uk">Hansard</a> reports what’s said in the UK Parliament, sets out details of divisions, and records decisions taken during a sitting. The R package <a href="https://cran.r-project.org/web/packages/hansard/">hansard package</a> <span class="citation" data-cites="hansard">(Odell 2017)</span> provides access to the data.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://docs.evanodell.com/hansard">hansard</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="http://talgalili.github.io/dendextend/">dendextend</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/taiyun/corrplot">corrplot</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="http://www.sthda.com/english/rpkgs/factoextra">factoextra</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/slowkow/ggrepel">ggrepel</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span>name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Moonrise2"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/hansard/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>I’ll start by building a list of all Labour Party MPs.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">url_prefix</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"http://data.parliament.uk/members/"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">mps</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://docs.evanodell.com/hansard/reference/members.html">commons_members</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">party_value</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Labour"</span> <span class="op" style="color: #5E5E5E;">|</span> <span class="va" style="color: #111111;">about</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url_prefix</span>, <span class="st" style="color: #20794D;">"478"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>ID <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">about</span>, <span class="va" style="color: #111111;">url_prefix</span>, <span class="st" style="color: #20794D;">""</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">mps</span>, file <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"mps.rds"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Creating a function will enable me to iterate through the MP list to extract their voting records.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">start_date</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"2017-06-08"</span></span>
<span><span class="va" style="color: #111111;">end_date</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"2018-01-28"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">pull_votes</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://docs.evanodell.com/hansard/reference/mp_vote_record.html">mp_vote_record</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span>,</span>
<span>    start_date <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">start_date</span>,</span>
<span>    end_date <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">end_date</span>,</span>
<span>    verbose <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>mp <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span></span></code></pre></div>
</div>
<p>I’ll use it to extract the “aye” and “no” votes. Use of <code>possibly</code> prevents the code from stopping when it encounters former MPs for whom no data is returned.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">votes</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">mps</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">ID</span>, <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/possibly.html">possibly</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pull_votes</span>, <span class="cn" style="color: #8f5902;">NULL</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/keep.html">compact</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">simplify</span>, <span class="st" style="color: #20794D;">"tibbles"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"lobby"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"vote"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">votes</span>, file <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"votes.rds"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Voting the opposite way to the majority of the party, as well as non-votes, will both be of interest when assessing which MPs are “most distant” from the wider party.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">votes_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">votes</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">mps</span>, by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"mp"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"ID"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span>about <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">about.x</span>, <span class="va" style="color: #111111;">title</span>, <span class="va" style="color: #111111;">date_value</span>, </span>
<span>         <span class="va" style="color: #111111;">lobby</span>, <span class="va" style="color: #111111;">mp</span>, name <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">full_name_value</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/transmute.html">transmute</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    vote <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">lobby</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"aye"</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    mp <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">name</span>, <span class="st" style="color: #20794D;">" ("</span>, <span class="va" style="color: #111111;">mp</span>, <span class="st" style="color: #20794D;">")"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    about <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">about</span>, <span class="st" style="color: #20794D;">"http://data.parliament.uk/resources/"</span>, <span class="st" style="color: #20794D;">""</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">title</span>, <span class="st" style="color: #20794D;">" ("</span>, <span class="va" style="color: #111111;">about</span>, <span class="st" style="color: #20794D;">")"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">about</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op" style="color: #5E5E5E;">(</span>names_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">title</span>, values_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">vote</span>, values_fill <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The data are standardised (i.e.&nbsp;scaled) to ensure comparability. This is verified by ensuring the mean and standard deviation are close to zero and one respectively.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">scaled_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="va" style="color: #111111;">votes_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">mp</span>, <span class="va" style="color: #111111;">scale</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">scaled_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">mp</span>, <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span>mean <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">mean</span>, sd <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">sd</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    sd_min <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/c_across.html">c_across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"_sd"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    sd_max <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/c_across.html">c_across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"_sd"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    mean_min <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/c_across.html">c_across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"_mean"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    mean_max <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/c_across.html">c_across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"_mean"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
<col style="width: 0%">
</colgroup>
<thead><tr class="header">
<th style="text-align: right;">Nuclear Safeguards Bill: Report Stage New Clause 1 (828384)_mean</th>
<th style="text-align: right;">Nuclear Safeguards Bill: Report Stage New Clause 1 (828384)_sd</th>
<th style="text-align: right;">Nuclear Safeguards Bill: Report Stage Amdt 5 (828386)_mean</th>
<th style="text-align: right;">Nuclear Safeguards Bill: Report Stage Amdt 5 (828386)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage New Clause 1 (824363)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage New Clause 1 (824363)_sd</th>
<th style="text-align: right;">European Union Withdrawal Bill: Report Stage New Clause 6 (824364)_mean</th>
<th style="text-align: right;">European Union Withdrawal Bill: Report Stage New Clause 6 (824364)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: New Clause 11 (824365)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: New Clause 11 (824365)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: New Clause 12 (824368)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: New Clause 12 (824368)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: New Clause 17 (824369)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: New Clause 17 (824369)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: Amendment 2 (824372)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: Amendment 2 (824372)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: Amdt 1 (824373)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: Amdt 1 (824373)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Third Reading: Mr Blackford’s amendment (824378)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Third Reading: Mr Blackford’s amendment (824378)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: Amendment 57 (823320)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: Amendment 57 (823320)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: New Clause 7 (823321)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: New Clause 7 (823321)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: Amdt 4 (823322)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: Amdt 4 (823322)_sd</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Report Stage Amdt 3 (823332)_mean</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Report Stage Amdt 3 (823332)_sd</th>
<th style="text-align: right;">Trade Bill: Second Reading: Mr Corbyn’s amendment (818946)_mean</th>
<th style="text-align: right;">Trade Bill: Second Reading: Mr Corbyn’s amendment (818946)_sd</th>
<th style="text-align: right;">Taxation (Cross-Border Trade) Bill Second Reading: Jeremy Corbyn’s amendment (818647)_mean</th>
<th style="text-align: right;">Taxation (Cross-Border Trade) Bill Second Reading: Jeremy Corbyn’s amendment (818647)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 349 (809990)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 349 (809990)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 54 (810045)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 54 (810045)_sd</th>
<th style="text-align: right;">Finance (No 2) Bill: Committee of the whole House: New Clause 6 (809139)_mean</th>
<th style="text-align: right;">Finance (No 2) Bill: Committee of the whole House: New Clause 6 (809139)_sd</th>
<th style="text-align: right;">Finance (No 2) Bill Committee of the whole House New Clause 8 (809145)_mean</th>
<th style="text-align: right;">Finance (No 2) Bill Committee of the whole House New Clause 8 (809145)_sd</th>
<th style="text-align: right;">Finance (No.&nbsp;2) Bill: Committee of the whole House New Clause 1 (808733)_mean</th>
<th style="text-align: right;">Finance (No.&nbsp;2) Bill: Committee of the whole House New Clause 1 (808733)_sd</th>
<th style="text-align: right;">Finance (No.&nbsp;2) Bill: Committee of the whole House New Clause 4 (808776)_mean</th>
<th style="text-align: right;">Finance (No.&nbsp;2) Bill: Committee of the whole House New Clause 4 (808776)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 7 (805525)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 7 (805525)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 30 (805526)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 30 (805526)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 241 (805550)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 241 (805550)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 1 (805551)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 1 (805551)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 22 (806101)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 22 (806101)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 26 (806103)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 26 (806103)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 63 (805092)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 63 (805092)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amendment 49 (805093)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amendment 49 (805093)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amendment 25 (805096)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amendment 25 (805096)_sd</th>
<th style="text-align: right;">Finance (No.2) Bill Second Reading: Jeremy Corbyn’s amendment (804247)_mean</th>
<th style="text-align: right;">Finance (No.2) Bill Second Reading: Jeremy Corbyn’s amendment (804247)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill Committee of the whole House Amendment 167 (801697)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill Committee of the whole House Amendment 167 (801697)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 17 (801727)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 17 (801727)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 80 (801729)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 80 (801729)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 339 (801730)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 339 (801730)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill Committee of the whole House New Clause 64 (800480)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill Committee of the whole House New Clause 64 (800480)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill Committee of the whole House Amendment 42 (800481)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill Committee of the whole House Amendment 42 (800481)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill Committee of the whole House Amendment 72 (800482)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill Committee of the whole House Amendment 72 (800482)_sd</th>
<th style="text-align: right;">Closure Motion: Parliamentary Constituencies (Amendment Bill) (798552)_mean</th>
<th style="text-align: right;">Closure Motion: Parliamentary Constituencies (Amendment Bill) (798552)_sd</th>
<th style="text-align: right;">Opposition Motion: Women affected by state pension age increases (796706)_mean</th>
<th style="text-align: right;">Opposition Motion: Women affected by state pension age increases (796706)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 79 (792888)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 79 (792888)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 46 (792889)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 46 (792889)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 336 (792890)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 336 (792890)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 139 (792945)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 139 (792945)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 25 (789396)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 25 (789396)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 58 (789397)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 58 (789397)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 30 (789922)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 30 (789922)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 67 (789923)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 67 (789923)_sd</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Committee of the whole House New Clause 14 (788941)_mean</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Committee of the whole House New Clause 14 (788941)_sd</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Committee of the whole House Amdt 137 (788942)_mean</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Committee of the whole House Amdt 137 (788942)_sd</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Committee of the whole House Amdt 278 (788943)_mean</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Committee of the whole House Amdt 278 (788943)_sd</th>
<th style="text-align: right;">Finance Bill: Report Stage New Clause 1 (780710)_mean</th>
<th style="text-align: right;">Finance Bill: Report Stage New Clause 1 (780710)_sd</th>
<th style="text-align: right;">Finance Bill: Report Stage Amdt 1 (780713)_mean</th>
<th style="text-align: right;">Finance Bill: Report Stage Amdt 1 (780713)_sd</th>
<th style="text-align: right;">Finance Bill: Report Stage Amdt 11 (780714)_mean</th>
<th style="text-align: right;">Finance Bill: Report Stage Amdt 11 (780714)_sd</th>
<th style="text-align: right;">Finance Bill: Report New Clause 2 (780715)_mean</th>
<th style="text-align: right;">Finance Bill: Report New Clause 2 (780715)_sd</th>
<th style="text-align: right;">Opposition Motion: Pause of Universal Credit full service roll-out (772511)_mean</th>
<th style="text-align: right;">Opposition Motion: Pause of Universal Credit full service roll-out (772511)_sd</th>
<th style="text-align: right;">Finance Bill: Committee of the whole House Amdt 1 (768283)_mean</th>
<th style="text-align: right;">Finance Bill: Committee of the whole House Amdt 1 (768283)_sd</th>
<th style="text-align: right;">Finance Bill: Committee of the whole House Amdt 2 (768285)_mean</th>
<th style="text-align: right;">Finance Bill: Committee of the whole House Amdt 2 (768285)_sd</th>
<th style="text-align: right;">Finance Bill: Committee of the whole House Amdt 4 (768286)_mean</th>
<th style="text-align: right;">Finance Bill: Committee of the whole House Amdt 4 (768286)_sd</th>
<th style="text-align: right;">Finance Bill: Committee of the whole House New Clause 1 (768287)_mean</th>
<th style="text-align: right;">Finance Bill: Committee of the whole House New Clause 1 (768287)_sd</th>
<th style="text-align: right;">Finance Bill: Committee of the whole House New Clause 2 (768324)_mean</th>
<th style="text-align: right;">Finance Bill: Committee of the whole House New Clause 2 (768324)_sd</th>
<th style="text-align: right;">Nomination of Members to Committees: Mr Carmichael’s amendment (759599)_mean</th>
<th style="text-align: right;">Nomination of Members to Committees: Mr Carmichael’s amendment (759599)_sd</th>
<th style="text-align: right;">EU (Withdrawal) Bill Second Reading: Mr Corbyn’s amendment (759160)_mean</th>
<th style="text-align: right;">EU (Withdrawal) Bill Second Reading: Mr Corbyn’s amendment (759160)_sd</th>
<th style="text-align: right;">Business of the House (Private Members’ Bills): Amendment (a) (752310)_mean</th>
<th style="text-align: right;">Business of the House (Private Members’ Bills): Amendment (a) (752310)_sd</th>
<th style="text-align: right;">Business of the House (Private Members’ Bills): Amendment (b) (752311)_mean</th>
<th style="text-align: right;">Business of the House (Private Members’ Bills): Amendment (b) (752311)_sd</th>
<th style="text-align: right;">Air Travel Organisers’ Licensing Bill: Committee of the whole House Amdt 2 (750424)_mean</th>
<th style="text-align: right;">Air Travel Organisers’ Licensing Bill: Committee of the whole House Amdt 2 (750424)_sd</th>
<th style="text-align: right;">Air Travel Organisers’ Bill: Committee of the whole House Amdt 3 (750425)_mean</th>
<th style="text-align: right;">Air Travel Organisers’ Bill: Committee of the whole House Amdt 3 (750425)_sd</th>
<th style="text-align: right;">Air Travel Organisers’ Licensing Bill: Committee of the whole House New Clause 1 (750435)_mean</th>
<th style="text-align: right;">Air Travel Organisers’ Licensing Bill: Committee of the whole House New Clause 1 (750435)_sd</th>
<th style="text-align: right;">Queen’s Speech: Economy and Jobs Amdt (l) (746517)_mean</th>
<th style="text-align: right;">Queen’s Speech: Economy and Jobs Amdt (l) (746517)_sd</th>
<th style="text-align: right;">Queen’s Speech: Health, Social Care and Security Amendment (i) (746031)_mean</th>
<th style="text-align: right;">Queen’s Speech: Health, Social Care and Security Amendment (i) (746031)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Third Reading (824379)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Third Reading (824379)_sd</th>
<th style="text-align: right;">European (Withdrawal) Bill: Report Stage Amdts 21-29 (823331)_mean</th>
<th style="text-align: right;">European (Withdrawal) Bill: Report Stage Amdts 21-29 (823331)_sd</th>
<th style="text-align: right;">Trade Bill: Second Reading (818948)_mean</th>
<th style="text-align: right;">Trade Bill: Second Reading (818948)_sd</th>
<th style="text-align: right;">Taxation (Cross-Border Trade): Second Reading (818649)_mean</th>
<th style="text-align: right;">Taxation (Cross-Border Trade): Second Reading (818649)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdts 381 and 399 (809989)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdts 381 and 399 (809989)_sd</th>
<th style="text-align: right;">Finance (No.&nbsp;2) Bill: Committee of the whole House Schedule 9 (808574)_mean</th>
<th style="text-align: right;">Finance (No.&nbsp;2) Bill: Committee of the whole House Schedule 9 (808574)_sd</th>
<th style="text-align: right;">Finance (No 2) Bill: Second Reading (804248)_mean</th>
<th style="text-align: right;">Finance (No 2) Bill: Second Reading (804248)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill Committee of the whole House Clause 11 and Schedule 3 stand part (800483)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill Committee of the whole House Clause 11 and Schedule 3 stand part (800483)_sd</th>
<th style="text-align: right;">Budget resolutions motion 28: Bank levy (795657)_mean</th>
<th style="text-align: right;">Budget resolutions motion 28: Bank levy (795657)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Schedule 1 (792946)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Schedule 1 (792946)_sd</th>
<th style="text-align: right;">Motion to sit in private (783133)_mean</th>
<th style="text-align: right;">Motion to sit in private (783133)_sd</th>
<th style="text-align: right;">Finance Bill: Third Reading (780719)_mean</th>
<th style="text-align: right;">Finance Bill: Third Reading (780719)_sd</th>
<th style="text-align: right;">Smart Meters Bill (Programme) (776386)_mean</th>
<th style="text-align: right;">Smart Meters Bill (Programme) (776386)_sd</th>
<th style="text-align: right;">Automated and Electric Vehicles Bill (Programme motion) (776007)_mean</th>
<th style="text-align: right;">Automated and Electric Vehicles Bill (Programme motion) (776007)_sd</th>
<th style="text-align: right;">Finance Bill: Second Reading (759531)_mean</th>
<th style="text-align: right;">Finance Bill: Second Reading (759531)_sd</th>
<th style="text-align: right;">Nomination of Members to Committees (759600)_mean</th>
<th style="text-align: right;">Nomination of Members to Committees (759600)_sd</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Second Reading (759161)_mean</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Second Reading (759161)_sd</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Programme Motion (759162)_mean</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Programme Motion (759162)_sd</th>
<th style="text-align: right;">Ways and Means motion 13: Business investment relief (757972)_mean</th>
<th style="text-align: right;">Ways and Means motion 13: Business investment relief (757972)_sd</th>
<th style="text-align: right;">Ways and Means Motion 4: Termination payments etc. (757973)_mean</th>
<th style="text-align: right;">Ways and Means Motion 4: Termination payments etc. (757973)_sd</th>
<th style="text-align: right;">Ways and Means motion 22: Trading profits taxable at the Northern Ireland rate (757974)_mean</th>
<th style="text-align: right;">Ways and Means motion 22: Trading profits taxable at the Northern Ireland rate (757974)_sd</th>
<th style="text-align: right;">Queen’s Speech: Main Question (746519)_mean</th>
<th style="text-align: right;">Queen’s Speech: Main Question (746519)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 44 (810044)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 44 (810044)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amendment 158 (805095)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amendment 158 (805095)_sd</th>
<th style="text-align: right;">Electoral Commission (828389)_mean</th>
<th style="text-align: right;">Electoral Commission (828389)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: Amdt 59 (824370)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Report Stage: Amdt 59 (824370)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amendment 124 (805094)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amendment 124 (805094)_sd</th>
<th style="text-align: right;">Cross-Border Trade Resolution: Amendment (e) (792581)_mean</th>
<th style="text-align: right;">Cross-Border Trade Resolution: Amendment (e) (792581)_sd</th>
<th style="text-align: right;">Draft Local Authorities (Mayoral Elections) (England and Wales) (Amendment) Regulations 2017 (809953)_mean</th>
<th style="text-align: right;">Draft Local Authorities (Mayoral Elections) (England and Wales) (Amendment) Regulations 2017 (809953)_sd</th>
<th style="text-align: right;">Draft Combined Authorities (Mayoral Elections) (Amendment) Order 2017 (809954)_mean</th>
<th style="text-align: right;">Draft Combined Authorities (Mayoral Elections) (Amendment) Order 2017 (809954)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 13 (809988)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House New Clause 13 (809988)_sd</th>
<th style="text-align: right;">Queen’s Speech: Economy and Jobs Amdt (g) (746518)_mean</th>
<th style="text-align: right;">Queen’s Speech: Economy and Jobs Amdt (g) (746518)_sd</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Committee of the whole House Clause 1 (788773)_mean</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Committee of the whole House Clause 1 (788773)_sd</th>
<th style="text-align: right;">Motion to sit in private (798541)_mean</th>
<th style="text-align: right;">Motion to sit in private (798541)_sd</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 120 (810046)_mean</th>
<th style="text-align: right;">European Union (Withdrawal) Bill: Committee of the whole House Amdt 120 (810046)_sd</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Committee of the whole House Amdt 79 (788772)_mean</th>
<th style="text-align: right;">EU (Withdrawal) Bill: Committee of the whole House Amdt 79 (788772)_sd</th>
<th style="text-align: right;">sd_min</th>
<th style="text-align: right;">sd_max</th>
<th style="text-align: right;">mean_min</th>
<th style="text-align: right;">mean_max</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr></tbody>
</table>
</div>
</div>
</div>
<p>I’d like to assess whether the data contain meaningful clusters rather than random noise. This is achieved quantitatively by calculating the Hopkins statistic, and visually by inspection.</p>
<p>If the <a href="https://en.wikipedia.org/wiki/Hopkins_statistic">Hopkins statistic</a> is closer to 1 than 0, then we have data which may be clustered.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">scaled_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">mp</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/factoextra/man/get_clust_tendency.html">get_clust_tendency</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">votes_df</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"hopkins_stat"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.783357</code></pre>
</div>
</div>
<p>A visual assessment of clustering tendency reveals distance data exhibiting a visible structure.</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">scaled_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">mp</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/factoextra/man/dist.html">fviz_dist</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    show_labels <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span>,</span>
<span>    gradient <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      low <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>      mid <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>      high <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">]</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/hansard/index_files/figure-html/structure-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>There are eight methods I could use for <a href="https://en.wikipedia.org/wiki/Hierarchical_clustering">hierarchical clustering</a>, and I’ll need to determine which will yield results that best fit the data.</p>
<p>The correlation plot below shows that the <em>median</em> and <em>ward</em> methods have a weaker correlation with the other five methods.</p>
<div class="cell">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">orig_dist</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">scaled_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">mp</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">dend_meths</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"complete"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"average"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"single"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"ward.D"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"ward.D2"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"mcquitty"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"median"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"centroid"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">dend_list</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dend_meths</span>, \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>    <span class="va" style="color: #111111;">orig_dist</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">dend_list</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dendlist</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dend_meths</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://talgalili.github.io/dendextend/reference/cor.dendlist.html">cor.dendlist</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.html">corrplot</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"pie"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"lower"</span>,</span>
<span>    col <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>    mar <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">0.5</span>, <span class="fl" style="color: #AD0000;">4</span>, <span class="fl" style="color: #AD0000;">0.5</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    order <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"AOE"</span>,</span>
<span>    tl.cex <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.8</span>,</span>
<span>    tl.col <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"black"</span>,</span>
<span>    cl.cex <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.7</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/hansard/index_files/figure-html/cluster-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The above plot does not tell us which method is optimal. For that, I’ll take each of the cluster agglomeration methods and calculate their cophenetic distances. I can then correlate these with the original distance to see which offers the best fit.</p>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">methods</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="st" style="color: #20794D;">"complete"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"average"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"single"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"ward.D"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"ward.D2"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"mcquitty"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"median"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"centroid"</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">best_method</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">methods</span>, \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="va" style="color: #111111;">co_comp</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>    <span class="va" style="color: #111111;">orig_dist</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/cophenetic.html">cophenetic</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    correlation <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">orig_dist</span>, <span class="va" style="color: #111111;">co_comp</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    method <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">x</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The plot below confirms the <em>ward</em> and <em>median</em> methods having a weaker fit. <em>Average</em> produces the strongest correlation coefficient of 0.98.</p>
<div class="cell">
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">best_method</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">method</span>, <span class="va" style="color: #111111;">correlation</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">correlation</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>, width <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.8</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">method</span>, <span class="st" style="color: #20794D;">"  "</span>, <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">correlation</span>, <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1.3</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Method"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Correlation"</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cluster Method Correlation Coefficients"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: Hansard"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/hansard/index_files/figure-html/best-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>I can now plot the full Labour Party dendrogram using the <em>average</em> method. This shows a “cluster of six” MPs which is the last to merge with the rest of the party based on their voting pattern.</p>
<div class="cell">
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">dend_avg</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">orig_dist</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"average"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/labels.html">labels</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dend_avg</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">scaled_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">mp</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/order.dendrogram.html">order.dendrogram</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dend_avg</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span></span>
<span></span>
<span><span class="va" style="color: #111111;">dend</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">dend_avg</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://talgalili.github.io/dendextend/reference/color_branches.html">color_branches</a></span><span class="op" style="color: #5E5E5E;">(</span>k <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, col <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://talgalili.github.io/dendextend/reference/set.html">set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"labels_cex"</span>, <span class="fl" style="color: #AD0000;">0.4</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">start_formatted</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">start_date</span>, format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%Y-%m-%d"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_format.html">date_format</a></span><span class="op" style="color: #5E5E5E;">(</span>format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%b %d, %Y"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">end_formatted</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">end_date</span>, format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%Y-%m-%d"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_format.html">date_format</a></span><span class="op" style="color: #5E5E5E;">(</span>format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%b %d, %Y"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dend</span><span class="op" style="color: #5E5E5E;">)</span>, horiz <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, offset_labels <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"\nDistance"</span>, title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Hierarchical Clustering of Labour MPs"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Based on House of Commons Divisions Since the 2017 Election"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"Source: Hansard ({start_formatted} to {end_formatted})"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>panel.border <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/hansard/index_files/figure-html/dendogram-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>I’ll zoom in on the “cluster of six”.</p>
<div class="cell">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">dend_cuts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">dend</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://talgalili.github.io/dendextend/reference/assign_values_to_leaves_nodePar.html">assign_values_to_leaves_nodePar</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">19</span>, <span class="st" style="color: #20794D;">"pch"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://talgalili.github.io/dendextend/reference/assign_values_to_leaves_nodePar.html">assign_values_to_leaves_nodePar</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">5</span>, <span class="st" style="color: #20794D;">"cex"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://talgalili.github.io/dendextend/reference/assign_values_to_leaves_nodePar.html">assign_values_to_leaves_nodePar</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>, <span class="st" style="color: #20794D;">"col"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://talgalili.github.io/dendextend/reference/set.html">set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"labels_cex"</span>, <span class="fl" style="color: #AD0000;">0.4</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://talgalili.github.io/dendextend/reference/set.html">set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"branches_lwd"</span>, <span class="fl" style="color: #AD0000;">2.5</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://talgalili.github.io/dendextend/reference/color_branches.html">color_branches</a></span><span class="op" style="color: #5E5E5E;">(</span>k <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, col <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op" style="color: #5E5E5E;">(</span>h <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">50</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dend_cuts</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">lower</span><span class="op" style="color: #5E5E5E;">[[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  horiz <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>  nodePar <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">nodePar</span>,</span>
<span>  offset_labels <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.5</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cluster of Six"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"MPs who Branch off First in the Dendrogram"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>plot.margin <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"cm"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/hansard/index_files/figure-html/zoom-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Summarising and sorting the total votes by MP tells me that the “cluster of six” MPs are among the eight MPs voting the fewest times. And I can, for example, verify the record for Emma Reynolds directly via <a href="https://hansard.parliament.uk/search/MemberContributions?memberId=4077&amp;startDate=2017-06-08&amp;endDate=2018-01-27&amp;type=Divisions&amp;outputType=List"><em>Hansard</em></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">fewest_votes</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">votes</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">mps</span>, by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"mp"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"ID"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>n_lobby <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">full_name_value</span>, <span class="va" style="color: #111111;">lobby</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span>mp <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">full_name_value</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op" style="color: #5E5E5E;">(</span>names_from <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"lobby"</span>, values_from <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"n_lobby"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>total <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">aye</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="va" style="color: #111111;">no</span>,</span>
<span>         mp <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">mp</span>, <span class="va" style="color: #111111;">total</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_min</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span>, order_by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">total</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op" style="color: #5E5E5E;">(</span>cols <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">mp</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">name</span> <span class="op" style="color: #5E5E5E;">!=</span> <span class="st" style="color: #20794D;">"total"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">fewest_votes</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">mp</span>, <span class="va" style="color: #111111;">value</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">name</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">value</span><span class="op" style="color: #5E5E5E;">)</span>, position <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/position_stack.html">position_stack</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Labour MPs Voting Fewest Times"</span>,</span>
<span>       y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Votes"</span>, x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/hansard/index_files/figure-html/fewest-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Non-voting will not be the only influencing factor. The “distant cluster” will be particularly influenced by a small minority of MPs voting in the opposite direction to the overwhelming majority.</p>
<p><a href="https://en.wikipedia.org/wiki/Cook%27s_distance"><em>Cook’s Distance</em></a> visualises these influential outliers. This shows the voting of three MPs, all on the European Union Withdrawal Bill readings, to be particular outliers. All three MPs are in the “cluster of six”.</p>
<div class="cell">
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">votes_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op" style="color: #5E5E5E;">(</span>cols <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">mp</span>, names_to <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"title"</span>, values_to <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"vote"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">mod</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">vote</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">.</span>, data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">tidy_df</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">mod_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">mod</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">mod_df</span>, <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">title</span>, <span class="va" style="color: #111111;">.cooksd</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">mp</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html">geom_label_repel</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.cooksd</span> <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="fl" style="color: #AD0000;">0.002</span>, <span class="va" style="color: #111111;">mp</span>, <span class="cn" style="color: #8f5902;">NA</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">220</span>, name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Moonrise2"</span>, type <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"continuous"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Cook's Distance"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    panel.border <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    axis.text <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/hansard/index_files/figure-html/cooks-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">mod_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">title</span>, <span class="st" style="color: #20794D;">"759161|824379|809989"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_wrap.html">str_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">title</span>, <span class="fl" style="color: #AD0000;">30</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">title</span>, <span class="va" style="color: #111111;">.cooksd</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">mp</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op" style="color: #5E5E5E;">(</span>size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html">geom_label_repel</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.cooksd</span> <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="fl" style="color: #AD0000;">0.0015</span>, <span class="va" style="color: #111111;">mp</span>, <span class="cn" style="color: #8f5902;">NA</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Cook's Distance"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    axis.line.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op" style="color: #5E5E5E;">(</span>color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"grey60"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    axis.text <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">8</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span>,</span>
<span>    axis.title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="fl" style="color: #AD0000;">210</span>, name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Moonrise2"</span>, type <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"continuous"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/hansard/index_files/figure-html/six-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 3%">
<col style="width: 96%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">c[7]; cut[1]; labels[1]; library[10]; list[3]; max[2]; min[2]; nrow[1]; readRDS[2]; rev[2]; round[1]; saveRDS[2]; scale[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">broom</td>
<td style="text-align: left;">augment[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">date_format[2]; date_parse[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">corrplot</td>
<td style="text-align: left;">corrplot[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dendextend</td>
<td style="text-align: left;">assign_values_to_leaves_nodePar[3]; color_branches[2]; cor.dendlist[1]; dendlist[1]; set[3]</td>
</tr>
<tr class="even">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[3]; across[2]; c_across[4]; if_else[3]; left_join[2]; mutate[5]; n[1]; rename[2]; select[5]; slice_min[1]; summarise[2]; transmute[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">factoextra</td>
<td style="text-align: left;">fviz_dist[1]; get_clust_tendency[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">forcats</td>
<td style="text-align: left;">fct_reorder[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[8]; coord_flip[4]; element_blank[3]; element_line[1]; element_text[2]; geom_col[2]; geom_jitter[1]; geom_label[1]; geom_point[1]; geom_text[1]; ggplot[6]; ggtitle[1]; labs[5]; position_stack[1]; scale_colour_manual[2]; scale_fill_manual[1]; theme[4]; theme_bw[1]; theme_set[1]; theme_void[1]; unit[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggrepel</td>
<td style="text-align: left;">geom_label_repel[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">hansard</td>
<td style="text-align: left;">commons_members[1]; mp_vote_record[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">compact[1]; list_rbind[2]; map[4]; pluck[1]; possibly[1]; reduce[1]; set_names[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">as.dendrogram[2]; cophenetic[1]; cor[1]; dist[2]; hclust[3]; lm[1]; order.dendrogram[1]; reorder[1]; sd[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[4]; str_detect[1]; str_replace[2]; str_wrap[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">as_tibble[1]; tibble[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">pivot_longer[2]; pivot_wider[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[3]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-hansard" class="csl-entry">
Odell, Evan. 2017. <span>“<span></span>Hansard<span></span>: Provides Easy Downloading Capabilities for the UK Parliament API.”</span> <a href="https://doi.org/10.5281/zenodo.591264">https://doi.org/10.5281/zenodo.591264</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>clustering</category>
  <category>correlation</category>
  <guid>https://www.quantumjitter.com/project/hansard/index.html</guid>
  <pubDate>Mon, 29 Jan 2018 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/hansard/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Digging Deep</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/planning/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/planning/feature.gif" class="img-fluid" alt="A spade is seen tossing fresh dirt from a deep hole. A granted planning permission and an empty new spade box lie nearby."></p>
<p>In <a href="../../project/sw10">House Sales</a> I looked at how a series of events damped down sales. By combining these sales data with planning applications I’d like to see if home owners “start digging” when they can’t sell.</p>
<p>Planning data is harvested with the kind permission of The Royal Borough of Kensington and Chelsea (RBKC). The code for these code chunks is not rendered out of courtesy to RBKC.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">SPARQL</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://quanteda.io">quanteda</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://quanteda.io">quanteda.textstats</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/jabiru/tictoc">tictoc</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/ramnathv/htmlwidgets">htmlwidgets</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/robjhyndman/fpp3-package">fpp3</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/rstudio/DT">DT</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://vctrs.r-lib.org/">vctrs</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span>name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Darjeeling2"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/planning/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">case_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"case.rds"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">url <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb4-2">  <span class="st" style="color: #20794D;">"https://www.freemaptools.com/download/full-postcodes/ukpostcodes.zip"</span></span>
<span id="cb4-3"></span>
<span id="cb4-4">file_name <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">basename</span>(url)</span>
<span id="cb4-5"></span>
<span id="cb4-6">url <span class="sc" style="color: #5E5E5E;">|&gt;</span> basename</span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="fu" style="color: #4758AB;">download.file</span>(url, file_name)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">geocodes</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"ukpostcodes.zip"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The data need a bit of wrangling. And there is also the opportunity to try the newest column-wise enhancements to mutate: <code>mutate_if</code> and <code>mutate_at</code> have been superseded by <code>mutate</code> with <code>across</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">wide_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">case_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op" style="color: #5E5E5E;">(</span>names_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">X1</span>, values_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">X2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">plan_colnames</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">property_list</span>, <span class="va" style="color: #111111;">property_cons</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="op" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/na_if.html">na_if</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.</span>, <span class="st" style="color: #20794D;">"N/A"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>         <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">app_comp</span>, <span class="va" style="color: #111111;">decision</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="op" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/na_if.html">na_if</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.</span>, <span class="st" style="color: #20794D;">""</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">wide_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    dec_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dec_date</span>, format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%d %b %Y"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    dec_year <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_year</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dec_date</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    proposal_dev <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">proposal_dev</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    property_pcode <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">property_add</span>, <span class="st" style="color: #20794D;">"SW10[\\s]?\\d[[:alpha:]]{2}"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    property_pcode <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">property_pcode</span>, <span class="st" style="color: #20794D;">"SW10(?!\\s)"</span>, <span class="st" style="color: #20794D;">"SW10 "</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    app_comp <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">app_comp</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"[:punct:]"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"\\b(?:AND|LTD|CO|LIMITED|UK|GROUP|LLP)\\b"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    decision <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">decision</span>, na_level <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Other"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    decision <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">decision</span>, <span class="st" style="color: #20794D;">"/"</span>, <span class="st" style="color: #20794D;">" / "</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    dec_lump <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_lump.html">fct_lump</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">decision</span>, prop <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.03</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    basement <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">proposal_dev</span>, <span class="st" style="color: #20794D;">"basement"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"Yes"</span>, <span class="st" style="color: #20794D;">"No"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    property_listed <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">property_list</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"II"</span>, <span class="st" style="color: #20794D;">"II*"</span>, <span class="st" style="color: #20794D;">"2"</span>, <span class="st" style="color: #20794D;">"2*"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Yes"</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">property_list</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"No"</span>,</span>
<span>      <span class="cn" style="color: #8f5902;">TRUE</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"No"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    app_comp <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">app_comp</span>, <span class="st" style="color: #20794D;">"None"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    property_cons <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">property_cons</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">""</span> <span class="op" style="color: #5E5E5E;">|</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">property_cons</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      <span class="st" style="color: #20794D;">"None"</span>, <span class="va" style="color: #111111;">property_cons</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    proposal_dev <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">proposal_dev</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">""</span> <span class="op" style="color: #5E5E5E;">|</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">proposal_dev</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      <span class="st" style="color: #20794D;">"None"</span>, <span class="va" style="color: #111111;">proposal_dev</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">where</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">is.character</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">str_trim</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"app_comp"</span>, <span class="st" style="color: #20794D;">"proposal_type"</span>, <span class="st" style="color: #20794D;">"property_cons"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">factor</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">geocodes</span>, by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"property_pcode"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"postcode"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dec_lump</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Decision"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">dec_lump</span>, <span class="st" style="color: #20794D;">"Count"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">Decision</th>
<th style="text-align: right;">Count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Grant Planning Permission / Consent</td>
<td style="text-align: right;">5336</td>
</tr>
<tr class="even">
<td style="text-align: left;">Withdrawn by Applicant</td>
<td style="text-align: right;">1123</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Other</td>
<td style="text-align: right;">847</td>
</tr>
<tr class="even">
<td style="text-align: left;">Refuse Planning Permission / Consent</td>
<td style="text-align: right;">752</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Discharge of Conditions - Grant</td>
<td style="text-align: right;">626</td>
</tr>
<tr class="even">
<td style="text-align: left;">Raise No Objection</td>
<td style="text-align: right;">418</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>quanteda <span class="citation" data-cites="quanteda">(Benoit et al. 2018)</span> to look at key words in context (kwic).</p>
<iframe seamless="" src="../../project/planning/dt1.html" width="100%" height="500"></iframe>
<p>I’d like to review planning applications by theme. So I’ll first need to get a sense of what the themes are by plotting the words which appear most frequently.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">plus_words</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"new"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"pp"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"two"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"one"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"dated"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"withdrawn"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"flat"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"x"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"permission"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"rear"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"first"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"second"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"planning"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"floor"</span>,</span>
<span>    <span class="st" style="color: #20794D;">"erection"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">words</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/corpus.html">corpus</a></span><span class="op" style="color: #5E5E5E;">(</span>text_field <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"proposal_dev"</span>, </span>
<span>         doc_vars <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"dec_date"</span>, <span class="st" style="color: #20794D;">"proposal_type"</span>, </span>
<span>                      <span class="st" style="color: #20794D;">"decision"</span>, <span class="st" style="color: #20794D;">"dec_year"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/dfm.html">dfm</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    remove <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/stopwords/man/stopwords.html">stopwords</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"english"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">plus_words</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    remove_numbers <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>    remove_punct <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://quanteda.io/reference/textstat_frequency.html">textstat_frequency</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">30</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>feature <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">feature</span>, <span class="va" style="color: #111111;">frequency</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">words</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">feature</span>, <span class="va" style="color: #111111;">frequency</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, </span>
<span>       title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Frequent Planning Proposal Words"</span>,</span>
<span>       caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: RBKC Planning Search"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/planning/index_files/figure-html/dfm-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Now I can create a theme feature.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    theme <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">proposal_dev</span>, <span class="st" style="color: #20794D;">"basement|excav"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Basement or Excavation"</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">proposal_dev</span>, <span class="st" style="color: #20794D;">"exten|conservatory|storey"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Extension, Conservatory \nor Storey"</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">proposal_dev</span>, <span class="st" style="color: #20794D;">"window|door"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Windows or Doors"</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">proposal_dev</span>, <span class="st" style="color: #20794D;">"roof"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Roof"</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">proposal_type</span>, <span class="st" style="color: #20794D;">"Tree"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|</span></span>
<span>        <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">proposal_dev</span>, <span class="st" style="color: #20794D;">"terrac|landscap|garden"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Trees, Landscaping, \nGarden or Terrace"</span>,</span>
<span>      <span class="cn" style="color: #8f5902;">TRUE</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Other"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    outcome <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">decision</span>, <span class="st" style="color: #20794D;">"Grant|No Obj|Accept|Lawful"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Positive"</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">decision</span>, <span class="st" style="color: #20794D;">"Refuse"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Refuse"</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">decision</span>, <span class="st" style="color: #20794D;">"Withdrawn"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Withdrawn"</span>,</span>
<span>      <span class="cn" style="color: #8f5902;">TRUE</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"Other"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>I also want to compare house sales with planning applications over time. So, I’ll re-use the SPARQL query from <a href="../../project/sw10">House Sales</a>.</p>
<div class="cell" data-hash="index_cache/html/compare_ab6ab84f4c48420f110b3594abac0487">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">endpoint</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"https://landregistry.data.gov.uk/landregistry/query"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">query</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">'PREFIX  text: &lt;http://jena.apache.org/text#&gt;</span></span>
<span><span class="st" style="color: #20794D;">PREFIX  ppd:  &lt;http://landregistry.data.gov.uk/def/ppi/&gt;</span></span>
<span><span class="st" style="color: #20794D;">PREFIX  lrcommon: &lt;http://landregistry.data.gov.uk/def/common/&gt;</span></span>
<span><span class="st" style="color: #20794D;">  </span></span>
<span><span class="st" style="color: #20794D;">SELECT  ?item ?ppd_propertyAddress ?ppd_hasTransaction ?ppd_pricePaid ?ppd_transactionCategory ?ppd_transactionDate ?ppd_transactionId ?ppd_estateType ?ppd_newBuild ?ppd_propertyAddressCounty ?ppd_propertyAddressDistrict ?ppd_propertyAddressLocality ?ppd_propertyAddressPaon ?ppd_propertyAddressPostcode ?ppd_propertyAddressSaon ?ppd_propertyAddressStreet ?ppd_propertyAddressTown ?ppd_propertyType ?ppd_recordStatus</span></span>
<span><span class="st" style="color: #20794D;"></span></span>
<span><span class="st" style="color: #20794D;">WHERE</span></span>
<span><span class="st" style="color: #20794D;">{ ?ppd_propertyAddress text:query _:b0 .</span></span>
<span><span class="st" style="color: #20794D;">  _:b0 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#first&gt; lrcommon:postcode .</span></span>
<span><span class="st" style="color: #20794D;">  _:b0 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#rest&gt; _:b1 .</span></span>
<span><span class="st" style="color: #20794D;">  _:b1 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#first&gt; "( SW10 )" .</span></span>
<span><span class="st" style="color: #20794D;">  _:b1 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#rest&gt; _:b2 .</span></span>
<span><span class="st" style="color: #20794D;">  _:b2 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#first&gt; 3000000 .</span></span>
<span><span class="st" style="color: #20794D;">  _:b2 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#rest&gt; &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#nil&gt; .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:propertyAddress ?ppd_propertyAddress .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:hasTransaction ?ppd_hasTransaction .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:pricePaid ?ppd_pricePaid .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:transactionCategory ?ppd_transactionCategory .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:transactionDate ?ppd_transactionDate .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:transactionId ?ppd_transactionId</span></span>
<span><span class="st" style="color: #20794D;">  </span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?item ppd:estateType ?ppd_estateType }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?item ppd:newBuild ?ppd_newBuild }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:county ?ppd_propertyAddressCounty }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:district ?ppd_propertyAddressDistrict }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:locality ?ppd_propertyAddressLocality }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:paon ?ppd_propertyAddressPaon }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:postcode ?ppd_propertyAddressPostcode }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:saon ?ppd_propertyAddressSaon }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:street ?ppd_propertyAddressStreet }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:town ?ppd_propertyAddressTown }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?item ppd:propertyType ?ppd_propertyType }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?item ppd:recordStatus ?ppd_recordStatus }</span></span>
<span><span class="st" style="color: #20794D;">}'</span></span>
<span></span>
<span><span class="va" style="color: #111111;">sales</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/SPARQL/man/SPARQL.html">SPARQL</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">endpoint</span>, <span class="va" style="color: #111111;">query</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>196.543 sec elapsed</code></pre>
</div>
</div>
<p>Let’s now bind the data into one tibble and summarise the transaction volumes over time.</p>
<div class="cell">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">sales_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">sales</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">results</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://vctrs.r-lib.org/reference/new_date.html">new_datetime</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">ppd_transactionDate</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/as_date.html">as_date</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    dataset <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Sales"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>volume <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, <span class="va" style="color: #111111;">dataset</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">app_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    date <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">dec_date</span>,</span>
<span>    dataset <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Planning"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>volume <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, <span class="va" style="color: #111111;">dataset</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">compare_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">app_df</span>, <span class="va" style="color: #111111;">sales_df</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">summary_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">compare_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span> <span class="op" style="color: #5E5E5E;">&gt;=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sales_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_build.html">date_build</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_year</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/clock-getters.html">get_month</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="st" style="color: #20794D;">"last"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>volume <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">volume</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, <span class="va" style="color: #111111;">dataset</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The visualisation below does suggest that home owners “start digging” when they can’t sell. At least in this part of London.</p>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">monthly_ts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">summary_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">yearmonth</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;">as_tsibble</span><span class="op" style="color: #5E5E5E;">(</span>key <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">dataset</span>, index <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">date</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">monthly_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">date</span>, <span class="va" style="color: #111111;">volume</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">dataset</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span>key_glyph <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"timeseries"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>       title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Monthly Property Transaction Volume in SW10"</span>,</span>
<span>       caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Sources: Land Registry &amp; RBKC Planning"</span></span>
<span>       <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/planning/index_files/figure-html/viisualise-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Time-series data may have an underlying trend and a seasonality pattern. I’ll use the seasonal package to decompose each time-series. Each exhibit annual seasonality which evolves over time.</p>
<div class="cell">
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">monthly_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">model</span><span class="op" style="color: #5E5E5E;">(</span>stl <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">STL</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">volume</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;">season</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">components</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Time Series Decomposition"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/planning/index_files/figure-html/decomposition-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>We also see some inverse correlation between the two time-series re-affirming the visual conclusion that planning applications increase when the housing market is depressed.</p>
<div class="cell">
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">monthly_ts</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op" style="color: #5E5E5E;">(</span>names_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">dataset</span>, values_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">volume</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">CCF</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">Sales</span>, <span class="va" style="color: #111111;">Planning</span>, lag_max <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">6</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Correlation Between Sales &amp; Planning"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/planning/index_files/figure-html/correlation-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The overall volumes of planning applications and house transactions in SW10 are fairly similar.</p>
<div class="cell">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">summary_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>total <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">volume</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">dataset</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Dataset"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">dataset</span>, <span class="st" style="color: #20794D;">"Count"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">total</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">Dataset</th>
<th style="text-align: right;">Count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Planning</td>
<td style="text-align: right;">8926</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sales</td>
<td style="text-align: right;">11764</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Earlier, I added a “theme” feature to the data. So let’s take a look at the volume of applications over time faceted by theme and coloured by the outcome. We see that the rise in planning applications is fuelled by basements or excavations, and work on outside landscaping and terracing. So perhaps we do “dig” when we can’t sell.</p>
<div class="cell">
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">tidy_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">dec_year</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">outcome</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="va" style="color: #111111;">theme</span>, nrow <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Planning Application Themes"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: RBKC Planning Search"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/planning/index_files/figure-html/trend-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 8%">
<col style="width: 91%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">DT</td>
<td style="text-align: left;">datatable[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">SPARQL</td>
<td style="text-align: left;">SPARQL[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.numeric[1]; basename[1]; c[17]; factor[1]; is.character[1]; is.na[3]; library[12]; min[1]; readRDS[1]; saveRDS[1]; sum[2]; url[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">date_build[1]; date_parse[1]; get_month[1]; get_year[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[2]; across[4]; arrange[1]; bind_rows[2]; case_when[3]; count[1]; desc[1]; if_else[3]; left_join[1]; mutate[9]; n[4]; na_if[2]; rename[2]; select[2]; slice_head[1]; summarise[4]</td>
</tr>
<tr class="even">
<td style="text-align: left;">fabletools</td>
<td style="text-align: left;">components[1]; model[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">feasts</td>
<td style="text-align: left;">CCF[1]; STL[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">forcats</td>
<td style="text-align: left;">fct_explicit_na[1]; fct_lump[1]; fct_reorder[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[3]; coord_flip[1]; element_text[1]; facet_wrap[1]; geom_bar[1]; geom_col[1]; geom_line[1]; ggplot[3]; labs[5]; scale_colour_manual[2]; scale_fill_manual[1]; theme[1]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">list_rbind[2]; map[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">quanteda</td>
<td style="text-align: left;">corpus[2]; dfm[1]; kwic[1]; phrase[1]; stopwords[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">quanteda.textstats</td>
<td style="text-align: left;">textstat_frequency[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">readr</td>
<td style="text-align: left;">read_csv[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">rvest</td>
<td style="text-align: left;">html_attr[1]; html_element[2]; html_elements[2]; html_table[1]; html_text[1]; read_html[3]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">frequency[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[3]; str_detect[11]; str_extract[1]; str_remove_all[2]; str_replace[2]; str_squish[1]; str_to_lower[1]; str_to_upper[1]; str_trim[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">as_tibble[2]; tibble[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tictoc</td>
<td style="text-align: left;">tic[2]; toc[2]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">pivot_wider[2]; replace_na[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tsibble</td>
<td style="text-align: left;">yearmonth[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">utils</td>
<td style="text-align: left;">download.file[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">vctrs</td>
<td style="text-align: left;">new_datetime[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-quanteda" class="csl-entry">
Benoit, Kenneth, Kohei Watanabe, Haiyan Wang, Paul Nulty, Adam Obeng, Stefan Müller, and Akitaka Matsuo. 2018. <span>“Quanteda: An r Package for the Quantitative Analysis of Textual Data”</span> 3: 774. <a href="https://doi.org/10.21105/joss.00774">https://doi.org/10.21105/joss.00774</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>time series</category>
  <category>correlation</category>
  <category>apps</category>
  <category>tables</category>
  <category>textual analysis</category>
  <guid>https://www.quantumjitter.com/project/planning/index.html</guid>
  <pubDate>Wed, 10 Jan 2018 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/planning/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Surprising Stories</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/stories/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/stories/feature.gif" class="img-fluid" alt="Young woman in a black dress, with a pony-tail moving in the gentle breeze, lies in a rowing boat in the middle of a still lake reading &quot;Carl's Blog&quot;. A sandwich box sits nearby."></p>
<p>Late in 2017 I experimented with geospatial mapping techniques in R. The log file for my blog seemed like a good source of data. I thought it might appeal to a wider audience of one (including me).</p>
<p>Combined with longitude and latitude data from MaxMind’s GeoLite2, this offered a basis for analysis. Although less precise than the GeoIP2 database, this would be more than adequate for my purpose of getting to country and city level. I settled on the leaflet <span class="citation" data-cites="leaflet">(Cheng, Karambelkar, and Xie 2022)</span> package for visualisation given the interactivity and pleasing choice of aesthetics.</p>
<p>The results however were a little puzzling.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">rgeolocate</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://henrikbengtsson.github.io/R.utils/">R.utils</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://rstudio.github.io/leaflet/">leaflet</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="http://rgdal.r-forge.r-project.org">rgdal</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/ramnathv/htmlwidgets">htmlwidgets</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Darjeeling2"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/stories/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">zip_file</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"world_shape_file.zip"</span></span>
<span><span class="va" style="color: #111111;">shape_file</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"TM_WORLD_BORDERS_SIMPL-0.3"</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"http://thematicmapping.org/downloads/"</span>, <span class="va" style="color: #111111;">shape_file</span>, <span class="st" style="color: #20794D;">".zip"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">zip_file</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">zip_file</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">world_spdf</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="http://rgdal.r-forge.r-project.org/reference/rgdal-deprecated.html">readOGR</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">shape_file</span>, verbose <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">url</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">file_name</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span>, <span class="va" style="color: #111111;">file_name</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://henrikbengtsson.github.io/R.utils/reference/compressFile.html">gunzip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">file_name</span>, overwrite <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">stats</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"stats.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">ip_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">stats</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">IP</span>, <span class="va" style="color: #111111;">stats</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">Pages</span>, \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span>, <span class="va" style="color: #111111;">y</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/rgeolocate/man/maxmind.html">maxmind</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="va" style="color: #111111;">x</span>,</span>
<span>    <span class="st" style="color: #20794D;">"GeoLite2-City.mmdb"</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"country_name"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"city_name"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"longitude"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"latitude"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"region_name"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>IP <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      country <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">country_name</span>,</span>
<span>      region <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">region_name</span>,</span>
<span>      city <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">city_name</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      Pages <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">y</span>,</span>
<span>      Views <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>        <span class="va" style="color: #111111;">Pages</span> <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="fl" style="color: #AD0000;">500</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fl" style="color: #AD0000;">1</span>,</span>
<span>        <span class="va" style="color: #111111;">Pages</span> <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="fl" style="color: #AD0000;">1000</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fl" style="color: #AD0000;">2</span>,</span>
<span>        <span class="va" style="color: #111111;">Pages</span> <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="fl" style="color: #AD0000;">2000</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fl" style="color: #AD0000;">3</span>,</span>
<span>        <span class="cn" style="color: #8f5902;">TRUE</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fl" style="color: #AD0000;">4</span></span>
<span>      <span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">ip_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">ip_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">longitude</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|</span> <span class="op" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">latitude</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">Pages</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The concentration of page views in central London was of no immediate surprise as this was likely to be my site maintenance and blogging. What did strike me as odd though was the high concentration of page views in the centre of the US. More curious still, when I zoomed in on Kansas and found myself in the middle of the Cheney Reservoir.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">pal</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html">colorFactor</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>    domain <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">map1</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">world_spdf</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="co" style="color: #5E5E5E;"># World view</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/leaflet/man/addProviderTiles.html">addProviderTiles</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">providers</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">CartoDB.Positron</span>,</span>
<span>    options <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/leaflet/man/addProviderTiles.html">providerTileOptions</a></span><span class="op" style="color: #5E5E5E;">(</span>maxZoom <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">21</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/leaflet/man/map-methods.html">setView</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">30</span>, <span class="fl" style="color: #AD0000;">35</span>, zoom <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="co" style="color: #5E5E5E;"># World view</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addPolygons</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    fillColor <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>    stroke <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>    fillOpacity <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>,</span>
<span>    color <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>    weight <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.3</span>,</span>
<span>    highlight <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">highlightOptions</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      weight <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>,</span>
<span>      color <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>      fillOpacity <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.3</span>,</span>
<span>      bringToFront <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">world_spdf</span><span class="op" style="color: #5E5E5E;">@</span><span class="va" style="color: #111111;">data</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">NAME</span>,</span>
<span>    labelOptions <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/leaflet/man/map-options.html">labelOptions</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      style <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"font-weight"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"normal"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      textsize <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"12px"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircleMarkers</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    lng <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">ip_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">longitude</span>,</span>
<span>    lat <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">ip_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">latitude</span>,</span>
<span>    radius <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">ip_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">Views</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fl" style="color: #AD0000;">5</span>,</span>
<span>      <span class="va" style="color: #111111;">ip_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">Views</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">2</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fl" style="color: #AD0000;">10</span>,</span>
<span>      <span class="va" style="color: #111111;">ip_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">Views</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">3</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fl" style="color: #AD0000;">15</span>,</span>
<span>      <span class="cn" style="color: #8f5902;">TRUE</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fl" style="color: #AD0000;">20</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    fillColor <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;">pal</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">ip_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">Views</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    color <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>    weight <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>,</span>
<span>    fillOpacity <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.7</span>,</span>
<span>    popup <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="st" style="color: #20794D;">"&lt;b&gt;"</span>,</span>
<span>      <span class="va" style="color: #111111;">ip_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">city</span>,</span>
<span>      <span class="st" style="color: #20794D;">"&lt;/b&gt;"</span>,</span>
<span>      <span class="st" style="color: #20794D;">"&lt;br/&gt;"</span>,</span>
<span>      <span class="va" style="color: #111111;">ip_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">region</span>,</span>
<span>      <span class="st" style="color: #20794D;">"&lt;br/&gt;"</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">ip_df</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">Pages</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      <span class="st" style="color: #20794D;">" "</span>,</span>
<span>      <span class="st" style="color: #20794D;">"page views"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/leaflet/man/addLegend.html">addLegend</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    colors <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span>,</span>
<span>    labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"&lt;500"</span>, <span class="st" style="color: #20794D;">"500+"</span>, <span class="st" style="color: #20794D;">"1,000+"</span>, <span class="st" style="color: #20794D;">"2,000+"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    opacity <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Page Views&lt;br/&gt;Oct-23 to Dec-31 2017"</span>,</span>
<span>    position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"bottomleft"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<iframe seamless="" src="../../project/stories/world.html" width="100%" height="500"></iframe>
<p>I imagined someone drifting in the expanse of water with laptop, flask of coffee and box of sandwiches, whiling away the hours absorbed in my blog. Perhaps not. How could such a small number of blog pages generate in excess of 2,000 page views in one spot in less than two months?</p>
<p>Then I chanced upon a <a href="https://www.bbc.co.uk/news/technology-37048521">BBC news article</a> from August 2016. When unable to locate IPs, MaxMind chose the geographical centre of the US as a default. This initially turned out to be a rented house in Kansas, which was rather unfortunate for the occupants, and brought upon them all kinds of unwanted attention.</p>
<p>MaxMind subsequently changed its default centre points to be the middle of bodies of water. And this solved another puzzle. Some of the page views in London appeared to be in the middle of the River Thames.</p>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 6%">
<col style="width: 93%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">R.utils</td>
<td style="text-align: left;">R.utils[1]; gunzip[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.character[1]; basename[1]; c[5]; getwd[1]; is.na[2]; library[7]; list[1]; url[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[1]; arrange[1]; case_when[2]; if_else[2]; mutate[3]; rename[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">htmlwidgets</td>
<td style="text-align: left;">saveWidget[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">leaflet</td>
<td style="text-align: left;">addCircleMarkers[1]; addLegend[1]; addPolygons[1]; addProviderTiles[1]; colorFactor[1]; highlightOptions[1]; labelOptions[1]; leaflet[2]; providerTileOptions[1]; setView[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">list_rbind[1]; map2[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">readr</td>
<td style="text-align: left;">read_csv[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rgdal</td>
<td style="text-align: left;">readOGR[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">rgeolocate</td>
<td style="text-align: left;">maxmind[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">utils</td>
<td style="text-align: left;">download.file[2]; unzip[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-leaflet" class="csl-entry">
Cheng, Joe, Bhaskar Karambelkar, and Yihui Xie. 2022. <span>“Leaflet: Create Interactive Web Maps with the JavaScript ’Leaflet’ Library.”</span> <a href="https://CRAN.R-project.org/package=leaflet">https://CRAN.R-project.org/package=leaflet</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>geospatial</category>
  <guid>https://www.quantumjitter.com/project/stories/index.html</guid>
  <pubDate>Wed, 20 Dec 2017 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/stories/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>House Sales</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/sw10/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/sw10/feature.jpg" class="img-fluid" alt="A painted map of part of central London including the border of SW10 sited next to Chelsea FC"></p>
<p>Various events have impacted house sales in London. There has been a series of increases in <a href="https://www.gov.uk/stamp-duty-land-tax">stamp duty</a> and the impact of the financial crisis. More recently Brexit and the consequences of Covid-19.</p>
<p>How is London postal area SW10 coping with all this?</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span>, exclude <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"date_format"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">SPARQL</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://vctrs.r-lib.org/">vctrs</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tsibble.tidyverts.org">tsibble</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/haleyjeppson/ggmosaic">ggmosaic</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span>name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Darjeeling1"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/sw10/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>House prices paid data are provided by <a href="http://landregistry.data.gov.uk/app/qonsole#">HM Land Registry Open Data</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">endpoint</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"https://landregistry.data.gov.uk/landregistry/query"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">query</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">'PREFIX  text: &lt;http://jena.apache.org/text#&gt;</span></span>
<span><span class="st" style="color: #20794D;">PREFIX  ppd:  &lt;http://landregistry.data.gov.uk/def/ppi/&gt;</span></span>
<span><span class="st" style="color: #20794D;">PREFIX  lrcommon: &lt;http://landregistry.data.gov.uk/def/common/&gt;</span></span>
<span><span class="st" style="color: #20794D;">  </span></span>
<span><span class="st" style="color: #20794D;">SELECT  ?item ?ppd_propertyAddress ?ppd_hasTransaction ?ppd_pricePaid ?ppd_transactionCategory ?ppd_transactionDate ?ppd_transactionId ?ppd_estateType ?ppd_newBuild ?ppd_propertyAddressCounty ?ppd_propertyAddressDistrict ?ppd_propertyAddressLocality ?ppd_propertyAddressPaon ?ppd_propertyAddressPostcode ?ppd_propertyAddressSaon ?ppd_propertyAddressStreet ?ppd_propertyAddressTown ?ppd_propertyType ?ppd_recordStatus</span></span>
<span><span class="st" style="color: #20794D;"></span></span>
<span><span class="st" style="color: #20794D;">WHERE</span></span>
<span><span class="st" style="color: #20794D;">{ ?ppd_propertyAddress text:query _:b0 .</span></span>
<span><span class="st" style="color: #20794D;">  _:b0 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#first&gt; lrcommon:postcode .</span></span>
<span><span class="st" style="color: #20794D;">  _:b0 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#rest&gt; _:b1 .</span></span>
<span><span class="st" style="color: #20794D;">  _:b1 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#first&gt; "( SW10 )" .</span></span>
<span><span class="st" style="color: #20794D;">  _:b1 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#rest&gt; _:b2 .</span></span>
<span><span class="st" style="color: #20794D;">  _:b2 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#first&gt; 3000000 .</span></span>
<span><span class="st" style="color: #20794D;">  _:b2 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#rest&gt; &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#nil&gt; .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:propertyAddress ?ppd_propertyAddress .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:hasTransaction ?ppd_hasTransaction .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:pricePaid ?ppd_pricePaid .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:transactionCategory ?ppd_transactionCategory .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:transactionDate ?ppd_transactionDate .</span></span>
<span><span class="st" style="color: #20794D;">  ?item ppd:transactionId ?ppd_transactionId</span></span>
<span><span class="st" style="color: #20794D;">  </span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?item ppd:estateType ?ppd_estateType }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?item ppd:newBuild ?ppd_newBuild }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:county ?ppd_propertyAddressCounty }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:district ?ppd_propertyAddressDistrict }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:locality ?ppd_propertyAddressLocality }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:paon ?ppd_propertyAddressPaon }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:postcode ?ppd_propertyAddressPostcode }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:saon ?ppd_propertyAddressSaon }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:street ?ppd_propertyAddressStreet }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?ppd_propertyAddress lrcommon:town ?ppd_propertyAddressTown }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?item ppd:propertyType ?ppd_propertyType }</span></span>
<span><span class="st" style="color: #20794D;">  OPTIONAL { ?item ppd:recordStatus ?ppd_recordStatus }</span></span>
<span><span class="st" style="color: #20794D;">}'</span></span>
<span></span>
<span><span class="va" style="color: #111111;">data_lst</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/SPARQL/man/SPARQL.html">SPARQL</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">endpoint</span>, <span class="va" style="color: #111111;">query</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>The focus is on the <a href="https://www.gov.uk/guidance/about-the-price-paid-data#explanations-of-column-headers-in-the-ppd">standard price paid</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_lst</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">results</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    trans_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://vctrs.r-lib.org/reference/new_date.html">new_datetime</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">ppd_transactionDate</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/as_date.html">as_date</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    amount <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">ppd_pricePaid</span>,</span>
<span>    prop_type <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">ppd_propertyType</span>, <span class="st" style="color: #20794D;">"(?&lt;=common/)[\\w]+"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    est_type <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">ppd_estateType</span>, <span class="st" style="color: #20794D;">"(?&lt;=common/)[\\w]+"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    cat <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">ppd_transactionCategory</span>, <span class="st" style="color: #20794D;">"&lt;http://landregistry.data.gov.uk/def/ppi/"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    prop_type <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">prop_type</span>, otherPropertyType <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Other"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cat</span>, <span class="st" style="color: #20794D;">"standard"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>A Telegraph article entitled <a href="https://www.telegraph.co.uk/property/buy/timeline-20-years-of-stamp-duty-increases-for-home-buyers/">Timeline: 20 years of stamp duty increases for home buyers</a> pinpoints many of the key event dates.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">events</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">event_date</span>, <span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">change</span>,</span>
<span>  <span class="st" style="color: #20794D;">"96-07-31"</span>, <span class="st" style="color: #20794D;">"Stamp Duty £250k (1.5%) £500k (2%)"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"98-03-31"</span>, <span class="st" style="color: #20794D;">"£250k (2%) £500k (3%)"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"99-03-31"</span>, <span class="st" style="color: #20794D;">"£250k (2.5%) £500k (3.5%)"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"00-03-31"</span>, <span class="st" style="color: #20794D;">"£250k (3%) £500k (4%)"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"11-04-30"</span>, <span class="st" style="color: #20794D;">"£250k (3%) £500k (4%) £1m (5%)"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"12-03-31"</span>, <span class="st" style="color: #20794D;">"£250k (3%) £500k (4%) £1m (5%) £2m (7%)"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"14-12-31"</span>, <span class="st" style="color: #20794D;">"£250k (5%) £925k (10%) 1.5m (12%)"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"07-08-09"</span>, <span class="st" style="color: #20794D;">"Financial Crisis"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"16-06-23"</span>, <span class="st" style="color: #20794D;">"Brexit Vote"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"20-03-23"</span>, <span class="st" style="color: #20794D;">"Covid-19 Lockdown"</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>event_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">event_date</span>, format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%y-%m-%d"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">events</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Date"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">event_date</span>, <span class="st" style="color: #20794D;">"Event"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">change</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;">Date</th>
<th style="text-align: left;">Event</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1996-07-31</td>
<td style="text-align: left;">Stamp Duty £250k (1.5%) £500k (2%)</td>
</tr>
<tr class="even">
<td style="text-align: left;">1998-03-31</td>
<td style="text-align: left;">£250k (2%) £500k (3%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1999-03-31</td>
<td style="text-align: left;">£250k (2.5%) £500k (3.5%)</td>
</tr>
<tr class="even">
<td style="text-align: left;">2000-03-31</td>
<td style="text-align: left;">£250k (3%) £500k (4%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2011-04-30</td>
<td style="text-align: left;">£250k (3%) £500k (4%) £1m (5%)</td>
</tr>
<tr class="even">
<td style="text-align: left;">2012-03-31</td>
<td style="text-align: left;">£250k (3%) £500k (4%) £1m (5%) £2m (7%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2014-12-31</td>
<td style="text-align: left;">£250k (5%) £925k (10%) 1.5m (12%)</td>
</tr>
<tr class="even">
<td style="text-align: left;">2007-08-09</td>
<td style="text-align: left;">Financial Crisis</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2016-06-23</td>
<td style="text-align: left;">Brexit Vote</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-03-23</td>
<td style="text-align: left;">Covid-19 Lockdown</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Visually, it appears that the financial crisis had a big impact on sales volume, with the Brexit vote sucking much of the remaining oxygen out of the market. Stamp duty increases in between probably slowed any intermediate recovery.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">to_date</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">trans_date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/date_format.html">date_format</a></span><span class="op" style="color: #5E5E5E;">(</span>format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%b %d, %Y"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">trans_date</span>, <span class="va" style="color: #111111;">amount</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">est_type</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op" style="color: #5E5E5E;">(</span>alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.2</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.7</span>, show.legend <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op" style="color: #5E5E5E;">(</span>se <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span>, <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>linetype <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">est_type</span><span class="op" style="color: #5E5E5E;">)</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1.2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"SW10 Standard House Prices"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Prices Paid to {to_date} (Prices &gt; £5m Not Shown)"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Type"</span>, linetype <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Type"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: HM Land Registry"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op" style="color: #5E5E5E;">(</span>xintercept <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">events</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">event_date</span>, </span>
<span>             size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span>, lty <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.4</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"text"</span>, <span class="va" style="color: #111111;">events</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">event_date</span>, <span class="fl" style="color: #AD0000;">5000000</span>,</span>
<span>    angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">90</span>,</span>
<span>    label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">events</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">change</span>, vjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1.4</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>, fontface <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op" style="color: #5E5E5E;">(</span>ylim <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">5000000</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op" style="color: #5E5E5E;">(</span>date_breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"2 years"</span>, date_labels <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%Y"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span>accuracy <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.1</span>, prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>, </span>
<span>                                           scale_cut <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/number.html">cut_short_scale</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/sw10/index_files/figure-html/trend-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>An alternative way of looking at this is by median quarterly prices (with upper and lower quartiles), supplemented by sales volumes.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">qtr_start</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date-today.html">date_today</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Europe/London"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/as_year_quarter_day.html">as_year_quarter_day</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/calendar-boundary.html">calendar_start</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"quarter"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">qtile_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">trans_date</span> <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="va" style="color: #111111;">qtr_start</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>yr_qtr <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://tsibble.tidyverts.org/reference/year-quarter.html">yearquarter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">trans_date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>price <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">amount</span>, <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">0.25</span>, <span class="fl" style="color: #AD0000;">0.5</span>, <span class="fl" style="color: #AD0000;">0.75</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>            quantile <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"lower"</span>, <span class="st" style="color: #20794D;">"median"</span>, <span class="st" style="color: #20794D;">"upper"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            n <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">yr_qtr</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op" style="color: #5E5E5E;">(</span>names_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">quantile</span>, values_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">price</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">last</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">qtile_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">yr_qtr</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">first</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">qtile_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">yr_qtr</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p1</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">qtile_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">yr_qtr</span>, <span class="va" style="color: #111111;">median</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>ymin <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">lower</span>, ymax <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">upper</span><span class="op" style="color: #5E5E5E;">)</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op" style="color: #5E5E5E;">(</span>yintercept <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1000000</span>, linetype <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"dashed"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"text"</span>, x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">17700</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">300000</span>, </span>
<span>           label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Covid-19\nLockdown"</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tsibble.tidyverts.org/reference/tsibble-scales.html">scale_x_yearquarter</a></span><span class="op" style="color: #5E5E5E;">(</span>date_breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"2 years"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_dollar.html">label_dollar</a></span><span class="op" style="color: #5E5E5E;">(</span>prefix <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"£"</span>, </span>
<span>                                      scale_cut <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/number.html">cut_short_scale</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Median Quarterly SW10 Property Prices ({first} to {last})"</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"With Upper / Lower Price Quartiles &amp; Sales Volume"</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Price (Log10)"</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">qtile_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">yr_qtr</span>, <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"text"</span>, x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">14100</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">180</span>, label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Financial\nCrisis"</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"text"</span>, x <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">17100</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">130</span>, label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Brexit\nVote"</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tsibble.tidyverts.org/reference/tsibble-scales.html">scale_x_yearquarter</a></span><span class="op" style="color: #5E5E5E;">(</span>date_breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"2 years"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Transactions"</span>,</span>
<span>       caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: HM Land Registry"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>axis.text.x <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;">(</span>angle <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">45</span>, hjust <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="va" style="color: #111111;">p2</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op" style="color: #5E5E5E;">(</span>heights <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/sw10/index_files/figure-html/median-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>A ggmosaic <span class="citation" data-cites="ggmosaic">(Jeppson, Hofmann, and Cook 2021)</span> visualisation of the composition of SW10 reveals the postal area to be overwhelmingly dominated by leasehold flats.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">num_trans</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggmosaic/man/geom_mosaic.html">geom_mosaic</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggmosaic/man/product.html">product</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">prop_type</span>, <span class="va" style="color: #111111;">est_type</span><span class="op" style="color: #5E5E5E;">)</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">prop_type</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>              offset <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.02</span>, divider <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggmosaic/man/mosaic.html">mosaic</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"h"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"SW10 Transactions by Estate &amp; Property Types"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"{comma(num_trans)} Transactions to {to_date}"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">""</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">""</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Property Type"</span>, </span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: HM Land Registry"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/sw10/index_files/figure-html/composition-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Other blog posts on <a href="../../.">quantum jitter</a> look at SW10 property from diffferent perspectives: <a href="../../project/planning">Digging Deep</a> considers the correlation between house sales and planning applications; and <a href="../../project/bands">Bootstraps &amp; Bandings</a> uses a sample of recent house sales to infer whether property bands are as representative of property values today as they were three decades ago.</p>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 3%">
<col style="width: 96%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">SPARQL</td>
<td style="text-align: left;">SPARQL[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.Date[1]; c[6]; factor[1]; library[10]; max[2]; min[1]; nrow[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">as_date[1]; as_year_quarter_day[1]; calendar_start[1]; date_format[1]; date_parse[1]; date_today[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[2]; mutate[3]; n[2]; pull[3]; recode[1]; rename[1]; summarise[4]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggmosaic</td>
<td style="text-align: left;">geom_mosaic[1]; mosaic[1]; product[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[6]; annotate[4]; coord_cartesian[1]; element_blank[1]; element_text[1]; geom_hline[1]; geom_line[2]; geom_point[1]; geom_ribbon[1]; geom_smooth[1]; geom_vline[1]; ggplot[4]; labs[4]; scale_colour_manual[1]; scale_fill_manual[1]; scale_x_date[1]; scale_y_continuous[1]; scale_y_log10[1]; theme[2]; theme_bw[1]; theme_minimal[1]; theme_set[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[4]</td>
</tr>
<tr class="even">
<td style="text-align: left;">patchwork</td>
<td style="text-align: left;">plot_layout[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">comma[1]; cut_short_scale[2]; label_dollar[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">median[1]; quantile[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_detect[1]; str_extract[2]; str_remove[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">as_tibble[1]; tribble[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">pivot_wider[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tsibble</td>
<td style="text-align: left;">scale_x_yearquarter[2]; tsibble[1]; yearquarter[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">vctrs</td>
<td style="text-align: left;">new_datetime[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-ggmosaic" class="csl-entry">
Jeppson, Haley, Heike Hofmann, and Di Cook. 2021. <span>“Ggmosaic: Mosaic Plots in the ’Ggplot2’ Framework.”</span> <a href="https://CRAN.R-project.org/package=ggmosaic">https://CRAN.R-project.org/package=ggmosaic</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>time series</category>
  <guid>https://www.quantumjitter.com/project/sw10/index.html</guid>
  <pubDate>Sun, 17 Dec 2017 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/sw10/feature.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Where Clouds Cross</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/sets/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/sets/feature.gif" class="img-fluid" alt="A silhouette of the Houses of Parliament with the text &quot;G9&quot; instead of Big Ben's clock. Three semi-transparent clouds move across the sky mimicing a Venn diagram."></p>
<p>When visualising a small number of overlapping sets, <a href="https://en.wikipedia.org/wiki/Venn_diagram">Venn diagrams</a> work well. But what if there are more. Here’s a <a href="https://www.tidyverse.org">tidyverse</a> approach to the exploration of sets and their intersections.</p>
<p>In <a href="../../project/jitter">Let’s Jitter</a> I looked at a relatively simple set of cloud-service-related sales data. <a href="https://www.digitalmarketplace.service.gov.uk/g-cloud/search">G-Cloud data</a> offers a much richer source with many thousands of services documented by several thousand suppliers and hosted across myriad web pages. These services straddle many categories. I’ll use these data to explore the sets and where they cross.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/jabiru/tictoc">tictoc</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/const-ae/ggupset">ggupset</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/gaospecial/ggVennDiagram">ggVennDiagram</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">multisession</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Royal2"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/sets/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>I’m going to focus on the Cloud Hosting lot. Suppliers document the services they want to offer to Public Sector buyers. Each supplier is free to assign each of their services to one or more service categories. It would be interesting to see how these categories overlap when looking at the aggregated data.</p>
<p>I’ll begin by harvesting the URL for each category’s search results. And I’ll also capture the number of search pages for each category. This will enable me to later control how R iterates through the web pages to extract the required data.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">path</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"https://www.applytosupply.digitalmarketplace"</span>, </span>
<span>        <span class="st" style="color: #20794D;">".service.gov.uk/g-cloud/search?lot=cloud-"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">lot_urls</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">path</span>, <span class="st" style="color: #20794D;">"hosting"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">path</span>, <span class="st" style="color: #20794D;">"software"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">path</span>, <span class="st" style="color: #20794D;">"support"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">cat_urls</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://furrr.futureverse.org/reference/future_map.html">future_map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">lot_urls</span>, \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="va" style="color: #111111;">nodes</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">x</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_element.html">html_elements</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">".app-lot-filter__last-list li a"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    url <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">nodes</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_attr.html">html_attr</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"href"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span></span>
<span>    pages <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">nodes</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    pages <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/parse_number.html">parse_number</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pages</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    pages <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pages</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl" style="color: #AD0000;">30</span> <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="fl" style="color: #AD0000;">0</span>, <span class="va" style="color: #111111;">pages</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fl" style="color: #AD0000;">30</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="fl" style="color: #AD0000;">1</span>, <span class="va" style="color: #111111;">pages</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fl" style="color: #AD0000;">30</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    lot <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span>, <span class="st" style="color: #20794D;">"(?&lt;=cloud-)[\\w]+"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    url <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span>, <span class="st" style="color: #20794D;">".*(?=&amp;)"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">version</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">lot_urls</span><span class="op" style="color: #5E5E5E;">[[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">]</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_element.html">html_elements</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">".app-search-result:first-child"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"G-Cloud \\d\\d"</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>So now I’m all set to parallel process through the data at two levels. At category level. And within each category, I’ll iterate through the multiple pages of search results, harvesting 100 service IDs per page.</p>
<p>I’ll also auto-abbreviate the category names so I’ll have the option of more concise names for less-cluttered plotting later on.</p>
<p><a href="https://en.wikipedia.org/wiki/Regular_expression">Regex</a> is used here to isolate pieces of text:</p>
<ul>
<li>
<code>[[:digit:]]{15}</code> finds the 15-digit service ID in the scraped link</li>
<li>
<code>\\Q+\\E</code> finds the <em>literal</em> <code>+</code> character rather than interpreting it as a <em>one or more</em> quantifier (i.e.&nbsp;if the <code>\\Q</code> and <code>\\E</code> were not specified)</li>
</ul>
<div class="cell" data-hash="index_cache/html/service ids_7f41bc651695f0feb2f2d4dc9db871ee">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://furrr.futureverse.org/reference/future_map2.html">future_pmap</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="va" style="color: #111111;">cat_urls</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">url</span>,</span>
<span>      <span class="va" style="color: #111111;">cat_urls</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">pages</span>,</span>
<span>      <span class="va" style="color: #111111;">cat_urls</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">lot</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span>, <span class="va" style="color: #111111;">y</span>, <span class="va" style="color: #111111;">z</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://furrr.futureverse.org/reference/future_map.html">future_map_dfr</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="va" style="color: #111111;">y</span>, \<span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">y</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>        <span class="va" style="color: #111111;">refs</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>          <span class="st" style="color: #20794D;">"https://www.applytosupply.digitalmarketplace"</span>, </span>
<span>          <span class="st" style="color: #20794D;">".service.gov.uk/g-cloud/search?page="</span>,</span>
<span>          <span class="va" style="color: #111111;">y</span>,</span>
<span>          <span class="va" style="color: #111111;">x</span>,</span>
<span>          <span class="st" style="color: #20794D;">"&amp;lot=cloud-"</span>,</span>
<span>          <span class="va" style="color: #111111;">z</span></span>
<span>        <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>          <span class="fu" style="color: #4758AB;"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>          <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_element.html">html_elements</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"#js-dm-live-search-results .govuk-link"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>          <span class="fu" style="color: #4758AB;"><a href="https://rvest.tidyverse.org/reference/html_attr.html">html_attr</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"href"</span><span class="op" style="color: #5E5E5E;">)</span> </span>
<span>        </span>
<span>       <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>            lot <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Cloud "</span>, <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">z</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            service_id <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">refs</span>, <span class="st" style="color: #20794D;">"[[:digit:]]{15}"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>            cat <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span>, <span class="st" style="color: #20794D;">"&amp;serviceCategories="</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>              <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"\\Q+\\E"</span>, <span class="st" style="color: #20794D;">" "</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>              <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"%28[[:print:]]+%29"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>          <span class="op" style="color: #5E5E5E;">)</span></span>
<span>      <span class="op" style="color: #5E5E5E;">}</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">}</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">lot</span><span class="op" style="color: #5E5E5E;">:</span><span class="va" style="color: #111111;">cat</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    cat <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cat</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    abbr <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cat</span>, <span class="st" style="color: #20794D;">"and"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/abbreviate.html">abbreviate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1355.652 sec elapsed</code></pre>
</div>
</div>
<p>Now that I have a nice tidy <a href="https://tibble.tidyverse.org">tibble</a> <span class="citation" data-cites="tibble">(Müller and Wickham 2022)</span>, I can start to think about visualisations.</p>
<p>I like Venn diagrams. But to create one I’ll first need to do a little prep as ggVennDiagram <span class="citation" data-cites="ggVennDiagram">(Gao 2022)</span> requires separate character vectors for each set.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">host_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">lot</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Cloud Hosting"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">abbr</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">keys</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">host_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/group_data.html">group_keys</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">abbr</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">all_cats</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">host_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"service_id"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">keys</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Venn diagrams work best with a small number of sets. So we’ll select four categories.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">four_cats</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">all_cats</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"CAAH"</span>, <span class="st" style="color: #20794D;">"PAAS"</span>, <span class="st" style="color: #20794D;">"OBS"</span>, <span class="st" style="color: #20794D;">"IND"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span></span>
<span></span>
<span><span class="va" style="color: #111111;">four_cats</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggVennDiagram/man/ggVennDiagram.html">ggVennDiagram</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"count"</span>, label_alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op" style="color: #5E5E5E;">(</span>low <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">]</span>, high <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op" style="color: #5E5E5E;">(</span>values <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">4</span>, <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Category Combinations"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"# Services"</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"The Most Frequent Category Combinations"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Focusing on Four {version} Service Categories"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: digitalmarketplace.service.gov.uk\n"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/sets/index_files/figure-html/venn-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Let’s suppose I want to find out which Service IDs lie in a particular intersection. Perhaps I want to go back to the web site with those IDs to search for, and read up on, those particular services. I could use purrr’s <code>reduce</code> to achieve this. For example, let’s extract the IDs at the heart of the Venn which intersect all categories.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">four_cats</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">intersect</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "498337261767401" "735625897584273" "941404079421892" "468519278288161"
 [5] "528818827198493" "590998313986731" "745846238180953" "173163384195854"
 [9] "924318408511326" "920078916328776" "507106315499984" "247181335014212"
[13] "760565690434196" "567990943722560" "674396953847294" "546389562586229"
[17] "616594390875571" "720996025285364"</code></pre>
</div>
</div>
<p>And if we wanted the IDs intersecting the “OBS” and “IND” categories?</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="va" style="color: #111111;">four_cats</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">OBS</span>,</span>
<span>  <span class="va" style="color: #111111;">four_cats</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">IND</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">intersect</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "498337261767401" "622063745429810" "146737546710992" "735625897584273"
 [5] "282378513056803" "824432812764583" "941404079421892" "924245378460936"
 [9] "468519278288161" "979714835327372" "528818827198493" "361367891935175"
[13] "590998313986731" "964621745018513" "745846238180953" "406334290207572"
[17] "173163384195854" "924318408511326" "226716894364641" "920078916328776"
[21] "507106315499984" "247181335014212" "760565690434196" "567990943722560"
[25] "390438216681657" "263304084312287" "133984215794494" "674396953847294"
[29] "761608237467474" "426708477587492" "147659063793653" "546389562586229"
[33] "616594390875571" "172104444338022" "720996025285364" "266583255948268"
[37] "420184478022971" "647839522738604" "746066603748154" "829256437326217"
[41] "455997758057773"</code></pre>
</div>
</div>
<p>Sometimes though we need something a little more scalable than a Venn diagram. The ggupset package provides a good solution. Before we try more than four sets though, I’ll first use the same four categories so we may compare the visualisation to the Venn.</p>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">set_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">abbr</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"CAAH"</span>, <span class="st" style="color: #20794D;">"PAAS"</span>, <span class="st" style="color: #20794D;">"OBS"</span>, <span class="st" style="color: #20794D;">"IND"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>category <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cat</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">service_id</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">service_id</span>, <span class="va" style="color: #111111;">category</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">category</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">set_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">category</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>y <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span>, label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span>, vjust <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.1</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggupset/man/scale_x_upset.html">scale_x_upset</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>expand <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op" style="color: #5E5E5E;">(</span>mult <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">0.15</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>panel.border <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Category Combinations"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"The Most Frequent Category Combinations"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Focusing on Four {version} Service Categories"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: digitalmarketplace.service.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/sets/index_files/figure-html/frequent-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Now let’s take a look at the intersections across all the categories. And let’s suppose that our particular interest is all services which appear in one, and only one, category.</p>
<div class="cell">
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">set_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="fl" style="color: #AD0000;">1</span>, <span class="va" style="color: #111111;">lot</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Cloud Hosting"</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">service_id</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>category <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cat</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">service_id</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">service_id</span>, <span class="va" style="color: #111111;">category</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">category</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">set_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">category</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>y <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span>, label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span>, vjust <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.1</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggupset/man/scale_x_upset.html">scale_x_upset</a></span><span class="op" style="color: #5E5E5E;">(</span>n_sets <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>expand <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op" style="color: #5E5E5E;">(</span>mult <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">0.15</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>panel.border <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Category Combinations"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"10 Most Frequent Single-Category Services"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Focused on Service Categories in the Cloud Hosting Lot"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: digitalmarketplace.service.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/sets/index_files/figure-html/singles-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Suppose we want to extract the intersection data for the top intersections across all sets. I could use functions from the tidyr package to achieve this.</p>
<div class="cell">
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">cat_mix</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">lot</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Cloud Hosting"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cat</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">service_id</span>, names_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cat</span>, values_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">x</span>, values_fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"^"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span><span class="op" style="color: #5E5E5E;">(</span>col <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">intersect</span>, <span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">service_id</span>, sep <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"/"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">intersect</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    intersect <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">intersect</span>, <span class="st" style="color: #20794D;">"(?:\\Q/^\\E|\\Q^/\\E)"</span>, <span class="st" style="color: #20794D;">""</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    intersect <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">intersect</span>, <span class="st" style="color: #20794D;">"/"</span>, <span class="st" style="color: #20794D;">" | "</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">21</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">cat_mix</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="st" style="color: #20794D;">"Intersecting Categories"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">intersect</span>,</span>
<span>    <span class="st" style="color: #20794D;">"Services Count"</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 95%">
<col style="width: 4%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Intersecting Categories</th>
<th style="text-align: right;">Services Count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Platform As A Service</td>
<td style="text-align: right;">501</td>
</tr>
<tr class="even">
<td style="text-align: left;">Compute And Application Hosting</td>
<td style="text-align: right;">182</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Networking</td>
<td style="text-align: right;">142</td>
</tr>
<tr class="even">
<td style="text-align: left;">Archiving Backup And Disaster Recovery</td>
<td style="text-align: right;">107</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Other Storage Services</td>
<td style="text-align: right;">94</td>
</tr>
<tr class="even">
<td style="text-align: left;">Archiving Backup And Disaster Recovery | Compute And Application Hosting | Nosql Database | Other Database Services | Networking | Platform As A Service | Search | Block Storage | Object Storage | Other Storage Services</td>
<td style="text-align: right;">76</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Logging And Analysis</td>
<td style="text-align: right;">67</td>
</tr>
<tr class="even">
<td style="text-align: left;">Other Database Services</td>
<td style="text-align: right;">57</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Infrastructure And Platform Security</td>
<td style="text-align: right;">57</td>
</tr>
<tr class="even">
<td style="text-align: left;">Compute And Application Hosting | Platform As A Service</td>
<td style="text-align: right;">51</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Archiving Backup And Disaster Recovery | Compute And Application Hosting | Content Delivery Network | Data Warehousing | Distributed Denial Of Service Attack Protection | Firewall | Infrastructure And Platform Security | Intrusion Detection | Platform As A Service | Protective Monitoring</td>
<td style="text-align: right;">39</td>
</tr>
<tr class="even">
<td style="text-align: left;">Relational Database</td>
<td style="text-align: right;">38</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Container Service</td>
<td style="text-align: right;">34</td>
</tr>
<tr class="even">
<td style="text-align: left;">Message Queuing And Processing</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Infrastructure And Platform Security | Intrusion Detection | Logging And Analysis | Protective Monitoring</td>
<td style="text-align: right;">27</td>
</tr>
<tr class="even">
<td style="text-align: left;">Archiving Backup And Disaster Recovery | Compute And Application Hosting | Nosql Database | Relational Database | Other Database Services | Networking | Platform As A Service | Search | Block Storage | Other Storage Services</td>
<td style="text-align: right;">23</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Archiving Backup And Disaster Recovery | Compute And Application Hosting | Firewall | Infrastructure And Platform Security | Intrusion Detection | Load Balancing | Logging And Analysis | Networking | Platform As A Service | Protective Monitoring</td>
<td style="text-align: right;">22</td>
</tr>
<tr class="even">
<td style="text-align: left;">Block Storage | Object Storage | Other Storage Services</td>
<td style="text-align: right;">22</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Archiving Backup And Disaster Recovery | Other Storage Services</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="even">
<td style="text-align: left;">Compute And Application Hosting | Container Service | Platform As A Service</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Infrastructure And Platform Security | Networking</td>
<td style="text-align: right;">20</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>And I can compare this table to the equivalent ggupset <span class="citation" data-cites="ggupset">(Ahlmann-Eltze 2020)</span>visualisation.</p>
<div class="cell">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">set_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">lot</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Cloud Hosting"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>category <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cat</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">service_id</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">service_id</span>, <span class="va" style="color: #111111;">category</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">category</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">set_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">category</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>y <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span>, label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n</span><span class="op" style="color: #5E5E5E;">)</span>, vjust <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.1</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggupset/man/scale_x_upset.html">scale_x_upset</a></span><span class="op" style="color: #5E5E5E;">(</span>n_sets <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">22</span>, n_intersections <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">21</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>expand <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op" style="color: #5E5E5E;">(</span>mult <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">0.15</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span>panel.border <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Category Combinations"</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Top Intersections Across all Sets"</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Focused on Service Categories in the Cloud Hosting Lot"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: digitalmarketplace.service.gov.uk"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/sets/index_files/figure-html/upset top-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>And if I want to extract all the service IDs for the top 5 intersections, I could use dplyr <span class="citation" data-cites="dplyr">(Wickham et al. 2022)</span> and tidyr <span class="citation" data-cites="tidyr">(Wickham and Girlich 2022)</span> verbs to achieve this too.</p>
<p>I won’t print them all out though!</p>
<div class="cell">
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">top5_int</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">data_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">lot</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Cloud Hosting"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">service_id</span>, <span class="va" style="color: #111111;">abbr</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>x <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">abbr</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op" style="color: #5E5E5E;">(</span>names_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">abbr</span>, values_from <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">x</span>, values_fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"^"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span><span class="op" style="color: #5E5E5E;">(</span>col <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">intersect</span>, <span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">service_id</span>, sep <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"/"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    intersect <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">intersect</span>, <span class="st" style="color: #20794D;">"(?:\\Q/^\\E|\\Q^/\\E)"</span>, <span class="st" style="color: #20794D;">""</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    intersect <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">intersect</span>, <span class="st" style="color: #20794D;">"/"</span>, <span class="st" style="color: #20794D;">" | "</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>count <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">service_id</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">intersect</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">count</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">intersect</span>, <span class="va" style="color: #111111;">service_id</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/count.html">add_count</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">intersect</span>, wt <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">count</span>, name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"temp"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>temp <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/row_number.html">dense_rank</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">temp</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">temp</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">service_id</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">top5_int</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>service_ids <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">service_id</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: right;">service_ids</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">1026</td>
</tr></tbody>
</table>
</div>
</div>
</div>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 5%">
<col style="width: 94%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">abbreviate[1]; as.character[1]; c[7]; cat[6]; library[8]; list[5]; rep[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[7]; add_count[1]; arrange[2]; count[2]; dense_rank[1]; desc[3]; distinct[4]; group_by[1]; group_keys[1]; group_split[1]; if_else[1]; mutate[14]; n[8]; n_distinct[2]; pull[1]; rename[1]; select[2]; slice[1]; summarise[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">furrr</td>
<td style="text-align: left;">future_map[1]; future_map_dfr[1]; future_pmap[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">future</td>
<td style="text-align: left;">multisession[1]; plan[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggVennDiagram</td>
<td style="text-align: left;">ggVennDiagram[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[6]; element_blank[3]; expansion[3]; geom_bar[3]; geom_label[3]; ggplot[3]; labs[4]; scale_colour_manual[1]; scale_fill_gradient[1]; scale_y_continuous[3]; theme[3]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggupset</td>
<td style="text-align: left;">scale_x_upset[3]</td>
</tr>
<tr class="even">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[3]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">purrr</td>
<td style="text-align: left;">list_rbind[2]; map[1]; reduce[2]; set_names[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">readr</td>
<td style="text-align: left;">parse_number[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rvest</td>
<td style="text-align: left;">html_attr[2]; html_elements[3]; html_text[2]; read_html[3]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[6]; str_extract[3]; str_remove[4]; str_replace[1]; str_replace_all[4]; str_to_title[2]; str_to_upper[1]; str_trim[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tibble</td>
<td style="text-align: left;">tibble[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">tictoc</td>
<td style="text-align: left;">tic[1]; toc[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tidyr</td>
<td style="text-align: left;">pivot_wider[2]; unite[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-ggupset" class="csl-entry">
Ahlmann-Eltze, Constantin. 2020. <span>“Ggupset: Combination Matrix Axis for ’Ggplot2’ to Create ’UpSet’ Plots.”</span> <a href="https://CRAN.R-project.org/package=ggupset">https://CRAN.R-project.org/package=ggupset</a>.
</div>
<div id="ref-ggVennDiagram" class="csl-entry">
Gao, Chun-Hui. 2022. <span>“ggVennDiagram: A ’Ggplot2’ Implement of Venn Diagram.”</span> <a href="https://CRAN.R-project.org/package=ggVennDiagram">https://CRAN.R-project.org/package=ggVennDiagram</a>.
</div>
<div id="ref-tibble" class="csl-entry">
Müller, Kirill, and Hadley Wickham. 2022. <span>“Tibble: Simple Data Frames.”</span> <a href="https://CRAN.R-project.org/package=tibble">https://CRAN.R-project.org/package=tibble</a>.
</div>
<div id="ref-dplyr" class="csl-entry">
Wickham, Hadley, Romain François, Lionel Henry, and Kirill Müller. 2022. <span>“Dplyr: A Grammar of Data Manipulation.”</span> <a href="https://CRAN.R-project.org/package=dplyr">https://CRAN.R-project.org/package=dplyr</a>.
</div>
<div id="ref-tidyr" class="csl-entry">
Wickham, Hadley, and Maximilian Girlich. 2022. <span>“Tidyr: Tidy Messy Data.”</span> <a href="https://CRAN.R-project.org/package=tidyr">https://CRAN.R-project.org/package=tidyr</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>sets</category>
  <category>web scraping</category>
  <category>regex</category>
  <guid>https://www.quantumjitter.com/project/sets/index.html</guid>
  <pubDate>Tue, 14 Nov 2017 00:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/sets/feature.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Let’s Jitter</title>
  <dc:creator>Carl Goodwin</dc:creator>
  <link>https://www.quantumjitter.com/project/jitter/index.html</link>
  <description><![CDATA[ <p><img src="https://www.quantumjitter.com/project/jitter/feature.gif" class="img-fluid" alt="A silhouette of the Houses of Parliament with the text &quot;G9&quot; instead of Big Ben's clock. In the sky, three clouds jitter and leaves are swept by the wind across the word &quot;Autumn&quot;."></p>
<p>Welcome to the <a href="https://www.tidyverse.org">tidyverse</a> <span class="citation" data-cites="tidyverse">(Wickham et al. 2019)</span> with data ingestion, cleaning and tidying. And some visualisations of sales data with a little jittering.</p>
<p>This first little project uses the tidyverse collection of packages to import, explore and visualise some sales data. The UK Government’s Digital Marketplace provides a rich and varied source of public data <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">under the Open Government Licence</a> <sup>1</sup>.</p>
<p>The marketplace was set up with an intent to break down barriers that impede Small and Medium Enterprises (SMEs) from bidding for Public Sector contracts. So, let’s see how that’s going.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://clock.r-lib.org">clock</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://scales.r-lib.org">scales</a></span>, exclude <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"date_format"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/karthik/wesanderson">wesanderson</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">cols</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/wesanderson/man/wes_palette.html">wes_palette</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Royal1"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/jitter/index_files/figure-html/theme-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The tidyverse framework sits at the heart of all my data science work as evidenced in my <a href="../../project/box">favourite things</a>. So I’ll begin by using two of my most used tidyverse packages (readr <span class="citation" data-cites="readr">(Wickham, Hester, and Bryan 2022)</span> and dplyr <span class="citation" data-cites="dplyr">(Wickham et al. 2022)</span>) to import and tidy the cloud services (G-Cloud) sales data.</p>
<p>Wild data are often scruffy affairs. Cleaning and tidying is a necessary first step. In the case of these data, there are characters in an otherwise numeric spend column. And the date column is a mix of two formats.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">url</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="st" style="color: #20794D;">"https://www.gov.uk/government/"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"uploads/system/uploads/attachment_data/"</span>,</span>
<span>  <span class="st" style="color: #20794D;">"file/639799/g-cloud-sales-figures-july2017.csv"</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">gcloud_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">url</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    evidenced_spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">evidenced_spend</span>, <span class="st" style="color: #20794D;">"[^0-9-]"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/parse_number.html">parse_number</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    spend_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">return_month</span><span class="op" style="color: #5E5E5E;">)</span>, origin <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"1899-12-30"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    spend_date <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend_date</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_parse.html">date_parse</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">return_month</span>, format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%d/%m/%y"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>      <span class="va" style="color: #111111;">spend_date</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    sme_status <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sme_status</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"SME"</span>, <span class="st" style="color: #20794D;">"SME"</span>, <span class="st" style="color: #20794D;">"Non-SME"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    sme_spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sme_status</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"SME"</span>, <span class="va" style="color: #111111;">evidenced_spend</span>, <span class="fl" style="color: #AD0000;">0</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Now we can summarise and visualise how the SME share has changed over time using the ggplot2 package.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">share_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">gcloud_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    evidenced_spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">evidenced_spend</span>, na.rm <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    sme_spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sme_spend</span>, na.rm <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    pct <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">sme_spend</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="va" style="color: #111111;">evidenced_spend</span>, </span>
<span>    .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">spend_date</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend_date</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">last_date</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">gcloud_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend_date</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://clock.r-lib.org/reference/date_format.html">date_format</a></span><span class="op" style="color: #5E5E5E;">(</span>format <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%B %d, %Y"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">share_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">spend_date</span>, <span class="va" style="color: #111111;">pct</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op" style="color: #5E5E5E;">(</span>colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op" style="color: #5E5E5E;">(</span>date_breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"years"</span>, date_labels <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"%Y"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"SME Share of G-Cloud to {last_date}"</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Dots = % Monthly Sales via SMEs"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: GOV.UK G-Cloud Sales"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/jitter/index_files/figure-html/share-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Sales grew steadily to a cumulative £2.4B by July 2017. And as the volume of sales grew, an increasingly clearer picture of sustained growth in the SME share emerged. However, in those latter few months, SMEs lost a little ground.</p>
<p>Dig a little deeper, and one can also see variation by sub-sector. And that’s after setting aside those buyers with cumulative G-Cloud spend below £100k, where large enterprise suppliers are less inclined to compete.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">sector_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">gcloud_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>sector <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    <span class="va" style="color: #111111;">sector</span> <span class="op" style="color: #5E5E5E;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Central Government"</span>, <span class="st" style="color: #20794D;">"Local Government"</span>, </span>
<span>                  <span class="st" style="color: #20794D;">"Police"</span>, <span class="st" style="color: #20794D;">"Health"</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="va" style="color: #111111;">sector</span>, <span class="st" style="color: #20794D;">"Other Sector"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    evidenced_spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">evidenced_spend</span>, na.rm <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    sme_spend <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sme_spend</span>, na.rm <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    pct <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">sme_spend</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="va" style="color: #111111;">evidenced_spend</span>,</span>
<span>    .by <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">customer_name</span>, <span class="va" style="color: #111111;">sector</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">evidenced_spend</span> <span class="op" style="color: #5E5E5E;">&gt;=</span> <span class="fl" style="color: #AD0000;">100000</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>median_pct <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pct</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">sector</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">|&gt;</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;">(</span>sector <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sector</span>, <span class="va" style="color: #111111;">median_pct</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">n_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">sector_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>n <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>, .by <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">sector</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">sector_df</span> <span class="op" style="color: #5E5E5E;">|&gt;</span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">sector</span>, <span class="va" style="color: #111111;">pct</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op" style="color: #5E5E5E;">(</span>outlier.shape <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op" style="color: #5E5E5E;">(</span>width <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.2</span>, alpha <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>y <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">.75</span>, label <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"n = {n}"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">n_df</span>,</span>
<span>    fill <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cols</span><span class="op" style="color: #5E5E5E;">[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span>, colour <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"white"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;">(</span>labels <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    x <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, y <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>,</span>
<span>    title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"SME Share of G-Cloud to {last_date}"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    subtitle <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"% Sales via SMEs for Buyers with Cumulative Sales &gt;= £100k"</span>,</span>
<span>    caption <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Source: gov.uk G-Cloud Sales"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.quantumjitter.com/project/jitter/index_files/figure-html/sub-sector-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>The <a href="https://en.wikipedia.org/wiki/Box_plot">box plot</a>, overlaid with jittered points to avoid over-plotting, shows:</p>
<ul>
<li>Central government, with its big-spending departments, and police favouring large suppliers. This may reflect, among other things, their ability to scale.</li>
<li>Local government and health, in contrast, favouring SMEs. And this despite their looser tether to central government strategy.</li>
</ul>
<p>So, irrespective of whether service integration is taken in-house or handled by a service integrator, large enterprise suppliers have much to offer:</p>
<ul>
<li>The ability to deliver at scale;</li>
<li>A breadth and depth of capabilities exploitable during discovery to better articulate the “art of the possible”;</li>
<li>A re-assurance that there is always extensive capability on hand.</li>
</ul>
<p>SMEs offer flexibility, fresh thinking and broader competition, often deploying their resources and building their mission around a narrower focus. They tend to do one thing, or a few things, exceptionally well.</p>
<p>These data are explored further in <a href="../../project/six">Six months later</a> and <a href="../../project/forecast">Can Ravens Forecast</a>.</p>
<section id="r-toolbox" class="level2"><h2 class="anchored" data-anchor-id="r-toolbox">R Toolbox</h2>
<p>Summarising below the packages and functions used in this post enables me to separately create a <a href="../../project/box">toolbox visualisation</a> summarising the usage of packages and functions across all posts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 6%">
<col style="width: 93%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: left;">as.Date[1]; as.numeric[1]; c[2]; is.na[1]; library[6]; max[1]; sum[4]</td>
</tr>
<tr class="even">
<td style="text-align: left;">clock</td>
<td style="text-align: left;">date_format[1]; date_parse[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: left;">filter[1]; arrange[1]; if_else[4]; mutate[4]; n[1]; pull[1]; summarise[4]</td>
</tr>
<tr class="even">
<td style="text-align: left;">forcats</td>
<td style="text-align: left;">fct_reorder[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ggplot2</td>
<td style="text-align: left;">aes[3]; geom_boxplot[1]; geom_jitter[1]; geom_label[1]; geom_point[1]; geom_smooth[1]; ggplot[2]; labs[2]; scale_x_date[1]; scale_y_continuous[2]; theme_bw[1]; theme_set[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">glue</td>
<td style="text-align: left;">glue[4]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">janitor</td>
<td style="text-align: left;">clean_names[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">readr</td>
<td style="text-align: left;">parse_number[1]; read_csv[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">scales</td>
<td style="text-align: left;">label_percent[2]</td>
</tr>
<tr class="even">
<td style="text-align: left;">stats</td>
<td style="text-align: left;">median[1]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stringr</td>
<td style="text-align: left;">str_c[1]; str_remove_all[1]</td>
</tr>
<tr class="even">
<td style="text-align: left;">wesanderson</td>
<td style="text-align: left;">wes_palette[1]</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-tidyverse" class="csl-entry">
Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“Welcome to the <span></span>Tidyverse<span></span>”</span> 4: 1686. <a href="https://doi.org/10.21105/joss.01686">https://doi.org/10.21105/joss.01686</a>.
</div>
<div id="ref-dplyr" class="csl-entry">
Wickham, Hadley, Romain François, Lionel Henry, and Kirill Müller. 2022. <span>“Dplyr: A Grammar of Data Manipulation.”</span> <a href="https://CRAN.R-project.org/package=dplyr">https://CRAN.R-project.org/package=dplyr</a>.
</div>
<div id="ref-readr" class="csl-entry">
Wickham, Hadley, Jim Hester, and Jennifer Bryan. 2022. <span>“Readr: Read Rectangular Text Data.”</span> <a href="https://CRAN.R-project.org/package=readr">https://CRAN.R-project.org/package=readr</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>
<ol>
<li id="fn1"><p>&nbsp;Contains public sector information licensed under the Open Government Licence v3.0.↩︎</p></li>
</ol></section></div> ]]></description>
  <category>R</category>
  <guid>https://www.quantumjitter.com/project/jitter/index.html</guid>
  <pubDate>Mon, 11 Sep 2017 23:00:00 GMT</pubDate>
  <media:content url="https://www.quantumjitter.com/project/jitter/feature.gif" medium="image" type="image/gif"/>
</item>
</channel>
</rss>
