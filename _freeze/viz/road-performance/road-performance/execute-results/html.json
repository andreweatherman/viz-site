{
  "hash": "b38324e13e41a893e6a7c121bad5fccd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Best Road Performance\"\nauthor: \"Andrew Weatherman\"\ndate: \"2024-05-19\"\ncategories: [gt, college basketball, cbbdata]\ndescription: \"Adjusted road performances in college basketball\"\n---\n\n\n# The What\n\nA `gt` table that calculates the 10 best T-Rank efficiency ratings in true D-1 vs. D-1 road performances -- also includes a composite season-long predictive average across all games and quadrant records in true road games.\n\n<details>\n\n<summary>Final Table</summary>\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](final_table.png){width=100%}\n:::\n:::\n\n\n</details>\n\n# The How\n\nFor this visualization, you will need the following packages:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(cbbdata)\nlibrary(cbbplotR)\nlibrary(tidyverse)\nlibrary(gt)\nlibrary(gtExtras)\n```\n:::\n\n\n## Scripts\n\nThis visualization is not yet accompanied by a tutorial.\n\n### The Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## grab ratings in away games vs. top 150\naway_ratings <- cbd_torvik_team_factors(year = 2024, venue = 'away')\n\n## get best away win by highest T-Rank\nbest_win <- cbd_torvik_game_factors(year = 2024, location = 'A') %>%\n  filter(result == 'W') %>% \n  left_join(cbd_torvik_ratings(year=2024) %>% select(team, barthag), join_by('opp' == 'team')) %>% \n  left_join(cbd_teams() %>% select(opp = common_team, opp_logo = logo)) %>% \n  slice_max(barthag, n = 1, by = team) %>% \n  select(team, opp_logo)\n\n## get quad records in away games\nquad_records <- cbd_torvik_team_schedule(year = 2024, location = 'A') %>% \n  filter(date < Sys.Date()) %>% \n  cbd_add_net_quad() %>% \n  # join on results\n  left_join(cbd_torvik_game_box(year = 2024) %>% select(date, team, opp, result),\n            by = c('date', 'team', 'opp')) %>% \n  summarize(\n    record = paste0(sum(result == 'W'), '-', sum(result == 'L')),\n    .by = c(team, quad)\n  ) %>% \n  # pivot wider so we get proper joining + plotting format\n  pivot_wider(names_from = quad, values_from = record) %>% \n  # replace NAs (quads with no games) as 0-0\n  mutate(across(-team, ~ifelse(.x == 'NA-NA' | is.na(.x), '0-0', .x))) %>% \n  # rename // could do this later in gt\n  select(team, q1 = `Quadrant 1`, q2 = `Quadrant 2`, q3 = `Quadrant 3`, q4 = `Quadrant 4`)\n\n# get predictive metric average\npred_avg <- cbd_all_metrics() %>% \n  summarize(\n    avg = (trank_rank + kp_rank + bpi_rank + net_rank) / 4,\n    .by = team\n  )\n\n## join together\ndata <- list(away_ratings, quad_records, best_win, pred_avg) %>% \n  # use reduce to quickly join multiple DFs (passed as list) w/ a common key (team)\n  reduce(left_join, by = 'team') %>% \n  # take highest barthags\n  slice_max(barthag, n = 10) %>%\n  # add logos\n  left_join(cbd_teams() %>% select(team = common_team, logo = logo)) %>% \n  mutate(team = glue(\"<img src='{logo}' style='height: 20px; width: auto; vertical-align: -25%;'>&nbsp; {team}\")) %>% \n  # add record column // add record to logo col.\n  mutate(record = paste0(wins, '-', losses),\n         team = paste0(team, ' (', record, ')'),\n         avg = paste0('#', round(avg, 0))) %>% \n  # select columns to plot\n  select(avg, team, adj_o, adj_d, barthag, starts_with('q'), best = opp_logo)\n```\n:::\n\n\n### The Table\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# make table\ndata %>% \n  # set table id so we can use css later\n  gt(id = 'table') %>% \n  # add theme as a base\n  gt_theme_nytimes() %>% \n  # render logos\n  fmt_markdown(team) %>% \n  # render best win logo\n  fmt_image(best, width = 20, height = 20) %>% \n  # round numbers\n  fmt_number(columns = adj_o:adj_d, decimals = 1) %>% \n  fmt_percent(columns = barthag, decimals = 1) %>% \n  # align cols\n  cols_align(columns = avg, 'right') %>% \n  cols_align(columns = -c(team, avg), 'center') %>% \n  # bold barthag\n  tab_style(locations = cells_body(columns = barthag), style = cell_text(weight = 'bold')) %>% \n  # add spanner for quad\n  tab_spanner(columns = q1:q4, label = 'Quadrant Records') %>% \n  # add spanner for t-rank\n  tab_spanner(columns = adj_o:barthag, label = 'Road Efficiency') %>% \n  # add dividers\n  gt_add_divider(team, include_labels = FALSE, color = 'black', weight = px(1.5)) %>% \n  gt_add_divider(barthag, include_labels = FALSE, color = 'black', weight = px(1.5)) %>% \n  gt_add_divider(q4, include_labels = FALSE, color = 'black', weight = px(1.5)) %>% \n  # add footnote for best win\n  tab_footnote(locations = cells_column_labels(columns = best),\n               footnote = 'Highest current opponent T-Rank in a road win') %>% \n  # add footnote for T-Rank\n  tab_footnote(locations = cells_column_labels(columns = barthag),\n               footnote = 'T-Rank Rating: WP% vs. average team on neutral floor based on road performance') %>%\n  # add footnote for pred average\n  tab_footnote(locations = cells_column_labels(columns = avg),\n               footnote = 'Predictive Average: KenPom, T-Rank, BPI, and NET (rounded to nearest integer)') %>% \n  # rename cols.\n  cols_label(\n    team = 'Team (record)',\n    adj_o = 'Adj. O',\n    adj_d = 'Adj. D',\n    barthag = 'T-Rank',\n    best = 'Best'\n  ) %>% \n  # add stripping b/c why not and it looks good\n  opt_row_striping() %>% \n  tab_options(data_row.padding = 4,\n              footnotes.font.size = 11,\n              # do this so we have the light lines below column spanners!\n              column_labels.border.bottom.style = \"solid\",\n              column_labels.border.bottom.width = px(1), \n              column_labels.border.bottom.color = \"black\",\n              table.border.bottom.style = 'none',\n              source_notes.font.size = 10,\n              source_notes.border.lr.style = \"none\") %>% \n  # add headers // labs\n  tab_header(\n    title = 'Who are the best road teams in college basketball?',\n    subtitle = \"10 highest T-Rank ratings in true road performances (D-1 vs. D-1)\"\n  ) %>% \n  tab_source_note(\n    md(\"Data by cbbdata + cbbplotR through 2023-24<br>Table + Analysis by @andreweatherman\")\n  ) %>% \n  # css // this does some light other formatting and styling\n  opt_css(\n    '#table .gt_footnote {\n        padding-top: 2px !important;\n        padding-bottom: 2px !important;\n        line-height: 1;\n      }\n    #table .gt_heading {\n         padding-bottom: 0px;\n         padding-top: 6px\n        }\n      #table .gt_subtitle {\n         padding-top: 2px;\n         padding-bottom: 6px;\n      }\n      #table .gt_sourcenote {\n         text-align: right\n        }\n    '\n  ) %>% \n  # save it!\n  gtsave_extra('best_road_teams.png', zoom = 3)\n```\n:::\n\n\n## Complete Script\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(cbbdata)\nlibrary(cbbplotR)\nlibrary(tidyverse)\nlibrary(gt)\nlibrary(gtExtras)\n\naway_ratings <- cbd_torvik_team_factors(year = 2024, venue = 'away')\n\nbest_win <- cbd_torvik_game_factors(year = 2024, location = 'A') %>%\n  filter(result == 'W') %>% \n  left_join(cbd_torvik_ratings(year=2024) %>% select(team, barthag), join_by('opp' == 'team')) %>% \n  left_join(cbd_teams() %>% select(opp = common_team, opp_logo = logo)) %>% \n  slice_max(barthag, n = 1, by = team) %>% \n  select(team, opp_logo)\n\nquad_records <- cbd_torvik_team_schedule(year = 2024, location = 'A') %>% \n  filter(date < Sys.Date()) %>% \n  cbd_add_net_quad() %>% \n  left_join(cbd_torvik_game_box(year = 2024) %>% select(date, team, opp, result),\n            by = c('date', 'team', 'opp')) %>% \n  summarize(\n    record = paste0(sum(result == 'W'), '-', sum(result == 'L')),\n    .by = c(team, quad)\n  ) %>% \n  pivot_wider(names_from = quad, values_from = record) %>% \n  mutate(across(-team, ~ifelse(.x == 'NA-NA' | is.na(.x), '0-0', .x))) %>% \n  select(team, q1 = `Quadrant 1`, q2 = `Quadrant 2`, q3 = `Quadrant 3`, q4 = `Quadrant 4`)\n\npred_avg <- cbd_all_metrics() %>% \n  summarize(\n    avg = (trank_rank + kp_rank + bpi_rank + net_rank) / 4,\n    .by = team\n  )\n\ndata <- list(away_ratings, quad_records, best_win, pred_avg) %>% \n  reduce(left_join, by = 'team') %>% \n  slice_max(barthag, n = 10) %>%\n  left_join(cbd_teams() %>% select(team = common_team, logo = logo)) %>% \n  mutate(team = glue(\"<img src='{logo}' style='height: 20px; width: auto; vertical-align: -25%;'>&nbsp; {team}\")) %>% \n  mutate(record = paste0(wins, '-', losses),\n         team = paste0(team, ' (', record, ')'),\n         avg = paste0('#', round(avg, 0))) %>% \n  select(avg, team, adj_o, adj_d, barthag, starts_with('q'), best = opp_logo)\n\ndata %>% \n  gt(id = 'table') %>% \n  gt_theme_nytimes() %>% \n  fmt_markdown(team) %>% \n  fmt_image(best, width = 20, height = 20) %>% \n  fmt_number(columns = adj_o:adj_d, decimals = 1) %>% \n  fmt_percent(columns = barthag, decimals = 1) %>% \n  cols_align(columns = avg, 'right') %>% \n  cols_align(columns = -c(team, avg), 'center') %>% \n  tab_style(locations = cells_body(columns = barthag), style = cell_text(weight = 'bold')) %>% \n  tab_spanner(columns = q1:q4, label = 'Quadrant Records') %>% \n  tab_spanner(columns = adj_o:barthag, label = 'Road Efficiency') %>% \n  gt_add_divider(team, include_labels = FALSE, color = 'black', weight = px(1.5)) %>% \n  gt_add_divider(barthag, include_labels = FALSE, color = 'black', weight = px(1.5)) %>% \n  gt_add_divider(q4, include_labels = FALSE, color = 'black', weight = px(1.5)) %>%\n  tab_footnote(locations = cells_column_labels(columns = best),\n               footnote = 'Highest current opponent T-Rank in a road win') %>% \n  tab_footnote(locations = cells_column_labels(columns = barthag),\n               footnote = 'T-Rank Rating: WP% vs. average team on neutral floor based on road performance') %>%\n  tab_footnote(locations = cells_column_labels(columns = avg),\n               footnote = 'Predictive Average: KenPom, T-Rank, BPI, and NET (rounded to nearest integer)') %>% \n  cols_label(\n    team = 'Team (record)',\n    adj_o = 'Adj. O',\n    adj_d = 'Adj. D',\n    barthag = 'T-Rank',\n    best = 'Best'\n  ) %>% \n  opt_row_striping() %>% \n  tab_options(data_row.padding = 4,\n              footnotes.font.size = 11,\n              column_labels.border.bottom.style = \"solid\",\n              column_labels.border.bottom.width = px(1), \n              column_labels.border.bottom.color = \"black\",\n              table.border.bottom.style = 'none',\n              source_notes.font.size = 10,\n              source_notes.border.lr.style = \"none\") %>% \n  tab_header(\n    title = 'Who are the best road teams in college basketball?',\n    subtitle = \"10 highest T-Rank ratings in true road performances (D-1 vs. D-1)\"\n  ) %>% \n  tab_source_note(\n    md(\"Data by cbbdata + cbbplotR through 2023-24<br>Table + Analysis by @andreweatherman\")\n  ) %>% \n  opt_css(\n    '#table .gt_footnote {\n        padding-top: 2px !important;\n        padding-bottom: 2px !important;\n        line-height: 1;\n      }\n    #table .gt_heading {\n         padding-bottom: 0px;\n         padding-top: 6px\n        }\n      #table .gt_subtitle {\n         padding-top: 2px;\n         padding-bottom: 6px;\n      }\n      #table .gt_sourcenote {\n         text-align: right\n        }\n    '\n  ) %>% \n  gtsave_extra('best_road_teams.png', zoom = 5)\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}