{
  "hash": "b29835403f2a9a90dfb1a8c37eed6147",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"New Coaches vs. KenPom\"\nauthor: \"Andrew Weatherman\"\ndate: \"2024-05-17\"\ncategories: [gt, college basketball, cbbdata, scraping, tutorial]\ndescription: \"Using custom functions in `gt`\"\n---\n\n\n# The What\n\nWe will be making a table that plots preseason vs. final KenPom rating improvements for new head coaches.\n\n::: callout-warning\nTo build this table, you will need an *active* KenPom subscription and a [`cbbdata` account](https://cbbdata.aweatherman.com/#registering-for-an-api-key). Follow [these steps](https://cbbdata.aweatherman.com/#kenpom) to link your KenPom account to `cbbdata`.\n:::\n\n<details>\n\n<summary>Final Table</summary>\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](final_table.png){width=100%}\n:::\n:::\n\n\n</details>\n\n# The How\n\nFor this table, we will need:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(cbbdata)\nlibrary(gt)\nlibrary(gtExtras)\nlibrary(glue)\nlibrary(janitor)\n```\n:::\n\n\n## The Data\n\n### Grab The Data\n\n#### Coaching Changes\n\nThe first thing that we will need is a list of coaching changes by season. There are a few different places from which to grab this, but the most straightforward way is the 'Coaching Changes' page at [barttorvik](https://www.barttorvik.com).\n\nThe data is presented in a static HTML table by year, so we will write a function with `rvest` and use `purrr` to loop over needed seasons (2012-2024).\n\n::: callout-note\nFor some reason, the Barttorvik site *blocks* requests originating from Windows devices. To get around this, we will use `withr` and set a custom user-agent.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_coaching_changes <- function(year) {\n  \n  suppressWarnings({\n    withr::local_options(HTTPUserAgent='Not Windows')\n    read_html(glue(\"https://barttorvik.com/coaching_moves.php?year={year}\")) %>% \n      html_table() %>% \n      pluck(1) %>% \n      clean_names() %>% \n      mutate(year = year) %>% \n      select(team, year, new_coach)\n  })\n  \n}\n```\n:::\n\n\nNow that we have our scraping function, let's loop over it with `map_dfr`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_changes <- map_dfr(2012:2024, \\(year) get_coaching_changes(year))\n```\n:::\n\n\n#### KenPom Ratings\n\nNext, we need preseason *and* year-end KenPom ratings, which is possible with the `cbd_kenpom_ratings_archive` function from `cbbdata`. Specifying `adj_em[which.min(date)]` will grab the KenPom rating associated with the first observed date (preseason) for each team and year, etc.\n\n\n::: {.cell}\n\n```{.r .cell-code}\narchive <- cbd_kenpom_ratings_archive() %>% \n  filter(year >= 2008) %>% \n  summarize(\n    start_em = adj_em[which.min(date)],\n    end_em = adj_em[which.max(date)],\n    final_rank = adj_em_rk[which.max(date)],\n    .by = c(team, year)\n  ) %>% \n  mutate(diff = end_em - start_em)\n```\n:::\n\n\n#### Season Record\n\nFor some added flair, let's include team records too.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nteam_records <- cbd_torvik_game_box() %>%\n  summarize(\n    record = glue(\"{sum(result == 'W')}-{sum(result == 'L')}\"),\n    .by = c(team, year)\n  )\n```\n:::\n\n\n#### Combine\n\nFinally, let's combine our data and calculate the rating difference. All `join` functions in `dplyr` only work with two data frames. However, we can place everything inside of a list and use `reduce`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- list(all_changes, archive, team_records) %>% \n  reduce(left_join, by = c(\"team\", \"year\"))\n```\n:::\n\n\nWe're only going to plot the 10 bets rating jumps.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data %>% slice_max(diff, n = 10)\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|team                   | year|new_coach      | start_em| end_em| final_rank|  diff|record |\n|:----------------------|----:|:--------------|--------:|------:|----------:|-----:|:------|\n|Wyoming                | 2012|Larry Shyatt   |    -9.43|   8.05|         90| 17.48|19-12  |\n|Maryland Eastern Shore | 2015|Bobby Collins  |   -20.12|  -3.33|        207| 16.79|18-15  |\n|Northwestern St.       | 2023|Corey Gipson   |   -19.49|  -3.28|        215| 16.21|22-11  |\n|Tennessee Martin       | 2015|Heath Schroyer |   -14.01|   1.84|        148| 15.85|19-13  |\n|Utah St.               | 2019|Craig Smith    |    -0.10|  15.41|         38| 15.51|28-7   |\n|Portland               | 2022|Shantay Legans |   -16.25|  -0.89|        180| 15.36|19-15  |\n|Canisius               | 2013|Jim Baron      |    -9.61|   5.06|        116| 14.67|20-14  |\n|High Point             | 2024|Alan Huss      |    -9.07|   5.33|        114| 14.40|27-9   |\n|Texas A&M Corpus Chris | 2022|Steve Lutz     |   -20.17|  -6.55|        245| 13.62|23-12  |\n|Ohio St.               | 2018|Chris Holtmann |     7.85|  21.23|         16| 13.38|25-9   |\n\n</div>\n:::\n:::\n\n\n\n#### Postseason Outcome\n\nThe final thing that we are going to include is a column on whether or not a team made the postseason (NCAA, NIT, CBI, etc.). The *easiest* way to do this is to scrape Sports Reference -- which is why we're adding this *after* we have combined our data and grabbed the 10 largest jumps.\n\nPostseason information can be found on a team's schedule page for a given season. We can use `cbd_teams` to grab the needed team slugs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsr_ids <- cbd_teams() %>% select(team = common_team, sr_link)\ngrab_schedules <- function(team, year) {\n  \n  Sys.sleep(3) # sleep for 501\n  \n  id <- filter(sr_ids, team == !!team)$sr_link\n  slug <- str_extract(id, \"(?<=/schools/)[^/]+(?=/men)\") # regex to extract slug\n  url <- glue(\"https://www.sports-reference.com/cbb/schools/{slug}/men/{year}-schedule.html\")\n  \n  read_html(url) %>% \n    html_nodes(\"#schedule\") %>% \n    html_table() %>% \n    pluck(1) %>% \n    clean_names() %>% \n    slice_tail(n = 1) %>% \n    select(\"type\") %>% \n    mutate(team = team, year = year)\n  \n}\n```\n:::\n\n\nUse `purrr` to iterate over all teams and combine the data back\n\n\n::: {.cell}\n\n```{.r .cell-code}\npostseason <- map2_dfr(data$team, data$year, \\(team, year) grab_schedules(team, year))\n\ndata <- left_join(data, postseason, by = c('team', 'year')) %>% \n  mutate(type = ifelse(type == \"CTOURN\", \"---\", type))\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|team                   | year|new_coach      | start_em| end_em| final_rank|  diff|record |type |\n|:----------------------|----:|:--------------|--------:|------:|----------:|-----:|:------|:----|\n|Wyoming                | 2012|Larry Shyatt   |    -9.43|   8.05|         90| 17.48|19-12  |CBI  |\n|Maryland Eastern Shore | 2015|Bobby Collins  |   -20.12|  -3.33|        207| 16.79|18-15  |CIT  |\n|Northwestern St.       | 2023|Corey Gipson   |   -19.49|  -3.28|        215| 16.21|22-11  |---  |\n|Tennessee Martin       | 2015|Heath Schroyer |   -14.01|   1.84|        148| 15.85|19-13  |CIT  |\n|Utah St.               | 2019|Craig Smith    |    -0.10|  15.41|         38| 15.51|28-7   |NCAA |\n|Portland               | 2022|Shantay Legans |   -16.25|  -0.89|        180| 15.36|19-15  |TBC  |\n|Canisius               | 2013|Jim Baron      |    -9.61|   5.06|        116| 14.67|20-14  |CIT  |\n|High Point             | 2024|Alan Huss      |    -9.07|   5.33|        114| 14.40|27-9   |CBI  |\n|Texas A&M Corpus Chris | 2022|Steve Lutz     |   -20.17|  -6.55|        245| 13.62|23-12  |NCAA |\n|Ohio St.               | 2018|Chris Holtmann |     7.85|  21.23|         16| 13.38|25-9   |NCAA |\n\n</div>\n:::\n:::\n\n{{< downloadthis biggest_jumps_final.csv dname=\"biggest_jumps\" label=\"Download a copy of the data\" icon=\"database-fill-down\" type=\"info\" >}}\n\n\n\n## The Table\n\n### Stack Function\n\nTo make things cleaner, here is a function that will plot team logos and stack some additional text to the right using HTML.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngt_cbb_stack <- function(data, upper_text1, upper_text2, lower_text1, lower_text2, lower_text3, logo) {\n\n  data %>%\n    mutate(stack = glue(\n        \"<div style='display: flex; align-items: center;'>\n           <img src='{eval(expr({{logo}}))}' style='height: auto; width: 20px; padding-right: 5px;'>\n           <div>\n             <div style='line-height:14px;'><span style='font-weight:bold;color:black;font-size:14px'>{eval(expr({{upper_text1}}))}, {eval(expr({{upper_text2}}))}</span></div>\n             <div style='line-height:10px;'><span style='font-weight:plain;color:grey;font-size:10px'>{eval(expr({{lower_text1}}))} --  #{eval(expr({{lower_text2}}))}, {eval(expr({{lower_text3}}))}</span></div>\n           </div>\n         </div>\"\n      )\n    )\n}\n```\n:::\n\n\nTo use this, we need to add a column with team logo links. Then, let's apply it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data %>% left_join(cbd_teams() %>% select(team = common_team, espn_nickname, logo))\n\ndata <- data %>% gt_cbb_stack(new_coach, year, espn_nickname, final_rank, record, logo)\n```\n:::\n\n\n### Column Header + Subheader Function\n\nIn late January, Todd Whitehead (Synergy) [posted a table](https://x.com/CrumpledJumper/status/1751698732591251583) with cool column headers + subheaders. I really liked this design, which pairs very well with stacked cells, so I created a function to mimic this effect in `gt`. We'll use it in our table too.\n\nThis function does a few things, but most notably, it creates an HTML string for the \"stacked\" effect, parses it using `htmltools`, and then sets it as the header using `cols_label`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngt_column_subheaders <- function(gt_table, ...) {\n\n  subheaders <- list(...)\n  all_col_names <- colnames(gt_table[['_data']])\n\n  for (col_name in all_col_names) {\n\n    subtitle_info <- subheaders[[col_name]] %||% list(subtitle = \"&nbsp;\", heading = col_name)\n    subtitle <- subtitle_info$subtitle\n    new_header_title <- subtitle_info$heading\n\nlabel_html <- htmltools::HTML(glue(\n  \"<div style='line-height: 1.05; margin-bottom: -2px;'>\n    <span style='font-size: 14px; font-weight: bold; color: black;'>{new_header_title}</span>\n    <br>\n    <span style='font-size: 10px; font-weight: normal; color: #808080;'>{subtitle}</span>\n  </div>\"\n))\n\n    gt_table <- gt_table %>% \n      cols_label(!!sym(col_name) := label_html)\n  }\n  \n  gt_table\n}\n```\n:::\n\n\n#### 1) The Base Table\n\nHonestly, the code below outputs a pretty nice table, but there is definitely some room for improvement.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata %>% \n  select(stack, type, start_em, end_em, diff) %>% \n  gt(id = 'table') %>% \n  gt_theme_nytimes() %>% \n  fmt_markdown(stack) %>% \n  cols_move_to_start(stack) %>% \n  cols_align(columns = stack, 'left') %>% \n  cols_align(columns = -stack, 'center')\n```\n:::\n\n\n#### 2) Applying Custom Column Function\n\nLet's apply our custom `gt_column_subheaders` function. To relabel a column, you need to pass a *list* with `heading` and `subheading`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n... %>%\n  gt_column_subheaders(stack = list(heading = \"Coach and Year\",\n                                    subtitle = \"Team, Final Rank, and Record\"),\n                       type = list(heading = 'Post SZN',\n                                    subtitle = \"Tournament\"),\n                       start_em = list(heading = 'Pre',\n                                    subtitle = \"Rating\"),\n                       end_em = list(heading = 'End',\n                                    subtitle = \"Rating\"),\n                       diff = list(heading = 'Jump',\n                                    subtitle = \"End - Start\"))\n```\n:::\n\n\n#### 3) Table Borders\n\nTo give our table some more clarity and definition, we will add some borders around our cells.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n... %>%\n  tab_style(locations = cells_body(columns = c(type, ends_with(\"em\"))), style = cell_borders()) %>% \n  tab_style(locations = cells_body(columns = -ends_with(\"em\")), style = cell_borders(sides = \"bottom\")) %>% \n  tab_style(locations = cells_body(rows = 1), style = cell_borders(sides = \"top\", weight = px(2))) %>% \n  tab_style(locations = cells_body(columns = diff), style = cell_text(weight = 'bold')) \n```\n:::\n\n\n#### 4) Table Annotations + Options\n\nLet's add our title and caption. We will also tweak our caption font size, force the line below the caption to white (not sure why this theme doesn't do it by default), and compress our rows.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n... %>%\n  tab_options(data_row.padding = 3.5,\n              source_notes.border.bottom.style = \"solid\",\n              source_notes.border.bottom.color = \"white\",\n              source_notes.font.size = 10) %>% \n  tab_header(title = \"New coaches beating KenPom expectations\",\n             subtitle = md(\"The largest pre-season vs. year-end KenPom rating improvements<br>by new head coaches since 2012\")) %>% \n  tab_source_note(md(\"Data by cbbdata + Sports Reference<br>Viz. + Analysis by @andreweatherman\"))\n```\n:::\n\n\n#### 5) Additional CSS\n\nFinally, let's throw in some minor CSS changes. When using opt_css, it is important to reference the same table id that you created in gt(id = ...).\n\nThe first two lines adjust the padding between the title and subtitles -- \"squishing\" them together.\n\nThe third line targets the *bottom* border of the table. It creates the same effect as the `tab_style` that targeted the first row (black border at 2px weight).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n... %>%\n    opt_css(\n    \"\n    #table .gt_heading {\n      padding-top: 6px;\n      padding-bottom: 0px;\n    }\n    #table .gt_subtitle {\n      padding-top: 2px;\n      padding-bottom: 6px;\n    }\n    #table tbody tr:last-child {\n    border-bottom: 2px solid #000000;\n    }\n    \"\n  )\n```\n:::\n\n\n## Complete Script\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(cbbdata)\nlibrary(gt)\nlibrary(gtExtras)\nlibrary(glue)\nlibrary(janitor)\n\n## functions ===\n\nget_coaching_changes <- function(year) {\n  \n  suppressWarnings({\n    withr::local_options(HTTPUserAgent='Not Windows')\n    read_html(glue(\"https://barttorvik.com/coaching_moves.php?year={year}\")) %>% \n      html_table() %>% \n      pluck(1) %>% \n      clean_names() %>% \n      mutate(year = year) %>% \n      select(team, year, new_coach)\n  })\n  \n}\n\ngrab_schedules <- function(team, year) {\n  \n  Sys.sleep(3) # sleep for 501\n  \n  id <- filter(sr_ids, team == !!team)$sr_link\n  slug <- str_extract(id, \"(?<=/schools/)[^/]+(?=/men)\") # regex to extract slug\n  url <- glue(\"https://www.sports-reference.com/cbb/schools/{slug}/men/{year}-schedule.html\")\n  \n  read_html(url) %>% \n    html_nodes(\"#schedule\") %>% \n    html_table() %>% \n    pluck(1) %>% \n    clean_names() %>% \n    slice_tail(n = 1) %>% \n    select(\"type\") %>% \n    mutate(team = team, year = year)\n  \n}\n\ngt_cbb_stack <- function(data, upper_text1, upper_text2, lower_text1, lower_text2, lower_text3, logo) {\n\n  data %>%\n    mutate(stack = glue(\n        \"<div style='display: flex; align-items: center;'>\n           <img src='{eval(expr({{logo}}))}' style='height: auto; width: 20px; padding-right: 5px;'>\n           <div>\n             <div style='line-height:14px;'><span style='font-weight:bold;color:black;font-size:14px'>{eval(expr({{upper_text1}}))}, {eval(expr({{upper_text2}}))}</span></div>\n             <div style='line-height:10px;'><span style='font-weight:plain;color:grey;font-size:10px'>{eval(expr({{lower_text1}}))} --  #{eval(expr({{lower_text2}}))}, {eval(expr({{lower_text3}}))}</span></div>\n           </div>\n         </div>\"\n      )\n    )\n}\n\ngt_column_subheaders <- function(gt_table, ...) {\n\n  subheaders <- list(...)\n  all_col_names <- colnames(gt_table[['_data']])\n\n  for (col_name in all_col_names) {\n\n    subtitle_info <- subheaders[[col_name]] %||% list(subtitle = \"&nbsp;\", heading = col_name)\n    subtitle <- subtitle_info$subtitle\n    new_header_title <- subtitle_info$heading\n\nlabel_html <- htmltools::HTML(glue(\n  \"<div style='line-height: 1.05; margin-bottom: -2px;'>\n    <span style='font-size: 14px; font-weight: bold; color: black;'>{new_header_title}</span>\n    <br>\n    <span style='font-size: 10px; font-weight: normal; color: #808080;'>{subtitle}</span>\n  </div>\"\n))\n\n    gt_table <- gt_table %>% \n      cols_label(!!sym(col_name) := label_html)\n  }\n  \n  gt_table\n}\n\n## code ===\n\nall_changes <- map_dfr(2012:2024, \\(year) get_coaching_changes(year))\n\narchive <- cbd_kenpom_ratings_archive() %>% \n  filter(year >= 2008) %>% \n  summarize(\n    start_em = adj_em[which.min(date)],\n    end_em = adj_em[which.max(date)],\n    final_rank = adj_em_rk[which.max(date)],\n    .by = c(team, year)\n  ) %>% \n  mutate(diff = end_em - start_em)\n\nteam_records <- cbd_torvik_game_box() %>%\n  summarize(\n    record = glue(\"{sum(result == 'W')}-{sum(result == 'L')}\"),\n    .by = c(team, year)\n  )\n\ndata <- list(all_changes, archive, team_records) %>% \n  reduce(left_join, by = c(\"team\", \"year\")) %>% \n  slice_max(diff, n = 10)\n\nsr_ids <- cbd_teams() %>% select(team = common_team, sr_link)\n\npostseason <- map2_dfr(data$team, data$year, \\(team, year) grab_schedules(team, year))\n\ndata <- left_join(data, postseason, by = c('team', 'year')) %>% \n  mutate(type = ifelse(type == \"CTOURN\", \"---\", type)) %>% \n  left_join(cbd_teams() %>% select(team = common_team, espn_nickname, logo)) %>% \n  gt_cbb_stack(new_coach, year, espn_nickname, final_rank, record, logo)\n\n## table ===\n\ntable <- data %>% \n  select(stack, type, start_em, end_em, diff) %>% \n  gt(id = 'table') %>% \n  gt_theme_nytimes() %>% \n  fmt_markdown(stack) %>% \n  cols_move_to_start(stack) %>% \n  cols_align(columns = stack, 'left') %>% \n  cols_align(columns = -stack, 'center') %>% \n  gt_column_subheaders(stack = list(heading = \"Coach and Year\",\n                                  subtitle = \"Team, Final Rank, and Record\"),\n                     type = list(heading = 'Post SZN',\n                                  subtitle = \"Tournament\"),\n                     start_em = list(heading = 'Pre',\n                                  subtitle = \"Rating\"),\n                     end_em = list(heading = 'End',\n                                  subtitle = \"Rating\"),\n                     diff = list(heading = 'Jump',\n                                  subtitle = \"End - Start\")) %>% \n  tab_style(locations = cells_body(columns = c(type, ends_with(\"em\"))), style = cell_borders()) %>% \n  tab_style(locations = cells_body(columns = -ends_with(\"em\")), style = cell_borders(sides = \"bottom\")) %>% \n  tab_style(locations = cells_body(rows = 1), style = cell_borders(sides = \"top\", weight = px(2))) %>% \n  tab_style(locations = cells_body(columns = diff), style = cell_text(weight = 'bold')) %>% \n  tab_options(data_row.padding = 3.5,\n              source_notes.border.bottom.style = \"solid\",\n              source_notes.border.bottom.color = \"white\",\n              source_notes.font.size = 10) %>% \n  tab_header(title = \"New coaches beating KenPom expectations\",\n             subtitle = md(\"The largest pre-season vs. year-end KenPom rating improvements<br>by new head coaches since 2012\")) %>% \n  tab_source_note(md(\"Data by cbbdata + Sports Reference<br>Viz. + Analysis by @andreweatherman\")) %>% \n  opt_css(\n    \"\n    #table .gt_heading {\n      padding-top: 6px;\n      padding-bottom: 0px;\n    }\n    #table .gt_subtitle {\n      padding-top: 2px;\n      padding-bottom: 6px;\n    }\n    #table tbody tr:last-child {\n    border-bottom: 2px solid #000000;\n    }\n    \"\n  )\n\n## save ===\n\ngtsave_extra(table, \"final_table.png\", zoom = 5)\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}