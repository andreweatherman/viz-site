{
  "hash": "d5ca082182ae3368b1c6241dcb7ddd0d",
  "result": {
    "markdown": "---\ntitle: \"Finding Happiness in The Smoke\"\ndate: \"2022-03-19\"\ncategories: [R, dimension reduction, clustering, geospatial, machine learning]\ndescription: \"Cluster analysis and the characteristics that bind London boroughs\"\nimage: \"feature.gif\"\nbibliography: references.bib\n---\n\n\n![](feature.gif)\n\n[The Smoke](https://www.theguardian.com/environment/2002/nov/30/uknews.pollution), to use London's nickname, has 32 boroughs plus the central business district known as the [City of London](https://en.wikipedia.org/wiki/City_of_London). What does Cluster Analysis tell us about the characteristics that bind them?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(tidytext)\nlibrary(tidyclust)\nlibrary(glue)\nlibrary(readxl)\nlibrary(janitor)\nlibrary(ggrepel)\nlibrary(sf)\nlibrary(scales)\n```\n:::\n\n\nThe graphics will use a custom palette created in [Adobe Colour](https://color.adobe.com).\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_bw())\n\ncols <- c(\"#0AC449\", \"#CF4E0A\", \"#0057B7\", \"#FFD700\", \"#870AC4\") |>\n  fct_inorder()\n\ntibble(x = 1:5, y = 1) |>\n  ggplot(aes(x, y, fill = cols)) +\n  geom_col(colour = \"white\") +\n  geom_label(aes(label = cols), size = 4, vjust = 2, fill = \"white\") +\n  annotate(\n    \"label\",\n    x = 3, y = 0.5,\n    label = \"Custom Pallette\",\n    fill = \"white\",\n    alpha = 0.8,\n    size = 6\n  ) +\n  scale_fill_manual(values = as.character(cols)) +\n  theme_void() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/theme-1.png){width=100%}\n:::\n:::\n\n\n[The London Datastore](https://data.london.gov.uk) provides data profiling each area.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nraw_df <-\n  read_xlsx(\"london-borough-profiles.xlsx\", sheet = 2) |>\n  clean_names() |>\n  filter(str_starts(code, \"E\")) |>\n  mutate(across(where(is.character), ~ na_if(., \".\")),\n    inner_outer_london = str_remove(inner_outer_london, \" London\")\n  )\n```\n:::\n\n\n## Dimensionality Reduction\n\nThese data include 81 numeric variables quantifying such things as population density, happiness and age. Way too many variables to visualise two-dimensionally. [Principal Components Analysis](https://en.wikipedia.org/wiki/Principal_component_analysis) can reduce the bulk of the information down to two variables. It is then possible to more easily visualise the relationships.\n\nThe City of London, aka \"The Square Mile\", is quite distinct from the other 32 areas and has many NA values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nraw_df |> \n  rowwise() |> \n  mutate(na_count = sum(is.na(cur_data()))) |> \n  select(area_name, na_count) |>\n  filter(na_count != 0) |>\n  arrange(desc(na_count))\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|area_name              | na_count|\n|:----------------------|--------:|\n|City of London         |       27|\n|Kensington and Chelsea |        3|\n|Barnet                 |        1|\n|Camden                 |        1|\n|Hackney                |        1|\n|Haringey               |        1|\n|Harrow                 |        1|\n|Islington              |        1|\n|Lewisham               |        1|\n|Merton                 |        1|\n|Richmond upon Thames   |        1|\n|Waltham Forest         |        1|\n|Wandsworth             |        1|\n\n</div>\n:::\n:::\n\n\nNot surprisingly, the two-dimensional visualisation sets the City of London apart. And the other 32 are broadly, albeit with some mixing, divided into inner and outer London boroughs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npca_fit <- raw_df |>\n  select(where(is.numeric)) |>\n  prcomp(scale = TRUE)\n\npca_augmented <-\n  pca_fit |>\n  augment(raw_df)\n\npca_augmented |>\n  ggplot(aes(.fittedPC1, .fittedPC2, fill = inner_outer_london)) +\n  geom_label(aes(label = area_name), size = 2, hjust = \"inward\") +\n  scale_fill_manual(values = as.character(cols)) +\n  labs(\n    title = \"33 London Areas\", fill = \"London\",\n    x = \"Principal Component 1\", y = \"Principal Component 2\",\n    caption = \"Source: data.london.gov.uk\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/pca-1.png){width=100%}\n:::\n:::\n\n\nAfter squeezing the many dimensions into two, how much of the original information was it possible to retain?\n\n\n::: {.cell}\n\n```{.r .cell-code}\npca_tidied <- pca_fit |>\n  tidy(matrix = \"eigenvalues\")\n\npct_explained <-\n  pca_tidied |>\n  pluck(\"cumulative\", 2)\n\npca_tidied |>\n  ggplot(aes(PC, percent)) +\n  geom_col(aes(fill = if_else(PC <= 2, TRUE, FALSE)),\n    alpha = 0.8, show.legend = FALSE\n  ) +\n  scale_y_continuous(labels = label_percent(1)) +\n  scale_fill_manual(values = as.character(cols)) +\n  coord_flip() +\n  labs(\n    title = glue(\n      \"{percent(pct_explained, 0.1)} of the \",\n      \"Variance Explained by Principal Components 1 & 2\"\n    ),\n    x = \"Principal Component\", y = NULL\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/pc1 & 2-1.png){width=100%}\n:::\n:::\n\n\nWhilst we do lose ease of interpretation by distilling the information in this way, it is still possible to understand which of the original variables influenced their two-dimensional positioning.\n\nThe axes depicted by the arrows below tell us that **anxiety scores** play a significant role in the placement of the City of London towards the upper-left. **Average age** pushes areas more towards the top. And **happiness** influences the bottom-right.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npattern <- \"_\\\\d{4}|_st.+|_score|_rates|proportion_of_|_\\\\d{2}_out_of_\\\\d{2}\"\n\npca_fit |>\n  tidy(matrix = \"rotation\") |>\n  pivot_wider(names_from = \"PC\", names_prefix = \"PC\", values_from = \"value\") |>\n  mutate(column = str_remove_all(column, pattern)) |>\n  ggplot(aes(PC1, PC2)) +\n  geom_segment(\n    xend = 0, yend = 0, colour = \"grey70\",\n    arrow = arrow(ends = \"first\", length = unit(8, \"pt\"))\n  ) +\n  geom_text_repel(aes(label = column), size = 3) +\n  theme_minimal() +\n  labs(\n    x = \"PC 1\", y = \"PC 2\",\n    title = \"Characteristics Influencing Area Positioning\",\n    caption = \"Source: data.london.gov.uk\"\n  ) +\n  theme(axis.text = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/interpretation-1.png){width=100%}\n:::\n:::\n\n\nThis may be validated by ranking all 33 areas by these three original variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npca_long <- \n  pca_augmented |>\n  select(area_name, matches(\"happ|anx|average_age\")) |>\n  rename_with(~ str_remove(., \"_.*\")) |>\n  rename(\"avg_age\" = \"average\") |>\n  pivot_longer(-area, values_to = \"score\") |>\n  mutate(area = reorder_within(area, score, name)) \n\npca_long |>\n  ggplot(aes(area, score, colour = name)) +\n  geom_point(show.legend = FALSE) +\n  facet_wrap(~name, scales = \"free\") +\n  scale_x_reordered() +\n  scale_colour_manual(values = as.character(cols)) +\n  coord_flip() +\n  labs(x = NULL, caption = \"Source: data.london.gov.uk\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/ranking-1.png){width=100%}\n:::\n:::\n\n\n## Cluster Modelling\n\nTo collect these areas into their natural groupings, a decision is needed on the desired number of clusters. We can visualise dividing the areas into 1, 2, 3 and so forth clusters. And, per below, 3 appears to nicely capture the natural grouping of the coloured points.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(2022)\n\nkclusts <-\n  tibble(k = 1:6) |>\n  mutate(\n    kclust = map(k, ~ kmeans(pca_augmented |> \n                               select(.fittedPC1, .fittedPC2), .x)),\n    tidied = map(kclust, tidy),\n    glanced = map(kclust, glance),\n    augmented = map(kclust, augment, pca_augmented)\n  )\n\nassignments <-\n  kclusts |>\n  unnest(cols = c(augmented))\n\nclusters <-\n  kclusts |>\n  unnest(cols = c(tidied))\n\nassignments |>\n  ggplot(aes(x = .fittedPC1, y = .fittedPC2)) +\n  geom_point(aes(color = .cluster)) +\n  facet_wrap(~k, nrow = 2) +\n  scale_colour_manual(values = as.character(cols[c(1:6)])) +\n  geom_point(data = clusters, size = 4, shape = 13) +\n  labs(\n    title = \"How Many Clusters Best Captures the Groupings?\",\n    subtitle = \"X Marks the Cluster Centre\",\n    caption = \"Source: data.london.gov.uk\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/kmeans-1.png){width=100%}\n:::\n:::\n\n\nThe [elbow method](https://en.wikipedia.org/wiki/Elbow_method_(clustering)) provides a more mathematical approach to the choice. The compactness of the clustering (as measured by the total within-cluster sum of squares) is significantly optimised when choosing 3 clusters, with diminishing returns thereafter.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkclusts |>\n  unnest(cols = c(glanced)) |>\n  ggplot(aes(k, tot.withinss)) +\n  geom_line() +\n  geom_point() +\n  geom_label(aes(label = if_else(k == 3, \"Elbow\", NA_character_)),\n    nudge_y = -25, fill = cols[1]\n  ) +\n  labs(\n    title = \"Elbow Method\",\n    x = \"Clusters\", y = \"Within-Cluster Variance\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/elbow-1.png){width=100%}\n:::\n:::\n\n\nAnd settling on this choice of 3 clusters, we get this split.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nassignments |>\n  filter(k == 3) |>\n  ggplot(aes(.fittedPC1, .fittedPC2, fill = .cluster)) +\n  geom_label(aes(label = area_name), size = 2, hjust = \"inward\", overlap = FALSE) +\n  scale_fill_manual(values = as.character(cols[c(1, 2, 4)])) +\n  labs(\n    title = \"Closely-Related London Areas\", fill = \"Cluster\",\n    x = \"Principal Component 1\", y = \"Principal Component 2\",\n    caption = \"Source: data.london.gov.uk\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/final clusters-1.png){width=100%}\n:::\n:::\n\n\n## Using Tidymodels\n\nAn alternative approach is to use the new [tidyclust](https://github.com/EmilHvitfeldt/tidyclust)[@tidyclust] package which augments the tidymodels framework with a tidy unified interface to clustering models.\n\nFirst we tune the model with 1 to 6 clusters and review how well they capture the natural groupings.\n\n\n::: {.cell hash='index_cache/html/tidyclust tune_a9e57b25cb03b3394bd85998e555be9c'}\n\n```{.r .cell-code}\nkmeans_spec <- k_means(num_clusters = tune()) |> \n  set_engine(\"stats\", algorithm = \"Hartigan-Wong\")\n\nkmeans_rec <- recipe(~ .fittedPC1 + .fittedPC2, data = pca_augmented)\n\nkmeans_wflow <- workflow() |>\n  add_model(kmeans_spec) |>\n  add_recipe(kmeans_rec)\n\nkmeans_cv <- vfold_cv(pca_augmented, v = 5, repeats = 10)\n\nkmeans_res <- tune_cluster(\n  kmeans_wflow,\n  resamples = kmeans_cv,\n  grid = crossing(\n    num_clusters = seq(1, 6, 1)\n  ),\n  control = control_grid(save_pred = TRUE, extract = identity),\n  metrics = cluster_metric_set(sse_total, sse_ratio)\n)\n\nkmeans_metrics <- kmeans_res |> collect_metrics()\n\nkmeans_metrics |>\n  filter(.metric == \"sse_ratio\") |>\n  ggplot(aes(num_clusters, mean)) +\n  geom_point() +\n  geom_line() +\n  geom_label(aes(label = if_else(num_clusters == 3, \"Elbow\", NA_character_)),\n             nudge_y = -0.1, fill = cols[1]) +\n  labs(title = \"Elbow Method\", x = \"Clusters\", y = \"WSS\") +\n  scale_x_continuous(breaks = 1:6)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/tidyclust tune-1.png){width=100%}\n:::\n:::\n\n\nAgain we can visualise the 3 clusters suggested by the elbow method.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkmeans_spec <- k_means(num_clusters = 3) |> \n  set_engine(\"stats\", algorithm = \"Hartigan-Wong\")\n\nkmeans_wflow <- kmeans_wflow |> \n  update_model(kmeans_spec)\n\nkmeans_fit <- kmeans_wflow |> \n  fit(pca_augmented) \n\nkmeans_clust <- kmeans_fit |> \n  extract_centroids()\n\nkmeans_aug <- kmeans_fit |> \n  augment(pca_augmented)\n\nkmeans_aug |>\n  ggplot(aes(.fittedPC1, .fittedPC2)) +\n  geom_label(aes(label = area_name, colour = .pred_cluster),\n             size = 2, hjust = \"inward\") +\n  scale_colour_manual(values = as.character(cols[c(1:3, 5)])) +\n  geom_point(data = kmeans_clust, size = 4, shape = 13) +\n  labs(\n    title = \"Closely-Related London Areas\", fill = \"Cluster\",\n    subtitle = \"X Marks the Cluster Centre\",\n    x = \"Principal Component 1\", y = \"Principal Component 2\",\n    caption = \"Source: data.london.gov.uk\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/tidyclust fit-1.png){width=100%}\n:::\n:::\n\n\nHow does this look with [geospatial data](https://data.london.gov.uk/dataset/statistical-gis-boundary-files-london)? And how do the clusters relate to inner and outer London?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nshape_df <-\n  st_read(\"statistical-gis-boundaries-london/ESRI\",\n    \"London_Borough_Excluding_MHW\",\n    as_tibble = TRUE, quiet = TRUE\n  ) |>\n  left_join(assignments |> \n              filter(k == 3), by = c(\"GSS_CODE\" = \"code\")) |>\n  select(.cluster, inner_outer_london, NAME, geometry) |>\n  pivot_longer(c(.cluster, inner_outer_london)) |>\n  mutate(value = recode(value, \"1\" = \"Cluster 1\", \n                        \"2\" = \"Cluster 2\", \"3\" = \"Cluster 3\"))\n\nshape_df |>\n  mutate(name = recode(name,\n    \".cluster\" = \"By Cluster\",\n    \"inner_outer_london\" = \"By Inner/Outer\"\n  )) |>\n  ggplot() +\n  geom_sf(aes(fill = value), colour = \"white\") +\n  geom_sf_label(aes(label = NAME), size = 2, alpha = 0.7) +\n  scale_fill_manual(values = as.character(cols[c(3, 4, 1, 2, 5)])) +\n  facet_wrap(~name) +\n  theme_void() +\n  theme(legend.position = \"none\") +\n  labs(fill = NULL)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/geospatial-1.png){width=100%}\n:::\n:::\n\n\nNot too dissimilar, but with some notable differences.\n\nThe City of London is a cluster apart in the heart of London. Kensington and Chelsea is an inner-London borough, but exhibits outer-London characteristics. And the reverse is true of the likes of Brent and Greenwich.\n\nDimensionality reduction is further explored in [East-West Drift](/project/un) coupled with animation.\n\n## R Toolbox\n\nSummarising below the packages and functions used in this post enables me to separately create a [toolbox visualisation](/project/box) summarising the usage of packages and functions across all posts.\n\n\n::: {.cell}\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|Package   |Function                                                                                                                                                                                                                                                                                                                                                                                                        |\n|:---------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n|base      |as.character[8];  c[6];  conflicts[1];  cumsum[1];  function[1];  identity[1];  is.character[1];  is.na[1];  is.numeric[1];  mean[1];  search[1];  seq[1];  set.seed[1];  sum[2]                                                                                                                                                                                                                                |\n|dplyr     |filter[10];  across[1];  arrange[3];  cur_data[1];  desc[3];  group_by[1];  if_else[6];  left_join[1];  mutate[11];  na_if[1];  recode[2];  rename[1];  rename_with[1];  rowwise[1];  select[5];  summarise[1]                                                                                                                                                                                                  |\n|forcats   |fct_inorder[1]                                                                                                                                                                                                                                                                                                                                                                                                  |\n|ggplot2   |aes[21];  annotate[1];  arrow[1];  coord_flip[2];  element_blank[1];  facet_wrap[3];  geom_col[2];  geom_label[6];  geom_line[2];  geom_point[6];  geom_segment[1];  geom_sf[1];  geom_sf_label[1];  ggplot[11];  labs[10];  scale_colour_manual[3];  scale_fill_manual[5];  scale_x_continuous[1];  scale_y_continuous[1];  theme[3];  theme_bw[1];  theme_minimal[1];  theme_set[1];  theme_void[2];  unit[1] |\n|ggrepel   |geom_text_repel[1]                                                                                                                                                                                                                                                                                                                                                                                              |\n|glue      |glue[1]                                                                                                                                                                                                                                                                                                                                                                                                         |\n|janitor   |clean_names[1]                                                                                                                                                                                                                                                                                                                                                                                                  |\n|purrr     |map[5];  map2_dfr[1];  pluck[1];  possibly[1];  set_names[1]                                                                                                                                                                                                                                                                                                                                                    |\n|readr     |read_lines[1]                                                                                                                                                                                                                                                                                                                                                                                                   |\n|readxl    |read_xlsx[1]                                                                                                                                                                                                                                                                                                                                                                                                    |\n|recipes   |recipe[1]                                                                                                                                                                                                                                                                                                                                                                                                       |\n|rsample   |vfold_cv[1]                                                                                                                                                                                                                                                                                                                                                                                                     |\n|scales    |label_percent[1];  percent[2]                                                                                                                                                                                                                                                                                                                                                                                   |\n|sf        |st_read[1]                                                                                                                                                                                                                                                                                                                                                                                                      |\n|stats     |kmeans[1];  prcomp[1]                                                                                                                                                                                                                                                                                                                                                                                           |\n|stringr   |str_c[5];  str_count[1];  str_detect[2];  str_remove[4];  str_remove_all[2];  str_starts[2]                                                                                                                                                                                                                                                                                                                     |\n|tibble    |as_tibble[1];  tibble[4];  enframe[1]                                                                                                                                                                                                                                                                                                                                                                           |\n|tidyclust |cluster_metric_set[1];  extract_centroids[1];  k_means[2];  sse_ratio[1];  tune_cluster[1]                                                                                                                                                                                                                                                                                                                      |\n|tidyr     |crossing[1];  pivot_longer[2];  pivot_wider[1];  unnest[4]                                                                                                                                                                                                                                                                                                                                                      |\n|tidytext  |reorder_within[1];  scale_x_reordered[1]                                                                                                                                                                                                                                                                                                                                                                        |\n|tune      |control_grid[1]                                                                                                                                                                                                                                                                                                                                                                                                 |\n|workflows |add_model[1];  add_recipe[1];  update_model[1];  workflow[1]                                                                                                                                                                                                                                                                                                                                                    |\n\n</div>\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}