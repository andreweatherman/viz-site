{
  "hash": "1cf4f89909caf66a801e00ffe8437a5a",
  "result": {
    "markdown": "---\ntitle: \"A Frosty Deal?\"\ndate: \"2020-09-18\"\ncategories: [R, textual analysis, word embeddings, natural language processing]\ndescription: \"Quantitative textual analysis, word embeddings and analysing shifting trade-talk sentiment?\"\nbibliography: references.bib\n---\n\n\n![](feature.gif){fig-alt=\"Two frosty fists bump\"}\n\nBefore the post-Brexit trade negotiations concluded, what did quantitative textual analysis and word embeddings tell us about the shifting trade-talk sentiment?\n\nReading news articles on the will-they-won't-they post-Brexit trade negotiations with the EU sees days of optimism jarred by days of gloom. Do negative news articles, when one wants a positive outcome, leave a deeper impression?\n\nIs it possible to get a more objective view from [quantitative analysis of textual data](https://quanteda.io)? To do this, I'm going to look at hundreds of articles published in the Guardian newspaper over the course of the year to see how trade-talk sentiment changed week-to-week.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(wesanderson)\nlibrary(guardianapi)\nlibrary(quanteda)\nlibrary(scales)\nlibrary(tictoc)\nlibrary(clock)\nlibrary(patchwork)\nlibrary(text2vec)\nlibrary(topicmodels)\nlibrary(slider)\nlibrary(glue)\nlibrary(usedthese)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_bw())\n\n(cols <- wes_palette(name = \"Chevalier1\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/theme-1.png){width=100%}\n:::\n:::\n\n\nThe Withdrawal Agreement between the UK and the European Union was [signed on the 24th of January 2020](https://en.wikipedia.org/wiki/Brexit_withdrawal_agreement). Brexit-related newspaper articles will be imported from that date.\n\n::: callout-note\nSince publishing this article in September 2020, [an agreement was reached on December 24th 2020](https://www.bbc.com/news/uk-politics-55476625).\n:::\n\nThe Guardian newspaper asks for requests to span no more than 1 month at a time. Creating a set of monthly date ranges will enable the requests to be chunked.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndates_df <- tibble(start_date = date_build(2020, 1:11, 25)) |> \n  mutate(end_date = add_months(start_date, 1) |> add_days(-1))\n\ndates_df\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|start_date |end_date   |\n|:----------|:----------|\n|2020-01-25 |2020-02-24 |\n|2020-02-25 |2020-03-24 |\n|2020-03-25 |2020-04-24 |\n|2020-04-25 |2020-05-24 |\n|2020-05-25 |2020-06-24 |\n|2020-06-25 |2020-07-24 |\n|2020-07-25 |2020-08-24 |\n|2020-08-25 |2020-09-24 |\n|2020-09-25 |2020-10-24 |\n|2020-10-25 |2020-11-24 |\n|2020-11-25 |2020-12-24 |\n\n</div>\n:::\n:::\n\n\n::: callout-important\nAccess to the Guardian's API via [guardianapi](https://github.com/cran/guardianapi)[@guardianapi] requires a key which may be requested [here](https://open-platform.theguardian.com/access/) and stored in the .Renviron file.\n:::\n\n\n::: {.cell hash='index_cache/html/read_b9a221b348136d61f0c7450830da90ee'}\n\n```{.r .cell-code}\ntic()\n\nread_slowly <- slowly(gu_content)\n\narticle_df <-\n  pmap(dates_df, \\(start_date, end_date) {\n    read_slowly(\n      \"brexit\",\n      from_date = start_date,\n      to_date = end_date\n    )\n  }) |> \n  list_rbind()\n\ntoc()\n```\n:::\n\n\nThe data need a little cleaning, for example, to remove multi-topic articles, html tags and non-breaking spaces.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrade_df <-\n  article_df |>\n  filter(!str_detect(id, \"/live/\"), \n         section_id %in% c(\"world\", \"politics\", \"business\")) |>\n  mutate(\n    body = str_remove_all(body, \"<.*?>\") |> str_to_lower(),\n    body = str_remove_all(body, \"[^a-z0-9 .-]\"),\n    body = str_remove_all(body, \"nbsp\")\n  )\n```\n:::\n\n\nA corpus then gives me a collection of texts whereby each document is a newspaper article.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrade_corp <- trade_df |> \n  corpus(docid_field = \"short_url\", \n         text_field = \"body\", unique_docnames = FALSE)\n```\n:::\n\n\nAlthough only articles mentioning Brexit have been imported, some of these will not be related to trade negotiations with the EU. For example, there are on-going negotiations with many countries around the world. So, word embeddings[@text2vec] will help to narrow the focus to the specific context of the UK-EU trade deal.\n\nThe chief negotiator for the EU is Michel Barnier, so I'll quantitatively identify words in close proximity to \"Barnier\" in the context of these Brexit news articles.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwindow <- 5\n\ntrade_fcm <-\n  trade_corp |>\n  fcm(context = \"window\", window = window, \n      count = \"weighted\", weights = window:1)\n\nglove <- GlobalVectors$new(rank = 60, x_max = 10)\n\nset.seed(42)\n\nwv_main <- glove$fit_transform(trade_fcm, n_iter = 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nINFO  [19:40:03.268] epoch 1, loss 0.3788\nINFO  [19:40:05.687] epoch 2, loss 0.2570\nINFO  [19:40:08.150] epoch 3, loss 0.2292\nINFO  [19:40:10.665] epoch 4, loss 0.2090\nINFO  [19:40:13.159] epoch 5, loss 0.1921\nINFO  [19:40:15.670] epoch 6, loss 0.1791\nINFO  [19:40:18.175] epoch 7, loss 0.1694\nINFO  [19:40:20.681] epoch 8, loss 0.1619\nINFO  [19:40:23.174] epoch 9, loss 0.1557\nINFO  [19:40:25.663] epoch 10, loss 0.1506\n```\n:::\n\n```{.r .cell-code}\nwv_context <- glove$components\nword_vectors <- wv_main + t(wv_context)\n\nsearch_coord <- \n  word_vectors[\"barnier\", , drop = FALSE]\n\nword_vectors |> \n  sim2(search_coord, method = \"cosine\") |> \n  as_tibble(rownames = NA) |> \n  rownames_to_column(\"term\") |> \n  rename(similarity = 2) |> \n  slice_max(similarity, n = 10)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|term         | similarity|\n|:------------|----------:|\n|barnier      |  1.0000000|\n|negotiator   |  0.8060194|\n|michel       |  0.8060093|\n|frost        |  0.8040999|\n|brussels     |  0.7012591|\n|negotiators  |  0.6404119|\n|chief        |  0.6399011|\n|friday       |  0.6363004|\n|team         |  0.6253523|\n|negotiations |  0.6246642|\n\n</div>\n:::\n:::\n\n\nWord embedding is a learned modelling technique placing words into a multi-dimensional vector space such that contextually-similar words may be found close by. Not surprisingly, one of the closest words contextually is \"Michel\". And as he is the chief negotiator for the EU, we find \"negotiator\" and \"brussels\" also in the top most contextually-similar words.\n\nThe word embeddings algorithm, through word co-occurrence, has identified the name of Michel Barnier's UK counterpart David Frost. So filtering articles for \"Barnier\", \"Frost\" and \"UK-EU\" should help narrow the focus.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncontext_df <- \n  trade_df |> \n  filter(str_detect(body, \"barnier|frost|uk-eu\")) \n\ncontext_corp <- \n  context_df |> \n  corpus(docid_field = \"short_url\", text_field = \"body\")\n```\n:::\n\n\nQuanteda's[@quanteda] `kwic` function shows key phrases in context to ensure we're homing in on the required texts. Short URLs are included below so one can click on any to read the actual article as presented by The Guardian.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\n\ncontext_corp |>\n  tokens(\n    remove_punct = TRUE,\n    remove_symbols = TRUE,\n    remove_numbers = TRUE\n  ) |>\n  kwic(pattern = phrase(c(\"trade negotiation\", \"trade deal\", \"trade talks\")), \n       valuetype = \"regex\", window = 7) |>\n  as_tibble() |>\n  left_join(article_df, by = join_by(docname == short_url)) |> \n  slice_sample(n = 10) |> \n  select(docname, pre, keyword, post, headline)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|docname                             |pre                                          |keyword            |post                                              |headline                                                                     |\n|:-----------------------------------|:--------------------------------------------|:------------------|:-------------------------------------------------|:----------------------------------------------------------------------------|\n|https://www.theguardian.com/p/ep2yb |put pressure on brussels to agree a          |trade deal         |and iron out problems with the withdrawal         |Boris Johnson bows to Tory rebels with Brexit bill compromise                |\n|https://www.theguardian.com/p/dag4n |expected from parties about to embark on     |trade talks        |eu member states are due to confirm               |Brexit deal 'a different ball game' to Canada agreement, warns EU            |\n|https://www.theguardian.com/p/ekz7e |has gone down badly in brussels in           |trade negotiations |usually both sides work out a consolidated        |Barnier 'flabbergasted' at UK attempt to reopen Brexit specialty food debate |\n|https://www.theguardian.com/p/fptbj |the eu followed the usual pattern of         |trade talks        |down the ages the negotiations seemed to          |Brexit talks followed common pattern but barrier-raising outcome is unique   |\n|https://www.theguardian.com/p/dq896 |text contains a cut-and-paste from the eus   |trade deal         |with canada stating merely that it would          |Brexit talks: Britain accuses EU of treating UK as 'unworthy' partner        |\n|https://www.theguardian.com/p/fmmga |the conservative party for years john harris |trade deals        |are not meant to assert sovereignty she           |EU leaders stress unity as they welcome Brexit trade talks extension         |\n|https://www.theguardian.com/p/fv2xh |demanded a last-minute compromise to reach a |trade deal         |and avert chaos at the border as                  |Firms plead for Brexit deal as coronavirus leaves industry reeling           |\n|https://www.theguardian.com/p/f6444 |canada-style trade deal the eu has a         |trade deal         |with canada called the comprehensive economic and |What did Boris Johnson mean by an Australia-style system of trade?           |\n|https://www.theguardian.com/p/fk5kt |companies await news of a potential uk-eu    |trade deal         |abf said our businesses have completed all        |Primark reports 'phenomenal' trading since lockdowns ended                   |\n|https://www.theguardian.com/p/evgxe |in talks trying to thrash out a              |trade deal         |before january but after the chief negotiators    |Wednesday briefing: Tory revolt over Cummings piles pressure on PM           |\n\n</div>\n:::\n:::\n\n\nQuanteda provides a sentiment dictionary which, in addition to identifying positive and negative words, also finds negative-negatives and negative-positives such as, for example, \"not effective\". For each week's worth of articles, we can calculate the proportion of positive sentiments.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntic()\n\nsent_df <- \n  context_corp |> \n  tokens() |> \n  dfm(dictionary = data_dictionary_LSD2015) |> \n  as_tibble() |>\n  left_join(context_df, by = join_by(doc_id == short_url)) |> \n  mutate(\n    pos = positive + neg_negative,\n    neg = negative + neg_positive,\n    web_date = date_ceiling(as.Date(web_publication_date), \"week\"),\n    pct_pos = pos / (pos + neg)\n  )\n\nsent_df |> \n  select(Article = doc_id, \"Pos Score\" = pos, \"Neg Score\" = neg) |> \n  slice(1:10)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|Article                             | Pos Score| Neg Score|\n|:-----------------------------------|---------:|---------:|\n|https://www.theguardian.com/p/d6qhb |        40|        22|\n|https://www.theguardian.com/p/d9e9j |        27|        15|\n|https://www.theguardian.com/p/d6kzd |        52|        27|\n|https://www.theguardian.com/p/d79cn |        57|        51|\n|https://www.theguardian.com/p/d6t3c |        28|        26|\n|https://www.theguardian.com/p/d9vjq |        13|        23|\n|https://www.theguardian.com/p/d7n8b |        57|        35|\n|https://www.theguardian.com/p/dag4n |        37|        38|\n|https://www.theguardian.com/p/d9xtf |        33|        14|\n|https://www.theguardian.com/p/d7d9t |        23|        11|\n\n</div>\n:::\n\n```{.r .cell-code}\nsummary_df <- sent_df |> \n  summarise(pct_pos = mean(pct_pos), \n            n = n(),\n            .by = web_date)\n\ntoc()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n1.002 sec elapsed\n```\n:::\n:::\n\n\nPlotting the changing proportion of positive sentiment over time did surprise me a little. The outcome was more balanced than I expected which perhaps confirms the deeper impression left on me by negative articles.\n\nThe upper plot shows a rolling 7-day mean with a narrowing ribbon representing a narrowing variation in sentiment.\n\nThe lower plot shows the volume of articles. As we drew closer to the crunch-point the volume picked up.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwidth <- 7\n\nsent_df2 <- sent_df |>\n  mutate(web_date = as.Date(web_publication_date)) |> \n  group_by(web_date) |>\n  summarise(pct_pos = sum(pos) / sum(neg + pos)) |> \n  mutate(\n    roll_mean = slide_dbl(pct_pos, mean, .before = 6),\n    roll_lq = slide_dbl(pct_pos, ~ quantile(.x, probs = 0.25), .before = 6),\n    roll_uq = slide_dbl(pct_pos, ~ quantile(.x, probs = 0.75), .before = 6)\n  )\n\np1 <- sent_df2 |>\n  ggplot(aes(web_date)) +\n  geom_line(aes(y = roll_mean), colour = cols[1]) +\n  geom_ribbon(aes(ymin = roll_lq, ymax = roll_uq), \n              alpha = 0.33, fill = cols[1]) +\n  geom_hline(yintercept = 0.5, linetype = \"dashed\", \n             colour = cols[4], linewidth = 1) +\n  scale_y_continuous(labels = label_percent(accuracy = 1)) +\n  labs(\n    title = \"Changing Sentiment Towards a UK-EU Trade Deal\",\n    subtitle = glue(\"Rolling {width} days Since the Withdrawal Agreement\"),\n    x = NULL, y = \"Positive Sentiment\"\n  )\n\np2 <- summary_df |> \n  ggplot(aes(web_date, n)) +\n  geom_line(colour = cols[1]) +\n  labs(x = \"Weeks\", y = \"Article Count\",\n       caption = \"Source: Guardian Newspaper\")\n\np1 / p2 + \n  plot_layout(heights = c(2, 1))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-1.png){width=100%}\n:::\n:::\n\n\n## R Toolbox\n\nSummarising below the packages and functions used in this post enables me to separately create a [toolbox visualisation](/project/box) summarising the usage of packages and functions across all posts.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nused_here()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"usedthese table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Package </th>\n   <th style=\"text-align:left;\"> Function </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> base </td>\n   <td style=\"text-align:left;\"> as.Date[2];  c[3];  library[13];  mean[1];  set.seed[2];  sum[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> clock </td>\n   <td style=\"text-align:left;\"> add_days[1];  add_months[1];  date_build[1];  date_ceiling[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dplyr </td>\n   <td style=\"text-align:left;\"> filter[2];  group_by[1];  join_by[2];  left_join[2];  mutate[5];  n[1];  rename[1];  select[2];  slice[1];  slice_max[1];  slice_sample[1];  summarise[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ggplot2 </td>\n   <td style=\"text-align:left;\"> aes[4];  geom_hline[1];  geom_line[2];  geom_ribbon[1];  ggplot[2];  labs[2];  scale_y_continuous[1];  theme_bw[1];  theme_set[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> glue </td>\n   <td style=\"text-align:left;\"> glue[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> methods </td>\n   <td style=\"text-align:left;\"> new[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> patchwork </td>\n   <td style=\"text-align:left;\"> plot_layout[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> purrr </td>\n   <td style=\"text-align:left;\"> list_rbind[1];  pmap[1];  slowly[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> quanteda </td>\n   <td style=\"text-align:left;\"> corpus[2];  dfm[1];  fcm[1];  kwic[1];  phrase[1];  t[1];  tokens[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> scales </td>\n   <td style=\"text-align:left;\"> label_percent[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> slider </td>\n   <td style=\"text-align:left;\"> slide_dbl[3] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> stats </td>\n   <td style=\"text-align:left;\"> quantile[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> stringr </td>\n   <td style=\"text-align:left;\"> str_detect[2];  str_remove_all[3];  str_to_lower[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> text2vec </td>\n   <td style=\"text-align:left;\"> fit_transform[1];  sim2[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> tibble </td>\n   <td style=\"text-align:left;\"> as_tibble[3];  tibble[1];  rownames_to_column[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> tictoc </td>\n   <td style=\"text-align:left;\"> tic[2];  toc[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> usedthese </td>\n   <td style=\"text-align:left;\"> used_here[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> wesanderson </td>\n   <td style=\"text-align:left;\"> wes_palette[1] </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}