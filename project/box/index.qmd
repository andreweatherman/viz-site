---
title: "Favourite Things"
date: "2020-07-26"
categories: [R, web scraping]
description: "R packages & functions that make doing data science a joy based on usage across projects"
---

![](feature-1.png){fig-alt="Wordcloud of this site's most used R packages and functions"}

Each [project](/project/) closes with a table summarising the R tools used. By visualising the most frequently used packages and functions I can get a sense of where I may most benefit from going deeper into the latest package versions.

Early on, it was an opportunity to replace superseded functions like `spread` and `gather` with `pivot_wider` and `pivot_longer`. More recently there have been examples of using newer packages such as [tidyclust](https://github.com/EmilHvitfeldt/tidyclust), which brings cluster modelling to tidymodels (used in the latest quarto version of [Finding Happiness in 'The Smoke'](https://www.quantumjitter.com/project/happiness/)), or [bslib](https://rstudio.github.io/bslib/), used in the latest shiny app embedded in [Plots Thicken](https://www.quantumjitter.com/project/thicken/).

And in the latest refresh, the newest versions of dplyr and purrr have offered many opportunities for improvements. For example, the `.by` argument in `mutate` and friends as an alternative to `group_by` and `ungroup`. And changes in the `map_` family which introduce `list_rbind` and associates.

```{r}
#| label: libraries

library(tidyverse)
library(tidytext)
library(rvest)
library(paletteer)
library(janitor)
library(glue)
library(ggwordcloud)
library(fpp3)
library(tidymodels)
library(patchwork)
library(clock)
```

```{r}
#| label: theme
#| fig-height: 2
#| dev.args: { bg: "transparent" }

theme_set(theme_bw())

n <- 4
palette <- "harrypotter::ronweasley2"

cols <- paletteer_c(palette, n = n)

tibble(x = 1:n, y = 1) |>
  ggplot(aes(x, y, fill = cols)) +
  geom_col(colour = "white") +
  geom_label(aes(label = cols |> str_remove("FF$")), 
             size = 4, vjust = 2, fill = "white") +
  annotate(
    "label",
    x = (n + 1) / 2, y = 0.5,
    label = palette,
    fill = "white",
    alpha = 0.8,
    size = 6
  ) +
  scale_fill_manual(values = as.character(cols)) +
  theme_void() +
  theme(legend.position = "none")
```

I'll start by grabbing the url for all projects.

```{r}
#| label: urls

urls <- "https://www.quantumjitter.com/project/" |> 
  read_html() |> 
  html_elements(".quarto-grid-link") |> 
  html_attr("href") |> 
  as_tibble() |> 
  transmute(str_c("https://www.quantumjitter.com/", value)) |> 
  pull()
```

This enables me to extract the package and function usage table for each one.

```{r}
#| label: usage

table_df <- map(urls, \(x) {
  x |>
    read_html() |>
    html_elements("#r-toolbox , kable-table") |>
    html_table() |> 
    bind_rows()
}) |>
  list_rbind() |> 
  clean_names(replace = c("io" = "")) |>
  select(package, functn) |>
  drop_na()
```

A little "spring cleaning" is needed, and separation of tidyverse and non-tidyverse packages.

-   [tidyverse](https://www.tidyverse.org/packages/)
-   [tidymodels](https://www.tidymodels.org/packages/)
-   [tidyverts](https://tidyverts.org)

```{r}
#| label: clean

tidy <-
  c(
    tidyverse_packages(),
    fpp3_packages(),
    tidymodels_packages()
  ) |>
  unique()

tidy_df <- table_df |>
  separate_rows(functn, sep = ";") |>
  separate(functn, c("functn", "count"), "\\Q[\\E") |>
  mutate(
    count = str_remove(count, "]") |> as.integer(),
    functn = str_squish(functn)
  ) |>
  count(package, functn, wt = count) |>
  mutate(multiverse = case_when(
    package %in% tidy ~ "tidy",
    package %in% c("base", "graphics") ~ "base",
    TRUE ~ "special"
  ))
```

Then I can summarise usage and prepare for a faceted plot.

```{r}
#| label: summarise

pack_df <- tidy_df |>
  count(package, multiverse, wt = n) |>
  mutate(name = "package")

fun_df <- tidy_df |>
  count(functn, multiverse, wt = n) |>
  mutate(name = "function")

n_url <- urls |> n_distinct()

packfun_df <- pack_df |>
  bind_rows(fun_df) |>
  arrange(desc(n)) |>
  mutate(
    packfun = coalesce(package, functn),
    name = fct_rev(name),
    .by = name
  )
```

I've taken advantage of Quarto's `{{< include _foobar.qmd >}}` to lift, standardise and simplify the toolbox code from the end of every project. Previously, this code (broadly repeated 20 times) inflated the function usage numbers.

With the latest versions of dplyr and purrr, `group_by` has dropped a significant number of places and `list_rbind` has taken a prominent position.

```{r}
#| label: plot
#| fig-height: 20

p1 <- packfun_df |>
  filter(name == "package") |> 
  ggplot(aes(fct_reorder(packfun, n), n, fill = multiverse)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  geom_label(aes(label = n), hjust = "inward", size = 2, fill = "white") +
  scale_fill_manual(values = cols[c(2, 3, 4)]) +
  labs(x = NULL, y = NULL)

min_n <- 7

p2 <- packfun_df |>
  filter(name == "function", n >= min_n) |> 
  ggplot(aes(fct_reorder(packfun, n), n, fill = multiverse)) +
  geom_col() +
  coord_flip() +
  geom_label(aes(label = n), hjust = "inward", size = 2, fill = "white") +
  scale_fill_manual(values = cols[c(2, 3, 4)]) +
  labs(x = NULL, y = NULL, 
       subtitle = glue("Function Usage >= {min_n}"))

p1 + p2 +
  plot_annotation(
    title = glue(
      "Favourite Things from {n_url} Projects as at ",
      "{date_format(date_today('Europe/London'), format = '%B %d, %Y')}"
    )
  )
```

I'd also like a word cloud generated as the new featured image for this project.

```{r}
#| label: feature
#| fig-height: 4.83
#| fig-width: 9
#| fig-path: ""

set.seed = 123

packfun_df |>
  mutate(angle = 45 * sample(-2:2, n(), 
                             replace = TRUE, 
                             prob = c(1, 1, 4, 1, 1))) |>
  ggplot(aes(
    label = packfun,
    size = n,
    colour = multiverse,
    angle = angle
  )) +
  geom_text_wordcloud(
    eccentricity = 1,
    seed = 789
  ) +
  scale_size_area(max_size = 20) +
  scale_colour_manual(values = cols[c(2, 3, 4)]) +
  theme_void() +
  theme(plot.background = element_rect(fill = cols[1]))
```

## R Toolbox

A little bit circular, but I might as well include this code too in my "favourite things".

{{< include /project/_toolbox.qmd >}}
